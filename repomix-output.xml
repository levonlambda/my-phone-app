This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
eslint.config.js
index.html
package.json
postcss.config.js
public/vite.svg
src/App.jsx
src/assets/react.svg
src/components/inventory/DeleteConfirmationModal.jsx
src/components/inventory/InventoryEditForm.jsx
src/components/inventory/InventoryFilters.jsx
src/components/inventory/InventoryRow.jsx
src/components/inventory/InventoryTable.jsx
src/components/InventoryListForm.jsx
src/components/InventorySummaryForm.jsx
src/components/phone-list/PhoneAdvancedSearch.jsx
src/components/phone-list/PhoneDetailModal.jsx
src/components/phone-selection/hooks/usePhoneCache.js
src/components/phone-selection/hooks/usePhoneOptions.js
src/components/phone-selection/PhoneAdditionalInfo.jsx
src/components/phone-selection/PhoneBasicInfo.jsx
src/components/phone-selection/PhoneColorInfo.jsx
src/components/phone-selection/PhonePriceInfo.jsx
src/components/phone-selection/PhoneSelectionForm.jsx
src/components/phone-selection/services/InventoryService.js
src/components/phone-selection/utils/phoneUtils.js
src/components/PhoneListForm.jsx
src/components/PhoneProcurementForm.jsx
src/components/PhoneSpecCard.jsx
src/components/PhoneSpecForm.jsx
src/components/PriceManagementForm.jsx
src/components/ProcurementManagementForm.jsx
src/components/StockReceivingForm.jsx
src/components/SupplierManagementForm.jsx
src/components/ui/badge/index.jsx
src/components/ui/badge/variants.jsx
src/components/ui/card.jsx
src/context/GlobalStateContext.jsx
src/firebase/config.js
src/index.css
src/lib/utils.js
src/main.jsx
src/services/supplierService.js
src/styles.css
tailwind.config.js
vite.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

<file path="eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import react from 'eslint-plugin-react'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'

export default [
  { ignores: ['dist'] },
  {
    files: ['**/*.{js,jsx}'],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    settings: { react: { version: '18.3' } },
    plugins: {
      react,
      'react-hooks': reactHooks,
      'react-refresh': reactRefresh,
    },
    rules: {
      ...js.configs.recommended.rules,
      ...react.configs.recommended.rules,
      ...react.configs['jsx-runtime'].rules,
      ...reactHooks.configs.recommended.rules,
      'react/jsx-no-target-blank': 'off',
      'react-refresh/only-export-components': [
        'warn',
        { allowConstantExport: true },
      ],
    },
  },
]
</file>

<file path="index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + React</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="postcss.config.js">
export default {
    plugins: {
      tailwindcss: {},
      autoprefixer: {},
    },
  }
</file>

<file path="public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="src/assets/react.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="35.93" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 228"><path fill="#00D8FF" d="M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z"></path></svg>
</file>

<file path="src/components/inventory/DeleteConfirmationModal.jsx">
import PropTypes from 'prop-types';
import { X } from 'lucide-react';

const DeleteConfirmationModal = ({ 
  isOpen, 
  itemToDelete, 
  onCancel, 
  onConfirm,
  isDeleting
}) => {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/30 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg shadow-lg max-w-md w-full p-6 mx-4">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-lg font-semibold text-gray-900">Confirm Deletion</h3>
          <button 
            onClick={onCancel}
            className="text-gray-500 hover:text-gray-700"
          >
            <X className="h-5 w-5" />
          </button>
        </div>
        
        <div className="mb-6">
          <p className="text-gray-700 mb-2">
            Are you sure you want to delete this item?
          </p>
          {itemToDelete && (
            <div className="mt-3 bg-gray-50 p-3 rounded-md">
              <p className="font-medium">
                {itemToDelete.manufacturer} {itemToDelete.model}
              </p>
              <p className="text-sm text-gray-500 mt-1">
                {itemToDelete.ram} RAM, {itemToDelete.storage} Storage, {itemToDelete.color}
              </p>
              <p className="text-sm text-gray-500 mt-1">
                IMEI: {itemToDelete.imei1}
              </p>
            </div>
          )}
          <p className="text-red-600 text-sm mt-4">
            This action cannot be undone.
          </p>
        </div>
        
        <div className="flex justify-end space-x-3">
          <button
            onClick={onCancel}
            className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
            disabled={isDeleting}
          >
            Cancel
          </button>
          <button
            onClick={onConfirm}
            className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center"
            disabled={isDeleting}
          >
            {isDeleting ? (
              <>
                <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Deleting...
              </>
            ) : (
              'Delete Item'
            )}
          </button>
        </div>
      </div>
    </div>
  );
};

DeleteConfirmationModal.propTypes = {
  isOpen: PropTypes.bool.isRequired,
  itemToDelete: PropTypes.object,
  onCancel: PropTypes.func.isRequired,
  onConfirm: PropTypes.func.isRequired,
  isDeleting: PropTypes.bool.isRequired
};

export default DeleteConfirmationModal;
</file>

<file path="src/components/phone-selection/hooks/usePhoneOptions.js">
import { useState } from 'react';
import { collection, getDocs, query, where } from 'firebase/firestore';
import { db } from '../../../firebase/config';

export const usePhoneOptions = () => {
  // State for available options
  const [manufacturers, setManufacturers] = useState([]);
  const [models, setModels] = useState([]);
  const [colors, setColors] = useState([]);
  const [storage, setStorage] = useState([]);
  const [ram, setRam] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  // Fetch manufacturers
  const fetchManufacturers = async () => {
    setLoading(true);
    try {
      console.log("Attempting to fetch manufacturers...");
      const phonesRef = collection(db, 'phones');
      const snapshot = await getDocs(phonesRef);
      
      // Extract unique manufacturers
      const uniqueManufacturers = new Set();
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.manufacturer) {
          uniqueManufacturers.add(data.manufacturer);
        }
      });
      
      const manufacturerArray = Array.from(uniqueManufacturers).sort();
      console.log("Manufacturers fetched:", manufacturerArray);
      setManufacturers(manufacturerArray);
      setLoading(false);
      return manufacturerArray;
    } catch (error) {
      console.error("Error fetching manufacturers:", error);
      setError(`Error fetching manufacturers: ${error.message}`);
      setLoading(false);
      return [];
    }
  };

  // Fetch models for a specific manufacturer
  const fetchModels = async (manufacturer) => {
    if (!manufacturer) {
      setModels([]);
      return [];
    }
    
    setLoading(true);
    try {
      console.log(`Fetching models for ${manufacturer}...`);
      const phonesRef = collection(db, 'phones');
      const q = query(phonesRef, where("manufacturer", "==", manufacturer));
      const snapshot = await getDocs(q);
      
      // Extract unique models
      const uniqueModels = new Set();
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.model) {
          uniqueModels.add(data.model);
        }
      });
      
      const modelArray = Array.from(uniqueModels).sort();
      console.log("Models fetched:", modelArray);
      setModels(modelArray);
      setLoading(false);
      return modelArray;
    } catch (error) {
      console.error(`Error fetching models for ${manufacturer}:`, error);
      setError(`Error fetching models: ${error.message}`);
      setLoading(false);
      return [];
    }
  };

  // Fetch options (colors, storage, RAM) for a specific model
  const fetchOptions = async (manufacturer, model) => {
    if (!manufacturer || !model) {
      setColors([]);
      setStorage([]);
      setRam([]);
      return { colors: [], storage: [], ram: [] };
    }
    
    setLoading(true);
    try {
      console.log(`Fetching options for ${manufacturer} ${model}...`);
      const phonesRef = collection(db, 'phones');
      const q = query(
        phonesRef, 
        where("manufacturer", "==", manufacturer),
        where("model", "==", model)
      );
      const snapshot = await getDocs(q);
      
      let colorsArray = [];
      let storageArray = [];
      let ramArray = [];
      
      // Get the first matching document
      if (!snapshot.empty) {
        const data = snapshot.docs[0].data();
        
        // Set colors, storage and RAM options
        colorsArray = Array.isArray(data.colors) ? data.colors : [];
        storageArray = Array.isArray(data.storage) ? data.storage : [];
        ramArray = Array.isArray(data.storage_extra) ? data.storage_extra : [];
        
        setColors(colorsArray);
        setStorage(storageArray);
        setRam(ramArray);
        
        console.log("Options fetched:", {
          colors: colorsArray,
          storage: storageArray,
          ram: ramArray
        });
      }
      
      setLoading(false);
      return { colors: colorsArray, storage: storageArray, ram: ramArray };
    } catch (error) {
      console.error(`Error fetching options for ${manufacturer} ${model}:`, error);
      setError(`Error fetching options: ${error.message}`);
      setLoading(false);
      return { colors: [], storage: [], ram: [] };
    }
  };
  
  return {
    manufacturers,
    models,
    colors,
    storage,
    ram,
    loading,
    error,
    fetchManufacturers,
    fetchModels,
    fetchOptions
  };
};

export default usePhoneOptions;
</file>

<file path="src/components/phone-selection/PhoneColorInfo.jsx">
import PropTypes from 'prop-types';

const PhoneColorInfo = ({
  selectedColor,
  colors,
  handleColorChange
}) => {
  return (
    <div className="space-y-2">
      <label className="block text-[rgb(52,69,157)] font-semibold">Color:</label>
      <select 
        className="w-full p-2 border rounded"
        value={selectedColor}
        onChange={handleColorChange}
        required={colors.length > 0}
      >
        <option value="">-- Select Color --</option>
        {colors.map(color => (
          <option key={color} value={color}>
            {color}
          </option>
        ))}
      </select>
    </div>
  );
};

PhoneColorInfo.propTypes = {
  selectedColor: PropTypes.string.isRequired,
  colors: PropTypes.array.isRequired,
  handleColorChange: PropTypes.func.isRequired
};

export default PhoneColorInfo;
</file>

<file path="src/components/phone-selection/utils/phoneUtils.js">
// Get current date in MM/DD/YYYY format
export function getCurrentDate() {
    const today = new Date();
    const month = today.getMonth() + 1; // getMonth() is zero-based
    const day = today.getDate();
    const year = today.getFullYear();
    return `${month}/${day}/${year}`;
  }
  
  // Calculate markup percentage
  export const calculateMarkup = (dealersPrice, retailPrice) => {
    const dPrice = parseFloat(dealersPrice.replace(/,/g, '')) || 0;
    const rPrice = parseFloat(retailPrice.replace(/,/g, '')) || 0;
    
    if (dPrice <= 0) return '0.00';
    
    const markup = ((rPrice - dPrice) / dPrice) * 100;
    return markup.toFixed(2);
  };
  
  // Calculate profit amount
  export const calculateProfit = (dealersPrice, retailPrice) => {
    const dPrice = parseFloat(dealersPrice.replace(/,/g, '')) || 0;
    const rPrice = parseFloat(retailPrice.replace(/,/g, '')) || 0;
    
    const profit = rPrice - dPrice;
    return profit.toFixed(2);
  };
  
  // Format numbers with commas
  export const formatNumberWithCommas = (value) => {
    // Remove any non-digits except for decimal point
    const cleanValue = value.replace(/[^\d.]/g, '');
    
    // If there's no decimal point, format with commas
    if (!cleanValue.includes('.')) {
      return cleanValue.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }
    
    // Split at decimal point and format the whole number part
    const parts = cleanValue.split('.');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    
    // Join back with decimal point and limit to 2 decimal places
    return parts[0] + (parts.length > 1 ? '.' + parts[1].slice(0, 2) : '');
  };
  
  // Validation function for IMEI
  export const validateImei = (value) => {
    // Only allow digits, max 15 characters
    return value.replace(/[^\d]/g, '').slice(0, 15);
  };
  
  // Validation function for price
  export const validatePrice = (value) => {
    // Only allow digits and one decimal point
    return value.replace(/[^\d.]/g, '').replace(/(\..*)\./g, '$1');
  };
  
  // Create a unique inventory ID
  export const createInventoryId = (manufacturer, model, ram, storage, color) => {
    return `${manufacturer}_${model}_${ram}_${storage}_${color}`.replace(/\s+/g, '_').toLowerCase();
  };
  
  // Parse price value for filters
  export const parsePrice = (value) => {
    if (!value) return '';
    return value.replace(/,/g, '');
  };
  
  // Helper to prevent form submission on Enter key
  export const handleKeyDown = (e) => {
    // Prevent Enter key from submitting the form
    if (e.key === 'Enter') {
      e.preventDefault();
    }
  };
</file>

<file path="src/components/ui/badge/index.jsx">
import PropTypes from 'prop-types'
import { cn } from "@/lib/utils"
import { badgeVariants } from './variants'

function Badge({
  className = '',  // Using default parameter instead of defaultProps
  variant = 'default', // Using default parameter instead of defaultProps
  ...props
}) {
  return (
    <div 
      className={cn(badgeVariants({ variant }), className)} 
      {...props} 
    />
  )
}

Badge.propTypes = {
  className: PropTypes.string,
  variant: PropTypes.oneOf(['default', 'secondary', 'destructive', 'outline'])
}

// Remove Badge.defaultProps

export { Badge }
</file>

<file path="src/components/ui/badge/variants.jsx">
import { cva } from "class-variance-authority"

export const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)
</file>

<file path="src/components/ui/card.jsx">
import * as React from "react"
import { cn } from "@/lib/utils"
import PropTypes from 'prop-types'

const Card = React.forwardRef(({ 
  className = '', // Using default parameter
  ...props 
}, ref) => (
  <div
    ref={ref}
    className={cn("rounded-lg border bg-card text-card-foreground shadow-sm", className)}
    {...props}
  />
))
Card.displayName = "Card"
Card.propTypes = {
  className: PropTypes.string
}

const CardHeader = React.forwardRef(({ 
  className = '', // Using default parameter
  ...props 
}, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"
CardHeader.propTypes = {
  className: PropTypes.string
}

const CardTitle = React.forwardRef(({ 
  className = '', // Using default parameter
  ...props 
}, ref) => (
  <h3
    ref={ref}
    className={cn("text-2xl font-semibold leading-none tracking-tight", className)}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"
CardTitle.propTypes = {
  className: PropTypes.string
}

const CardContent = React.forwardRef(({ 
  className = '', // Using default parameter
  ...props 
}, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"
CardContent.propTypes = {
  className: PropTypes.string
}

export { Card, CardHeader, CardTitle, CardContent }
</file>

<file path="src/firebase/config.js">
import { initializeApp } from 'firebase/app';
import { getFirestore } from 'firebase/firestore';

const firebaseConfig = {

    apiKey: "AIzaSyAdj8EwqtB7uP_gQmevelvbxew4_X4LJyk",  
    authDomain: "tech-city-phone-information.firebaseapp.com",  
    projectId: "tech-city-phone-information",  
    storageBucket: "tech-city-phone-information.firebasestorage.app",  
    messagingSenderId: "218177382353",  
    appId: "1:218177382353:web:cf92ab1e75bcd139a062f0"  
};
  

// Initialize Firebase
const app = initializeApp(firebaseConfig);
export const db = getFirestore(app);
</file>

<file path="src/index.css">
@tailwind base;
@tailwind components;
@tailwind utilities;
</file>

<file path="src/lib/utils.js">
import { clsx } from "clsx"
import { twMerge } from "tailwind-merge"
 
export function cn(...inputs) {
  return twMerge(clsx(inputs))
}
</file>

<file path="src/main.jsx">
// src/main.jsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import './index.css';
import './styles.css';
// Import the GlobalStateProvider from our consolidated file
import { GlobalStateProvider } from './context/GlobalStateContext';

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <GlobalStateProvider>
      <App />
    </GlobalStateProvider>
  </React.StrictMode>
);
</file>

<file path="src/styles.css">
.test-blue {
    background-color: rgb(52,69,157);
    padding: 20px;
    color: white;
  }
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,jsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: []
}
</file>

<file path="vite.config.js">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { fileURLToPath } from 'url'
import path from 'path'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src"),
    },
  },
  esbuild: {
    loader: "jsx",
    include: /src\/.*\.jsx?$/,
    exclude: [],
  },
})
</file>

<file path="package.json">
{
  "name": "my-phone-app",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite --host",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@radix-ui/react-icons": "^1.3.2",
    "@radix-ui/react-slot": "^1.1.1",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "firebase": "^11.2.0",
    "lucide-react": "^0.474.0",
    "path": "^0.12.7",
    "prop-types": "^15.8.1",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-qr-code": "^2.0.15",
    "tailwind-merge": "^2.6.0",
    "url": "^0.11.4"
  },
  "devDependencies": {
    "@eslint/js": "^9.17.0",
    "@shadcn/ui": "^0.0.4",
    "@types/react": "^18.3.18",
    "@types/react-dom": "^18.3.5",
    "@vitejs/plugin-react": "^4.3.4",
    "autoprefixer": "^10.4.17",
    "eslint": "^9.17.0",
    "eslint-plugin-react": "^7.37.2",
    "eslint-plugin-react-hooks": "^5.0.0",
    "eslint-plugin-react-refresh": "^0.4.16",
    "globals": "^15.14.0",
    "postcss": "^8.4.33",
    "tailwindcss": "^3.4.1",
    "tailwindcss-animate": "^1.0.7",
    "vite": "^6.0.5"
  }
}
</file>

<file path="src/components/phone-list/PhoneAdvancedSearch.jsx">
{/* Part 1 Start - Imports */}
import { useState } from 'react';
import PropTypes from 'prop-types';
import { X } from 'lucide-react';
{/* Part 1 End - Imports */}

{/* Part 2 Start - Component Definition */}
const PhoneAdvancedSearch = ({ isOpen, onClose, onSearch, manufacturers }) => {
{/* Part 2 End - Component Definition */}

  {/* Part 3 Start - State Management */}
  const [searchCriteria, setSearchCriteria] = useState({
    manufacturer: '',
    model: '',
    ram: '',
    storage: '',
    display: '',
    battery: { min: '', max: '' },
    chipset: ''
  });
  {/* Part 3 End - State Management */}

  {/* Part 4 Start - Early Return */}
  if (!isOpen) return null;
  {/* Part 4 End - Early Return */}

  {/* Part 5 Start - Event Handlers */}
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    
    if (name.includes('.')) {
      // Handle nested fields like battery.min
      const [parent, child] = name.split('.');
      setSearchCriteria(prev => ({
        ...prev,
        [parent]: {
          ...prev[parent],
          [child]: value
        }
      }));
    } else {
      setSearchCriteria(prev => ({
        ...prev,
        [name]: value
      }));
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    onSearch(searchCriteria);
    onClose();
  };

  const handleReset = () => {
    setSearchCriteria({
      manufacturer: '',
      model: '',
      ram: '',
      storage: '',
      display: '',
      battery: { min: '', max: '' },
      chipset: ''
    });
  };
  {/* Part 5 End - Event Handlers */}

  {/* Part 6 Start - Component Render */}
  return (
    <div className="fixed inset-0 bg-black/30 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-lg max-w-xl w-full">
        <div className="p-4 border-b flex justify-between items-center">
          <h2 className="text-lg font-semibold text-[rgb(52,69,157)]">Advanced Search</h2>
          <button 
            onClick={onClose}
            className="text-gray-500 hover:text-gray-700"
          >
            <X className="h-5 w-5" />
          </button>
        </div>
        
        <form onSubmit={handleSubmit}>
          <div className="p-4 space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Manufacturer
                </label>
                <select
                  name="manufacturer"
                  value={searchCriteria.manufacturer}
                  onChange={handleInputChange}
                  className="w-full p-2 border rounded"
                >
                  <option value="">Any Manufacturer</option>
                  {manufacturers.map(manufacturer => (
                    <option key={manufacturer} value={manufacturer}>
                      {manufacturer}
                    </option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Model
                </label>
                <input
                  type="text"
                  name="model"
                  value={searchCriteria.model}
                  onChange={handleInputChange}
                  placeholder="e.g. Galaxy S25"
                  className="w-full p-2 border rounded"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  RAM
                </label>
                <input
                  type="text"
                  name="ram"
                  value={searchCriteria.ram}
                  onChange={handleInputChange}
                  placeholder="e.g. 8GB"
                  className="w-full p-2 border rounded"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Storage
                </label>
                <input
                  type="text"
                  name="storage"
                  value={searchCriteria.storage}
                  onChange={handleInputChange}
                  placeholder="e.g. 256GB"
                  className="w-full p-2 border rounded"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Display Type
                </label>
                <input
                  type="text"
                  name="display"
                  value={searchCriteria.display}
                  onChange={handleInputChange}
                  placeholder="e.g. AMOLED"
                  className="w-full p-2 border rounded"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Chipset
                </label>
                <input
                  type="text"
                  name="chipset"
                  value={searchCriteria.chipset}
                  onChange={handleInputChange}
                  placeholder="e.g. Snapdragon"
                  className="w-full p-2 border rounded"
                />
              </div>
              
              <div className="md:col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Battery Capacity (mAh)
                </label>
                <div className="flex gap-4">
                  <div className="flex-1">
                    <input
                      type="number"
                      name="battery.min"
                      value={searchCriteria.battery.min}
                      onChange={handleInputChange}
                      placeholder="Min"
                      className="w-full p-2 border rounded"
                    />
                  </div>
                  <div className="flex-1">
                    <input
                      type="number"
                      name="battery.max"
                      value={searchCriteria.battery.max}
                      onChange={handleInputChange}
                      placeholder="Max"
                      className="w-full p-2 border rounded"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div className="p-4 bg-gray-50 flex justify-end gap-2">
            <button
              type="button"
              onClick={handleReset}
              className="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-100"
            >
              Reset
            </button>
            <button
              type="button"
              onClick={onClose}
              className="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-100"
            >
              Cancel
            </button>
            <button
              type="submit"
              className="px-4 py-2 bg-[rgb(52,69,157)] text-white rounded hover:bg-[rgb(52,69,157)]/90"
            >
              Search
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};
{/* Part 6 End - Component Render */}

{/* Part 7 Start - PropTypes Definition */}
PhoneAdvancedSearch.propTypes = {
  isOpen: PropTypes.bool.isRequired,
  onClose: PropTypes.func.isRequired,
  onSearch: PropTypes.func.isRequired,
  manufacturers: PropTypes.array.isRequired
};
{/* Part 7 End - PropTypes Definition */}

{/* Part 8 Start - Export */}
export default PhoneAdvancedSearch;
{/* Part 8 End - Export */}
</file>

<file path="src/components/phone-list/PhoneDetailModal.jsx">
{/* Part 1 Start - Imports */}
import PropTypes from 'prop-types';
import { X, Monitor, Cpu, Camera, Battery, Palette } from 'lucide-react';
{/* Part 1 End - Imports */}

{/* Part 2 Start - Component Definition */}
const PhoneDetailModal = ({ isOpen, phone, onClose }) => {
{/* Part 2 End - Component Definition */}

  {/* Part 3 Start - Early Return */}
  if (!isOpen || !phone) return null;
  {/* Part 3 End - Early Return */}

  {/* Part 4 Start - Sub-component Definition */}
  const SpecRow = ({ label, value }) => (
    <div className="flex items-center py-0.5">
      <p className="text-[rgb(52,69,157)] w-36 text-sm">{label}:</p>
      <p className="text-sm">{value}</p>
    </div>
  );
  
  SpecRow.propTypes = {
    label: PropTypes.string.isRequired,
    value: PropTypes.oneOfType([PropTypes.string, PropTypes.number])
  };
  {/* Part 4 End - Sub-component Definition */}

  {/* Part 5 Start - Helper Functions */}
  const formatArray = (arr) => {
    if (!arr || !Array.isArray(arr)) return '-';
    return arr.join(', ');
  };
  {/* Part 5 End - Helper Functions */}

  {/* Part 6 Start - Component Render */}
  return (
    <div className="fixed inset-0 bg-black/30 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
          <h2 className="text-xl font-bold text-[rgb(52,69,157)]">
            {phone.manufacturer} {phone.model}
          </h2>
          <button 
            onClick={onClose}
            className="text-gray-500 hover:text-gray-700"
          >
            <X className="h-5 w-5" />
          </button>
        </div>
        
        <div className="p-6 space-y-6">
          {/* Display Section */}
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Monitor className="w-5 h-5 text-[rgb(52,69,157)]" />
              <h3 className="text-lg font-semibold">Display</h3>
            </div>
            <div className="ml-7">
              <SpecRow label="Type" value={phone.display || '-'} />
              <SpecRow label="Resolution" value={phone.resolution || '-'} />
              {phone.resolution_extra && (
                <SpecRow label="Refresh Rate" value={`${phone.resolution_extra} Hz`} />
              )}
              {phone.resolution_extra2 && (
                <SpecRow label="Pixel Density" value={`${phone.resolution_extra2} ppi`} />
              )}
              <SpecRow label="Protection" value={phone.protection || '-'} />
            </div>
          </div>

          {/* Performance Section */}
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Cpu className="w-5 h-5 text-[rgb(52,69,157)]" />
              <h3 className="text-lg font-semibold">Performance</h3>
            </div>
            <div className="ml-7">
              <SpecRow label="OS" value={phone.os || '-'} />
              <SpecRow label="Chipset" value={phone.chipset || '-'} />
              {phone.chipset_extra && (
                <SpecRow label="Benchmark" value={phone.chipset_extra} />
              )}
              <SpecRow label="CPU" value={phone.cpu || '-'} />
              <SpecRow label="GPU" value={phone.gpu || '-'} />
              <SpecRow label="RAM" value={formatArray(phone.storage_extra)} />
              <SpecRow label="Storage" value={formatArray(phone.storage)} />
            </div>
          </div>

          {/* Camera Section */}
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Camera className="w-5 h-5 text-[rgb(52,69,157)]" />
              <h3 className="text-lg font-semibold">Camera</h3>
            </div>
            <div className="ml-7">
              <SpecRow label="Rear Camera" value={phone.rearCamera || '-'} />
              <SpecRow label="Front Camera" value={phone.frontCamera || '-'} />
            </div>
          </div>

          {/* Battery Section */}
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Battery className="w-5 h-5 text-[rgb(52,69,157)]" />
              <h3 className="text-lg font-semibold">Battery</h3>
            </div>
            <div className="ml-7">
              <SpecRow label="Capacity" value={phone.battery ? `${phone.battery} mAh` : '-'} />
              <SpecRow label="Wired Charging" value={phone.wiredCharging ? `${phone.wiredCharging}W` : '-'} />
              <SpecRow label="Wireless Charging" value={phone.wirelessCharging ? `${phone.wirelessCharging}W` : '-'} />
            </div>
          </div>

          {/* Misc Section */}
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Palette className="w-5 h-5 text-[rgb(52,69,157)]" />
              <h3 className="text-lg font-semibold">Additional Info</h3>
            </div>
            <div className="ml-7">
              <SpecRow label="Released" value={phone.released || '-'} />
              <SpecRow label="Weight" value={phone.weight ? `${phone.weight}g` : '-'} />
              
              {/* Colors Section */}
              <div className="flex py-0.5">
                <p className="text-[rgb(52,69,157)] w-36 text-sm">Colors:</p>
                <div className="flex flex-wrap gap-2">
                  {Array.isArray(phone.colors) && phone.colors.length > 0 ? (
                    phone.colors.map((color, index) => (
                      <span 
                        key={index} 
                        className="inline-block px-2 py-1 text-xs bg-gray-100 rounded-full"
                      >
                        {color}
                      </span>
                    ))
                  ) : (
                    <p className="text-sm">-</p>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};
{/* Part 6 End - Component Render */}

{/* Part 7 Start - PropTypes Definition */}
PhoneDetailModal.propTypes = {
  isOpen: PropTypes.bool.isRequired,
  phone: PropTypes.object,
  onClose: PropTypes.func.isRequired
};
{/* Part 7 End - PropTypes Definition */}

{/* Part 8 Start - Export */}
export default PhoneDetailModal;
{/* Part 8 End - Export */}
</file>

<file path="src/components/phone-selection/hooks/usePhoneCache.js">
import { useState, useCallback } from 'react';
import { collection, getDocs, doc, setDoc } from 'firebase/firestore';
import { db } from '../../../firebase/config';
import { formatNumberWithCommas, getCurrentDate } from '../utils/phoneUtils';

export const usePhoneCache = () => {
  const [priceCache, setPriceCache] = useState({});
  
  // Load price cache from existing inventory
  const loadPriceCacheFromInventory = useCallback(async () => {
    try {
      const newPriceCache = {};
     
      // First load price configurations (both base and color-specific)
      const configsRef = collection(db, 'price_configurations');
      const configsSnapshot = await getDocs(configsRef);
     
      configsSnapshot.forEach(doc => {
        const data = doc.data();
        console.log("Loading price config:", doc.id, data); // Add this line
        if (data.manufacturer && data.model && data.ram && data.storage) {
          let cacheKey;
         
          if (data.color) {
            // Color-specific price
            cacheKey = `${data.manufacturer}_${data.model}_${data.ram}_${data.storage}_${data.color}`;
          } else {
            // Base price
            cacheKey = `${data.manufacturer}_${data.model}_${data.ram}_${data.storage}`;
          }
         
          newPriceCache[cacheKey] = {
            dealersPrice: formatNumberWithCommas(data.dealersPrice.toString()),
            retailPrice: formatNumberWithCommas(data.retailPrice.toString()),
            lastUpdated: data.lastUpdated
          };
        }
      });
     
      // Then load barcodes from inventory
      const inventoryRef = collection(db, 'inventory');
      const inventorySnapshot = await getDocs(inventoryRef);
     
      inventorySnapshot.forEach(doc => {
        const data = doc.data();
        if (data.manufacturer && data.model && data.ram && data.storage && data.color && data.barcode) {
          const barcodeKey = `${data.manufacturer}_${data.model}_${data.ram}_${data.storage}_${data.color}`;
         
          // Update existing entry or create new one
          newPriceCache[barcodeKey] = {
            ...newPriceCache[barcodeKey] || {},
            barcode: data.barcode,
            // Only update lastUpdated if this is a new entry
            lastUpdated: newPriceCache[barcodeKey]?.lastUpdated || data.lastUpdated
          };
        }
      });
     
      console.log("Price cache loaded:", Object.keys(newPriceCache).length, "entries");
      setPriceCache(newPriceCache);
    } catch (error) {
      console.error("Error loading price cache:", error);
    }
  }, [setPriceCache]);
  
  // Helper function to save/update price configurations
  const updatePriceConfiguration = async (manufacturer, model, ram, storage, dealersPrice, retailPrice, color = null) => {
    try {
      // Create a unique ID - with or without color
      let configId;
      if (color) {
        // Color-specific pricing
        configId = `${manufacturer}_${model}_${ram}_${storage}_${color}`.replace(/\s+/g, '_').toLowerCase();
      } else {
        // Base pricing for this configuration
        configId = `${manufacturer}_${model}_${ram}_${storage}`.replace(/\s+/g, '_').toLowerCase();
      }
      
      // Remove commas and convert to number
      const dPrice = parseFloat(dealersPrice.toString().replace(/,/g, '')) || 0;
      const rPrice = parseFloat(retailPrice.toString().replace(/,/g, '')) || 0;
      
      await setDoc(doc(db, 'price_configurations', configId), {
        manufacturer,
        model,
        ram,
        storage,
        color, // null for base configuration
        dealersPrice: dPrice,
        retailPrice: rPrice,
        lastUpdated: getCurrentDate()
      }, { merge: true });
      
      return true;
    } catch (error) {
      console.error("Error updating price configuration:", error);
      return false;
    }
  };

  return {
    priceCache,
    setPriceCache,
    loadPriceCacheFromInventory,
    updatePriceConfiguration
  };
};

export default usePhoneCache;
</file>

<file path="src/components/phone-selection/PhoneBasicInfo.jsx">
{/* Part 1 Start - Imports and Dependencies */}
import PropTypes from 'prop-types';
{/* Part 1 End - Imports and Dependencies */}

{/* Part 2 Start - Component Definition */}
const PhoneBasicInfo = ({ 
  selectedManufacturer, 
  selectedModel,
  selectedRam,
  selectedStorage,
  manufacturers,
  models,
  ram,
  storage,
  handleRamChange,
  handleStorageChange,
  handleManufacturerChange,
  handleModelChange
}) => {
{/* Part 2 End - Component Definition */}

{/* Part 3 Start - Component Render */}
  return (
    <>
      {/* Manufacturer Selection */}
      <div className="space-y-2">
        <label className="block text-[rgb(52,69,157)] font-semibold">Manufacturer:</label>
        <select 
          className="w-full p-2 border rounded"
          value={selectedManufacturer}
          onChange={handleManufacturerChange}
          required
        >
          <option value="">-- Select Manufacturer --</option>
          {manufacturers.map(manufacturer => (
            <option key={manufacturer} value={manufacturer}>
              {manufacturer}
            </option>
          ))}
        </select>
      </div>

      {/* Model Selection */}
      <div className="space-y-2">
        <label className="block text-[rgb(52,69,157)] font-semibold">Model:</label>
        <select 
          className="w-full p-2 border rounded"
          value={selectedModel}
          onChange={handleModelChange}
          disabled={!selectedManufacturer}
          required
        >
          <option value="">-- Select Model --</option>
          {models.map(model => (
            <option key={model} value={model}>
              {model}
            </option>
          ))}
        </select>
      </div>

      {selectedModel && (
        <div className="flex gap-4">
          {/* RAM Selection */}
          <div className="flex-1 space-y-2">
            <label className="block text-[rgb(52,69,157)] font-semibold">RAM:</label>
            <select 
              className="w-full p-2 border rounded"
              value={selectedRam}
              onChange={handleRamChange}
              required={ram.length > 0}
            >
              <option value="">-- Select RAM --</option>
              {ram.map(option => (
                <option key={option} value={option}>
                  {option}
                </option>
              ))}
            </select>
          </div>

          {/* Storage Selection */}
          <div className="flex-1 space-y-2">
            <label className="block text-[rgb(52,69,157)] font-semibold">Storage:</label>
            <select 
              className="w-full p-2 border rounded"
              value={selectedStorage}
              onChange={handleStorageChange}
              required={storage.length > 0}
            >
              <option value="">-- Select Storage --</option>
              {storage.map(option => (
                <option key={option} value={option}>
                  {option}
                </option>
              ))}
            </select>
          </div>
        </div>
      )}
    </>
  );
};
{/* Part 3 End - Component Render */}

{/* Part 4 Start - PropTypes Validation */}
PhoneBasicInfo.propTypes = {
  selectedManufacturer: PropTypes.string.isRequired,
  selectedModel: PropTypes.string.isRequired,
  selectedRam: PropTypes.string.isRequired,
  selectedStorage: PropTypes.string.isRequired,
  manufacturers: PropTypes.array.isRequired,
  models: PropTypes.array.isRequired,
  ram: PropTypes.array.isRequired,
  storage: PropTypes.array.isRequired,
  handleRamChange: PropTypes.func.isRequired,
  handleStorageChange: PropTypes.func.isRequired,
  handleManufacturerChange: PropTypes.func.isRequired,
  handleModelChange: PropTypes.func.isRequired
};
{/* Part 4 End - PropTypes Validation */}

{/* Part 5 Start - Export */}
export default PhoneBasicInfo;
{/* Part 5 End - Export */}
</file>

<file path="src/components/phone-selection/PhonePriceInfo.jsx">
{/* Part 1 Start - Imports and Dependencies */}
import PropTypes from 'prop-types';
import { calculateMarkup, calculateProfit } from './utils/phoneUtils';
{/* Part 1 End - Imports and Dependencies */}

{/* Part 2 Start - Component Definition */}
const PhonePriceInfo = ({
  dealersPrice,
  retailPrice,
  handleDealersPriceChange,
  handleRetailPriceChange
}) => {
{/* Part 2 End - Component Definition */}

{/* Part 3 Start - Helper Functions */}
  // Helper function to get display values for profit calculation
  // This ensures we don't try to calculate with empty values
  const getPriceForCalculation = (price) => {
    if (!price || price === '') return '0';
    return price;
  };
{/* Part 3 End - Helper Functions */}

{/* Part 4 Start - Component Render */}
  return (
    <div className="space-y-4 pt-2">
      <div className="flex gap-4">
        <div className="flex-1 space-y-2">
          <label className="block text-[rgb(52,69,157)] font-semibold">Dealers Price:</label>
          <input 
            type="text" 
            className="w-full p-2 border rounded"
            value={dealersPrice}
            onChange={handleDealersPriceChange}
            placeholder="0.00"
            required
          />
        </div>
        <div className="flex-1 space-y-2">
          <label className="block text-[rgb(52,69,157)] font-semibold">Retail Price:</label>
          <input 
            type="text" 
            className="w-full p-2 border rounded"
            value={retailPrice}
            onChange={handleRetailPriceChange}
            placeholder="0.00"
            required
          />
        </div>
      </div>
      
      {/* Markup and Profit calculations - only show if both prices have values */}
      {dealersPrice && retailPrice && dealersPrice !== '' && retailPrice !== '' && (
        <div className="flex gap-4">
          <div className="flex-1 space-y-2">
            <label className="block text-[rgb(52,69,157)] font-semibold">Markup:</label>
            <div className="w-full p-2 border rounded bg-gray-50">
              {calculateMarkup(getPriceForCalculation(dealersPrice), getPriceForCalculation(retailPrice))}%
            </div>
          </div>
          <div className="flex-1 space-y-2">
            <label className="block text-[rgb(52,69,157)] font-semibold">Profit:</label>
            <div className="w-full p-2 border rounded bg-gray-50">
              {calculateProfit(getPriceForCalculation(dealersPrice), getPriceForCalculation(retailPrice))}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};
{/* Part 4 End - Component Render */}

{/* Part 5 Start - PropTypes Validation */}
PhonePriceInfo.propTypes = {
  dealersPrice: PropTypes.string.isRequired,
  retailPrice: PropTypes.string.isRequired,
  handleDealersPriceChange: PropTypes.func.isRequired,
  handleRetailPriceChange: PropTypes.func.isRequired
};
{/* Part 5 End - PropTypes Validation */}

{/* Part 6 Start - Export */}
export default PhonePriceInfo;
{/* Part 6 End - Export */}
</file>

<file path="src/components/PhoneListForm.jsx">
{/* Part 1 Start - Imports */}
import { useState, useEffect, useCallback } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { collection, getDocs, query, orderBy } from 'firebase/firestore';
import { db } from '../firebase/config';
import { Smartphone, RefreshCw, Search, Filter, X, Eye, SlidersHorizontal, Edit } from 'lucide-react';
import PhoneDetailModal from './phone-list/PhoneDetailModal';
import PhoneAdvancedSearch from './phone-list/PhoneAdvancedSearch';
import { useGlobalState } from '../context/GlobalStateContext';
{/* Part 1 End - Imports */}

{/* Part 2 Start - Component Definition */}
const PhoneListForm = () => {
{/* Part 2 End - Component Definition */}

  {/* Part 3 Start - State Management */}
  // Get global state functions
  const { editPhone } = useGlobalState();
  
  // State for phones data
  const [phones, setPhones] = useState([]);
  const [filteredPhones, setFilteredPhones] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [sortField, setSortField] = useState('manufacturer');
  const [sortDirection, setSortDirection] = useState('asc');
  
  // State for filters
  const [filters, setFilters] = useState({
    manufacturer: '',
    searchTerm: ''
  });
  
  // Filter options
  const [manufacturers, setManufacturers] = useState([]);
  
  // Show/hide filters
  const [showFilters, setShowFilters] = useState(true);
  
  // Advanced search modal state
  const [isAdvancedSearchOpen, setIsAdvancedSearchOpen] = useState(false);
  const [advancedSearchCriteria, setAdvancedSearchCriteria] = useState(null);
  
  // Detail modal state
  const [isDetailModalOpen, setIsDetailModalOpen] = useState(false);
  const [selectedPhone, setSelectedPhone] = useState(null);
  {/* Part 3 End - State Management */}

  {/* Part 4 Start - Filter and Search Functions */}
  // Apply filters function defined before fetchPhones to avoid dependency issues
  const applyFilters = useCallback((phonesData) => {
    let filtered = [...phonesData];
    
    // Apply basic filters
    // Apply manufacturer filter
    if (filters.manufacturer) {
      filtered = filtered.filter(phone => 
        phone.manufacturer === filters.manufacturer
      );
    }
    
    // Apply search term filter (search across multiple fields)
    if (filters.searchTerm) {
      const searchLower = filters.searchTerm.toLowerCase();
      filtered = filtered.filter(phone => 
        phone.manufacturer?.toLowerCase().includes(searchLower) ||
        phone.model?.toLowerCase().includes(searchLower) ||
        phone.chipset?.toLowerCase().includes(searchLower) ||
        phone.display?.toLowerCase().includes(searchLower) ||
        (Array.isArray(phone.colors) && phone.colors.some(color => 
          color.toLowerCase().includes(searchLower)
        ))
      );
    }
    
    // Apply advanced search criteria if present
    if (advancedSearchCriteria) {
      // Manufacturer filter (if not already applied in basic filters)
      if (advancedSearchCriteria.manufacturer && !filters.manufacturer) {
        filtered = filtered.filter(phone => 
          phone.manufacturer === advancedSearchCriteria.manufacturer
        );
      }
      
      // Model filter
      if (advancedSearchCriteria.model) {
        const modelSearch = advancedSearchCriteria.model.toLowerCase();
        filtered = filtered.filter(phone => 
          phone.model?.toLowerCase().includes(modelSearch)
        );
      }
      
      // RAM filter
      if (advancedSearchCriteria.ram) {
        const ramSearch = advancedSearchCriteria.ram.toLowerCase();
        filtered = filtered.filter(phone => 
          Array.isArray(phone.storage_extra) && 
          phone.storage_extra.some(ram => ram.toLowerCase().includes(ramSearch))
        );
      }
      
      // Storage filter
      if (advancedSearchCriteria.storage) {
        const storageSearch = advancedSearchCriteria.storage.toLowerCase();
        filtered = filtered.filter(phone => 
          Array.isArray(phone.storage) && 
          phone.storage.some(storage => storage.toLowerCase().includes(storageSearch))
        );
      }
      
      // Display filter
      if (advancedSearchCriteria.display) {
        const displaySearch = advancedSearchCriteria.display.toLowerCase();
        filtered = filtered.filter(phone => 
          phone.display?.toLowerCase().includes(displaySearch)
        );
      }
      
      // Chipset filter
      if (advancedSearchCriteria.chipset) {
        const chipsetSearch = advancedSearchCriteria.chipset.toLowerCase();
        filtered = filtered.filter(phone => 
          phone.chipset?.toLowerCase().includes(chipsetSearch) ||
          phone.cpu?.toLowerCase().includes(chipsetSearch)
        );
      }
      
      // Battery range filter
      if (advancedSearchCriteria.battery) {
        // Min battery
        if (advancedSearchCriteria.battery.min) {
          const minBattery = parseInt(advancedSearchCriteria.battery.min);
          if (!isNaN(minBattery)) {
            filtered = filtered.filter(phone => 
              phone.battery >= minBattery
            );
          }
        }
        
        // Max battery
        if (advancedSearchCriteria.battery.max) {
          const maxBattery = parseInt(advancedSearchCriteria.battery.max);
          if (!isNaN(maxBattery)) {
            filtered = filtered.filter(phone => 
              phone.battery <= maxBattery
            );
          }
        }
      }
    }
    
    setFilteredPhones(filtered);
  }, [filters, advancedSearchCriteria]);

  // Fetch phones data
  const fetchPhones = useCallback(async () => {
    setLoading(true);
    setError(null);
    
    try {
      const phonesRef = collection(db, 'phones');
      const q = query(phonesRef, orderBy(sortField, sortDirection));
      const snapshot = await getDocs(q);
      
      const phonesData = [];
      snapshot.forEach(doc => {
        phonesData.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      // Extract unique manufacturers for filter
      const uniqueManufacturers = [...new Set(phonesData.map(phone => phone.manufacturer))].sort();
      setManufacturers(uniqueManufacturers);
      
      setPhones(phonesData);
      applyFilters(phonesData);
      setLoading(false);
    } catch (error) {
      console.error("Error fetching phones:", error);
      setError(`Error fetching phones: ${error.message}`);
      setLoading(false);
    }
  }, [sortField, sortDirection, applyFilters]); // Added applyFilters dependency here
  {/* Part 4 End - Filter and Search Functions */}

  {/* Part 5 Start - Event Handlers */}
  // Handle filter change
  const handleFilterChange = (e) => {
    const { name, value } = e.target;
    setFilters(prev => ({
      ...prev,
      [name]: value
    }));
  };

  // Clear all filters
  const clearFilters = () => {
    setFilters({
      manufacturer: '',
      searchTerm: ''
    });
    setAdvancedSearchCriteria(null);
  };
  
  // Handle advanced search
  const handleAdvancedSearch = (criteria) => {
    setAdvancedSearchCriteria(criteria);
    // Clear basic search term to avoid confusion
    setFilters(prev => ({
      ...prev,
      searchTerm: ''
    }));
  };
  
  // Open advanced search modal
  const openAdvancedSearch = () => {
    setIsAdvancedSearchOpen(true);
  };
  
  // Close advanced search modal
  const closeAdvancedSearch = () => {
    setIsAdvancedSearchOpen(false);
  };

  // Handle sort change
  const handleSort = (field) => {
    if (field === sortField) {
      // Toggle direction if same field
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      // Set new field and default to asc
      setSortField(field);
      setSortDirection('asc');
    }
  };
  
  // Open detail modal for a phone
  const openPhoneDetail = (phone) => {
    setSelectedPhone(phone);
    setIsDetailModalOpen(true);
  };
  
  // Close detail modal
  const closePhoneDetail = () => {
    setIsDetailModalOpen(false);
    setSelectedPhone(null);
  };
  
  // Handle edit phone
  const handleEditPhone = (phone) => {
    console.log("Editing phone:", phone.id);
    editPhone(phone);
    // No need to manually change location, the context will handle this
  };
  {/* Part 5 End - Event Handlers */}

  {/* Part 6 Start - UseEffect Hooks */}
  // Initial data fetch
  useEffect(() => {
    fetchPhones();
  }, [fetchPhones]);

  // Apply filters when they change
  useEffect(() => {
    if (phones.length > 0) {
      applyFilters(phones);
    }
  }, [filters, phones, applyFilters, advancedSearchCriteria]);
  {/* Part 6 End - UseEffect Hooks */}

  {/* Part 7 Start - Helper Functions */}
  // Format storage array as string
  const formatStorage = (storageArray) => {
    if (!storageArray || !Array.isArray(storageArray)) return '-';
    return storageArray.join(', ');
  };

  // Format RAM array as string
  const formatRAM = (ramArray) => {
    if (!ramArray || !Array.isArray(ramArray)) return '-';
    return ramArray.join(', ');
  };
  {/* Part 7 End - Helper Functions */}

  {/* Part 8 Start - Component Render */}
  // Main component render
  return (
    <div className="min-h-screen bg-white p-4">
      <Card className="w-full max-w-6xl mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
        <CardHeader className="bg-[rgb(52,69,157)] py-3 flex flex-row justify-between items-center">
          <div className="flex items-center gap-2">
            <Smartphone className="h-6 w-6 text-white" />
            <CardTitle className="text-2xl text-white">Phone Models</CardTitle>
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => setShowFilters(!showFilters)}
              className={`flex items-center gap-1 ${showFilters ? 'bg-white/20 text-white' : 'bg-white text-[rgb(52,69,157)]'} px-4 py-2 rounded text-base font-medium`}
            >
              <Filter className="h-5 w-5 mr-1" />
              <span>Filters</span>
            </button>
            <button
              onClick={openAdvancedSearch}
              className="flex items-center gap-1 bg-white text-[rgb(52,69,157)] px-4 py-2 rounded text-base font-medium"
            >
              <SlidersHorizontal className="h-5 w-5 mr-1" />
              <span>Advanced</span>
            </button>
            <button
              onClick={fetchPhones}
              className="flex items-center gap-1 bg-white text-[rgb(52,69,157)] px-4 py-2 rounded text-base font-medium"
            >
              <RefreshCw className="h-5 w-5 mr-1" />
              <span>Refresh</span>
            </button>
          </div>
        </CardHeader>

        <CardContent className="p-4">
          {/* Filters panel */}
          {showFilters && (
            <div className="mb-6 p-4 bg-gray-50 rounded-lg border">
              <div className="flex justify-between items-center mb-4">
                <div>
                  <h3 className="font-semibold text-lg text-[rgb(52,69,157)]">Filters</h3>
                  {advancedSearchCriteria && (
                    <p className="text-xs text-[rgb(52,69,157)]">Advanced filters active</p>
                  )}
                </div>
                <button 
                  onClick={clearFilters}
                  className="text-gray-500 hover:text-red-500 flex items-center"
                >
                  <X className="h-4 w-4 mr-1" />
                  Clear Filters
                </button>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Manufacturer
                  </label>
                  <select
                    name="manufacturer"
                    value={filters.manufacturer}
                    onChange={handleFilterChange}
                    className="w-full p-2 border rounded"
                  >
                    <option value="">All Manufacturers</option>
                    {manufacturers.map(manufacturer => (
                      <option key={manufacturer} value={manufacturer}>
                        {manufacturer}
                      </option>
                    ))}
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Search
                  </label>
                  <div className="relative">
                    <input
                      type="text"
                      name="searchTerm"
                      value={filters.searchTerm}
                      onChange={handleFilterChange}
                      placeholder="Search phones..."
                      className="w-full p-2 pl-9 border rounded"
                    />
                    <Search className="h-4 w-4 text-gray-400 absolute left-3 top-3" />
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {/* Empty states and content */}
          {!loading && !error && (
            <>
              {phones.length === 0 ? (
                <div className="text-center py-12 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                  <Smartphone className="h-12 w-12 text-gray-400 mx-auto mb-4" />
                  <h3 className="text-lg font-medium text-gray-700 mb-2">No phones found</h3>
                  <p className="text-gray-500 mb-4">There are no phone models in the database yet.</p>
                  <button
                    onClick={() => window.location.href = '#form'}
                    className="px-4 py-2 bg-[rgb(52,69,157)] text-white rounded-md"
                  >
                    Add New Phone
                  </button>
                </div>
              ) : filteredPhones.length === 0 ? (
                <div className="text-center py-12 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                  <Search className="h-12 w-12 text-gray-400 mx-auto mb-4" />
                  <h3 className="text-lg font-medium text-gray-700 mb-2">No matching phones</h3>
                  <p className="text-gray-500 mb-4">Try changing your search criteria or clearing filters.</p>
                  <button
                    onClick={clearFilters}
                    className="px-4 py-2 bg-[rgb(52,69,157)] text-white rounded-md"
                  >
                    Clear All Filters
                  </button>
                </div>
              ) : (
                <div className="overflow-x-auto bg-white rounded-md border">
                  <table className="w-full border-collapse text-sm table-fixed">
                    <thead>
                      <tr className="bg-gray-100">
                        <th 
                          className="border px-4 py-2 text-left cursor-pointer hover:bg-gray-200 w-[11%]"
                          onClick={() => handleSort('manufacturer')}
                        >
                          Manufacturer
                          {sortField === 'manufacturer' && (
                            <span className="ml-1">{sortDirection === 'asc' ? '' : ''}</span>
                          )}
                        </th>
                        <th 
                          className="border px-4 py-2 text-left cursor-pointer hover:bg-gray-200 w-[11%]"
                          onClick={() => handleSort('model')}
                        >
                          Model
                          {sortField === 'model' && (
                            <span className="ml-1">{sortDirection === 'asc' ? '' : ''}</span>
                          )}
                        </th>
                        <th className="border px-4 py-2 text-left w-[10%]">Display</th>
                        <th className="border px-4 py-2 text-left w-[10%]">RAM</th>
                        <th className="border px-4 py-2 text-left w-[12%]">Storage</th>
                        <th className="border px-4 py-2 text-left w-[15%]">CPU/Chipset</th>
                        <th className="border px-4 py-2 text-left w-[10%]">Battery</th>
                        <th className="border px-4 py-2 text-left w-[13%]">Colors</th>
                        <th className="border px-4 py-2 text-center w-[8%]">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredPhones.map((phone) => (
                        <tr key={phone.id} className="hover:bg-gray-50">
                          <td className="border px-4 py-2">{phone.manufacturer}</td>
                          <td className="border px-4 py-2 font-medium">{phone.model}</td>
                          <td className="border px-4 py-2 truncate max-w-[150px]">{phone.display || '-'}</td>
                          <td className="border px-4 py-2 whitespace-nowrap">{formatRAM(phone.storage_extra)}</td>
                          <td className="border px-4 py-2 whitespace-nowrap">{formatStorage(phone.storage)}</td>
                          <td className="border px-4 py-2 truncate max-w-[200px]">{phone.chipset || phone.cpu || '-'}</td>
                          <td className="border px-4 py-2 whitespace-nowrap">{phone.battery ? `${phone.battery} mAh` : '-'}</td>
                          <td className="border px-4 py-2">
                            <div className="flex flex-wrap gap-1">
                              {Array.isArray(phone.colors) ? (
                                phone.colors.length > 0 ? (
                                  phone.colors.slice(0, 3).map((color, index) => (
                                    <span 
                                      key={index} 
                                      className="inline-block px-2 py-1 text-xs bg-gray-100 rounded"
                                    >
                                      {color}
                                    </span>
                                  ))
                                ) : '-'
                              ) : '-'}
                              {Array.isArray(phone.colors) && phone.colors.length > 3 && (
                                <span className="inline-block px-2 py-1 text-xs bg-gray-100 rounded">
                                  +{phone.colors.length - 3} more
                                </span>
                              )}
                            </div>
                          </td>
                          <td className="border px-4 py-2 text-center">
                            <div className="flex justify-center space-x-3">
                              <button
                                onClick={() => openPhoneDetail(phone)}
                                className="p-1 text-[rgb(52,69,157)] hover:text-[rgb(80,100,200)]"
                                title="View details"
                              >
                                <Eye className="h-5 w-5" />
                              </button>
                              <button
                                onClick={() => handleEditPhone(phone)}
                                className="p-1 text-[rgb(52,69,157)] hover:text-[rgb(80,100,200)]"
                                title="Edit phone"
                              >
                                <Edit className="h-5 w-5" />
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                  
                  <div className="p-4 flex justify-between items-center text-gray-600">
                    <div>
                      Showing {filteredPhones.length} of {phones.length} phones
                    </div>
                    {advancedSearchCriteria && (
                      <div className="text-xs bg-gray-100 px-2 py-1 rounded">
                        Advanced filters applied
                      </div>
                    )}
                  </div>
                </div>
              )}
            </>
          )}
          
          {/* Loading state */}
          {loading && (
            <div className="text-center py-12">
              <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[rgb(52,69,157)]"></div>
              <p className="mt-2 text-gray-600">Loading phones...</p>
            </div>
          )}
          
          {/* Error state */}
          {error && (
            <div className="text-center py-8 text-red-600">
              <p className="mb-2">{error}</p>
              <button
                onClick={fetchPhones}
                className="mt-2 px-4 py-2 bg-[rgb(52,69,157)] text-white rounded"
              >
                Try Again
              </button>
            </div>
          )}
          
          {/* Phone Detail Modal */}
          <PhoneDetailModal 
            isOpen={isDetailModalOpen}
            phone={selectedPhone}
            onClose={closePhoneDetail}
          />
          
          {/* Advanced Search Modal */}
          <PhoneAdvancedSearch
            isOpen={isAdvancedSearchOpen}
            onClose={closeAdvancedSearch}
            onSearch={handleAdvancedSearch}
            manufacturers={manufacturers}
          />
        </CardContent>
      </Card>
    </div>
  );
};
{/* Part 8 End - Component Render */}

{/* Part 9 Start - Export */}
export default PhoneListForm;
{/* Part 9 End - Export */}
</file>

<file path="src/components/PhoneSpecCard.jsx">
{/* Part 1 Start - Imports */}
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Battery, Camera, Cpu, Monitor, Palette } from 'lucide-react';
import PropTypes from 'prop-types';
{/* Part 1 End - Imports */}

{/* Part 2 Start - Component Definition */}
const PhoneSpecCard = () => {
{/* Part 2 End - Component Definition */}

  {/* Part 3 Start - Static Data */}
  const phoneData = {
    manufacturer: "Samsung",
    model: "Galaxy S25 Ultra",
    released: "February 2025",
    weight: "218g",
    display: "AMOLED (120Hz)",
    resolution: "1440 x 3120 (498 ppi density)",
    protection: "Corning Gorilla Armor 2",
    os: "Android 15",
    chipset: "Qualcom SM8750-AB Snapdragon 8 Elite",
    cpu: "Qualcomm Oryon",
    gpu: "Qualcomm Adreno",
    storageAndRam: "256GB/ 12GB",
    rearCamera: "200MP + 10MP + 50MP + 50MP",
    frontCamera: "12MP",
    battery: "5,000 mAh",
    wiredCharging: "45W",
    wirelessCharging: "25W",
    colors: ["Titanium Silver Blue", "Titanium Black", "Titanium White Silver", "Titanium Gray"]
  };
  {/* Part 3 End - Static Data */}

  {/* Part 4 Start - Sub-component Definition */}
  const SpecRow = ({ label, value }) => (
    <div className="flex items-center py-0.5">
      <p className="text-[rgb(52,69,157)] w-40 text-base">{label}:</p>
      <p className="text-base">{value}</p>
    </div>
  );
  
  SpecRow.propTypes = {
    label: PropTypes.string.isRequired,
    value: PropTypes.string.isRequired
  };
  {/* Part 4 End - Sub-component Definition */}

  {/* Part 5 Start - Component Render */}
  return (
    <div className="min-h-screen bg-white p-4">
      <Card className="w-full max-w-[640px] mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
        <CardHeader className="bg-[rgb(52,69,157)] py-3">
          <CardTitle className="text-2xl text-white">
            {phoneData.manufacturer} {phoneData.model}
          </CardTitle>
          <div className="flex gap-2 mt-2">
            <Badge className="bg-white rounded-md px-3 text-base" style={{ color: 'rgb(52,69,157)' }}>
              {phoneData.released}
            </Badge>
            <Badge variant="outline" className="border-white text-white rounded-md px-3 text-base">
              {phoneData.weight}
            </Badge>
          </div>
        </CardHeader>
        <CardContent className="bg-white p-4 space-y-4">
          {/* Display Section */}
          <div className="space-y-1">
            <div className="flex items-center gap-2">
              <Monitor className="w-5 h-5 text-[rgb(52,69,157)]" />
              <h3 className="text-lg font-semibold">Display</h3>
            </div>
            <div>
              <SpecRow label="Type" value={phoneData.display} />
              <SpecRow label="Resolution" value={phoneData.resolution} />
              <SpecRow label="Protection" value={phoneData.protection} />
            </div>
          </div>

          {/* Performance Section */}
          <div className="space-y-1">
            <div className="flex items-center gap-2">
              <Cpu className="w-5 h-5 text-[rgb(52,69,157)]" />
              <h3 className="text-lg font-semibold">Performance</h3>
            </div>
            <div>
              <SpecRow label="OS" value={phoneData.os} />
              <SpecRow label="Chipset" value={phoneData.chipset} />
              <SpecRow label="CPU" value={phoneData.cpu} />
              <SpecRow label="GPU" value={phoneData.gpu} />
              <SpecRow label="Storage & RAM" value={phoneData.storageAndRam} />
            </div>
          </div>

          {/* Camera Section */}
          <div className="space-y-1">
            <div className="flex items-center gap-2">
              <Camera className="w-5 h-5 text-[rgb(52,69,157)]" />
              <h3 className="text-lg font-semibold">Camera</h3>
            </div>
            <div>
              <SpecRow label="Rear Camera" value={phoneData.rearCamera} />
              <SpecRow label="Front Camera" value={phoneData.frontCamera} />
            </div>
          </div>

          {/* Battery Section */}
          <div className="space-y-1">
            <div className="flex items-center gap-2">
              <Battery className="w-5 h-5 text-[rgb(52,69,157)]" />
              <h3 className="text-lg font-semibold">Battery</h3>
            </div>
            <div>
              <SpecRow label="Capacity" value={phoneData.battery} />
              <SpecRow label="Wired Charging" value={phoneData.wiredCharging} />
              <SpecRow label="Wireless Charging" value={phoneData.wirelessCharging} />
            </div>
          </div>

          {/* Colors Section */}
          <div className="space-y-1">
            <div className="flex items-center gap-2">
              <Palette className="w-5 h-5 text-[rgb(52,69,157)]" />
              <h3 className="text-lg font-semibold">Available Colors</h3>
            </div>
            <div className="flex flex-wrap gap-2">
              {phoneData.colors.map((color, index) => (
                <Badge 
                  key={index} 
                  variant="outline" 
                  className="rounded-md px-3 text-sm" // Changed from text-base to text-sm
                  style={{ borderColor: 'rgb(52,69,157)', color: 'rgb(52,69,157)' }}
                >
                  {color}
                </Badge>
              ))}
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};
{/* Part 5 End - Component Render */}

{/* Part 6 Start - Export */}
export default PhoneSpecCard;
{/* Part 6 End - Export */}
</file>

<file path="src/components/PhoneSpecForm.jsx">
{/* Part 1 Start - State and Form Data Updates */}
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Battery, Camera, Cpu, Monitor, Palette, Smartphone } from 'lucide-react';
import { useState, useEffect } from 'react';
import PropTypes from 'prop-types';
import { addDoc, collection, doc, updateDoc } from 'firebase/firestore';
import { db } from '../firebase/config';
import { useGlobalState } from '../context/GlobalStateContext';

// Add capitalizeWords helper function
const capitalizeWords = (str) => {
  if (!str) return '';
  return str
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
};

// Helper function to clean and validate numeric input during typing
const validateNumericInput = (value) => {
  if (!value) return '';
  // Only allow digits, one decimal point, and commas in proper positions
  const cleaned = value
    // Remove anything that's not a digit, comma, or decimal
    .replace(/[^0-9,.]|\.(?=.*\.)/g, '')
    // Remove commas that aren't followed by 3 digits
    .replace(/,(?![0-9]{3})/g, '')
    // Remove multiple consecutive commas
    .replace(/,+/g, ',');
    
  return cleaned;
};

// Helper function to process numeric value before saving to Firebase
const processNumericValue = (value) => {
  if (!value) return null;
  // Remove commas and convert to number
  const cleanValue = value.replace(/,/g, '');
  return cleanValue ? Number(cleanValue) : null;
};

const InputField = ({ label, name, value, width = "w-40", onChange }) => (
  <div className="flex items-center py-0.5">
    <p className={`text-[rgb(52,69,157)] ${width} text-base`}>{label}:</p>
    <input
      type="text"
      name={name}
      value={value || ''}
      onChange={onChange}
      className="text-base flex-1 border rounded px-2 py-1"
    />
  </div>
);

const InputFieldWithExtra = ({ label, name, value, extraValue, extraPlaceholder, mainPlaceholder = "", onChange, width = "w-40" }) => (
  <div className="flex items-center py-0.5">
    <p className={`text-[rgb(52,69,157)] ${width} text-base`}>{label}:</p>
    <div className="flex-1 flex gap-2">
      <input
        type="text"
        name={name}
        value={value || ''}
        onChange={onChange}
        className="text-base flex-1 border rounded px-2 py-1"
        placeholder={mainPlaceholder}
      />
      <div className="w-32">
        <input
          type="text"
          name={`${name}_extra`}
          value={extraValue || ''}
          onChange={onChange}
          className="text-base w-full border rounded px-2 py-1"
          placeholder={extraPlaceholder}
        />
      </div>
    </div>
  </div>
);

const InputFieldWithTwoExtras = ({ label, name, value, extraValue, extraValue2, extraPlaceholder, extraPlaceholder2, mainPlaceholder = "", onChange, width = "w-40" }) => (
  <div className="flex items-center py-0.5">
    <p className={`text-[rgb(52,69,157)] ${width} text-base`}>{label}:</p>
    <div className="flex-1 flex gap-2">
      <div className="flex-1">
        <input
          type="text"
          name={name}
          value={value || ''}
          onChange={onChange}
          className="text-base w-full border rounded px-2 py-1" 
          placeholder={mainPlaceholder}
        />
      </div>
      <div className="w-32">
        <input
          type="text"
          name={`${name}_extra`}
          value={extraValue || ''}
          onChange={onChange}
          className="text-base w-full border rounded px-2 py-1"
          placeholder={extraPlaceholder}
        />
      </div>
      <div className="w-32">
        <input
          type="text"
          name={`${name}_extra2`}
          value={extraValue2 || ''}
          onChange={onChange}
          className="text-base w-full border rounded px-2 py-1"
          placeholder={extraPlaceholder2}
        />
      </div>
    </div>
  </div>
);

InputFieldWithExtra.propTypes = {
  label: PropTypes.string.isRequired,
  name: PropTypes.string.isRequired,
  value: PropTypes.string,
  extraValue: PropTypes.string,
  extraPlaceholder: PropTypes.string.isRequired,
  mainPlaceholder: PropTypes.string,
  onChange: PropTypes.func.isRequired,
  width: PropTypes.string
};

InputFieldWithTwoExtras.propTypes = {
  label: PropTypes.string.isRequired,
  name: PropTypes.string.isRequired,
  value: PropTypes.string,
  extraValue: PropTypes.string,
  extraValue2: PropTypes.string,
  extraPlaceholder: PropTypes.string.isRequired,
  extraPlaceholder2: PropTypes.string.isRequired,
  mainPlaceholder: PropTypes.string,
  onChange: PropTypes.func.isRequired,
  width: PropTypes.string
};

InputField.propTypes = {
  label: PropTypes.string.isRequired,
  name: PropTypes.string.isRequired,
  value: PropTypes.string,
  width: PropTypes.string,
  onChange: PropTypes.func.isRequired
};

InputField.defaultProps = {
  width: "w-40"
};

const PhoneSpecForm = () => {
  // Access the global state for editing
  const { phoneToEdit, clearPhoneToEdit } = useGlobalState();

  const [formData, setFormData] = useState({
    manufacturer: "",
    model: "",
    released: "",
    weight: "",    
    display: "",
    resolution: "",
    resolution_extra: "",
    resolution_extra2: "", 
    protection: "",
    os: "",
    chipset: "",
    chipset_extra: "",
    cpu: "",
    gpu: "",
    storage: "",
    storage_extra: "",
    rearCamera: "",
    frontCamera: "",
    battery: "",
    wiredCharging: "",
    wirelessCharging: "",
    colors: "",
    excludeFromSummary: false // NEW: Add exclude checkbox state
  });
  
  // State to track if we're editing an existing phone
  const [isEditing, setIsEditing] = useState(false);
  const [editId, setEditId] = useState(null);
{/* Part 1 End - State and Form Data Updates */}

{/* Part 2 Start - Effects and Input Handling */}
  // Update form data when phoneToEdit changes
  useEffect(() => {
    if (phoneToEdit) {
      // We're in edit mode
      setIsEditing(true);
      setEditId(phoneToEdit.id);
      
      // Format the data for the form
      const formattedData = {
        ...phoneToEdit,
        // Convert arrays to comma-separated strings
        storage: Array.isArray(phoneToEdit.storage) ? phoneToEdit.storage.join(', ') : '',
        storage_extra: Array.isArray(phoneToEdit.storage_extra) ? phoneToEdit.storage_extra.join(', ') : '',
        colors: Array.isArray(phoneToEdit.colors) ? phoneToEdit.colors.join(', ') : '',
        
        // Handle potentially undefined numeric values
        battery: phoneToEdit.battery?.toString() || '',
        wiredCharging: phoneToEdit.wiredCharging?.toString() || '',
        wirelessCharging: phoneToEdit.wirelessCharging?.toString() || '',
        weight: phoneToEdit.weight?.toString() || '',
        resolution_extra: phoneToEdit.resolution_extra?.toString() || '',
        resolution_extra2: phoneToEdit.resolution_extra2?.toString() || '',
        chipset_extra: phoneToEdit.chipset_extra?.toString() || '',
        
        // NEW: Handle exclude from summary field (default to false if not present)
        excludeFromSummary: phoneToEdit.excludeFromSummary || false
      };
      
      setFormData(formattedData);
    } else {
      // Reset edit state when there's no phone to edit
      setIsEditing(false);
      setEditId(null);
    }
  }, [phoneToEdit]);

  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target;
    
    // NEW: Handle checkbox input for excludeFromSummary
    if (type === 'checkbox') {
      setFormData(prev => ({
        ...prev,
        [name]: checked
      }));
      return;
    }
    
    // List of fields that should be numeric
    const numericFields = [
      'price',
      'chipset_extra', // Benchmark
      'battery',     
      'wiredCharging',
      'wirelessCharging',
      'weight',
      'resolution_extra', // Refresh Rate
      'resolution_extra2', // PPI
    ];
  
    // List of fields that can accept any input (documenting for clarity)
    const freeformFields = [
      'resolution',
      'rearCamera',
      'frontCamera',
      'storage',
      'storage_extra', // RAM
    ];
  
    // List of fields that should be uppercase
    const uppercaseFields = [
      'barcode',
      'display' 
    ];
  
    // If it's a numeric field, validate the input
    if (numericFields.includes(name)) {
      const validatedValue = validateNumericInput(value);
      setFormData(prev => ({
        ...prev,
        [name]: validatedValue
      }));
    } 
    // If it's an uppercase field, convert to uppercase while typing
    else if (uppercaseFields.includes(name)) {
      setFormData(prev => ({
        ...prev,
        [name]: value.toUpperCase()
      }));
    }
    // For freeform fields and all others
    else {
      if (freeformFields.includes(name)) {
        console.log(`Processing freeform field: ${name}`);
      }
      
      setFormData(prev => ({
        ...prev,
        [name]: value
      }));
    }
  };
{/* Part 2 End - Effects and Input Handling */}

{/* Part 3 Start - Submit Handler */}
  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const processedData = {
        ...formData,
        // String capitalizations
        manufacturer: capitalizeWords(formData.manufacturer),
        model: capitalizeWords(formData.model),
        released: capitalizeWords(formData.released),
        protection: capitalizeWords(formData.protection),
        os: capitalizeWords(formData.os),
        chipset: capitalizeWords(formData.chipset),
        cpu: capitalizeWords(formData.cpu),
        gpu: capitalizeWords(formData.gpu),
        // Ensure display is uppercase
        display: formData.display?.toUpperCase() || '',
        
        // Numeric conversions
        chipset_extra: processNumericValue(formData.chipset_extra),
        battery: processNumericValue(formData.battery),
        wiredCharging: processNumericValue(formData.wiredCharging),
        wirelessCharging: processNumericValue(formData.wirelessCharging),
        weight: processNumericValue(formData.weight),
        resolution_extra: processNumericValue(formData.resolution_extra),
        resolution_extra2: processNumericValue(formData.resolution_extra2),

        // Array processing for storage and RAM
        storage: formData.storage
          ? formData.storage.split(',').map(item => item.trim()).filter(item => item !== '')
          : [],
        
        storage_extra: formData.storage_extra
          ? formData.storage_extra.split(',').map(item => item.trim()).filter(item => item !== '')
          : [],

        // Array processing for colors
        colors: formData.colors
          ? formData.colors.split(',').map(color => color.trim()).filter(color => color !== '').map(color => capitalizeWords(color))
          : [],
          
        // NEW: Include exclude from summary boolean
        excludeFromSummary: formData.excludeFromSummary
      };
  
      if (isEditing && editId) {
        // Update existing document
        const phoneRef = doc(db, 'phones', editId);
        await updateDoc(phoneRef, processedData);
        console.log("Document updated with ID: ", editId);
      } else {
        // Add new document
        const docRef = await addDoc(collection(db, 'phones'), processedData);
        console.log("Document written with ID: ", docRef.id);
      }
      
      // Clear form after successful submission
      setFormData({
        manufacturer: "",
        model: "",
        released: "",
        weight: "",   
        display: "",
        resolution: "",
        resolution_extra: "",
        resolution_extra2: "", 
        protection: "",
        os: "",
        chipset: "",
        chipset_extra: "",
        cpu: "",
        gpu: "",
        storage: "",
        storage_extra: "",
        rearCamera: "",
        frontCamera: "",
        battery: "",
        wiredCharging: "",
        wirelessCharging: "",
        colors: "",
        excludeFromSummary: false // NEW: Reset exclude checkbox
      });
      
      // Reset edit state
      setIsEditing(false);
      setEditId(null);
      clearPhoneToEdit();
  
      alert(`Phone ${isEditing ? 'updated' : 'added'} successfully!`);
    } catch (error) {
      console.error("Error adding/updating document: ", error);
      alert(`Error ${isEditing ? 'updating' : 'adding'} phone. Please try again.`);
    }
  };
{/* Part 3 End - Submit Handler */}

{/* Part 4 Start - Cancel Handler and Render Start */}
  // Handle cancel edit
  const handleCancel = () => {
    // Clear form and exit edit mode
    setFormData({
      manufacturer: "",
      model: "",
      released: "",
      weight: "",   
      display: "",
      resolution: "",
      resolution_extra: "",
      resolution_extra2: "", 
      protection: "",
      os: "",
      chipset: "",
      chipset_extra: "",
      cpu: "",
      gpu: "",
      storage: "",
      storage_extra: "",
      rearCamera: "",
      frontCamera: "",
      battery: "",
      wiredCharging: "",
      wirelessCharging: "",
      colors: "",
      excludeFromSummary: false // NEW: Reset exclude checkbox
    });
    
    setIsEditing(false);
    setEditId(null);
    clearPhoneToEdit();
  };

  return (
    <div className="min-h-screen bg-white p-4">
      <form onSubmit={handleSubmit}>
        <Card className="w-full max-w-[640px] mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
          <CardHeader className="bg-[rgb(52,69,157)] py-3">
            <CardTitle className="text-2xl text-white">
              {isEditing ? 'Edit Phone' : 'Add New Phone'}
            </CardTitle>
          </CardHeader>

          <CardContent className="bg-white p-4 space-y-4">
            {/* Device Info Section */}
            <div className="space-y-1">
              <div className="flex items-center gap-2">
                <Smartphone className="w-6 h-6 text-[rgb(52,69,157)]" />
                <h3 className="text-xl font-semibold">Device Info</h3>
              </div>
              <div>
                <InputField label="Manufacturer" name="manufacturer" value={formData.manufacturer} onChange={handleInputChange} />
                <InputField label="Model" name="model" value={formData.model} onChange={handleInputChange} />
                <InputField label="Release Date" name="released" value={formData.released} onChange={handleInputChange} />
                <InputField label="Weigh (grams)" name="weight" value={formData.weight} onChange={handleInputChange} />                
              </div>
            </div>

            {/* Display Section */}
            <div className="space-y-1">
              <div className="flex items-center gap-2">
                <Monitor className="w-6 h-6 text-[rgb(52,69,157)]" />
                <h3 className="text-xl font-semibold">Display</h3>
              </div>
              <div>
                <InputFieldWithTwoExtras 
                  label="Resolution" 
                  name="resolution" 
                  value={formData.resolution} 
                  extraValue={formData.resolution_extra}
                  extraValue2={formData.resolution_extra2}
                  extraPlaceholder="Refresh Rate"
                  extraPlaceholder2="PPI"
                  onChange={handleInputChange} 
                />
                <InputField label="Type" name="display" value={formData.display} onChange={handleInputChange} />
                <InputField label="Protection" name="protection" value={formData.protection} onChange={handleInputChange} />
              </div>
            </div>

            {/* Performance Section */}
            <div className="space-y-1">
              <div className="flex items-center gap-2">
                <Cpu className="w-6 h-6 text-[rgb(52,69,157)]" />
                <h3 className="text-xl font-semibold">Performance</h3>
              </div>
              <div>
                <InputField label="OS" name="os" value={formData.os} onChange={handleInputChange} />
                <InputFieldWithExtra 
                  label="Chipset" 
                  name="chipset" 
                  value={formData.chipset} 
                  extraValue={formData.chipset_extra}
                  extraPlaceholder="Benchmark"
                  onChange={handleInputChange} 
                />
                <InputField label="CPU" name="cpu" value={formData.cpu} onChange={handleInputChange} />
                <InputField label="GPU" name="gpu" value={formData.gpu} onChange={handleInputChange} />
                
                {/* Custom RAM & Storage field with equal widths and reversed order */}
                <div className="flex items-center py-0.5">
                  <p className="text-[rgb(52,69,157)] w-40 text-base">RAM & Storage:</p>
                  <div className="flex-1 flex gap-2">
                    <div className="w-1/2">
                      <input
                        type="text"
                        name="storage_extra"
                        value={formData.storage_extra || ''}
                        onChange={handleInputChange}
                        className="text-base w-full border rounded px-2 py-1"
                        placeholder="RAM"
                      />
                    </div>
                    <div className="w-1/2">
                      <input
                        type="text"
                        name="storage"
                        value={formData.storage || ''}
                        onChange={handleInputChange}
                        className="text-base w-full border rounded px-2 py-1"
                        placeholder="Storage"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
{/* Part 4 End - Cancel Handler and Render Start */}

{/* Part 5 Start - Render Complete with Checkbox */}
            {/* Camera Section */}
            <div className="space-y-1">
              <div className="flex items-center gap-2">
                <Camera className="w-6 h-6 text-[rgb(52,69,157)]" />
                <h3 className="text-xl font-semibold">Camera</h3>
              </div>
              <div>
                <InputField label="Rear Camera" name="rearCamera" value={formData.rearCamera} onChange={handleInputChange} />
                <InputField label="Front Camera" name="frontCamera" value={formData.frontCamera} onChange={handleInputChange} />
              </div>
            </div>

            {/* Battery Section */}
            <div className="space-y-1">
              <div className="flex items-center gap-2">
                <Battery className="w-6 h-6 text-[rgb(52,69,157)]" />
                <h3 className="text-xl font-semibold">Battery</h3>
              </div>
              <div>
                <InputField label="Capacity" name="battery" value={formData.battery} onChange={handleInputChange} />
                <InputField label="Wired Charging" name="wiredCharging" value={formData.wiredCharging} onChange={handleInputChange} />
                <InputField label="Wireless Charging" name="wirelessCharging" value={formData.wirelessCharging} onChange={handleInputChange} />
              </div>
            </div>

            {/* Colors Section */}
            <div className="space-y-1">
              <div className="flex items-center gap-2">
                <Palette className="w-6 h-6 text-[rgb(52,69,157)]" />
                <h3 className="text-xl font-semibold">Available Colors</h3>
              </div>
              <div>
                <InputField 
                  label="Colors" 
                  name="colors" 
                  value={formData.colors} 
                  onChange={handleInputChange}
                  placeholder="Enter colors separated by commas"
                />
              </div>
            </div>

            {/* NEW: Exclude from Summary Section */}
            <div className="space-y-1 pt-4 border-t border-gray-300">
              <h3 className="text-xl font-semibold text-[rgb(52,69,157)]">Summary Settings</h3>
              <div className="flex items-center py-2">
                <div className="flex items-center">
                  <input
                    type="checkbox"
                    id="excludeFromSummary"
                    name="excludeFromSummary"
                    checked={formData.excludeFromSummary}
                    onChange={handleInputChange}
                    className="w-4 h-4 text-[rgb(52,69,157)] bg-gray-100 border-gray-300 rounded focus:ring-[rgb(52,69,157)] focus:ring-2"
                  />
                  <label 
                    htmlFor="excludeFromSummary" 
                    className="ml-2 text-base text-gray-700"
                  >
                    Exclude this model from Inventory Summary
                  </label>
                </div>
              </div>
              <div className="text-sm text-gray-500 ml-6">
                When checked, this phone model will not appear in the Inventory Summary reports and calculations.
              </div>
            </div>

            <div className="pt-4 flex gap-3">
              {isEditing && (
                <button
                  type="button"
                  onClick={handleCancel}
                  className="w-1/3 py-2 bg-gray-400 text-white rounded hover:bg-gray-500"
                >
                  Cancel
                </button>
              )}
              <button
                type="submit"
                className={`${isEditing ? 'w-2/3' : 'w-full'} py-2 bg-[rgb(52,69,157)] text-white rounded hover:bg-[rgb(52,69,157)]/90`}
              >
                {isEditing ? 'Update Phone' : 'Save Phone'}
              </button>
            </div>
          </CardContent>
        </Card>
      </form>
    </div>
  );
};

export default PhoneSpecForm;
{/* Part 5 End - Render Complete with Checkbox */}
</file>

<file path="src/components/PriceManagementForm.jsx">
{/* Part 1 Start - Complete File: Imports, State, and Helper Functions */}
import React, { useState, useEffect, useCallback } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { collection, getDocs, doc, setDoc, writeBatch, query, where } from 'firebase/firestore';
import { db } from '../firebase/config';
import { 
  Smartphone, 
  RefreshCw, 
  Filter, 
  X,
  Edit,
  Save,
  XCircle,
  CircleAlert  // NEW: Added for exclusion info display
} from 'lucide-react';
import { getCurrentDate } from './phone-selection/utils/phoneUtils';

const PriceManagementForm = () => {
  // State for grouped phone data
  const [phoneData, setPhoneData] = useState([]);
  const [filteredData, setFilteredData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  
  // State for expanded rows and color sections
  const [expandedRows, setExpandedRows] = useState(new Set());
  
  // State for editing
  const [editingBasePrice, setEditingBasePrice] = useState(null);
  const [editingColorPrice, setEditingColorPrice] = useState(null);
  const [editFormData, setEditFormData] = useState({
    dealersPrice: '',
    retailPrice: ''
  });
  const [savingPriceId, setSavingPriceId] = useState(null);
  
  // Force re-render state
  const [forceUpdate, setForceUpdate] = useState(0);
  
  // NEW: Add state for excluded models info
  const [excludedModelsInfo, setExcludedModelsInfo] = useState([]);
  
  // Filter states
  const [showFilters, setShowFilters] = useState(false);
  const [filters, setFilters] = useState({
    manufacturer: '',
    model: '',
    ram: '',
    storage: ''
  });
  
  // Filter options
  const [filterOptions, setFilterOptions] = useState({
    manufacturers: [],
    models: [],
    rams: [],
    storages: []
  });
  
  // Filtered options based on selections
  const [filteredOptions, setFilteredOptions] = useState({
    models: [],
    rams: [],
    storages: []
  });

  // NEW: Add this function to fetch excluded models info for display
  const fetchExcludedModelsInfo = async () => {
    try {
      const phonesRef = collection(db, 'phones');
      const phonesSnapshot = await getDocs(phonesRef);
      
      const excludedList = [];
      phonesSnapshot.forEach(doc => {
        const phoneData = doc.data();
        if (phoneData.excludeFromSummary === true && phoneData.manufacturer && phoneData.model) {
          excludedList.push({
            manufacturer: phoneData.manufacturer,
            model: phoneData.model
          });
        }
      });
      
      setExcludedModelsInfo(excludedList.sort((a, b) => {
        if (a.manufacturer !== b.manufacturer) {
          return a.manufacturer.localeCompare(b.manufacturer);
        }
        return a.model.localeCompare(b.model);
      }));
    } catch (error) {
      console.error("Error fetching excluded models info:", error);
    }
  };

  // Utility functions
  const formatPrice = (price) => {
    if (!price && price !== 0) return 'N/A';
    return `${price.toLocaleString()}`;
  };

  const formatNumberWithCommas = (value) => {
    if (!value && value !== 0) return '';
    return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  };

  const parsePrice = (value) => {
    if (!value) return 0;
    return parseFloat(value.toString().replace(/,/g, '')) || 0;
  };

  const calculateMargin = (dealersPrice, retailPrice) => {
    if (!dealersPrice || !retailPrice) return 'N/A';
    const costPrice = typeof dealersPrice === 'string' ? parseFloat(dealersPrice.replace(/[^\d.-]/g, '')) : dealersPrice;
    const sellPrice = typeof retailPrice === 'string' ? parseFloat(retailPrice.replace(/[^\d.-]/g, '')) : retailPrice;
    if (costPrice <= 0) return 'N/A';
    const marginAmount = sellPrice - costPrice;
    const marginPercentage = (marginAmount / costPrice) * 100;
    return `${marginPercentage.toFixed(2)}%`;
  };

  const formatWithGB = (value) => {
    if (!value) return 'N/A';
    if (value.includes('GB') || value.includes('TB') || value.includes('gb') || value.includes('tb')) {
      return value;
    }
    return `${value}GB`;
  };

  // Toggle row expansion
  const toggleRowExpansion = (index) => {
    const newExpandedRows = new Set(expandedRows);
    if (newExpandedRows.has(index)) {
      newExpandedRows.delete(index);
    } else {
      newExpandedRows.add(index);
    }
    setExpandedRows(newExpandedRows);
  };

  // Helper function to save/update price configurations
  const updatePriceConfiguration = async (manufacturer, model, ram, storage, dealersPrice, retailPrice, color = null) => {
    try {
      let configId;
      if (color) {
        configId = `${manufacturer}_${model}_${ram}_${storage}_${color}`.replace(/\s+/g, '_').toLowerCase();
      } else {
        configId = `${manufacturer}_${model}_${ram}_${storage}`.replace(/\s+/g, '_').toLowerCase();
      }
      
      const dPrice = parseFloat(dealersPrice.toString().replace(/,/g, '')) || 0;
      const rPrice = parseFloat(retailPrice.toString().replace(/,/g, '')) || 0;
      
      await setDoc(doc(db, 'price_configurations', configId), {
        manufacturer,
        model,
        ram,
        storage,
        color,
        dealersPrice: dPrice,
        retailPrice: rPrice,
        lastUpdated: getCurrentDate()
      }, { merge: true });
      
      return true;
    } catch (error) {
      console.error("Error updating price configuration:", error);
      return false;
    }
  };
{/* Part 1 End - Complete File: Imports, State, and Helper Functions */}

{/* Part 2 Start - Filter Handling Functions */}
  // Handle filter change
  const handleFilterChange = (e) => {
    const { name, value } = e.target;
    setFilters(prev => ({
      ...prev,
      [name]: value
    }));
  };

  // Clear all filters
  const clearFilters = () => {
    setFilters({
      manufacturer: '',
      model: '',
      ram: '',
      storage: ''
    });
    setFilteredOptions({
      models: filterOptions.models,
      rams: filterOptions.rams,
      storages: filterOptions.storages
    });
  };

  // Apply filters to data
  const applyFilters = useCallback(() => {
    if (!phoneData.length) return;
    const filtered = phoneData.filter(item => {
      if (filters.manufacturer && item.manufacturer !== filters.manufacturer) return false;
      if (filters.model && item.model !== filters.model) return false;
      if (filters.ram && item.ram !== filters.ram) return false;
      if (filters.storage && item.storage !== filters.storage) return false;
      return true;
    });
    setFilteredData(filtered);
  }, [phoneData, filters]);

  // Update filtered options based on current selections
  const updateFilteredOptions = useCallback(() => {
    if (!phoneData.length) return;
    
    let filteredModels = filterOptions.models;
    let filteredRams = filterOptions.rams;
    let filteredStorages = filterOptions.storages;
    
    if (filters.manufacturer) {
      filteredModels = [...new Set(
        phoneData
          .filter(item => item.manufacturer === filters.manufacturer)
          .map(item => item.model)
      )].sort();
    }
    
    if (filters.manufacturer || filters.model) {
      let filtered = phoneData;
      if (filters.manufacturer) {
        filtered = filtered.filter(item => item.manufacturer === filters.manufacturer);
      }
      if (filters.model) {
        filtered = filtered.filter(item => item.model === filters.model);
      }
      filteredRams = [...new Set(filtered.map(item => item.ram))].sort();
    }
    
    if (filters.manufacturer || filters.model || filters.ram) {
      let filtered = phoneData;
      if (filters.manufacturer) {
        filtered = filtered.filter(item => item.manufacturer === filters.manufacturer);
      }
      if (filters.model) {
        filtered = filtered.filter(item => item.model === filters.model);
      }
      if (filters.ram) {
        filtered = filtered.filter(item => item.ram === filters.ram);
      }
      filteredStorages = [...new Set(filtered.map(item => item.storage))].sort();
    }
    
    setFilteredOptions({
      models: filteredModels,
      rams: filteredRams,
      storages: filteredStorages
    });
  }, [phoneData, filters, filterOptions]);
{/* Part 2 End - Filter Handling Functions */}

{/* Part 3 Start - Edit Handling Functions */}
  // Handle edit base price
  const handleEditBasePrice = (item, index) => {
    setEditingBasePrice(index);
    setEditingColorPrice(null);
    setEditFormData({
      dealersPrice: formatNumberWithCommas(item.baseDealersPrice.toString()),
      retailPrice: formatNumberWithCommas(item.baseRetailPrice.toString())
    });
  };

  // Handle edit color price
  const handleEditColorPrice = (item, colorData, rowIndex, colorIndex) => {
    setEditingColorPrice(`${rowIndex}_${colorIndex}`);
    setEditingBasePrice(null);
    setEditFormData({
      dealersPrice: formatNumberWithCommas(colorData.dealersPrice.toString()),
      retailPrice: formatNumberWithCommas(colorData.retailPrice.toString())
    });
  };

  // Handle cancel edit
  const handleCancelEdit = () => {
    setEditingBasePrice(null);
    setEditingColorPrice(null);
    setEditFormData({
      dealersPrice: '',
      retailPrice: ''
    });
  };

  // Handle form input change
  const handleEditInputChange = (e) => {
    const { name, value } = e.target;
    
    let formattedValue = value;
    if (name === 'dealersPrice' || name === 'retailPrice') {
      const cleanValue = value.replace(/[^\d.]/g, '');
      formattedValue = formatNumberWithCommas(cleanValue);
    }
    
    setEditFormData(prev => ({
      ...prev,
      [name]: formattedValue
    }));
  };
{/* Part 3 End - Edit Handling Functions */}

{/* Part 4 Start - Save Price Functions */}
  // Save base price changes - FORCE RE-RENDER VERSION
  const saveBasePrice = async (item, index) => {
    setSavingPriceId(`base_${index}`);
    
    try {
      const dealersPrice = parsePrice(editFormData.dealersPrice);
      const retailPrice = parsePrice(editFormData.retailPrice);
      
      // Update base configuration
      await updatePriceConfiguration(
        item.manufacturer,
        item.model,
        item.ram,
        item.storage,
        dealersPrice.toString(),
        retailPrice.toString()
      );
      
      // Update ALL colors to use the new base pricing - regardless of whether they have specific configs
      const updatePromises = [];
      for (const colorData of item.colors) {
        updatePromises.push(
          updatePriceConfiguration(
            item.manufacturer,
            item.model,
            item.ram,
            item.storage,
            dealersPrice.toString(),
            retailPrice.toString(),
            colorData.color
          )
        );
      }
      await Promise.all(updatePromises);
      
      // Update ALL existing inventory items for this configuration - all colors
      const inventoryQuery = query(
        collection(db, 'inventory'),
        where("manufacturer", "==", item.manufacturer),
        where("model", "==", item.model),
        where("ram", "==", item.ram),
        where("storage", "==", item.storage)
      );
      
      const inventorySnap = await getDocs(inventoryQuery);
      
      if (!inventorySnap.empty) {
        const batch = writeBatch(db);
        
        // Update ALL inventory items regardless of color
        inventorySnap.docs.forEach(docRef => {
          batch.update(docRef.ref, {
            dealersPrice: dealersPrice,
            retailPrice: retailPrice,
            lastUpdated: getCurrentDate()
          });
        });
        
        await batch.commit();
        console.log(`Updated ${inventorySnap.docs.length} inventory items with new base pricing (ALL colors)`);
      }
      
      // FORCE STATE UPDATE - Create completely new arrays with updated data
      const newPhoneData = [...phoneData];
      newPhoneData[index] = {
        ...newPhoneData[index],
        baseDealersPrice: dealersPrice,
        baseRetailPrice: retailPrice,
        colors: newPhoneData[index].colors.map(color => ({
          ...color,
          dealersPrice: dealersPrice,
          retailPrice: retailPrice,
          configId: color.configId || 'updated'
        }))
      };
      
      // Update phoneData with completely new array
      setPhoneData(newPhoneData);
      
      // Find and update the same item in filteredData
      const newFilteredData = [...filteredData];
      const filteredIndex = newFilteredData.findIndex(phone => 
        phone.manufacturer === item.manufacturer &&
        phone.model === item.model &&
        phone.ram === item.ram &&
        phone.storage === item.storage
      );
      
      if (filteredIndex !== -1) {
        newFilteredData[filteredIndex] = {
          ...newFilteredData[filteredIndex],
          baseDealersPrice: dealersPrice,
          baseRetailPrice: retailPrice,
          colors: newFilteredData[filteredIndex].colors.map(color => ({
            ...color,
            dealersPrice: dealersPrice,
            retailPrice: retailPrice,
            configId: color.configId || 'updated'
          }))
        };
      }
      
      // Update filteredData with completely new array
      setFilteredData(newFilteredData);
      
      // Force component re-render
      setForceUpdate(prev => prev + 1);
      
      // Clear editing state
      handleCancelEdit();
      setSavingPriceId(null);
      
      console.log(`Successfully updated base price for ${item.manufacturer} ${item.model} to ${dealersPrice.toLocaleString()} / ${retailPrice.toLocaleString()}`);
      
      alert(`Base pricing updated successfully! All colors have been updated to the new base price.`);
      
    } catch (error) {
      console.error("Error updating base price:", error);
      alert(`Error updating price: ${error.message}`);
      setSavingPriceId(null);
    }
  };

  // Save color-specific price changes - FORCE RE-RENDER VERSION
  const saveColorPrice = async (item, colorData, rowIndex, colorIndex) => {
    setSavingPriceId(`color_${rowIndex}_${colorIndex}`);
    
    try {
      const dealersPrice = parsePrice(editFormData.dealersPrice);
      const retailPrice = parsePrice(editFormData.retailPrice);
      
      // Update color-specific configuration
      await updatePriceConfiguration(
        item.manufacturer,
        item.model,
        item.ram,
        item.storage,
        dealersPrice.toString(),
        retailPrice.toString(),
        colorData.color
      );
      
      // Update all existing inventory items for THIS SPECIFIC COLOR ONLY
      const inventoryQuery = query(
        collection(db, 'inventory'),
        where("manufacturer", "==", item.manufacturer),
        where("model", "==", item.model),
        where("ram", "==", item.ram),
        where("storage", "==", item.storage),
        where("color", "==", colorData.color)
      );
      
      const inventorySnap = await getDocs(inventoryQuery);
      
      if (!inventorySnap.empty) {
        const batch = writeBatch(db);
        
        inventorySnap.docs.forEach(docRef => {
          batch.update(docRef.ref, {
            dealersPrice: dealersPrice,
            retailPrice: retailPrice,
            lastUpdated: getCurrentDate()
          });
        });
        
        await batch.commit();
        console.log(`Updated ${inventorySnap.docs.length} inventory items for color ${colorData.color}`);
      }
      
      // FORCE STATE UPDATE - Create completely new arrays with updated data
      const newPhoneData = [...phoneData];
      newPhoneData[rowIndex] = {
        ...newPhoneData[rowIndex],
        colors: newPhoneData[rowIndex].colors.map((color, ci) => {
          if (ci === colorIndex) {
            return {
              ...color,
              dealersPrice: dealersPrice,
              retailPrice: retailPrice,
              configId: color.configId || 'updated'
            };
          }
          return { ...color };
        })
      };
      
      // Update phoneData with completely new array
      setPhoneData(newPhoneData);
      
      // Find and update the same item in filteredData
      const newFilteredData = [...filteredData];
      const filteredIndex = newFilteredData.findIndex(phone => 
        phone.manufacturer === item.manufacturer &&
        phone.model === item.model &&
        phone.ram === item.ram &&
        phone.storage === item.storage
      );
      
      if (filteredIndex !== -1) {
        newFilteredData[filteredIndex] = {
          ...newFilteredData[filteredIndex],
          colors: newFilteredData[filteredIndex].colors.map((color, ci) => {
            if (ci === colorIndex) {
              return {
                ...color,
                dealersPrice: dealersPrice,
                retailPrice: retailPrice,
                configId: color.configId || 'updated'
              };
            }
            return { ...color };
          })
        };
      }
      
      // Update filteredData with completely new array
      setFilteredData(newFilteredData);
      
      // Force component re-render
      setForceUpdate(prev => prev + 1);
      
      // Clear editing state
      handleCancelEdit();
      setSavingPriceId(null);
      
      console.log(`Successfully updated color price for ${colorData.color} to ${dealersPrice.toLocaleString()} / ${retailPrice.toLocaleString()}`);
      
      alert(`Color-specific pricing updated successfully! Updated prices for ${colorData.color} only.`);
      
    } catch (error) {
      console.error("Error updating color price:", error);
      alert(`Error updating price: ${error.message}`);
      setSavingPriceId(null);
    }
  };
{/* Part 4 End - Save Price Functions */}

{/* Part 5 Start - Data Fetching Function with Exclusion Logic */}
  // UPDATED: Fetch and process phone data with exclusion logic
  const fetchPhoneData = useCallback(async () => {
    setLoading(true);
    setError(null);
    
    try {
      // NEW: First, get the list of excluded models from the phones collection
      const phonesRef = collection(db, 'phones');
      const phonesSnapshot = await getDocs(phonesRef);
      
      const excludedModels = new Set();
      phonesSnapshot.forEach(doc => {
        const phoneData = doc.data();
        // If excludeFromSummary is true, add the manufacturer_model combination to excluded set
        if (phoneData.excludeFromSummary === true && phoneData.manufacturer && phoneData.model) {
          const modelKey = `${phoneData.manufacturer}_${phoneData.model}`;
          excludedModels.add(modelKey);
          console.log(`Excluding model from price management: ${phoneData.manufacturer} ${phoneData.model}`);
        }
      });
      
      console.log(`Found ${excludedModels.size} excluded models:`, Array.from(excludedModels));
      
      // Fetch from price_configurations collection
      const configsRef = collection(db, 'price_configurations');
      const configsSnapshot = await getDocs(configsRef);
      
      // Fetch from inventory collection to get color information
      const inventoryRef = collection(db, 'inventory');
      const inventorySnapshot = await getDocs(inventoryRef);
      
      // Group price configurations by base configuration (without color)
      const groupedData = {};
      const manufacturers = new Set();
      const models = new Set();
      const rams = new Set();
      const storages = new Set();
      
      // Process price configurations
      configsSnapshot.forEach(doc => {
        const config = { id: doc.id, ...doc.data() };
        
        if (config.manufacturer && config.model && config.ram && config.storage) {
          // NEW: Check if this model should be excluded from price management
          const modelKey = `${config.manufacturer}_${config.model}`;
          if (excludedModels.has(modelKey)) {
            console.log(`Skipping excluded model from price management: ${config.manufacturer} ${config.model}`);
            return; // Skip this item
          }
          
          const baseKey = `${config.manufacturer}_${config.model}_${config.ram}_${config.storage}`;
          
          // Add to filter options
          manufacturers.add(config.manufacturer);
          models.add(config.model);
          rams.add(config.ram);
          storages.add(config.storage);
          
          if (!groupedData[baseKey]) {
            groupedData[baseKey] = {
              manufacturer: config.manufacturer,
              model: config.model,
              ram: config.ram,
              storage: config.storage,
              baseDealersPrice: 0,
              baseRetailPrice: 0,
              colors: {}
            };
          }
          
          if (config.color) {
            // Color-specific pricing
            groupedData[baseKey].colors[config.color] = {
              color: config.color,
              dealersPrice: config.dealersPrice || 0,
              retailPrice: config.retailPrice || 0,
              configId: config.id,
              lastUpdated: config.lastUpdated
            };
          } else {
            // Base pricing
            groupedData[baseKey].baseDealersPrice = config.dealersPrice || 0;
            groupedData[baseKey].baseRetailPrice = config.retailPrice || 0;
            groupedData[baseKey].baseConfigId = config.id;
            groupedData[baseKey].lastUpdated = config.lastUpdated;
          }
        }
      });
      
      // Get all available colors from inventory for each base configuration
      const inventoryColors = {};
      inventorySnapshot.forEach(doc => {
        const item = doc.data();
        if (item.manufacturer && item.model && item.ram && item.storage && item.color) {
          // NEW: Check if this model should be excluded
          const modelKey = `${item.manufacturer}_${item.model}`;
          if (excludedModels.has(modelKey)) {
            return; // Skip this item
          }
          
          const baseKey = `${item.manufacturer}_${item.model}_${item.ram}_${item.storage}`;
          if (!inventoryColors[baseKey]) {
            inventoryColors[baseKey] = new Set();
          }
          inventoryColors[baseKey].add(item.color);
        }
      });
      
      // Ensure all colors have entries (even if no specific pricing exists)
      Object.keys(groupedData).forEach(baseKey => {
        const colors = inventoryColors[baseKey] || new Set();
        colors.forEach(color => {
          if (!groupedData[baseKey].colors[color]) {
            // Use base pricing if no color-specific pricing exists
            groupedData[baseKey].colors[color] = {
              color: color,
              dealersPrice: groupedData[baseKey].baseDealersPrice,
              retailPrice: groupedData[baseKey].baseRetailPrice,
              configId: null, // No specific config for this color yet
              lastUpdated: groupedData[baseKey].lastUpdated
            };
          }
        });
      });
      
      // Convert to array and sort colors
      Object.values(groupedData).forEach(group => {
        group.colors = Object.values(group.colors).sort((a, b) => a.color.localeCompare(b.color));
      });
      
      const phoneArray = Object.values(groupedData).sort((a, b) => {
        if (a.manufacturer !== b.manufacturer) {
          return a.manufacturer.localeCompare(b.manufacturer);
        }
        if (a.model !== b.model) {
          return a.model.localeCompare(b.model);
        }
        if (a.ram !== b.ram) {
          return a.ram.localeCompare(b.ram);
        }
        return a.storage.localeCompare(b.storage);
      });
      
      const filterOpts = {
        manufacturers: [...manufacturers].sort(),
        models: [...models].sort(),
        rams: [...rams].sort(),
        storages: [...storages].sort()
      };
      
      setFilterOptions(filterOpts);
      setFilteredOptions({
        models: filterOpts.models,
        rams: filterOpts.rams,
        storages: filterOpts.storages
      });
      
      setPhoneData(phoneArray);
      setFilteredData(phoneArray);
      setLoading(false);
      
      // NEW: Log summary of excluded models for debugging
      console.log(`Price Management loaded: ${phoneArray.length} configurations (${excludedModels.size} models excluded)`);
      
    } catch (err) {
      console.error("Error fetching phone data:", err);
      setError(`Error fetching phone data: ${err.message}`);
      setLoading(false);
    }
  }, []);
{/* Part 5 End - Data Fetching Function with Exclusion Logic */}

{/* Part 6 Start - Effects and Loading States */}
  // UPDATED: Effects to include fetchExcludedModelsInfo
  useEffect(() => {
    fetchPhoneData();
    fetchExcludedModelsInfo(); // NEW: Add this line
  }, [fetchPhoneData]);
  
  useEffect(() => {
    updateFilteredOptions();
  }, [updateFilteredOptions]);
  
  useEffect(() => {
    applyFilters();
  }, [applyFilters]);

  // Loading state
  if (loading) {
    return (
      <div className="min-h-screen bg-white p-4">
        <Card className="w-full max-w-[1400px] mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
          <CardHeader className="bg-[rgb(52,69,157)] py-3">
            <CardTitle className="text-2xl text-white">Price Management</CardTitle>
          </CardHeader>
          <CardContent className="p-4">
            <div className="text-center py-12">
              <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[rgb(52,69,157)]"></div>
              <p className="mt-2 text-gray-600">Loading phone pricing data...</p>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Error state
  if (error) {
    return (
      <div className="min-h-screen bg-white p-4">
        <Card className="w-full max-w-[1400px] mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
          <CardHeader className="bg-red-600 py-3">
            <CardTitle className="text-2xl text-white">Error</CardTitle>
          </CardHeader>
          <CardContent className="p-4">
            <p className="text-red-600">{error}</p>
            <button 
              onClick={fetchPhoneData}
              className="mt-4 px-4 py-2 bg-[rgb(52,69,157)] text-white rounded"
            >
              Try Again
            </button>
          </CardContent>
        </Card>
      </div>
    );
  }

  {/* Part 7 Start - Main Render Header and Filters */}
  return (
    <div className="min-h-screen bg-white p-4">
      <Card className="w-full max-w-[1400px] mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
        <CardHeader className="bg-[rgb(52,69,157)] py-3 flex flex-row justify-between items-center">
          <div className="flex items-center gap-2">
            <Smartphone className="h-6 w-6 text-white" />
            <CardTitle className="text-2xl text-white">Price Management</CardTitle>
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => setShowFilters(!showFilters)}
              className={`flex items-center gap-1 ${showFilters ? 'bg-white/20 text-white' : 'bg-white text-[rgb(52,69,157)]'} px-4 py-2 rounded text-base font-medium`}
            >
              <Filter className="h-5 w-5 mr-1" />
              <span>Filters</span>
            </button>
            <button
              onClick={fetchPhoneData}
              className="flex items-center gap-1 bg-white text-[rgb(52,69,157)] px-4 py-2 rounded text-base font-medium"
            >
              <RefreshCw className="h-5 w-5 mr-1" />
              <span>Refresh</span>
            </button>
          </div>
        </CardHeader>

        {/* Filter Panel */}
        {showFilters && (
          <div className="bg-gray-50 px-4 py-4 border-b">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-lg text-[rgb(52,69,157)]">Filters</h3>
              <button 
                onClick={clearFilters}
                className="text-gray-500 hover:text-red-500 flex items-center"
              >
                <X className="h-4 w-4 mr-1" />
                Clear Filters
              </button>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Manufacturer</label>
                <select name="manufacturer" value={filters.manufacturer} onChange={handleFilterChange} className="w-full p-2 border rounded">
                  <option value="">All Manufacturers</option>
                  {filterOptions.manufacturers.map(manufacturer => (
                    <option key={manufacturer} value={manufacturer}>{manufacturer}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Model</label>
                <select name="model" value={filters.model} onChange={handleFilterChange} className="w-full p-2 border rounded">
                  <option value="">All Models</option>
                  {filteredOptions.models.map(model => (
                    <option key={model} value={model}>{model}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">RAM</label>
                <select name="ram" value={filters.ram} onChange={handleFilterChange} className="w-full p-2 border rounded">
                  <option value="">All RAM</option>
                  {filteredOptions.rams.map(ram => (
                    <option key={ram} value={ram}>{ram}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Storage</label>
                <select name="storage" value={filters.storage} onChange={handleFilterChange} className="w-full p-2 border rounded">
                  <option value="">All Storage</option>
                  {filteredOptions.storages.map(storage => (
                    <option key={storage} value={storage}>{storage}</option>
                  ))}
                </select>
              </div>
            </div>
            
            {/* Active filters summary */}
            {Object.values(filters).some(filter => filter !== '') && (
              <div className="mt-4 flex flex-wrap gap-2">
                {Object.entries(filters).map(([key, value]) => 
                  value && (
                    <div key={key} className="bg-gray-200 rounded-full px-3 py-1 text-sm flex items-center">
                      <span className="font-medium capitalize">{key}:</span>
                      <span className="ml-1">{value}</span>
                      <button 
                        onClick={() => setFilters(prev => ({ ...prev, [key]: '' }))}
                        className="ml-2 text-gray-500 hover:text-gray-700"
                      >
                        <X className="h-3 w-3" />
                      </button>
                    </div>
                  )
                )}
              </div>
            )}
          </div>
        )}

        {/* NEW: Add Excluded Models Info Display */}
        <CardContent className="p-4">
          {excludedModelsInfo.length > 0 && (
            <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
              <div className="flex items-center gap-2 mb-2">
                <CircleAlert className="h-5 w-5 text-yellow-600" />
                <h4 className="font-medium text-yellow-800">
                  Excluded Models ({excludedModelsInfo.length})
                </h4>
              </div>
              <div className="text-sm text-yellow-700">
                The following models are excluded from price management:
              </div>
              <div className="mt-2 flex flex-wrap gap-2">
                {excludedModelsInfo.map((model, index) => (
                  <span 
                    key={index}
                    className="inline-block px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded"
                  >
                    {model.manufacturer} {model.model}
                  </span>
                ))}
              </div>
            </div>
          )}
{/* Part 7 End - Main Render Header and Filters */}

{/* Part 8 Start - Main Table Content */}
          {filteredData.length === 0 ? (
            <div className="text-center py-12 bg-gray-50 rounded-lg border border-dashed border-gray-300">
              <Smartphone className="h-12 w-12 text-gray-400 mx-auto mb-4" />
              <h3 className="text-lg font-medium text-gray-700 mb-2">No pricing data found</h3>
              {Object.values(filters).some(f => f) ? (
                <>
                  <p className="text-gray-500 mb-4">No items match your current filters.</p>
                  <button onClick={clearFilters} className="px-4 py-2 bg-[rgb(52,69,157)] text-white rounded-md">
                    Clear Filters
                  </button>
                </>
              ) : (
                <p className="text-gray-500">There are no price configurations in the database.</p>
              )}
            </div>
          ) : (
            <div className="space-y-4">
              {/* Main table */}
              <div className="bg-white border rounded-lg overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr className="text-xs font-semibold text-gray-700 uppercase tracking-wider">
                      <th className="px-3 py-3 text-left">Manufacturer</th>
                      <th className="px-3 py-3 text-left">Model</th>
                      <th className="px-3 py-3 text-left">RAM</th>
                      <th className="px-3 py-3 text-left">Storage</th>
                      <th className="px-3 py-3 text-left">Colors</th>
                      <th className="pl-0 pr-1 py-3 text-right">{"Dealer's Price"}</th>
                      <th className="px-1 py-3 text-right">Retail Price</th>
                      <th className="px-1 py-3 text-right">Margin</th>
                      <th className="px-1 py-3 text-center">Action</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {filteredData.map((item, index) => (
                      <React.Fragment key={`${item.manufacturer}_${item.model}_${item.ram}_${item.storage}_${forceUpdate}_${index}`}>
                        {/* Main row - show actual colors instead of "Multiple Colors" */}
                        <tr 
                          className={`hover:bg-gray-100 cursor-pointer ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}
                          onClick={() => toggleRowExpansion(index)}
                        >
                          <td className="px-3 py-3 text-sm">{item.manufacturer}</td>
                          <td className="px-3 py-3 text-sm font-medium">{item.model}</td>
                          <td className="px-3 py-3 text-sm">{formatWithGB(item.ram)}</td>
                          <td className="px-3 py-3 text-sm">{formatWithGB(item.storage)}</td>
                          <td className="px-3 py-3 text-sm">
                            <div className="flex flex-wrap gap-1">
                              {item.colors.slice(0, 3).map((colorData, colorIndex) => (
                                <span 
                                  key={colorIndex} 
                                  className="inline-block px-2 py-1 text-xs bg-gray-100 rounded"
                                >
                                  {colorData.color}
                                </span>
                              ))}
                              {item.colors.length > 3 && (
                                <span className="inline-block px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">
                                  +{item.colors.length - 3} more
                                </span>
                              )}
                            </div>
                          </td>
                          <td className="pl-0 pr-1 py-3 text-sm text-right">
                            {editingBasePrice === index ? (
                              <input
                                type="text"
                                name="dealersPrice"
                                value={editFormData.dealersPrice}
                                onChange={handleEditInputChange}
                                className="w-20 p-1 border rounded text-right"
                                onClick={(e) => e.stopPropagation()}
                              />
                            ) : (
                              formatPrice(item.baseDealersPrice)
                            )}
                          </td>
                          <td className="px-1 py-3 text-sm text-right">
                            {editingBasePrice === index ? (
                              <input
                                type="text"
                                name="retailPrice"
                                value={editFormData.retailPrice}
                                onChange={handleEditInputChange}
                                className="w-20 p-1 border rounded text-right"
                                onClick={(e) => e.stopPropagation()}
                              />
                            ) : (
                              formatPrice(item.baseRetailPrice)
                            )}
                          </td>
                          <td className="px-1 py-3 text-sm text-right font-medium">
                            {editingBasePrice === index 
                              ? calculateMargin(editFormData.dealersPrice, editFormData.retailPrice)
                              : calculateMargin(item.baseDealersPrice, item.baseRetailPrice)
                            }
                          </td>
                          <td className="px-1 py-3 text-sm text-center">
                            {editingBasePrice === index ? (
                              <div className="flex justify-center space-x-1">
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    saveBasePrice(item, index);
                                  }}
                                  disabled={savingPriceId === `base_${index}`}
                                  className="p-1 text-green-600 hover:text-green-800"
                                  title="Save changes"
                                >
                                  {savingPriceId === `base_${index}` ? (
                                    <RefreshCw className="h-4 w-4 animate-spin" />
                                  ) : (
                                    <Save className="h-4 w-4" />
                                  )}
                                </button>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    handleCancelEdit();
                                  }}
                                  className="p-1 text-red-600 hover:text-red-800"
                                  title="Cancel edit"
                                >
                                  <XCircle className="h-4 w-4" />
                                </button>
                              </div>
                            ) : (
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleEditBasePrice(item, index);
                                }}
                                className="p-1 text-blue-600 hover:text-blue-800"
                                title="Edit base price"
                              >
                                <Edit className="h-4 w-4" />
                              </button>
                            )}
                          </td>
                        </tr>
{/* Part 8 End - Main Table Content */}

{/* Part 9 Start - Expanded Color Rows and Footer */}
                        {/* Expanded color breakdown - EACH COLOR GETS ITS OWN SIMPLE ROW */}
                        {expandedRows.has(index) && 
                          item.colors.map((colorData, colorIndex) => (
                            <tr key={`color-${index}-${colorIndex}`} className="bg-gray-50">
                              <td className="px-3 py-3 text-sm text-gray-600">
                                <span className="ml-4">{colorData.color}</span>
                              </td>
                              <td className="px-3 py-3 text-sm text-gray-600">-</td>
                              <td className="px-3 py-3 text-sm text-gray-600">-</td>
                              <td className="px-3 py-3 text-sm text-gray-600">-</td>
                              <td className="px-3 py-3 text-sm">
                                {colorData.dealersPrice !== item.baseDealersPrice || 
                                 colorData.retailPrice !== item.baseRetailPrice ? (
                                  <span className="text-xs text-white bg-orange-500 px-2 py-1 rounded">
                                    Custom Price
                                  </span>
                                ) : null}
                              </td>
                              <td className="pl-0 pr-1 py-3 text-sm text-right">
                                {editingColorPrice === `${index}_${colorIndex}` ? (
                                  <input
                                    type="text"
                                    name="dealersPrice"
                                    value={editFormData.dealersPrice}
                                    onChange={handleEditInputChange}
                                    className="w-20 p-1 border rounded text-right"
                                    onClick={(e) => e.stopPropagation()}
                                  />
                                ) : (
                                  formatPrice(colorData.dealersPrice)
                                )}
                              </td>
                              <td className="px-1 py-3 text-sm text-right">
                                {editingColorPrice === `${index}_${colorIndex}` ? (
                                  <input
                                    type="text"
                                    name="retailPrice"
                                    value={editFormData.retailPrice}
                                    onChange={handleEditInputChange}
                                    className="w-20 p-1 border rounded text-right"
                                    onClick={(e) => e.stopPropagation()}
                                  />
                                ) : (
                                  formatPrice(colorData.retailPrice)
                                )}
                              </td>
                              <td className="px-1 py-3 text-sm text-right font-medium">
                                {editingColorPrice === `${index}_${colorIndex}` 
                                  ? calculateMargin(editFormData.dealersPrice, editFormData.retailPrice)
                                  : calculateMargin(colorData.dealersPrice, colorData.retailPrice)
                                }
                              </td>
                              <td className="px-1 py-3 text-sm text-center">
                                {editingColorPrice === `${index}_${colorIndex}` ? (
                                  <div className="flex justify-center space-x-1">
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        saveColorPrice(item, colorData, index, colorIndex);
                                      }}
                                      disabled={savingPriceId === `color_${index}_${colorIndex}`}
                                      className="p-1 text-green-600 hover:text-green-800"
                                      title="Save changes"
                                    >
                                      {savingPriceId === `color_${index}_${colorIndex}` ? (
                                        <RefreshCw className="h-4 w-4 animate-spin" />
                                      ) : (
                                        <Save className="h-4 w-4" />
                                      )}
                                    </button>
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        handleCancelEdit();
                                      }}
                                      className="p-1 text-red-600 hover:text-red-800"
                                      title="Cancel edit"
                                    >
                                      <XCircle className="h-4 w-4" />
                                    </button>
                                  </div>
                                ) : (
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleEditColorPrice(item, colorData, index, colorIndex);
                                    }}
                                    className="p-1 text-blue-600 hover:text-blue-800"
                                    title="Edit color price"
                                  >
                                    <Edit className="h-4 w-4" />
                                  </button>
                                )}
                              </td>
                            </tr>
                          ))
                        }
                      </React.Fragment>
                    ))}
                    </tbody>
                </table>
              </div>

              {/* Summary footer */}
              <div className="text-center text-gray-600">
                {Object.values(filters).some(f => f) 
                  ? `Showing ${filteredData.length} of ${phoneData.length} price configurations (filtered)`
                  : `Showing ${filteredData.length} price configurations`}
                {expandedRows.size > 0 && `  ${expandedRows.size} rows expanded`}
              </div>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
};

export default PriceManagementForm;
{/* Part 9 End - Expanded Color Rows and Footer */}
</file>

<file path="src/components/phone-selection/services/InventoryService.js">
{/* Part 1 Start - Imports */}
import { 
    doc, 
    addDoc, 
    collection, 
    query, 
    where, 
    getDocs, 
    runTransaction, 
    increment,
    updateDoc 
  } from 'firebase/firestore';
  import { db } from '../../../firebase/config';
  import { createInventoryId, getCurrentDate } from '../utils/phoneUtils';
{/* Part 1 End - Imports */}
      
  {/* Part 2 Start - Update Inventory Counts Function */}
  // Update inventory counts
  export const updateInventory = async (data, isNewPhone = true) => {
    try {
      const { manufacturer, model, ram, storage, color, status } = data;
      
      // Create a unique ID for this inventory item
      const inventoryId = createInventoryId(manufacturer, model, ram, storage, color);
      
      // Reference to the inventory doc
      const inventoryRef = doc(db, 'inventory_counts', inventoryId);
      
      // Run as a transaction to ensure data consistency
      await runTransaction(db, async (transaction) => {
        const inventoryDoc = await transaction.get(inventoryRef);
        
        if (!inventoryDoc.exists()) {
          // This is a new inventory item
          transaction.set(inventoryRef, {
            manufacturer,
            model,
            ram,
            storage,
            color,
            total: 1,
            onHand: status === 'On-Hand' ? 1 : 0,
            onDisplay: status === 'On-Display' ? 1 : 0,
            sold: status === 'Sold' ? 1 : 0,
            reserved: status === 'Reserved' ? 1 : 0,
            defective: status === 'Defective' ? 1 : 0,
            lastUpdated: getCurrentDate()
          });
        } else {
          // Existing inventory item
          const inventoryData = inventoryDoc.data();
          
          // If it's a new phone, increment total and the appropriate status count
          if (isNewPhone) {
            transaction.update(inventoryRef, {
              total: increment(1),
              onHand: status === 'On-Hand' ? increment(1) : inventoryData.onHand,
              onDisplay: status === 'On-Display' ? increment(1) : inventoryData.onDisplay || 0,
              sold: status === 'Sold' ? increment(1) : inventoryData.sold,
              reserved: status === 'Reserved' ? increment(1) : inventoryData.reserved,
              defective: status === 'Defective' ? increment(1) : inventoryData.defective,
              lastUpdated: getCurrentDate()
            });
          } 
          // If it's a status change, we'll handle it separately
        }
      });
      
      return true;
    } catch (error) {
      console.error("Error updating inventory:", error);
      return false;
    }
  };
  {/* Part 2 End - Update Inventory Counts Function */}
  
  {/* Part 3 Start - Add Phone to Inventory Function */}
  // Add a new phone to the inventory
  export const addPhoneToInventory = async (phoneData) => {
    try {
      // First add the phone to the inventory tracking system
      const inventoryUpdated = await updateInventory(phoneData, true);
      
      if (!inventoryUpdated) {
        throw new Error("Failed to update inventory counts");
      }
      
      // Add document to 'inventory' collection for the specific phone
      const docRef = await addDoc(collection(db, 'inventory'), phoneData);
      console.log("Document written with ID: ", docRef.id);
      
      return {
        success: true,
        docId: docRef.id
      };
    } catch (error) {
      console.error("Error adding phone to inventory:", error);
      return {
        success: false,
        error: error.message
      };
    }
  };
  {/* Part 3 End - Add Phone to Inventory Function */}

 {/* Part 4 Start - Update Phone in Inventory Function */}
 // Update an existing phone in the inventory
export const updatePhoneInInventory = async (itemId, phoneData, originalData) => {
  try {
    console.log('Updating phone with data:', phoneData); // ADD THIS LINE
    // First, check if the status changed
    const statusChanged = originalData.status !== phoneData.status;
    
    if (statusChanged) {
      // Update inventory counts for status change
      const oldInventoryId = createInventoryId(
        originalData.manufacturer,
        originalData.model,
        originalData.ram,
        originalData.storage,
        originalData.color
      );
      
      const newInventoryId = createInventoryId(
        phoneData.manufacturer,
        phoneData.model,
        phoneData.ram,
        phoneData.storage,
        phoneData.color
      );
      
      // Run transaction to update counts
      await runTransaction(db, async (transaction) => {
        const oldInventoryRef = doc(db, 'inventory_counts', oldInventoryId);
        const newInventoryRef = doc(db, 'inventory_counts', newInventoryId);
        
        // Get both documents
        const oldInventoryDoc = await transaction.get(oldInventoryRef);
        const newInventoryDoc = await transaction.get(newInventoryRef);
        
        if (oldInventoryDoc.exists()) {
          // Decrement old status count
          const decrementField = 
            originalData.status === 'On-Hand' ? 'onHand' : 
            originalData.status === 'On-Display' ? 'onDisplay' : 
            originalData.status === 'Sold' ? 'sold' : 
            originalData.status === 'Reserved' ? 'reserved' : 
            'defective';
          
          transaction.update(oldInventoryRef, {
            [decrementField]: increment(-1),
            lastUpdated: getCurrentDate()
          });
        }
        
        if (newInventoryDoc.exists()) {
          // Increment new status count
          const incrementField = 
            phoneData.status === 'On-Hand' ? 'onHand' : 
            phoneData.status === 'On-Display' ? 'onDisplay' : 
            phoneData.status === 'Sold' ? 'sold' : 
            phoneData.status === 'Reserved' ? 'reserved' : 
            'defective';
          
          transaction.update(newInventoryRef, {
            [incrementField]: increment(1),
            lastUpdated: getCurrentDate()
          });
        }
      });
    }
    
    // Update the inventory document
    const itemRef = doc(db, 'inventory', itemId);
    await updateDoc(itemRef, phoneData);

    console.log('Phone updated successfully with ID:', itemId); // ADD THIS LINE
    
    return {
      success: true,
      docId: itemId
    };
  } catch (error) {
    console.error("Error updating phone in inventory:", error);
    return {
      success: false,
      error: error.message
    };
  }
};
{/* Part 4 End - Update Phone in Inventory Function */}

{/* Part 5 Start - Check Duplicate IMEIs Function */}
// Check for duplicate IMEIs in the database
export const checkDuplicateImeis = async (imei1, imei2, excludeItemId = null) => {
  try {
    // Only check if IMEIs are not empty
    let hasError = false;
    let imei1Error = '';
    let imei2Error = '';
    
    // First check if IMEI1 and IMEI2 are the same
    if (imei1 && imei2 && imei1 === imei2) {
      imei2Error = 'IMEI 1 and IMEI 2 cannot be the same';
      hasError = true;
    }
    
    // Only query Firebase if necessary and if there are no other errors
    if (!hasError && imei1) {
      const imei1Query = query(
        collection(db, 'inventory'), 
        where("imei1", "==", imei1)
      );
      const imei1Snapshot = await getDocs(imei1Query);
      
      // Check if found document is not the current item being edited
      const foundDocs = imei1Snapshot.docs.filter(doc => doc.id !== excludeItemId);
      if (foundDocs.length > 0) {
        imei1Error = 'This IMEI already exists in inventory';
        hasError = true;
      }
    }
    
    // Only check IMEI2 if it's not empty and there are no other errors
    if (!hasError && imei2) {
      const imei2Query = query(
        collection(db, 'inventory'), 
        where("imei2", "==", imei2)
      );
      const imei2Snapshot = await getDocs(imei2Query);
      
      // Check if found document is not the current item being edited
      const foundDocs = imei2Snapshot.docs.filter(doc => doc.id !== excludeItemId);
      if (foundDocs.length > 0) {
        imei2Error = 'This IMEI already exists in inventory';
        hasError = true;
      }
    }
    
    return {
      isValid: !hasError,
      imei1Error,
      imei2Error
    };
  } catch (error) {
    console.error("Error checking IMEIs:", error);
    return {
      isValid: false,
      imei1Error: 'Error checking IMEI',
      imei2Error: 'Error checking IMEI'
    };
  }
};
{/* Part 5 End - Check Duplicate IMEIs Function */}
</file>

<file path="src/components/SupplierManagementForm.jsx">
{/* Part 1 Start - Updated Imports and Initial State */}
import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { 
  Building, 
  RefreshCw, 
  Plus, 
  Edit, 
  Trash2, 
  Save, 
  XCircle,
  Search,
  FileText,
  Calculator,
  Eye,
  Building2,
  CreditCard,
  DollarSign,
  StickyNote,
  Settings
} from 'lucide-react';
// Import the supplier service
import supplierService from '../services/supplierService';

const SupplierManagementForm = () => {
  // State for suppliers list - NOW LOADED FROM FIREBASE
  const [suppliers, setSuppliers] = useState([]);

  // State for current form
  const [currentSupplier, setCurrentSupplier] = useState({
    id: null,
    supplierName: '',
    bankName: '',
    bankAccount: '',
    notes: ''
  });

  // State for ledger entries - NOW LOADED FROM FIREBASE
  const [ledgerEntries, setLedgerEntries] = useState([]);
  const [selectedSupplierForLedger, setSelectedSupplierForLedger] = useState(null);
  const [ledgerSummary, setLedgerSummary] = useState(null);

  // State for loading and errors - NEW
  const [loading, setLoading] = useState(false);
  const [submitLoading, setSubmitLoading] = useState(false);
  const [error, setError] = useState('');
  const [successMessage, setSuccessMessage] = useState('');

  // UI State
  const [isEditing, setIsEditing] = useState(false);
  const [editingId, setEditingId] = useState(null);
  const [selectedSupplierId, setSelectedSupplierId] = useState(null);
  const [activeTab, setActiveTab] = useState('suppliers');
  const [showSupplierForm, setShowSupplierForm] = useState(false);

  // Load data when component mounts
  useEffect(() => {
    fetchSuppliers();
  }, []);

  // Load ledger when supplier is selected
  useEffect(() => {
    if (selectedSupplierId && activeTab === 'ledger') {
      fetchSupplierLedger(selectedSupplierId);
    }
  }, [selectedSupplierId, activeTab]);
{/* Part 1 End - Updated Imports and Initial State */}

{/* Part 2 Start - Real Data Fetching Functions */}
  // ====== REAL DATA FETCHING FUNCTIONS ======
  
  // Fetch all suppliers from Firebase
  const fetchSuppliers = async () => {
    try {
      setLoading(true);
      setError('');
      
      const result = await supplierService.getAllSuppliers();
      
      if (result.success) {
        setSuppliers(result.suppliers);
        console.log('Suppliers loaded:', result.suppliers);
      } else {
        setError(`Error loading suppliers: ${result.error}`);
        setSuppliers([]);
      }
    } catch (error) {
      console.error("Error fetching suppliers:", error);
      setError(`Error loading suppliers: ${error.message}`);
      setSuppliers([]);
    } finally {
      setLoading(false);
    }
  };

  // Fetch ledger for a specific supplier
  const fetchSupplierLedger = async (supplierId) => {
    try {
      setLoading(true);
      setError('');
      
      // Get ledger entries
      const ledgerResult = await supplierService.getSupplierLedger(supplierId);
      
      if (ledgerResult.success) {
        setLedgerEntries(ledgerResult.ledgerEntries);
        console.log('Ledger loaded:', ledgerResult.ledgerEntries);
      } else {
        setError(`Error loading ledger: ${ledgerResult.error}`);
        setLedgerEntries([]);
      }

      // Get ledger summary
      const summaryResult = await supplierService.getSupplierLedgerSummary(supplierId);
      
      if (summaryResult.success) {
        setLedgerSummary(summaryResult.summary);
        console.log('Ledger summary loaded:', summaryResult.summary);
      } else {
        console.warn('Could not load ledger summary:', summaryResult.error);
        setLedgerSummary(null);
      }
      
    } catch (error) {
      console.error("Error fetching supplier ledger:", error);
      setError(`Error loading ledger: ${error.message}`);
      setLedgerEntries([]);
      setLedgerSummary(null);
    } finally {
      setLoading(false);
    }
  };

  // Recalculate supplier balance
  const recalculateBalance = async (supplierId) => {
    try {
      setLoading(true);
      setError('');
      
      const result = await supplierService.recalculateSupplierBalance(supplierId);
      
      if (result.success) {
        setSuccessMessage(`Balance recalculated successfully. Final balance: ${formatNumberWithCommas(result.finalBalance.toString())}. Updated ${result.entriesUpdated} entries.`);
        
        // Refresh data
        await fetchSuppliers();
        if (selectedSupplierId) {
          await fetchSupplierLedger(selectedSupplierId);
        }
      } else {
        setError(`Error recalculating balance: ${result.error}`);
      }
    } catch (error) {
      console.error("Error recalculating balance:", error);
      setError(`Error recalculating balance: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };
{/* Part 2 End - Real Data Fetching Functions */}

{/* Part 3 Start - Real Backend Form Handlers */}
  // ====== REAL BACKEND FORM HANDLERS ======
  
  // Helper function to clear messages after a delay
  const clearMessages = () => {
    setTimeout(() => {
      setError('');
      setSuccessMessage('');
    }, 5000);
  };

  // Helper function to format numbers with commas
  const formatNumberWithCommas = (value) => {
    if (!value && value !== 0) return '';
    return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  };

  // Supplier form handlers - UPDATED to use real backend
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setCurrentSupplier(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const handleSubmit = async (e) => {
    if (e) e.preventDefault();
    
    // Validation
    if (!currentSupplier.supplierName.trim()) {
      setError('Supplier name is required');
      clearMessages();
      return;
    }

    if (!currentSupplier.bankName.trim()) {
      setError('Bank name is required');
      clearMessages();
      return;
    }

    if (!currentSupplier.bankAccount.trim()) {
      setError('Bank account is required');
      clearMessages();
      return;
    }

    try {
      setSubmitLoading(true);
      setError('');
      
      if (isEditing) {
        // Update existing supplier
        const result = await supplierService.updateSupplier(editingId, {
          supplierName: currentSupplier.supplierName.trim(),
          bankName: currentSupplier.bankName.trim(),
          bankAccount: currentSupplier.bankAccount.trim(),
          notes: currentSupplier.notes.trim()
        });

        if (result.success) {
          setSuccessMessage('Supplier updated successfully');
          await fetchSuppliers(); // Refresh the list
        } else {
          setError(`Error updating supplier: ${result.error}`);
        }
      } else {
        // Create new supplier
        const result = await supplierService.createSupplier({
          supplierName: currentSupplier.supplierName.trim(),
          bankName: currentSupplier.bankName.trim(),
          bankAccount: currentSupplier.bankAccount.trim(),
          notes: currentSupplier.notes.trim()
        });

        if (result.success) {
          setSuccessMessage('Supplier created successfully');
          await fetchSuppliers(); // Refresh the list
        } else {
          setError(`Error creating supplier: ${result.error}`);
        }
      }

      // Reset form on success
      if (!error) {
        handleCancel();
      }
      
    } catch (error) {
      console.error('Error submitting supplier:', error);
      setError(`Error saving supplier: ${error.message}`);
    } finally {
      setSubmitLoading(false);
      clearMessages();
    }
  };

  const handleEdit = (supplier) => {
    setCurrentSupplier({
      id: supplier.id,
      supplierName: supplier.supplierName,
      bankName: supplier.bankName,
      bankAccount: supplier.bankAccount,
      notes: supplier.notes || ''
    });
    setIsEditing(true);
    setEditingId(supplier.id);
    setShowSupplierForm(true);
  };

  const handleDelete = async (id) => {
    const supplier = suppliers.find(s => s.id === id);
    if (supplier && window.confirm(`Are you sure you want to delete "${supplier.supplierName}"? This action cannot be undone.`)) {
      try {
        setLoading(true);
        setError('');
        
        // Note: We don't have a delete function in the service yet, so we'll show an error for now
        setError('Delete functionality is not yet implemented. Please contact support.');
        
      } catch (error) {
        console.error('Error deleting supplier:', error);
        setError(`Error deleting supplier: ${error.message}`);
      } finally {
        setLoading(false);
        clearMessages();
      }
    }
  };

  const handleCancel = () => {
    setCurrentSupplier({
      id: null,
      supplierName: '',
      bankName: '',
      bankAccount: '',
      notes: ''
    });
    setIsEditing(false);
    setEditingId(null);
    setShowSupplierForm(false);
    setError('');
    setSuccessMessage('');
  };

  const handleAddNewSupplier = () => {
    setShowSupplierForm(true);
    setIsEditing(false);
    setEditingId(null);
    setCurrentSupplier({
      id: null,
      supplierName: '',
      bankName: '',
      bankAccount: '',
      notes: ''
    });
    setError('');
    setSuccessMessage('');
  };

  // Handle supplier selection for ledger
  const handleSupplierLedgerSelection = (supplierId) => {
    setSelectedSupplierId(supplierId);
    const supplier = suppliers.find(s => s.id === supplierId);
    setSelectedSupplierForLedger(supplier);
    
    if (supplierId) {
      fetchSupplierLedger(supplierId);
    } else {
      setLedgerEntries([]);
      setLedgerSummary(null);
    }
  };

  // Handle direct ledger view from supplier actions - NEW
  const handleViewLedger = (supplier) => {
    // Switch to ledger tab
    setActiveTab('ledger');
    // Select the supplier and load their ledger
    setSelectedSupplierId(supplier.id);
    setSelectedSupplierForLedger(supplier);
    // Clear any existing messages
    setError('');
    setSuccessMessage('');
    // Fetch the ledger data
    fetchSupplierLedger(supplier.id);
  };

  // Handle tab changes
  const handleTabChange = (tab) => {
    setActiveTab(tab);
    setError('');
    setSuccessMessage('');
  };

  // Handle refresh
  const handleRefresh = async () => {
    await fetchSuppliers();
    if (selectedSupplierId && activeTab === 'ledger') {
      await fetchSupplierLedger(selectedSupplierId);
    }
    setError('');
    setSuccessMessage('');
  };
{/* Part 3 End - Real Backend Form Handlers */}

{/* Part 4 Start - Main Component Structure and Header */}
  return (
    <div className="min-h-screen bg-white p-4">
      <Card className="w-full max-w-7xl mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
        <CardHeader className="bg-[rgb(52,69,157)] py-3 flex flex-row justify-between items-center">
          <div className="flex items-center gap-2">
            <Building className="h-6 w-6 text-white" />
            <CardTitle className="text-2xl text-white">Supplier Management</CardTitle>
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => handleTabChange('suppliers')}
              className={`flex items-center gap-1 ${activeTab === 'suppliers' ? 'bg-white text-[rgb(52,69,157)]' : 'bg-white/20 text-white'} px-4 py-2 rounded text-base font-medium`}
            >
              <Building className="h-5 w-5 mr-1" />
              <span>Suppliers</span>
            </button>
            <button
              onClick={() => handleTabChange('ledger')}
              className={`flex items-center gap-1 ${activeTab === 'ledger' ? 'bg-white text-[rgb(52,69,157)]' : 'bg-white/20 text-white'} px-4 py-2 rounded text-base font-medium`}
            >
              <FileText className="h-5 w-5 mr-1" />
              <span>Ledger</span>
            </button>
            {activeTab === 'suppliers' && (
              <button
                onClick={handleAddNewSupplier}
                className="flex items-center gap-1 bg-green-600 text-white px-4 py-2 rounded text-base font-medium hover:bg-green-700"
              >
                <Plus className="h-5 w-5 mr-1" />
                <span>Add New</span>
              </button>
            )}
            <button
              onClick={handleRefresh}
              disabled={loading}
              className="flex items-center gap-1 bg-white text-[rgb(52,69,157)] px-4 py-2 rounded text-base font-medium hover:bg-gray-50 disabled:opacity-50"
            >
              <RefreshCw className={`h-5 w-5 mr-1 ${loading ? 'animate-spin' : ''}`} />
              <span>Refresh</span>
            </button>
          </div>
        </CardHeader>

        <CardContent className="p-4">
          {/* Error and Success Messages */}
          {error && (
            <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
              {error}
            </div>
          )}
          
          {successMessage && (
            <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded mb-4">
              {successMessage}
            </div>
          )}

          {/* Loading Indicator */}
          {loading && (
            <div className="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded mb-4">
              Loading...
            </div>
          )}
{/* Part 4 End - Main Component Structure and Header */}

{/* Part 5 Start - Suppliers Tab Content with Outstanding Balance Display */}
          {/* Suppliers Tab */}
          {activeTab === 'suppliers' && (
            <div className="space-y-6">
              {/* Add/Edit Supplier Form */}
              {showSupplierForm && (
                <div className="bg-gray-50 p-4 rounded-lg border">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="font-semibold text-lg text-[rgb(52,69,157)]">
                      {isEditing ? 'Edit Supplier' : 'Add New Supplier'}
                    </h3>
                  </div>
                  
                  <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {/* Supplier Name - Position 1 */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Supplier Name *
                        </label>
                        <input
                          type="text"
                          name="supplierName"
                          value={currentSupplier.supplierName}
                          onChange={handleInputChange}
                          className="w-full p-2 border rounded"
                          required
                          disabled={submitLoading}
                        />
                      </div>

                      {/* Outstanding Balance - Position 2 (MOVED UP) */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Outstanding Balance
                        </label>
                        <input
                          type="text"
                          value={isEditing 
                            ? `${formatNumberWithCommas((suppliers.find(s => s.id === editingId)?.totalOutstanding || 0).toString())}`
                            : '0.00'
                          }
                          className="w-full p-2 border rounded bg-gray-100 text-gray-600"
                          disabled
                          placeholder="Auto-calculated from procurements"
                        />
                        <p className="text-xs text-gray-500 mt-1">
                          {isEditing ? 'This balance is calculated from active procurements and payments' : 'Balance will be calculated from procurements'}
                        </p>
                      </div>

                      {/* Bank Name - Position 3 */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Bank Name *
                        </label>
                        <input
                          type="text"
                          name="bankName"
                          value={currentSupplier.bankName}
                          onChange={handleInputChange}
                          className="w-full p-2 border rounded"
                          required
                          disabled={submitLoading}
                        />
                      </div>

                      {/* Bank Account - Position 4 */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Bank Account *
                        </label>
                        <input
                          type="text"
                          name="bankAccount"
                          value={currentSupplier.bankAccount}
                          onChange={handleInputChange}
                          className="w-full p-2 border rounded"
                          required
                          disabled={submitLoading}
                        />
                      </div>
                    </div>

                    {/* Notes - Full Width */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Notes
                      </label>
                      <textarea
                        name="notes"
                        value={currentSupplier.notes}
                        onChange={handleInputChange}
                        className="w-full p-2 border rounded h-20"
                        disabled={submitLoading}
                        placeholder="Additional notes about this supplier..."
                      />
                    </div>

                    <div className="flex gap-2">
                      <button
                        type="submit"
                        disabled={submitLoading}
                        className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center disabled:opacity-50"
                      >
                        <Save className="h-4 w-4 mr-2" />
                        {submitLoading ? 'Saving...' : (isEditing ? 'Update Supplier' : 'Add Supplier')}
                      </button>
                      
                      <button
                        type="button"
                        onClick={handleCancel}
                        disabled={submitLoading}
                        className="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 flex items-center"
                      >
                        <XCircle className="h-4 w-4 mr-2" />
                        Cancel
                      </button>
                    </div>
                  </form>
                </div>
              )}

              {/* Suppliers List */}
              <div className="bg-white border rounded-lg overflow-hidden">
                <div className="px-4 py-3 bg-gray-100 border-b">
                  <h3 className="font-semibold text-lg text-[rgb(52,69,157)]">
                    Suppliers List ({suppliers.length})
                  </h3>
                </div>
                
                {suppliers.length === 0 ? (
                  <div className="p-8 text-center text-gray-500">
                    <Building className="h-12 w-12 mx-auto mb-4 text-gray-300" />
                    <p>No suppliers found. Add your first supplier to get started.</p>
                  </div>
                ) : (
                  <>
                    <div className="overflow-x-auto border rounded-lg">
                      <table className="w-full border-collapse text-sm">
                        <thead>
                          <tr className="bg-gray-100">
                            <th className="border px-3 py-3 text-left font-semibold">
                              <div className="flex items-center">
                                <Building2 className="h-4 w-4 mr-2" />
                                Supplier
                              </div>
                            </th>
                            <th className="border px-3 py-3 text-left font-semibold">
                              <div className="flex items-center">
                                <CreditCard className="h-4 w-4 mr-2" />
                                Bank Details
                              </div>
                            </th>
                            <th className="border px-3 py-3 text-right font-semibold w-48">
                              <div className="flex items-center justify-end">
                                <DollarSign className="h-4 w-4 mr-2" />
                                Balance
                              </div>
                            </th>
                            <th className="border px-3 py-3 text-left font-semibold">
                              <div className="flex items-center">
                                <StickyNote className="h-4 w-4 mr-2" />
                                Notes
                              </div>
                            </th>
                            <th className="border px-3 py-3 text-center font-semibold w-32">
                              <div className="flex items-center justify-center">
                                <Settings className="h-4 w-4 mr-2" />
                                Actions
                              </div>
                            </th>
                          </tr>
                        </thead>
                        <tbody>
                          {suppliers.map((supplier) => (
                            <tr key={supplier.id} className="hover:bg-gray-50">
                              <td className="border px-3 py-3">
                                <div className="font-medium text-gray-900">{supplier.supplierName}</div>
                              </td>
                              <td className="border px-3 py-3">
                                <div className="font-medium text-gray-900">{supplier.bankName}</div>
                                <div className="text-xs text-gray-500 mt-1">{supplier.bankAccount}</div>
                              </td>
                              <td className="border px-3 py-3 text-right font-mono w-48">
                                <span className="font-semibold text-lg">
                                  {((supplier.totalOutstanding || 0).toLocaleString('en-US', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                  }))}
                                </span>
                              </td>
                              <td className="border px-3 py-3">
                                <div className="text-sm text-gray-500 max-w-xs truncate">
                                  {supplier.notes || 'No notes'}
                                </div>
                              </td>
                              <td className="border px-3 py-3 w-32">
                                <div className="flex items-center justify-center gap-1">
                                  <button 
                                    onClick={() => handleViewLedger(supplier)}
                                    disabled={loading}
                                    className="p-1 text-blue-600 hover:bg-blue-100 rounded disabled:opacity-50"
                                    title="View ledger"
                                  >
                                    <Eye className="h-4 w-4" />
                                  </button>
                                  <button 
                                    onClick={() => handleEdit(supplier)}
                                    disabled={loading}
                                    className="p-1 text-green-600 hover:bg-green-100 rounded disabled:opacity-50"
                                    title="Edit supplier"
                                  >
                                    <Edit className="h-4 w-4" />
                                  </button>
                                  <button 
                                    onClick={() => handleDelete(supplier.id)}
                                    disabled={loading}
                                    className="p-1 text-red-600 hover:bg-red-100 rounded disabled:opacity-50"
                                    title="Delete supplier"
                                  >
                                    <Trash2 className="h-4 w-4" />
                                  </button>
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </>
                )}
              </div>

              {/* Summary Statistics - Matching ProcurementManagementForm Style */}
              {suppliers.length > 0 && (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div className="flex items-center">
                      <Building2 className="h-8 w-8 text-blue-600 mr-3" />
                      <div>
                        <p className="text-sm text-gray-600">Total Suppliers</p>
                        <p className="text-xl font-bold text-blue-600">{suppliers.length}</p>
                      </div>
                    </div>
                  </div>
                  
                  <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div className="flex items-center">
                      <DollarSign className="h-8 w-8 text-green-600 mr-3" />
                      <div>
                        <p className="text-sm text-gray-600">Suppliers with Balance</p>
                        <p className="text-xl font-bold text-green-600">
                          {suppliers.filter(s => (s.totalOutstanding || 0) > 0).length}
                        </p>
                      </div>
                    </div>
                  </div>
                  
                  <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div className="flex items-center">
                      <CreditCard className="h-8 w-8 text-red-600 mr-3" />
                      <div>
                        <p className="text-sm text-gray-600">Total Balance</p>
                        <p className="text-xl font-bold text-red-600 font-mono">
                          {(suppliers.reduce((total, supplier) => total + (supplier.totalOutstanding || 0), 0).toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                          }))}
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}
{/* Part 5 End - Suppliers Tab Content with Outstanding Balance Display */}

{/* Part 6 Start - Ledger Tab and Component Export - FIXED */}
          {/* Ledger Tab */}
          {activeTab === 'ledger' && (
            <div className="space-y-6">
              {/* Supplier Selection for Ledger */}
              <div className="bg-white border rounded-lg p-4">
                <div className="flex items-end gap-4">
                  <div className="flex-1">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Select Supplier for Ledger View
                    </label>
                    <select
                      value={selectedSupplierId || ''}
                      onChange={(e) => handleSupplierLedgerSelection(e.target.value)}
                      className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      disabled={loading}
                    >
                      <option value="">Choose a supplier...</option>
                      {suppliers.map((supplier) => (
                        <option key={supplier.id} value={supplier.id}>
                          {supplier.supplierName}
                        </option>
                      ))}
                    </select>
                  </div>
                  
                  {selectedSupplierId && (
                    <button
                      onClick={() => recalculateBalance(selectedSupplierId)}
                      disabled={loading}
                      className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 h-[42px]"
                      title="Recalculate balance from all transactions"
                    >
                      <Calculator className="h-4 w-4" />
                      Recalculate
                    </button>
                  )}
                </div>
              </div>

              {/* Loading indicator */}
              {loading && (
                <div className="flex justify-center items-center py-8">
                  <RefreshCw className="h-8 w-8 animate-spin text-blue-600" />
                  <span className="ml-2 text-gray-600">Loading ledger...</span>
                </div>
              )}

              {/* Error message */}
              {error && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                  <p className="text-red-800">{error}</p>
                </div>
              )}

              {/* Success message */}
              {successMessage && (
                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                  <p className="text-green-800">{successMessage}</p>
                </div>
              )}

              {/* Ledger Summary - FIXED PROPERTY NAMES */}
              {selectedSupplierForLedger && ledgerSummary && (
                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6">
                  <h3 className="text-lg font-semibold text-gray-800 mb-4">
                    Ledger Summary for {selectedSupplierForLedger.supplierName}
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div className="bg-white rounded-lg p-4 border border-blue-100 shadow-sm">
                      <div className="text-center">
                        <p className="text-sm text-gray-600 font-medium">Total Purchases</p>
                        <p className="text-xl font-bold text-blue-600">
                          {formatNumberWithCommas(ledgerSummary.totalDue.toString())}
                        </p>
                      </div>
                    </div>
                    
                    <div className="bg-white rounded-lg p-4 border border-green-100 shadow-sm">
                      <div className="text-center">
                        <p className="text-sm text-gray-600 font-medium">Total Payments</p>
                        <p className="text-xl font-bold text-green-600">
                          {formatNumberWithCommas(ledgerSummary.totalPayments.toString())}
                        </p>
                      </div>
                    </div>
                    
                    <div className="bg-white rounded-lg p-4 border border-purple-100 shadow-sm">
                      <div className="text-center">
                        <p className="text-sm text-gray-600 font-medium">Outstanding Balance</p>
                        <p className={`text-xl font-bold ${ledgerSummary.outstandingBalance > 0 ? 'text-red-600' : 'text-green-600'}`}>
                          {formatNumberWithCommas(ledgerSummary.outstandingBalance.toString())}
                        </p>
                      </div>
                    </div>

                    <div className="bg-white rounded-lg p-4 border border-gray-100 shadow-sm">
                      <div className="text-center">
                        <p className="text-sm text-gray-600 font-medium">Last Activity</p>
                        <p className="text-sm font-bold text-gray-600">
                          {(() => {
                            const hasLastPurchase = ledgerSummary.lastPurchaseDate && ledgerSummary.lastPurchaseDate !== 'null';
                            const hasLastPayment = ledgerSummary.lastPaymentDate && ledgerSummary.lastPaymentDate !== 'null';
                            
                            if (!hasLastPurchase && !hasLastPayment) {
                              return 'No activity';
                            } else if (hasLastPurchase && !hasLastPayment) {
                              return `Purchase: ${ledgerSummary.lastPurchaseDate}`;
                            } else if (!hasLastPurchase && hasLastPayment) {
                              return `Payment: ${ledgerSummary.lastPaymentDate}`;
                            } else {
                              // Both exist, show the most recent one
                              return ledgerSummary.lastPurchaseDate > ledgerSummary.lastPaymentDate ? 
                                `Purchase: ${ledgerSummary.lastPurchaseDate}` : 
                                `Payment: ${ledgerSummary.lastPaymentDate}`;
                            }
                          })()}
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Ledger Table */}
              {selectedSupplierId ? (
                <div className="bg-white border rounded-lg overflow-hidden">
                  <div className="px-4 py-3 bg-gray-100 border-b">
                    <h3 className="font-semibold text-lg text-[rgb(52,69,157)]">
                      Ledger for {selectedSupplierForLedger?.supplierName}
                    </h3>
                  </div>
                  
                  {ledgerEntries.length === 0 ? (
                    <div className="p-8 text-center text-gray-500">
                      <FileText className="h-12 w-12 mx-auto mb-4 text-gray-300" />
                      <p>No ledger entries found for this supplier.</p>
                      <p className="text-sm text-gray-400 mt-2">
                        Ledger entries are created automatically when procurements are submitted.
                      </p>
                    </div>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-4 py-3 text-left text-sm font-medium text-gray-700">Date</th>
                            <th className="px-4 py-3 text-left text-sm font-medium text-gray-700">Reference</th>
                            <th className="px-4 py-3 text-left text-sm font-medium text-gray-700">Description</th>
                            <th className="px-4 py-3 text-right text-sm font-medium text-gray-700">Amount Due</th>
                            <th className="px-4 py-3 text-right text-sm font-medium text-gray-700">Amount Paid</th>
                            <th className="px-4 py-3 text-right text-sm font-medium text-gray-700">Running Balance</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                          {ledgerEntries.map((entry) => (
                            <tr key={entry.id} className="hover:bg-gray-50">
                              <td className="px-4 py-3 text-sm text-gray-900">
                                {entry.entryDate}
                              </td>
                              <td className="px-4 py-3 text-sm text-gray-900">
                                {entry.reference}
                              </td>
                              <td className="px-4 py-3 text-sm text-gray-900">
                                {entry.description}
                              </td>
                              <td className="px-4 py-3 text-sm text-right">
                                {entry.amountDue > 0 && (
                                  <span className="text-red-600 font-medium">
                                    {formatNumberWithCommas(entry.amountDue.toString())}
                                  </span>
                                )}
                              </td>
                              <td className="px-4 py-3 text-sm text-right">
                                {entry.amountPaid > 0 && (
                                  <span className="text-green-600 font-medium">
                                    {formatNumberWithCommas(entry.amountPaid.toString())}
                                  </span>
                                )}
                              </td>
                              <td className="px-4 py-3 text-sm text-right font-medium">
                                <span className={entry.runningBalance > 0 ? 
                                  'text-red-600' : 'text-green-600'}>
                                  {formatNumberWithCommas(entry.runningBalance.toString())}
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>
              ) : (
                <div className="p-8 text-center text-gray-500 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                  <Search className="h-12 w-12 mx-auto mb-4 text-gray-300" />
                  <p>Please select a supplier to view their ledger</p>
                </div>
              )}
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
};

export default SupplierManagementForm;
{/* Part 6 End - Ledger Tab and Component Export - FIXED */}
</file>

<file path="src/services/supplierService.js">
{/* Part 1 Start - Imports and Database Configuration */}
import { 
  collection, 
  doc, 
  addDoc, 
  updateDoc, 
  getDocs, 
  getDoc, 
  query, 
  where, 
  orderBy, 
  Timestamp,
  runTransaction,
  writeBatch  // ONLY ADDED THIS for batch operations in recalculateSupplierBalance
} from 'firebase/firestore';
import { db } from '../firebase/config';

/* ========== SUPPLIER SERVICE - COMPLETE FILE ========== */
/* This service handles all supplier, procurement, and ledger operations */
{/* Part 1 End - Imports and Database Configuration */}

{/* Part 2 Start - Utility Functions */}
/* ========== UTILITY FUNCTIONS ========== */

/**
 * Get current date in YYYY-MM-DD format
 */
export const getCurrentDate = () => {
  const today = new Date();
  return today.toISOString().split('T')[0];
};

/**
 * Generate procurement reference number
 */
export const generateProcurementReference = () => {
  const timestamp = Date.now();
  const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
  return `PROC-${timestamp}-${random}`;
};

/**
 * Generate payment reference number
 */
export const generatePaymentReference = () => {
  const timestamp = Date.now();
  const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
  return `PAY-${timestamp}-${random}`;
};

/**
 * Format price with commas and two decimal places
 */
const formatPrice = (value) => {
  if (!value && value !== 0) return '0.00';
  const numValue = parseFloat(value.toString().replace(/,/g, ''));
  if (isNaN(numValue)) return '0.00';
  return numValue.toLocaleString('en-US', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
};
{/* Part 2 End - Utility Functions */}

{/* Part 3 Start - Supplier Operations */}
/* ========== SUPPLIER OPERATIONS ========== */

/**
 * Create a new supplier
 */
export const createSupplier = async (supplierData) => {
  try {
    const supplierDoc = {
      ...supplierData,
      totalOutstanding: 0,
      dateCreated: Timestamp.now(),
      lastUpdated: Timestamp.now()
    };
    
    const docRef = await addDoc(collection(db, 'suppliers'), supplierDoc);
    
    return {
      success: true,
      id: docRef.id,
      message: 'Supplier created successfully'
    };
  } catch (error) {
    console.error('Error creating supplier:', error);
    return {
      success: false,
      error: error.message
    };
  }
};

/**
 * Update an existing supplier
 */
export const updateSupplier = async (supplierId, supplierData) => {
  try {
    const supplierRef = doc(db, 'suppliers', supplierId);
    
    await updateDoc(supplierRef, {
      ...supplierData,
      lastUpdated: Timestamp.now()
    });
    
    return {
      success: true,
      message: 'Supplier updated successfully'
    };
  } catch (error) {
    console.error('Error updating supplier:', error);
    return {
      success: false,
      error: error.message
    };
  }
};

/**
 * Get all suppliers
 */
export const getAllSuppliers = async () => {
  try {
    const querySnapshot = await getDocs(collection(db, 'suppliers'));
    const suppliers = [];
    
    querySnapshot.forEach((doc) => {
      suppliers.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    return {
      success: true,
      suppliers
    };
  } catch (error) {
    console.error('Error fetching suppliers:', error);
    return {
      success: false,
      error: error.message,
      suppliers: []
    };
  }
};

/**
 * Get supplier by ID
 */
export const getSupplierById = async (supplierId) => {
  try {
    const supplierRef = doc(db, 'suppliers', supplierId);
    const supplierSnap = await getDoc(supplierRef);
    
    if (supplierSnap.exists()) {
      return {
        success: true,
        supplier: {
          id: supplierSnap.id,
          ...supplierSnap.data()
        }
      };
    } else {
      return {
        success: false,
        error: 'Supplier not found'
      };
    }
  } catch (error) {
    console.error('Error fetching supplier:', error);
    return {
      success: false,
      error: error.message
    };
  }
};
{/* Part 3 End - Supplier Operations */}

{/* Part 4 Start - Procurement Operations */}
/* ========== PROCUREMENT OPERATIONS ========== */

/**
 * Create a new procurement and maintain data consistency
 */
export const createProcurement = async (procurementData, supplierId) => {
  try {
    // Validate inputs
    if (!supplierId) {
      throw new Error('Supplier ID is required');
    }
    
    // Use transaction to ensure data consistency
    const result = await runTransaction(db, async (transaction) => {
      // Get supplier document
      const supplierRef = doc(db, 'suppliers', supplierId);
      const supplierDoc = await transaction.get(supplierRef);
      
      if (!supplierDoc.exists()) {
        throw new Error('Supplier not found');
      }
      
      const supplierData = supplierDoc.data();
      const currentOutstanding = supplierData.totalOutstanding || 0;
      
      // Generate procurement reference
      const procurementRef = generateProcurementReference();
      
      // Create procurement document
      const procurementDoc = {
        ...procurementData,
        supplierId,
        supplierName: supplierData.supplierName,
        reference: procurementRef,
        isPaid: false,
        dateCreated: Timestamp.now(),
        lastUpdated: Timestamp.now()
      };
      
      const procurementDocRef = doc(collection(db, 'procurements'));
      transaction.set(procurementDocRef, procurementDoc);
      
      // Update supplier outstanding balance
      const newOutstanding = currentOutstanding + procurementData.grandTotal;
      transaction.update(supplierRef, {
        totalOutstanding: newOutstanding,
        lastUpdated: Timestamp.now()
      });
      
      // Create ledger entry for the purchase
      const ledgerEntry = {
        supplierId,
        supplierName: supplierData.supplierName,
        procurementId: procurementDocRef.id,
        entryType: 'purchase',
        purchaseDate: procurementData.purchaseDate,
        entryDate: procurementData.purchaseDate,
        reference: procurementRef,
        amountDue: procurementData.grandTotal,
        amountPaid: 0,
        runningBalance: newOutstanding,
        description: `Purchase order - ${procurementData.items.length} items`,
        sortOrder: 1,
        dateCreated: Timestamp.now()
      };
      
      const ledgerDocRef = doc(collection(db, 'supplier_ledger'));
      transaction.set(ledgerDocRef, ledgerEntry);
      
      return {
        procurementId: procurementDocRef.id,
        reference: procurementRef
      };
    });
    
    return {
      success: true,
      procurementId: result.procurementId,
      reference: result.reference,
      message: 'Procurement created successfully'
    };
    
  } catch (error) {
    console.error('Error creating procurement:', error);
    return {
      success: false,
      error: error.message
    };
  }
};

/**
 * Update an existing procurement and maintain data consistency
 * FINAL FIX: Pre-reads ledger entries before transaction to avoid query issues
 * This function handles:
 * - Updating the procurement document
 * - Adjusting supplier outstanding balances
 * - Updating corresponding ledger entries
 * - Handling supplier changes
 */
export const updateProcurement = async (procurementId, updatedProcurementData, newSupplierId) => {
  try {
    // Validate inputs
    if (!procurementId) {
      throw new Error('Procurement ID is required');
    }
    
    console.log('Starting updateProcurement:', { procurementId, newSupplierId });
    
    // =============================
    //  PRE-READ LEDGER ENTRIES OUTSIDE TRANSACTION
    // =============================
    
    // Get existing ledger entries BEFORE starting transaction
    const ledgerQuery = query(
      collection(db, 'supplier_ledger'),
      where('procurementId', '==', procurementId),
      where('entryType', '==', 'purchase')
    );
    
    const ledgerQuerySnap = await getDocs(ledgerQuery);
    console.log('Found ledger entries:', ledgerQuerySnap.size);
    
    // =============================
    //  START TRANSACTION
    // =============================
    
    const result = await runTransaction(db, async (transaction) => {
      console.log('Starting transaction...');
      
      // Get procurement document
      const procurementRef = doc(db, 'procurements', procurementId);
      const procurementSnap = await transaction.get(procurementRef);
      
      if (!procurementSnap.exists()) {
        throw new Error('Procurement not found');
      }
      
      const originalProcurement = procurementSnap.data();
      const originalGrandTotal = originalProcurement.grandTotal || 0;
      const originalSupplierId = originalProcurement.supplierId;
      const newGrandTotal = updatedProcurementData.grandTotal || 0;
      const grandTotalDifference = newGrandTotal - originalGrandTotal;
      
      console.log('Procurement data:', {
        originalGrandTotal,
        newGrandTotal,
        grandTotalDifference,
        originalSupplierId,
        newSupplierId: newSupplierId || originalSupplierId
      });
      
      // Get original supplier document
      const originalSupplierRef = doc(db, 'suppliers', originalSupplierId);
      const originalSupplierSnap = await transaction.get(originalSupplierRef);
      
      if (!originalSupplierSnap.exists()) {
        throw new Error('Original supplier not found');
      }
      
      const originalSupplierData = originalSupplierSnap.data();
      
      // If supplier is changing, get new supplier data
      let newSupplierData = null;
      let newSupplierRef = null;
      
      if (newSupplierId && newSupplierId !== originalSupplierId) {
        newSupplierRef = doc(db, 'suppliers', newSupplierId);
        const newSupplierSnap = await transaction.get(newSupplierRef);
        
        if (!newSupplierSnap.exists()) {
          throw new Error('New supplier not found');
        }
        
        newSupplierData = newSupplierSnap.data();
      }
      
      console.log('Starting writes...');
      
      // Handle supplier change scenario
      if (newSupplierId && newSupplierId !== originalSupplierId) {
        console.log('Supplier changed - handling supplier transfer');
        
        // Remove amount from original supplier's outstanding balance
        const originalNewOutstanding = (originalSupplierData.totalOutstanding || 0) - originalGrandTotal;
        transaction.update(originalSupplierRef, {
          totalOutstanding: Math.max(0, originalNewOutstanding),
          lastUpdated: Timestamp.now()
        });
        
        // Add amount to new supplier's outstanding balance
        const newSupplierNewOutstanding = (newSupplierData.totalOutstanding || 0) + newGrandTotal;
        transaction.update(newSupplierRef, {
          totalOutstanding: newSupplierNewOutstanding,
          lastUpdated: Timestamp.now()
        });
        
        // Update the procurement with new supplier info
        transaction.update(procurementRef, {
          ...updatedProcurementData,
          supplierId: newSupplierId,
          supplierName: newSupplierData.supplierName,
          lastUpdated: Timestamp.now()
        });
        
        // Update original ledger entry to mark it as transferred (using pre-read data)
        if (!ledgerQuerySnap.empty) {
          const originalLedgerDoc = ledgerQuerySnap.docs.find(doc => 
            doc.data().supplierId === originalSupplierId
          );
          
          if (originalLedgerDoc) {
            transaction.update(originalLedgerDoc.ref, {
              description: `${originalLedgerDoc.data().description} - TRANSFERRED TO ${newSupplierData.supplierName}`,
              amountDue: 0, // Zero out the amount since it's transferred
              runningBalance: Math.max(0, originalNewOutstanding),
              lastUpdated: Timestamp.now()
            });
          }
        }
        
        // Create new ledger entry for new supplier
        const newLedgerEntry = {
          supplierId: newSupplierId,
          supplierName: newSupplierData.supplierName,
          procurementId: procurementId,
          entryType: 'purchase',
          purchaseDate: updatedProcurementData.purchaseDate,
          entryDate: updatedProcurementData.purchaseDate,
          reference: originalProcurement.reference || `EDIT-${procurementId.substring(0, 8)}`,
          amountDue: newGrandTotal,
          amountPaid: 0,
          runningBalance: newSupplierNewOutstanding,
          description: `Purchase order - ${updatedProcurementData.items.length} items (TRANSFERRED FROM ${originalSupplierData.supplierName})`,
          sortOrder: 1,
          dateCreated: Timestamp.now()
        };
        
        const newLedgerDocRef = doc(collection(db, 'supplier_ledger'));
        transaction.set(newLedgerDocRef, newLedgerEntry);
        
      } else {
        // Same supplier - just update amounts
        console.log('Same supplier - updating amounts');
        
        // Update supplier outstanding balance with the difference
        const newOutstanding = (originalSupplierData.totalOutstanding || 0) + grandTotalDifference;
        transaction.update(originalSupplierRef, {
          totalOutstanding: Math.max(0, newOutstanding),
          lastUpdated: Timestamp.now()
        });
        
        // Update the procurement document
        transaction.update(procurementRef, {
          ...updatedProcurementData,
          lastUpdated: Timestamp.now()
        });
        
        // Update the corresponding ledger entry (using pre-read data)
        if (!ledgerQuerySnap.empty) {
          const ledgerDoc = ledgerQuerySnap.docs.find(doc => 
            doc.data().supplierId === originalSupplierId
          );
          
          if (ledgerDoc) {
            const updatedDescription = `Purchase order - ${updatedProcurementData.items.length} items${grandTotalDifference !== 0 ? ' (EDITED)' : ''}`;
            
            transaction.update(ledgerDoc.ref, {
              amountDue: newGrandTotal,
              runningBalance: Math.max(0, newOutstanding),
              description: updatedDescription,
              purchaseDate: updatedProcurementData.purchaseDate,
              entryDate: updatedProcurementData.purchaseDate,
              lastUpdated: Timestamp.now()
            });
          }
        }
      }
      
      console.log('All writes completed successfully');
      
      return {
        procurementId: procurementId,
        originalGrandTotal,
        newGrandTotal,
        grandTotalDifference,
        supplierChanged: newSupplierId && newSupplierId !== originalSupplierId
      };
    });
    
    console.log('Transaction completed successfully:', result);
    
    return {
      success: true,
      procurementId: result.procurementId,
      originalGrandTotal: result.originalGrandTotal,
      newGrandTotal: result.newGrandTotal,
      grandTotalDifference: result.grandTotalDifference,
      supplierChanged: result.supplierChanged,
      message: 'Procurement updated successfully with proper balance adjustments'
    };
    
  } catch (error) {
    console.error('Error updating procurement:', error);
    return {
      success: false,
      error: error.message
    };
  }
};

/**
 * Delete a procurement and maintain data consistency
 * This function handles:
 * - Removing the procurement document
 * - Adjusting supplier outstanding balances (subtracting the amount)
 * - Marking corresponding ledger entries as deleted with original amount preserved
 * - FIXED: Also handles payment ledger entries for paid procurements
 */
export const deleteProcurement = async (procurementId) => {
  try {
    // Validate inputs
    if (!procurementId) {
      throw new Error('Procurement ID is required');
    }
    
    console.log('Starting deleteProcurement:', { procurementId });
    
    // =============================
    //  PRE-READ LEDGER ENTRIES OUTSIDE TRANSACTION
    // =============================
    
    // Get existing PURCHASE ledger entries BEFORE starting transaction
    const purchaseLedgerQuery = query(
      collection(db, 'supplier_ledger'),
      where('procurementId', '==', procurementId),
      where('entryType', '==', 'purchase')
    );
    
    const purchaseLedgerQuerySnap = await getDocs(purchaseLedgerQuery);
    console.log('Found purchase ledger entries:', purchaseLedgerQuerySnap.size);
    
    // NEW: Get existing PAYMENT ledger entries
    const paymentLedgerQuery = query(
      collection(db, 'supplier_ledger'),
      where('procurementId', '==', procurementId),
      where('entryType', '==', 'payment')
    );
    
    const paymentLedgerQuerySnap = await getDocs(paymentLedgerQuery);
    console.log('Found payment ledger entries:', paymentLedgerQuerySnap.size);
    
    // =============================
    //  START TRANSACTION
    // =============================
    
    const result = await runTransaction(db, async (transaction) => {
      console.log('Starting transaction for delete...');
      
      // Get procurement document
      const procurementRef = doc(db, 'procurements', procurementId);
      const procurementSnap = await transaction.get(procurementRef);
      
      if (!procurementSnap.exists()) {
        throw new Error('Procurement not found');
      }
      
      const originalProcurement = procurementSnap.data();
      const originalGrandTotal = originalProcurement.grandTotal || 0;
      const supplierId = originalProcurement.supplierId;
      const isPaid = originalProcurement.isPaid || originalProcurement.paymentStatus === 'paid';
      
      console.log('Procurement to delete:', {
        id: procurementId,
        grandTotal: originalGrandTotal,
        supplierId: supplierId,
        reference: originalProcurement.reference,
        isPaid: isPaid
      });
      
      // Get supplier document
      const supplierRef = doc(db, 'suppliers', supplierId);
      const supplierSnap = await transaction.get(supplierRef);
      
      if (!supplierSnap.exists()) {
        throw new Error('Supplier not found');
      }
      
      const supplierData = supplierSnap.data();
      
      console.log('Starting writes...');
      
      // 1. Delete the procurement document
      transaction.delete(procurementRef);
      
      // 2. Update supplier outstanding balance
      // FIXED: For paid procurements, balance doesn't change because both purchase and payment are removed
      // For unpaid procurements, subtract the purchase amount
      let newOutstanding = supplierData.totalOutstanding || 0;
      
      if (!isPaid) {
        // Only adjust balance for unpaid procurements
        newOutstanding = newOutstanding - originalGrandTotal;
      }
      // For paid procurements, balance remains the same since we're removing both purchase and payment
      
      transaction.update(supplierRef, {
        totalOutstanding: Math.max(0, newOutstanding),
        lastUpdated: Timestamp.now()
      });
      
      // 3. Update the PURCHASE ledger entry with original amount preserved
      if (!purchaseLedgerQuerySnap.empty) {
        const purchaseLedgerDoc = purchaseLedgerQuerySnap.docs.find(doc => 
          doc.data().supplierId === supplierId
        );
        
        if (purchaseLedgerDoc) {
          const ledgerData = purchaseLedgerDoc.data();
          const originalDescription = ledgerData.description || '';
          const originalAmount = ledgerData.amountDue || 0;
          
          // Create enhanced description with original amount preserved
          const updatedDescription = `${originalDescription} - DELETED (Original: ${formatPrice(originalAmount.toString())})`;
          
          transaction.update(purchaseLedgerDoc.ref, {
            description: updatedDescription,
            amountDue: 0, // Zero out for balance calculations
            runningBalance: Math.max(0, newOutstanding),
            isDeleted: true, // Mark as deleted for audit purposes
            deletedDate: Timestamp.now(),
            lastUpdated: Timestamp.now()
          });
        }
      }
      
      // 4. NEW: Handle PAYMENT ledger entry if procurement was paid
      if (isPaid && !paymentLedgerQuerySnap.empty) {
        const paymentLedgerDoc = paymentLedgerQuerySnap.docs.find(doc => 
          doc.data().supplierId === supplierId
        );
        
        if (paymentLedgerDoc) {
          const paymentData = paymentLedgerDoc.data();
          const originalPaymentAmount = paymentData.amountPaid || 0;
          const originalPaymentDescription = paymentData.description || '';
          
          // Create enhanced description with original payment amount preserved
          const updatedPaymentDescription = `${originalPaymentDescription} - DELETED (Original Payment: ${formatPrice(originalPaymentAmount.toString())})`;
          
          transaction.update(paymentLedgerDoc.ref, {
            description: updatedPaymentDescription,
            amountPaid: 0, // Zero out for balance calculations
            runningBalance: Math.max(0, newOutstanding),
            isDeleted: true, // Mark as deleted for audit purposes
            deletedDate: Timestamp.now(),
            lastUpdated: Timestamp.now()
          });
        }
      }
      
      console.log('All writes completed successfully');
      
      return {
        procurementId: procurementId,
        deletedGrandTotal: originalGrandTotal,
        supplierId: supplierId,
        supplierName: supplierData.supplierName,
        reference: originalProcurement.reference,
        wasPaid: isPaid,
        finalBalance: newOutstanding
      };
    });
    
    console.log('Transaction completed successfully:', result);
    
    return {
      success: true,
      procurementId: result.procurementId,
      grandTotal: result.deletedGrandTotal, // Keep as grandTotal for compatibility with existing code
      supplierId: result.supplierId,
      supplierName: result.supplierName,
      reference: result.reference,
      wasPaid: result.wasPaid,
      finalBalance: result.finalBalance,
      message: result.wasPaid 
        ? 'Paid procurement deleted successfully. Both purchase and payment entries marked as deleted.'
        : 'Unpaid procurement deleted successfully with proper balance adjustments.'
    };
    
  } catch (error) {
    console.error('Error deleting procurement:', error);
    return {
      success: false,
      error: error.message
    };
  }
};

/**
 * Update procurement payment status
 */
export const updateProcurementPaymentStatus = async (procurementId, paymentData) => {
  try {
    // Use transaction to ensure data consistency
    const result = await runTransaction(db, async (transaction) => {
      // Get procurement document
      const procurementRef = doc(db, 'procurements', procurementId);
      const procurementSnap = await transaction.get(procurementRef);
      
      if (!procurementSnap.exists()) {
        throw new Error('Procurement not found');
      }
      
      const procurementDoc = procurementSnap.data();
      
      // Get supplier document
      const supplierRef = doc(db, 'suppliers', procurementDoc.supplierId);
      const supplierSnap = await transaction.get(supplierRef);
      
      if (!supplierSnap.exists()) {
        throw new Error('Supplier not found');
      }
      
      const supplierData = supplierSnap.data();
      
      // Update procurement payment status
      transaction.update(procurementRef, {
        ...paymentData,
        lastUpdated: Timestamp.now()
      });
      
      // If marking as paid, create payment ledger entry and update balance
      if (paymentData.isPaid && !procurementDoc.isPaid) {
        // Update supplier outstanding balance
        const newOutstanding = (supplierData.totalOutstanding || 0) - procurementDoc.grandTotal;
        transaction.update(supplierRef, {
          totalOutstanding: Math.max(0, newOutstanding), // Ensure balance doesn't go negative
          lastUpdated: Timestamp.now()
        });
        
        // Generate payment reference
        const paymentRef = paymentData.paymentReference || 
          generatePaymentReference();
        
        // Create payment ledger entry
        const paymentLedgerEntry = {
          supplierId: procurementDoc.supplierId,
          supplierName: supplierData.supplierName,
          procurementId: procurementId,
          entryType: 'payment',
          paymentDate: paymentData.paymentDate,
          entryDate: paymentData.paymentDate,
          reference: paymentRef,
          amountDue: 0,
          amountPaid: procurementDoc.grandTotal,
          runningBalance: Math.max(0, newOutstanding),
          description: `Payment for ${procurementDoc.reference || procurementId}`,
          sortOrder: 2,
          dateCreated: Timestamp.now()
        };
        
        const paymentLedgerDocRef = doc(collection(db, 'supplier_ledger'));
        transaction.set(paymentLedgerDocRef, paymentLedgerEntry);
      }
      
      return { procurementId };
    });
    
    return {
      success: true,
      procurementId: result.procurementId,
      message: 'Payment status updated successfully'
    };
    
  } catch (error) {
    console.error('Error updating payment status:', error);
    return {
      success: false,
      error: error.message
    };
  }
};

/**
 * Get procurements by supplier
 */
export const getProcurementsBySupplier = async (supplierId) => {
  try {
    const q = query(
      collection(db, 'procurements'),
      where('supplierId', '==', supplierId),
      orderBy('dateCreated', 'desc')
    );
    
    const querySnapshot = await getDocs(q);
    const procurements = [];
    
    querySnapshot.forEach((doc) => {
      procurements.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    return {
      success: true,
      procurements
    };
  } catch (error) {
    console.error('Error fetching procurements:', error);
    return {
      success: false,
      error: error.message,
      procurements: []
    };
  }
};
{/* Part 4 End - Procurement Operations */}

{/* Part 5 Start - Ledger Operations */}
/* ========== LEDGER OPERATIONS ========== */

/**
 * Get supplier ledger entries
 * Modified to group entries by procurementId so payments always appear below their procurement
 */
export const getSupplierLedger = async (supplierId) => {
  try {
    const q = query(
      collection(db, 'supplier_ledger'),
      where('supplierId', '==', supplierId)
    );
    
    const querySnapshot = await getDocs(q);
    const allEntries = [];
    
    querySnapshot.forEach((doc) => {
      allEntries.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    // Group entries by procurementId
    const entriesByProcurement = {};
    const standaloneEntries = [];
    
    allEntries.forEach(entry => {
      if (entry.procurementId) {
        if (!entriesByProcurement[entry.procurementId]) {
          entriesByProcurement[entry.procurementId] = [];
        }
        entriesByProcurement[entry.procurementId].push(entry);
      } else {
        // Handle entries without procurementId (if any exist)
        standaloneEntries.push(entry);
      }
    });
    
    // Sort entries within each procurement group by sortOrder
    Object.keys(entriesByProcurement).forEach(procurementId => {
      entriesByProcurement[procurementId].sort((a, b) => {
        // First by sortOrder (purchase=1, payment=2)
        if (a.sortOrder !== b.sortOrder) {
          return a.sortOrder - b.sortOrder;
        }
        // Then by date if same sortOrder
        return b.entryDate.localeCompare(a.entryDate);
      });
    });
    
    // Get the procurement entry date and creation time for each group for sorting
    const procurementGroups = Object.keys(entriesByProcurement).map(procurementId => {
      const entries = entriesByProcurement[procurementId];
      const procurementEntry = entries.find(e => e.entryType === 'purchase');
      return {
        procurementId,
        entries,
        // Use dateCreated for true chronological order since entryDate might be same
        dateCreated: procurementEntry ? procurementEntry.dateCreated : entries[0].dateCreated,
        reference: procurementEntry ? procurementEntry.reference : entries[0].reference
      };
    });
    
    // Sort groups by creation time (OLDEST first) - use dateCreated or reference
    procurementGroups.sort((a, b) => {
      // If dateCreated exists and is a Timestamp, use it
      if (a.dateCreated && b.dateCreated && a.dateCreated.seconds && b.dateCreated.seconds) {
        return a.dateCreated.seconds - b.dateCreated.seconds;
      }
      // Otherwise fall back to reference comparison
      return a.reference.localeCompare(b.reference);
    });
    
    // Flatten the sorted groups back into a single array
    const sortedEntries = [];
    procurementGroups.forEach(group => {
      sortedEntries.push(...group.entries);
    });
    
    // Add standalone entries at the end (sorted by date - oldest first)
    standaloneEntries.sort((a, b) => {
      if (a.dateCreated && b.dateCreated && a.dateCreated.seconds && b.dateCreated.seconds) {
        return a.dateCreated.seconds - b.dateCreated.seconds;
      }
      return a.entryDate.localeCompare(b.entryDate);
    });
    sortedEntries.push(...standaloneEntries);
    
    // Calculate running balance based on display order
    let runningBalance = 0;
    sortedEntries.forEach(entry => {
      if (entry.entryType === 'purchase' && !entry.isDeleted) {
        runningBalance += entry.amountDue || 0;
      } else if (entry.entryType === 'payment') {
        runningBalance -= entry.amountPaid || 0;
      }
      entry.runningBalance = Math.max(0, runningBalance);
    });
    
    return {
      success: true,
      ledgerEntries: sortedEntries
    };
  } catch (error) {
    console.error('Error fetching supplier ledger:', error);
    return {
      success: false,
      error: error.message,
      ledgerEntries: []
    };
  }
};

/**
 * Recalculate supplier balance (utility function for data consistency)
 */
export const recalculateSupplierBalance = async (supplierId) => {
  try {
    // Get all ledger entries in display order (grouped by procurement)
    const ledgerResult = await getSupplierLedger(supplierId);
    
    if (!ledgerResult.success) {
      throw new Error(ledgerResult.error);
    }
    
    let totalDue = 0;
    let totalPaid = 0;
    let runningBalance = 0;
    let entriesUpdated = 0;
    
    // Create a batch for efficient updates
    const batch = writeBatch(db);
    
    // Process entries in display order for correct running balance
    for (const entry of ledgerResult.ledgerEntries) {
      if (entry.entryType === 'purchase' && !entry.isDeleted) {
        totalDue += entry.amountDue || 0;
        runningBalance += entry.amountDue || 0;
      } else if (entry.entryType === 'payment') {
        totalPaid += entry.amountPaid || 0;
        runningBalance -= entry.amountPaid || 0;
      }
      
      // Update running balance if different
      const correctBalance = Math.max(0, runningBalance);
      if (entry.runningBalance !== correctBalance) {
        const entryRef = doc(db, 'supplier_ledger', entry.id);
        batch.update(entryRef, {
          runningBalance: correctBalance,
          lastUpdated: Timestamp.now()
        });
        entriesUpdated++;
      }
    }
    
    // Commit batch updates
    if (entriesUpdated > 0) {
      await batch.commit();
    }
    
    const finalBalance = Math.max(0, runningBalance);
    
    // Update supplier document
    await updateDoc(doc(db, 'suppliers', supplierId), {
      totalOutstanding: finalBalance,
      lastUpdated: Timestamp.now()
    });
    
    return {
      success: true,
      totalDue,
      totalPaid,
      finalBalance,
      entriesUpdated
    };
    
  } catch (error) {
    console.error('Error recalculating supplier balance:', error);
    return {
      success: false,
      error: error.message
    };
  }
};

/**
 * Get supplier ledger summary
 */
export const getSupplierLedgerSummary = async (supplierId) => {
  try {
    const ledgerResult = await getSupplierLedger(supplierId);
    
    if (!ledgerResult.success) {
      throw new Error(ledgerResult.error);
    }
    
    const summary = {
      totalDue: 0,
      totalPayments: 0,
      outstandingBalance: 0,
      totalTransactions: ledgerResult.ledgerEntries.length,
      lastPurchaseDate: null,
      lastPaymentDate: null
    };
    
    // Calculate summary from ledger entries
    for (const entry of ledgerResult.ledgerEntries) {
      if (entry.entryType === 'purchase' && !entry.isDeleted) {
        summary.totalDue += entry.amountDue;
        if (!summary.lastPurchaseDate || entry.purchaseDate > summary.lastPurchaseDate) {
          summary.lastPurchaseDate = entry.purchaseDate;
        }
      } else if (entry.entryType === 'payment') {
        summary.totalPayments += entry.amountPaid;
        if (!summary.lastPaymentDate || entry.entryDate > summary.lastPaymentDate) {
          summary.lastPaymentDate = entry.entryDate;
        }
      }
    }
    
    summary.outstandingBalance = summary.totalDue - summary.totalPayments;
    
    return {
      success: true,
      summary
    };
  } catch (error) {
    console.error('Error generating ledger summary:', error);
    return {
      success: false,
      error: error.message
    };
  }
};
{/* Part 5 End - Ledger Operations */}

{/* Part 6 Start - Export Statement */}
/* ========== EXPORT ALL SERVICES ========== */

// Export all functions as a default object for easy importing
export default {
  // Supplier operations
  createSupplier,
  updateSupplier,
  getAllSuppliers,
  getSupplierById,
  
  // Procurement operations
  createProcurement,
  updateProcurement,
  deleteProcurement, // NEW: Delete function added
  updateProcurementPaymentStatus,
  getProcurementsBySupplier,
  
  // Ledger operations
  getSupplierLedger,
  recalculateSupplierBalance,
  getSupplierLedgerSummary,
  
  // Utility functions
  getCurrentDate,
  generateProcurementReference,
  generatePaymentReference
};

/* ========== END OF SUPPLIER SERVICE FILE ========== */
{/* Part 6 End - Export Statement */}
</file>

<file path="src/components/phone-selection/PhoneAdditionalInfo.jsx">
{/* Part 1 Start - Imports and Dependencies */}
import PropTypes from 'prop-types';
{/* Part 1 End - Imports and Dependencies */}

{/* Part 2 Start - Component Definition */}
const PhoneAdditionalInfo = ({
  imei1,
  imei2,
  barcode,
  serialNumber,
  location,
  supplier,
  suppliers,
  status,
  lastUpdated,
  handleImei1Change,
  handleImei2Change,
  handleBarcodeChange,
  handleSerialNumberChange,
  handleLocationChange,
  handleSupplierChange,
  handleStatusChange,
  imei1Error,
  imei2Error,
}) => {
{/* Part 2 End - Component Definition */}

{/* Part 3 Start - Component Render */}
  return (
    <div className="pt-4 border-t border-gray-300 space-y-4">
      <h3 className="text-lg font-semibold text-[rgb(52,69,157)]">Additional Details</h3>
      
      {/* IMEI Fields */}
      <div className="flex gap-4">
        <div className="flex-1 space-y-2">
          <label className="block text-[rgb(52,69,157)] font-semibold">IMEI 1:</label>
          <input 
            type="text" 
            className={`w-full p-2 border rounded ${imei1Error ? 'border-red-500' : ''}`}
            value={imei1}
            onChange={handleImei1Change}
            placeholder="15-digit IMEI number"
            maxLength={15}
            required
          />
          {imei1Error && (
            <p className="text-red-500 text-sm mt-1">{imei1Error}</p>
          )}
        </div>
        <div className="flex-1 space-y-2">
          <label className="block text-[rgb(52,69,157)] font-semibold">IMEI 2:</label>
          <input 
            type="text" 
            className={`w-full p-2 border rounded ${imei2Error ? 'border-red-500' : ''}`}
            value={imei2}
            onChange={handleImei2Change}
            placeholder="Optional"
            maxLength={15}
          />
          {imei2Error && (
            <p className="text-red-500 text-sm mt-1">{imei2Error}</p>
          )}
        </div>
      </div>
      
      {/* Barcode and Serial Number */}
      <div className="flex gap-4">
        <div className="flex-1 space-y-2">
          <label className="block text-[rgb(52,69,157)] font-semibold">Barcode:</label>
          <input 
            type="text" 
            className="w-full p-2 border rounded"
            value={barcode}
            onChange={handleBarcodeChange}
            placeholder="Product barcode"
            required
          />
        </div>
        <div className="flex-1 space-y-2">
          <label className="block text-[rgb(52,69,157)] font-semibold">Serial Number:</label>
          <input 
            type="text" 
            className="w-full p-2 border rounded"
            value={serialNumber}
            onChange={handleSerialNumberChange}
            placeholder="Serial number (optional)"
          />
        </div>
      </div>
      
      {/* Location and Supplier Fields - NEW */}
      <div className="flex gap-4">
        <div className="flex-1 space-y-2">
          <label className="block text-[rgb(52,69,157)] font-semibold">Location:</label>
          <input 
            type="text" 
            className="w-full p-2 border rounded"
            value={location}
            onChange={handleLocationChange}
            placeholder="Enter location"
            required
          />
        </div>
        <div className="flex-1 space-y-2">
          <label className="block text-[rgb(52,69,157)] font-semibold">Supplier:</label>
          <select
            className="w-full p-2 border rounded"
            value={supplier}
            onChange={handleSupplierChange}
            required
          >
            <option value="">-- Select Supplier --</option>
            {suppliers.map(sup => (
              <option key={sup.id} value={sup.id}>
                {sup.supplierName}
              </option>
            ))}
          </select>
        </div>
      </div>
      
      {/* Status and Last Updated Fields */}
      <div className="flex gap-4">
        <div className="flex-1 space-y-2">
          <label className="block text-[rgb(52,69,157)] font-semibold">Status:</label>
          <select
            className="w-full p-2 border rounded"
            value={status}
            onChange={handleStatusChange}
            required
          >
            <option value="On-Hand">Stock</option>
            <option value="On-Display">On-Display</option>
            <option value="Sold">Sold</option>
            <option value="Reserved">Reserved</option>
            <option value="Defective">Defective</option>
          </select>
        </div>
        <div className="flex-1 space-y-2">
          <label className="block text-[rgb(52,69,157)] font-semibold">Last Updated:</label>
          <input 
            type="text" 
            className="w-full p-2 border rounded bg-gray-100"
            value={lastUpdated}
            readOnly
          />
        </div>
      </div>
    </div>
  );
};
{/* Part 3 End - Component Render */}

{/* Part 4 Start - PropTypes Validation */}
PhoneAdditionalInfo.propTypes = {
  imei1: PropTypes.string.isRequired,
  imei2: PropTypes.string.isRequired,
  barcode: PropTypes.string.isRequired,
  serialNumber: PropTypes.string.isRequired,
  location: PropTypes.string.isRequired,
  supplier: PropTypes.string.isRequired,
  suppliers: PropTypes.array.isRequired,
  status: PropTypes.string.isRequired,
  lastUpdated: PropTypes.string.isRequired,
  handleImei1Change: PropTypes.func.isRequired,
  handleImei2Change: PropTypes.func.isRequired,
  handleBarcodeChange: PropTypes.func.isRequired,
  handleSerialNumberChange: PropTypes.func.isRequired,
  handleLocationChange: PropTypes.func.isRequired,
  handleSupplierChange: PropTypes.func.isRequired,
  handleStatusChange: PropTypes.func.isRequired,
  imei1Error: PropTypes.string,
  imei2Error: PropTypes.string
};
{/* Part 4 End - PropTypes Validation */}

{/* Part 5 Start - Export */}
export default PhoneAdditionalInfo;
{/* Part 5 End - Export */}
</file>

<file path="src/components/inventory/InventoryEditForm.jsx">
{/* Part 1 Start - Imports */}
import PropTypes from 'prop-types';
import { RefreshCw, Save, XCircle } from 'lucide-react';
import { useState, useEffect } from 'react';
import supplierService from '../../services/supplierService';
{/* Part 1 End - Imports */}

{/* Part 2 Start - Component Definition */}
const InventoryEditForm = ({ 
  editFormData, 
  handleEditInputChange, 
  handleSaveEdit, 
  handleCancelEdit, 
  itemId, 
  savingItemId 
}) => {
{/* Part 2 End - Component Definition */}

  {/* Part 3 Start - Helper Functions */}
  // State for suppliers list
  const [suppliers, setSuppliers] = useState([]);
  
  // Fetch suppliers when component mounts
  useEffect(() => {
    async function fetchSuppliers() {
      try {
        const result = await supplierService.getAllSuppliers();
        if (result.success) {
          setSuppliers(result.suppliers);
        }
      } catch (error) {
        console.error("Error fetching suppliers:", error);
      }
    }
    
    fetchSuppliers();
  }, []);

  // NEW: Function to format price with currency - read-only display
  const formatPrice = (price) => {
    if (!price && price !== 0) return '-';
    return `${price.toLocaleString()}`;
  };
  {/* Part 3 End - Helper Functions */}

  {/* Part 4 Start - Component Render */}
  return (
    <tr className="hover:bg-gray-50">
      <td className="border px-2 py-3 whitespace-nowrap">
        <input
          type="text"
          name="manufacturer"
          value={editFormData.manufacturer}
          onChange={handleEditInputChange}
          className="w-full p-1 border rounded"
        />
      </td>
      <td className="border px-2 py-3 whitespace-nowrap">
        <input
          type="text"
          name="model"
          value={editFormData.model}
          onChange={handleEditInputChange}
          className="w-full p-1 border rounded"
        />
      </td>
      <td className="border px-2 py-3 whitespace-nowrap">
        <input
          type="text"
          name="ram"
          value={editFormData.ram}
          onChange={handleEditInputChange}
          className="w-full p-1 border rounded"
        />
      </td>
      <td className="border px-2 py-3 whitespace-nowrap">
        <input
          type="text"
          name="storage"
          value={editFormData.storage}
          onChange={handleEditInputChange}
          className="w-full p-1 border rounded"
        />
      </td>
      <td className="border px-2 py-3 whitespace-nowrap">
        <input
          type="text"
          name="color"
          value={editFormData.color}
          onChange={handleEditInputChange}
          className="w-full p-1 border rounded"
        />
      </td>
      <td className="border px-2 py-3 font-mono whitespace-nowrap">
        <input
          type="text"
          name="imei1"
          value={editFormData.imei1}
          onChange={handleEditInputChange}
          className="w-full p-1 border rounded font-mono"
        />
      </td>
      {/* UPDATED: Replaced barcode with serial number */}
      <td className="border px-2 py-3 font-mono whitespace-nowrap">
        <input
          type="text"
          name="serialNumber"
          value={editFormData.serialNumber}
          onChange={handleEditInputChange}
          className="w-full p-1 border rounded font-mono"
          placeholder="N/A"
        />
      </td>
      {/* NEW: Added supplier dropdown */}
      <td className="border px-2 py-3 whitespace-nowrap">
        <select
          name="supplier"
          value={editFormData.supplier}
          onChange={handleEditInputChange}
          className="w-full p-1 border rounded"
        >
          <option value="">N/A</option>
          {suppliers.map(sup => (
            <option key={sup.id} value={sup.id}>
              {sup.supplierName}
            </option>
          ))}
        </select>
      </td>

      {/* NEW: Added retail price column - read-only display */}
      <td className="border px-2 py-3 whitespace-nowrap text-right">
        <span className="text-gray-600 font-medium">
          {formatPrice(editFormData.retailPrice)}
        </span>
      </td>
      <td className="border px-2 py-3 whitespace-nowrap text-xs text-gray-500">
        {new Date().toLocaleDateString('en-US')}
      </td>
      <td className="border px-2 py-3 text-center whitespace-nowrap">
        <select
          name="status"
          value={editFormData.status}
          onChange={handleEditInputChange}
          className="w-full p-1 border rounded text-center"
        >
          <option value="On-Hand">Stock</option>
          <option value="On-Display">On-Display</option>
          <option value="Sold">Sold</option>
          <option value="Reserved">Reserved</option>
          <option value="Defective">Defective</option>
        </select>
      </td>
      <td className="border px-2 py-3 text-center whitespace-nowrap">
        <div className="flex justify-center space-x-2">
          <button
            onClick={() => handleSaveEdit(itemId)}
            disabled={savingItemId === itemId}
            className="p-1 text-green-600 hover:text-green-800"
            title="Save changes"
          >
            {savingItemId === itemId ? (
              <RefreshCw className="h-5 w-5 animate-spin" />
            ) : (
              <Save className="h-5 w-5" />
            )}
          </button>
          <button
            onClick={handleCancelEdit}
            className="p-1 text-red-600 hover:text-red-800"
            title="Cancel edit"
          >
            <XCircle className="h-5 w-5" />
          </button>
        </div>
      </td>
    </tr>
  );
};
{/* Part 4 End - Component Render */}

{/* Part 5 Start - PropTypes Definition */}
InventoryEditForm.propTypes = {
  editFormData: PropTypes.object.isRequired,
  handleEditInputChange: PropTypes.func.isRequired,
  handleSaveEdit: PropTypes.func.isRequired,
  handleCancelEdit: PropTypes.func.isRequired,
  itemId: PropTypes.string.isRequired,
  savingItemId: PropTypes.string
};
{/* Part 5 End - PropTypes Definition */}

{/* Part 6 Start - Export */}
export default InventoryEditForm;
{/* Part 6 End - Export */}
</file>

<file path="src/components/inventory/InventoryFilters.jsx">
{/* Part 1 Start - Imports and Dependencies */}
import PropTypes from 'prop-types';
import { useEffect, useState } from 'react';
import { collection, getDocs, query, where } from 'firebase/firestore';
import { db } from '../../firebase/config';
{/* Part 1 End - Imports and Dependencies */}

{/* Part 2 Start - Component Definition */}
const InventoryFilters = ({ 
  filters, 
  pendingFilters, 
  filterOptions, 
  handleFilterChange,
  allItems
}) => {
{/* Part 2 End - Component Definition */}

{/* Part 3 Start - State Definitions */}
  // State for filtered options based on selections
  const [filteredModels, setFilteredModels] = useState([]);
  const [filteredRams, setFilteredRams] = useState([]);
  const [filteredStorages, setFilteredStorages] = useState([]);
  const [filteredColors, setFilteredColors] = useState([]);
  
  // Loading states
  const [isLoadingModels, setIsLoadingModels] = useState(false);
  const [isLoadingRams, setIsLoadingRams] = useState(false);
  const [isLoadingStorages, setIsLoadingStorages] = useState(false);
  const [isLoadingColors, setIsLoadingColors] = useState(false);
{/* Part 3 End - State Definitions */}

{/* Part 4 Start - Data Loading Functions */}
  // Load models for selected manufacturer from database
  const loadModelsForManufacturer = async (manufacturer) => {
    if (!manufacturer) return;
    
    setIsLoadingModels(true);
    try {
      const inventoryRef = collection(db, 'inventory');
      const q = query(inventoryRef, where("manufacturer", "==", manufacturer));
      const snapshot = await getDocs(q);
      
      // Extract unique models
      const models = [...new Set(
        snapshot.docs.map(doc => doc.data().model)
      )].filter(Boolean).sort();
      
      setFilteredModels(models);
    } catch (error) {
      console.error("Error loading models:", error);
    } finally {
      setIsLoadingModels(false);
    }
  };

  // Load RAM options based on manufacturer and model
  const loadRamOptions = async (manufacturer, model) => {
    if (!manufacturer || !model) return;
    
    setIsLoadingRams(true);
    try {
      const inventoryRef = collection(db, 'inventory');
      const q = query(
        inventoryRef, 
        where("manufacturer", "==", manufacturer),
        where("model", "==", model)
      );
      const snapshot = await getDocs(q);
      
      // Extract unique RAM options
      const rams = [...new Set(
        snapshot.docs.map(doc => doc.data().ram)
      )].filter(Boolean).sort();
      
      setFilteredRams(rams);
    } catch (error) {
      console.error("Error loading RAM options:", error);
    } finally {
      setIsLoadingRams(false);
    }
  };

  // Load storage options based on manufacturer, model, and RAM
  const loadStorageOptions = async (manufacturer, model, ram) => {
    if (!manufacturer || !model) return;
    
    setIsLoadingStorages(true);
    try {
      let q;
      const inventoryRef = collection(db, 'inventory');
      
      if (ram) {
        // If RAM is selected, include it in the query
        q = query(
          inventoryRef, 
          where("manufacturer", "==", manufacturer),
          where("model", "==", model),
          where("ram", "==", ram)
        );
      } else {
        // If RAM is not selected, just filter by manufacturer and model
        q = query(
          inventoryRef, 
          where("manufacturer", "==", manufacturer),
          where("model", "==", model)
        );
      }
      
      const snapshot = await getDocs(q);
      
      // Extract unique storage options
      const storages = [...new Set(
        snapshot.docs.map(doc => doc.data().storage)
      )].filter(Boolean).sort();
      
      setFilteredStorages(storages);
    } catch (error) {
      console.error("Error loading storage options:", error);
    } finally {
      setIsLoadingStorages(false);
    }
  };

  // Load color options based on manufacturer, model, RAM, and storage
  const loadColorOptions = async (manufacturer, model, ram, storage) => {
    if (!manufacturer || !model) return;
    
    setIsLoadingColors(true);
    try {
      let q;
      const inventoryRef = collection(db, 'inventory');
      
      // Build query based on selected filters
      const constraints = [
        where("manufacturer", "==", manufacturer),
        where("model", "==", model)
      ];
      
      if (ram) {
        constraints.push(where("ram", "==", ram));
      }
      
      if (storage) {
        constraints.push(where("storage", "==", storage));
      }
      
      q = query(inventoryRef, ...constraints);
      const snapshot = await getDocs(q);
      
      // Extract unique color options
      const colors = [...new Set(
        snapshot.docs.map(doc => doc.data().color)
      )].filter(Boolean).sort();
      
      setFilteredColors(colors);
    } catch (error) {
      console.error("Error loading color options:", error);
    } finally {
      setIsLoadingColors(false);
    }
  };
{/* Part 4 End - Data Loading Functions */}

{/* Part 5 Start - Effect Hooks */}
  // Update models when manufacturer changes
  useEffect(() => {
    if (filters.manufacturer) {
      if (allItems && allItems.length > 0) {
        // If allItems is populated, filter models from it
        const modelsForManufacturer = [...new Set(
          allItems
            .filter(item => item.manufacturer === filters.manufacturer)
            .map(item => item.model)
        )].sort();
        
        // Only update if we found models
        if (modelsForManufacturer.length > 0) {
          setFilteredModels(modelsForManufacturer);
        } else {
          // If no models found in allItems, load from database
          loadModelsForManufacturer(filters.manufacturer);
        }
      } else {
        // If allItems is not available, load from database
        loadModelsForManufacturer(filters.manufacturer);
      }
    } else {
      // If no manufacturer is selected, show all models
      setFilteredModels(filterOptions.models);
    }
  }, [filters.manufacturer, allItems, filterOptions.models]);

  // Update RAM options when manufacturer and model change
  useEffect(() => {
    if (filters.manufacturer && filters.model) {
      if (allItems && allItems.length > 0) {
        // If allItems is populated, filter RAM options from it
        const ramsForModel = [...new Set(
          allItems
            .filter(item => 
              item.manufacturer === filters.manufacturer && 
              item.model === filters.model
            )
            .map(item => item.ram)
        )].sort();
        
        // Only update if we found RAM options
        if (ramsForModel.length > 0) {
          setFilteredRams(ramsForModel);
        } else {
          // If no RAM options found in allItems, load from database
          loadRamOptions(filters.manufacturer, filters.model);
        }
      } else {
        // If allItems is not available, load from database
        loadRamOptions(filters.manufacturer, filters.model);
      }
    } else {
      // If no manufacturer or model is selected, show all RAM options
      setFilteredRams(filterOptions.rams);
    }
  }, [filters.manufacturer, filters.model, allItems, filterOptions.rams]);

  // Update Storage options when manufacturer, model, and RAM change
  useEffect(() => {
    if (filters.manufacturer && filters.model) {
      if (allItems && allItems.length > 0) {
        // Filter items by current selections
        let filteredItems = allItems.filter(item => 
          item.manufacturer === filters.manufacturer && 
          item.model === filters.model
        );
        
        // If RAM is selected, filter by that too
        if (filters.ram) {
          filteredItems = filteredItems.filter(item => item.ram === filters.ram);
        }
        
        // Extract unique storage options
        const storagesForSelection = [...new Set(
          filteredItems.map(item => item.storage)
        )].sort();
        
        // Only update if we found storage options
        if (storagesForSelection.length > 0) {
          setFilteredStorages(storagesForSelection);
        } else {
          // If no storage options found in allItems, load from database
          loadStorageOptions(filters.manufacturer, filters.model, filters.ram);
        }
      } else {
        // If allItems is not available, load from database
        loadStorageOptions(filters.manufacturer, filters.model, filters.ram);
      }
    } else {
      // If no manufacturer or model is selected, show all storage options
      setFilteredStorages(filterOptions.storages);
    }
  }, [filters.manufacturer, filters.model, filters.ram, allItems, filterOptions.storages]);

  // Update Color options when manufacturer, model, RAM, and storage change
  useEffect(() => {
    if (filters.manufacturer && filters.model) {
      if (allItems && allItems.length > 0) {
        // Filter items by current selections
        let filteredItems = allItems.filter(item => 
          item.manufacturer === filters.manufacturer && 
          item.model === filters.model
        );
        
        // Apply additional filters if selected
        if (filters.ram) {
          filteredItems = filteredItems.filter(item => item.ram === filters.ram);
        }
        
        if (filters.storage) {
          filteredItems = filteredItems.filter(item => item.storage === filters.storage);
        }
        
        // Extract unique color options
        const colorsForSelection = [...new Set(
          filteredItems.map(item => item.color)
        )].sort();
        
        // Only update if we found color options
        if (colorsForSelection.length > 0) {
          setFilteredColors(colorsForSelection);
        } else {
          // If no color options found in allItems, load from database
          loadColorOptions(filters.manufacturer, filters.model, filters.ram, filters.storage);
        }
      } else {
        // If allItems is not available, load from database
        loadColorOptions(filters.manufacturer, filters.model, filters.ram, filters.storage);
      }
    } else {
      // If no manufacturer or model is selected, show all color options
      setFilteredColors(filterOptions.colors);
    }
  }, [
    filters.manufacturer, 
    filters.model, 
    filters.ram, 
    filters.storage, 
    allItems, 
    filterOptions.colors
  ]);
{/* Part 5 End - Effect Hooks */}

{/* Part 6 Start - Component Render */}
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {/* Manufacturer filter */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Manufacturer
        </label>
        <select
          name="manufacturer"
          value={filters.manufacturer}
          onChange={handleFilterChange}
          className="w-full p-2 border rounded"
        >
          <option value="">All Manufacturers</option>
          {filterOptions.manufacturers.map(manufacturer => (
            <option key={manufacturer} value={manufacturer}>
              {manufacturer}
            </option>
          ))}
        </select>
      </div>
      
      {/* Model filter */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Model
        </label>
        <select
          name="model"
          value={filters.model}
          onChange={handleFilterChange}
          className="w-full p-2 border rounded"
          disabled={!filters.manufacturer || isLoadingModels}
        >
          <option value="">All Models</option>
          {isLoadingModels ? (
            <option value="" disabled>Loading models...</option>
          ) : (
            filteredModels.map(model => (
              <option key={model} value={model}>
                {model}
              </option>
            ))
          )}
        </select>
        {isLoadingModels && (
          <p className="text-xs text-gray-500 mt-1">Loading models...</p>
        )}
        {!filters.manufacturer && (
          <p className="text-xs text-gray-500 mt-1">Select manufacturer first</p>
        )}
      </div>
      
      {/* RAM filter */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          RAM
        </label>
        <select
          name="ram"
          value={filters.ram}
          onChange={handleFilterChange}
          className="w-full p-2 border rounded"
          disabled={!filters.manufacturer || !filters.model || isLoadingRams}
        >
          <option value="">All RAM</option>
          {isLoadingRams ? (
            <option value="" disabled>Loading RAM options...</option>
          ) : (
            filteredRams.map(ram => (
              <option key={ram} value={ram}>
                {ram}
              </option>
            ))
          )}
        </select>
        {isLoadingRams && (
          <p className="text-xs text-gray-500 mt-1">Loading RAM options...</p>
        )}
        {(!filters.manufacturer || !filters.model) && (
          <p className="text-xs text-gray-500 mt-1">Select manufacturer and model first</p>
        )}
      </div>
      
      {/* Storage filter */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Storage
        </label>
        <select
          name="storage"
          value={filters.storage}
          onChange={handleFilterChange}
          className="w-full p-2 border rounded"
          disabled={!filters.manufacturer || !filters.model || isLoadingStorages}
        >
          <option value="">All Storage</option>
          {isLoadingStorages ? (
            <option value="" disabled>Loading storage options...</option>
          ) : (
            filteredStorages.map(storage => (
              <option key={storage} value={storage}>
                {storage}
              </option>
            ))
          )}
        </select>
        {isLoadingStorages && (
          <p className="text-xs text-gray-500 mt-1">Loading storage options...</p>
        )}
        {(!filters.manufacturer || !filters.model) && (
          <p className="text-xs text-gray-500 mt-1">Select manufacturer and model first</p>
        )}
      </div>
      
      {/* Status filter */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Status
        </label>
        <select
          name="status"
          value={filters.status}
          onChange={handleFilterChange}
          className="w-full p-2 border rounded"
        >
          <option value="">All Statuses</option>
          {filterOptions.statuses.map(status => (
            <option key={status} value={status}>
              {status}
            </option>
          ))}
        </select>
      </div>
      
      {/* Color filter */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Color
        </label>
        <select
          name="color"
          value={filters.color}
          onChange={handleFilterChange}
          className="w-full p-2 border rounded"
          disabled={!filters.manufacturer || !filters.model || isLoadingColors}
        >
          <option value="">All Colors</option>
          {isLoadingColors ? (
            <option value="" disabled>Loading color options...</option>
          ) : (
            filteredColors.map(color => (
              <option key={color} value={color}>
                {color}
              </option>
            ))
          )}
        </select>
        {isLoadingColors && (
          <p className="text-xs text-gray-500 mt-1">Loading color options...</p>
        )}
        {(!filters.manufacturer || !filters.model) && (
          <p className="text-xs text-gray-500 mt-1">Select manufacturer and model first</p>
        )}
      </div>
      
      {/* IMEI1 with Date Range group */}
      <div className="space-y-4">
        {/* IMEI1 filter */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            IMEI1
          </label>
          <input
            type="text"
            name="imei1"
            value={pendingFilters.imei1}
            onChange={handleFilterChange}
            placeholder="Search IMEI"
            className="w-full p-2 border rounded"
          />
        </div>
        
        {/* Date Range - positioned below IMEI1 */}
        <div className="flex gap-2">
          <div className="flex-1">
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Start Date
            </label>
            <input
              type="date"
              name="startDate"
              value={pendingFilters.startDate}
              onChange={handleFilterChange}
              className="w-full p-2 border rounded"
            />
          </div>
          <div className="flex-1">
            <label className="block text-sm font-medium text-gray-700 mb-1">
              End Date
            </label>
            <input
              type="date"
              name="endDate"
              value={pendingFilters.endDate}
              onChange={handleFilterChange}
              className="w-full p-2 border rounded"
            />
          </div>
        </div>
      </div>
      
      {/* Barcode with Supplier group */}
      <div className="space-y-4">
        {/* Barcode filter */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Barcode
          </label>
          <input
            type="text"
            name="barcode"
            value={pendingFilters.barcode}
            onChange={handleFilterChange}
            placeholder="Search barcode"
            className="w-full p-2 border rounded"
          />
        </div>
        
        {/* Supplier filter - DROPDOWN */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Supplier
          </label>
          <select
            name="supplier"
            value={filters.supplier}
            onChange={handleFilterChange}
            className="w-full p-2 border rounded"
          >
            <option value="">All Suppliers</option>
            {filterOptions.suppliers.map(supplier => (
              <option key={supplier.id} value={supplier.id}>
                {supplier.name}
              </option>
            ))}
          </select>
        </div>
      </div>

      {/* Serial Number with Price Range group */}
      <div className="space-y-4">
        {/* Serial Number filter */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Serial Number
          </label>
          <input
            type="text"
            name="serialNumber"
            value={pendingFilters.serialNumber}
            onChange={handleFilterChange}
            placeholder="Search serial number"
            className="w-full p-2 border rounded"
          />
        </div>
        
        {/* Price Range - positioned below Serial Number */}
        <div className="flex gap-2">
          <div className="flex-1">
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Min Price
            </label>
            <input
              type="text"
              name="minPrice"
              value={pendingFilters.minPrice}
              onChange={handleFilterChange}
              placeholder="0"
              className="w-full p-2 border rounded"
            />
          </div>
          <div className="flex-1">
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Max Price
            </label>
            <input
              type="text"
              name="maxPrice"
              value={pendingFilters.maxPrice}
              onChange={handleFilterChange}
              placeholder="999,999"
              className="w-full p-2 border rounded"
            />
          </div>
        </div>
      </div>
    </div>
  );
};
{/* Part 6 End - Component Render */}

{/* Part 7 Start - PropTypes Validation */}
InventoryFilters.propTypes = {
  filters: PropTypes.object.isRequired,
  pendingFilters: PropTypes.object.isRequired,
  filterOptions: PropTypes.object.isRequired,
  handleFilterChange: PropTypes.func.isRequired,
  allItems: PropTypes.array.isRequired
};
{/* Part 7 End - PropTypes Validation */}

{/* Part 8 Start - Export */}
export default InventoryFilters;
{/* Part 8 End - Export */}
</file>

<file path="src/context/GlobalStateContext.jsx">
{/* Part 1 Start - Imports and Context Creation */}
// src/context/GlobalStateContext.jsx
import PropTypes from 'prop-types';
import { createContext, useState, useContext } from 'react';

// Create context
export const GlobalStateContext = createContext();

// Custom hook for easier context usage
export const useGlobalState = () => useContext(GlobalStateContext);
{/* Part 1 End - Imports and Context Creation */}

{/* Part 2 Start - GlobalStateProvider Component */}
// Create provider
export const GlobalStateProvider = ({ children }) => {
  // ====== STATE DEFINITIONS ======
  const [phoneToEdit, setPhoneToEdit] = useState(null);
  const [procurementToEdit, setProcurementToEdit] = useState(null);
  const [inventoryItemToEdit, setInventoryItemToEdit] = useState(null); // NEW: State for inventory editing
  const [activeComponent, setActiveComponent] = useState('summary');
  const [isViewingProcurement, setIsViewingProcurement] = useState(false); // Track view vs edit mode
  const [procurementMode, setProcurementMode] = useState(''); // NEW: Track procurement mode ('view', 'edit', 'payment')
  const [procurementForReceiving, setProcurementForReceiving] = useState(null); // NEW: State for stock receiving
  
  // ====== PHONE EDITING FUNCTIONS ======
  // Function to set a phone for editing and switch to form
  const editPhone = (phone) => {
    setPhoneToEdit(phone);
    setActiveComponent('form');
  };
  
  // Function to clear the selected phone
  const clearPhoneToEdit = () => {
    setPhoneToEdit(null);
  };
  
  // ====== INVENTORY EDITING FUNCTIONS - NEW ======
  // Function to set an inventory item for editing and switch to selection form
  const editInventoryItem = (item) => {
    setInventoryItemToEdit(item);
    setActiveComponent('selection');
  };
  
  // Function to clear the selected inventory item
  const clearInventoryItemToEdit = () => {
    setInventoryItemToEdit(null);
  };
  
  // ====== PROCUREMENT EDITING FUNCTIONS ======
  // Function to set a procurement for editing and switch to procurement form
  const editProcurement = (procurement) => {
    setProcurementToEdit(procurement);
    setIsViewingProcurement(false); // Set to edit mode
    setProcurementMode('edit'); // NEW: Set mode to edit
    setActiveComponent('procurement');
  };
  
  // Function to set a procurement for viewing (read-only)
  const viewProcurement = (procurement) => {
    setProcurementToEdit(procurement);
    setIsViewingProcurement(true); // Set to view mode
    setProcurementMode('view'); // NEW: Set mode to view
    setActiveComponent('procurement');
  };
  
  // NEW: Function to set a procurement for payment entry
  const paymentProcurement = (procurement) => {
    setProcurementToEdit(procurement);
    setIsViewingProcurement(false); // Not in pure view mode
    setProcurementMode('payment'); // Set mode to payment
    setActiveComponent('procurement');
  };
  
  // NEW: Function to open stock receiving form with procurement data
  const receiveProcurement = (procurement) => {
    setProcurementForReceiving(procurement);
    setActiveComponent('stockreceiving');
  };
  
  // Function to clear the selected procurement
  const clearProcurementToEdit = () => {
    setProcurementToEdit(null);
    setIsViewingProcurement(false); // Reset view mode
    setProcurementMode(''); // NEW: Reset mode
  };
  
  // NEW: Function to clear procurement for receiving
  const clearProcurementForReceiving = () => {
    setProcurementForReceiving(null);
  };
  
  // ====== CONTEXT VALUE OBJECT ======
  // Create a value object with all the state and functions
  const contextValue = {
    phoneToEdit,
    editPhone,
    clearPhoneToEdit,
    inventoryItemToEdit, // NEW: Add inventory item state
    editInventoryItem, // NEW: Add inventory edit function
    clearInventoryItemToEdit, // NEW: Add inventory clear function
    procurementToEdit,
    editProcurement,
    viewProcurement,
    paymentProcurement, // NEW: Add payment function
    receiveProcurement, // NEW: Add receive function
    clearProcurementToEdit,
    isViewingProcurement,
    procurementMode, // NEW: Add procurement mode state
    procurementForReceiving, // NEW: Add procurement for receiving state
    clearProcurementForReceiving, // NEW: Add clear function
    activeComponent,
    setActiveComponent
  };
  
  return (
    <GlobalStateContext.Provider value={contextValue}>
      {children}
    </GlobalStateContext.Provider>
  );
};

// Add prop types for validation
GlobalStateProvider.propTypes = {
  children: PropTypes.node.isRequired
};
{/* Part 2 End - GlobalStateProvider Component */}

{/* Part 3 Start - Export Default Hook */}
// Also provide a default export for the hook for backward compatibility
export default useGlobalState;
{/* Part 3 End - Export Default Hook */}
</file>

<file path="src/App.jsx">
// src/App.jsx
import { useEffect } from 'react';
import PhoneSpecForm from './components/PhoneSpecForm';
import PhoneSelectionForm from './components/phone-selection/PhoneSelectionForm';
import InventoryListForm from './components/InventoryListForm';
import PhoneListForm from './components/PhoneListForm';
import InventorySummaryForm from './components/InventorySummaryForm';
import PriceManagementForm from './components/PriceManagementForm';
import PhoneProcurementForm from './components/PhoneProcurementForm';
import SupplierManagementForm from './components/SupplierManagementForm';
import ProcurementManagementForm from './components/ProcurementManagementForm';
import StockReceivingForm from './components/StockReceivingForm'; // NEW: Added stock receiving import
// Import the hook from our consolidated file
import { useGlobalState } from './context/GlobalStateContext';

function App() {
  const { activeComponent, setActiveComponent, phoneToEdit } = useGlobalState();
  
  // For debugging
  useEffect(() => {
    console.log("App: Active component changed to:", activeComponent);
    console.log("App: phoneToEdit:", phoneToEdit ? phoneToEdit.id : 'none');
  }, [activeComponent, phoneToEdit]);

  return (
    <div className="min-h-screen bg-white">
      <div className="p-4 bg-[rgb(52,69,157)] text-white">
        <div className="max-w-6xl mx-auto flex flex-wrap gap-4">
          <button 
            className={`px-4 py-2 rounded ${activeComponent === 'summary' ? 'bg-white text-[rgb(52,69,157)]' : 'bg-transparent'}`}
            onClick={() => setActiveComponent('summary')}
          >
            Inventory Summary
          </button>
          <button 
            className={`px-4 py-2 rounded ${activeComponent === 'inventory' ? 'bg-white text-[rgb(52,69,157)]' : 'bg-transparent'}`}
            onClick={() => setActiveComponent('inventory')}
          >
            Inventory List
          </button>
          <button 
            className={`px-4 py-2 rounded ${activeComponent === 'selection' ? 'bg-white text-[rgb(52,69,157)]' : 'bg-transparent'}`}
            onClick={() => setActiveComponent('selection')}
          >
            Add Phone Inventory
          </button>
          <button 
            className={`px-4 py-2 rounded ${activeComponent === 'procurement' ? 'bg-white text-[rgb(52,69,157)]' : 'bg-transparent'}`}
            onClick={() => setActiveComponent('procurement')}
          >
            Phone Procurement
          </button>
          <button 
            className={`px-4 py-2 rounded ${activeComponent === 'procurementmgmt' ? 'bg-white text-[rgb(52,69,157)]' : 'bg-transparent'}`}
            onClick={() => setActiveComponent('procurementmgmt')}
          >
            Procurement Management
          </button>
          <button 
            className={`px-4 py-2 rounded ${activeComponent === 'suppliers' ? 'bg-white text-[rgb(52,69,157)]' : 'bg-transparent'}`}
            onClick={() => setActiveComponent('suppliers')}
          >
            Supplier Management
          </button>
          <button 
            className={`px-4 py-2 rounded ${activeComponent === 'form' ? 'bg-white text-[rgb(52,69,157)]' : 'bg-transparent'}`}
            onClick={() => setActiveComponent('form')}
          >
            Add Phone Model
          </button>
          <button 
            className={`px-4 py-2 rounded ${activeComponent === 'phonelist' ? 'bg-white text-[rgb(52,69,157)]' : 'bg-transparent'}`}
            onClick={() => setActiveComponent('phonelist')}
          >
            Phone Models
          </button>
          <button 
            className={`px-4 py-2 rounded ${activeComponent === 'prices' ? 'bg-white text-[rgb(52,69,157)]' : 'bg-transparent'}`}
            onClick={() => setActiveComponent('prices')}
          >
            Price Management
          </button>
        </div>
      </div>
      
      {activeComponent === 'summary' && <InventorySummaryForm />}
      {activeComponent === 'selection' && <PhoneSelectionForm />}
      {activeComponent === 'procurement' && <PhoneProcurementForm />}
      {activeComponent === 'procurementmgmt' && <ProcurementManagementForm />}
      {activeComponent === 'stockreceiving' && <StockReceivingForm />}
      {activeComponent === 'suppliers' && <SupplierManagementForm />}
      {activeComponent === 'form' && <PhoneSpecForm />}
      {activeComponent === 'inventory' && <InventoryListForm />}
      {activeComponent === 'phonelist' && <PhoneListForm />}
      {activeComponent === 'prices' && <PriceManagementForm />}
    </div>
  );
}

export default App;
</file>

<file path="src/components/PhoneProcurementForm.jsx">
{/* Part 1 Start - Imports, State, and Helper Functions */}
import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { collection, getDocs, query, where } from 'firebase/firestore';
import { db } from '../firebase/config';
import { 
  RefreshCw, 
  Plus,
  Minus,
  ShoppingCart,
  Trash2
} from 'lucide-react';
// Import supplier service
import supplierService from '../services/supplierService';
// Import global state for editing functionality
import { useGlobalState } from '../context/GlobalStateContext';

const PhoneProcurementForm = () => {
  // ====== GLOBAL STATE FOR EDITING ======
  const { procurementToEdit, clearProcurementToEdit, isViewingProcurement, procurementMode } = useGlobalState(); // ADDED: procurementMode
  
  // ====== EDITING STATE ======
  const [isEditing, setIsEditing] = useState(false);
  const [editingId, setEditingId] = useState(null);
  
  // ====== STATE DEFINITIONS ======
  // Table data for multiple phone models
  const [procurementItems, setProcurementItems] = useState([]);
  const [nextId, setNextId] = useState(1);
  
  // Current item being added
  const [currentItem, setCurrentItem] = useState({
    id: null,
    manufacturer: '',
    model: '',
    ram: '',
    storage: '',
    color: '',
    quantity: 1,
    dealersPrice: '',
    retailPrice: '',
    totalPrice: 0
  });
  
  // Options from database
  const [manufacturers, setManufacturers] = useState([]);
  const [models, setModels] = useState([]);
  const [rams, setRams] = useState([]);
  const [storages, setStorages] = useState([]);
  const [colors, setColors] = useState([]);
  
  // Supplier management
  const [suppliers, setSuppliers] = useState([]); // Suppliers from Firebase
  const [selectedSupplier, setSelectedSupplier] = useState(''); // Selected supplier ID
  const [selectedSupplierData, setSelectedSupplierData] = useState(null); // Full supplier data
  
  // General procurement details
  const [purchaseDate, setPurchaseDate] = useState('');
  
  // Payment and delivery status - MODIFIED for payment mode
  const [paymentStatus, setPaymentStatus] = useState('unpaid'); // NEW: Added payment status state
  const [datePaid, setDatePaid] = useState(''); // MODIFIED: Now can be updated in payment mode
  const [dateDelivered] = useState(''); // Read-only, empty for new entries
  const [paymentReference, setPaymentReference] = useState('');
  const [bankName, setBankName] = useState('');
  const [bankAccount, setBankAccount] = useState('');
  const [accountPayable, setAccountPayable] = useState('');
  
  // UI state
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isCurrentItemValid, setIsCurrentItemValid] = useState(false);
  
  // State for tracking available colors for each item in the table
  const [itemColorOptions, setItemColorOptions] = useState({});

  // ====== HELPER FUNCTIONS ======
  // Get current date in YYYY-MM-DD format for date input
  const getCurrentDate = () => {
    const today = new Date();
    const year = today.getFullYear();
    const month = (today.getMonth() + 1).toString().padStart(2, '0');
    const day = today.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
  };

  // Format number with commas
  const formatNumberWithCommas = (value) => {
    if (!value && value !== 0) return '';
    return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  };

  // NEW: Format price with commas and two decimal places
  const formatPrice = (value) => {
    if (!value && value !== 0) return '';
    const numValue = parseFloat(value.toString().replace(/,/g, ''));
    if (isNaN(numValue)) return '';
    return numValue.toLocaleString('en-US', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  };

  // NEW: Clean price value by removing commas and formatting characters
  const cleanPriceValue = (value) => {
    return value.replace(/[^\d.]/g, '');
  };

  // Validation function for price - UPDATED to work with formatted prices
  const validatePrice = (value) => {
    return cleanPriceValue(value);
  };

  // Format RAM/Storage with GB suffix
  const formatWithGB = (value) => {
    return value ? `${value}GB` : value;
  };

  // Calculate margin percentage
  const calculateMargin = (dealersPrice, retailPrice) => {
    const dealers = parseFloat(dealersPrice.replace(/,/g, '')) || 0;
    const retail = parseFloat(retailPrice.replace(/,/g, '')) || 0;
    
    if (dealers === 0) return '0.00';
    const margin = ((retail - dealers) / dealers) * 100;
    return margin.toFixed(2);
  };

  // Calculate grand total
  const calculateGrandTotal = () => {
    return procurementItems.reduce((sum, item) => sum + item.totalPrice, 0);
  };

  // Reset current item to initial state
  const resetCurrentItem = () => {
    setCurrentItem({
      id: null,
      manufacturer: '',
      model: '',
      ram: '',
      storage: '',
      color: '',
      quantity: 1,
      dealersPrice: '',
      retailPrice: '',
      totalPrice: 0
    });
  };

  // Reset to create mode function
  const resetToCreateMode = () => {
    clearProcurementToEdit();
    resetForm();
  };

  // Reset form function - UPDATED to include payment fields
  const resetForm = () => {
    setProcurementItems([]);
    setNextId(1);
    resetCurrentItem();
    setPurchaseDate(getCurrentDate());
    setSelectedSupplier('');
    setSelectedSupplierData(null);
    setBankName('');
    setBankAccount('');
    setAccountPayable('');
    setPaymentReference('');
    setPaymentStatus('unpaid'); // NEW: Reset payment status
    setDatePaid(''); // NEW: Reset date paid
    setIsSubmitting(false);
    setIsEditing(false);
    setEditingId(null);
    // Clear global state to prevent persistence
    clearProcurementToEdit();
  };
{/* Part 1 End - Imports, State, and Helper Functions */}

{/* Part 2 Start - Data Fetching and useEffect Hooks with Suppliers */}
  // Initialize purchase date to current date
  useEffect(() => {
    setPurchaseDate(getCurrentDate());
  }, []);

  // Handle editing mode when procurementToEdit changes
  useEffect(() => {
    if (procurementToEdit) {
      setIsEditing(true);
      setEditingId(procurementToEdit.id);
      
      // Calculate account payable: use saved value, or calculate from grand total if zero/empty
      let accountPayableValue = procurementToEdit.accountPayable || '';
      
      // If account payable is zero or empty, calculate it from the procurement's grand total
      // This makes business sense: account payable should be the amount owed for THIS procurement
      if (!accountPayableValue || accountPayableValue === '0' || accountPayableValue === 0) {
        const grandTotal = procurementToEdit.grandTotal || 0;
        accountPayableValue = formatNumberWithCommas(grandTotal.toString());
      }
      
      // Populate form fields with existing procurement data
      setPurchaseDate(procurementToEdit.purchaseDate || getCurrentDate());
      setSelectedSupplier(procurementToEdit.supplierId || '');
      setBankName(procurementToEdit.bankName || '');
      setBankAccount(procurementToEdit.bankAccount || '');
      setAccountPayable(accountPayableValue);
      setPaymentReference(procurementToEdit.paymentReference || '');
      
      // NEW: Set payment-related fields for payment mode
      setPaymentStatus((procurementToEdit.paymentStatus === 'paid' || procurementToEdit.isPaid) ? 'paid' : 'unpaid');
      setDatePaid(procurementToEdit.datePaid || procurementToEdit.paymentDate || '');
      
      // Find and set supplier data WITHOUT triggering auto-populate behavior
      if (procurementToEdit.supplierId && suppliers.length > 0) {
        const supplierData = suppliers.find(s => s.id === procurementToEdit.supplierId);
        setSelectedSupplierData(supplierData || null);
        
        // For existing procurement: preserve bank fields from procurement data, NOT supplier data
        // This prevents overwriting with current supplier info when we want historical data
        if (supplierData) {
          // Only set bank fields if they're empty in procurement data
          if (!procurementToEdit.bankName) {
            setBankName(supplierData.bankName || '');
          }
          if (!procurementToEdit.bankAccount) {
            setBankAccount(supplierData.bankAccount || '');
          }
          // IMPORTANT: Account payable is already set above based on procurement data or calculated from grand total
          // Do NOT auto-populate from supplier's current outstanding balance for existing procurements
        }
      }
      
      // Populate procurement items and fetch colors for each item
      if (procurementToEdit.items && Array.isArray(procurementToEdit.items)) {
        const formattedItems = procurementToEdit.items.map((item, index) => ({
          id: index + 1,
          manufacturer: item.manufacturer || '',
          model: item.model || '',
          ram: item.ram || '',
          storage: item.storage || '',
          color: item.color || '',
          quantity: item.quantity || 1,
          dealersPrice: item.dealersPrice || '',
          retailPrice: item.retailPrice || '',
          totalPrice: item.totalPrice || 0
        }));
        
        setProcurementItems(formattedItems);
        setNextId(formattedItems.length + 1);
        
        // Fetch colors for each existing item
        const fetchColorsForExistingItems = async () => {
          const colorOptionsMap = {};
          
          for (const item of formattedItems) {
            if (item.manufacturer && item.model) {
              try {
                const q = query(
                  collection(db, 'phones'),
                  where('manufacturer', '==', item.manufacturer),
                  where('model', '==', item.model)
                );
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                  const data = querySnapshot.docs[0].data();
                  const colorArray = Array.isArray(data.colors) ? data.colors : [];
                  colorOptionsMap[item.id] = colorArray.sort();
                }
              } catch (error) {
                console.error(`Error fetching colors for ${item.manufacturer} ${item.model}:`, error);
                colorOptionsMap[item.id] = [];
              }
            } else {
              colorOptionsMap[item.id] = [];
            }
          }
          
          // Update itemColorOptions state with all fetched colors
          setItemColorOptions(colorOptionsMap);
        };
        
        // Call the function to fetch colors
        fetchColorsForExistingItems();
      }
    } else {
      // Reset form when not editing
      setIsEditing(false);
      setEditingId(null);
      setProcurementItems([]);
      setNextId(1);
      setItemColorOptions({}); // Clear color options
    }
  }, [procurementToEdit, suppliers]);

  // NEW: Clear payment fields when payment status changes to unpaid
  useEffect(() => {
    if (procurementMode === 'payment' && paymentStatus === 'unpaid') {
      setDatePaid('');
      setPaymentReference('');
    }
  }, [paymentStatus, procurementMode]);

  // Fetch suppliers on component mount
  useEffect(() => {
    const fetchSuppliers = async () => {
      try {
        const supplierResult = await supplierService.getAllSuppliers();
        if (supplierResult.success) {
          setSuppliers(supplierResult.suppliers);
          console.log("Suppliers loaded:", supplierResult.suppliers.length);
        } else {
          setError("Failed to load suppliers");
        }
      } catch (error) {
        console.error("Error fetching suppliers:", error);
        setError("Failed to load suppliers");
      }
    };

    fetchSuppliers();
  }, []);

  // Fetch manufacturers
  useEffect(() => {
    const fetchManufacturers = async () => {
      setLoading(true);
      try {
        const querySnapshot = await getDocs(collection(db, 'phones'));
        const manufacturerSet = new Set();
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          if (data.manufacturer) {
            manufacturerSet.add(data.manufacturer);
          }
        });
        
        setManufacturers(Array.from(manufacturerSet).sort());
      } catch (error) {
        console.error("Error fetching manufacturers:", error);
      } finally {
        setLoading(false);
      }
    };

    fetchManufacturers();
  }, []);

  // Fetch models
  useEffect(() => {
    const fetchModels = async () => {
      if (!currentItem.manufacturer) {
        setModels([]);
        return;
      }
      
      try {
        const q = query(
          collection(db, 'phones'),
          where('manufacturer', '==', currentItem.manufacturer)
        );
        const querySnapshot = await getDocs(q);
        const modelSet = new Set();
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          if (data.model) {
            modelSet.add(data.model);
          }
        });
        
        setModels(Array.from(modelSet).sort());
      } catch (error) {
        console.error("Error fetching models:", error);
      }
    };

    fetchModels();
  }, [currentItem.manufacturer]);

  // Fetch RAM, Storage, Colors from arrays in the document
  useEffect(() => {
    const fetchOptions = async () => {
      if (!currentItem.manufacturer || !currentItem.model) {
        setRams([]);
        setStorages([]);
        setColors([]);
        return;
      }
      
      try {
        const q = query(
          collection(db, 'phones'),
          where('manufacturer', '==', currentItem.manufacturer),
          where('model', '==', currentItem.model)
        );
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
          const data = querySnapshot.docs[0].data();
          
          const ramArray = Array.isArray(data.storage_extra) ? data.storage_extra : [];
          setRams(ramArray.sort());
          
          const storageArray = Array.isArray(data.storage) ? data.storage : [];
          setStorages(storageArray.sort());
          
          const colorArray = Array.isArray(data.colors) ? data.colors : [];
          setColors(colorArray.sort());
        } else {
          setRams([]);
          setStorages([]);
          setColors([]);
        }
      } catch (error) {
        console.error("Error fetching options:", error);
        setRams([]);
        setStorages([]);
        setColors([]);
      }
    };

    fetchOptions();
  }, [currentItem.manufacturer, currentItem.model]);

  // Fetch pricing when complete configuration is selected
  useEffect(() => {
    const fetchPricing = async () => {
      if (!currentItem.manufacturer || !currentItem.model || !currentItem.ram || !currentItem.storage || !currentItem.color) {
        setCurrentItem(prev => ({
          ...prev,
          dealersPrice: '',
          retailPrice: ''
        }));
        return;
      }
      
      try {
        const q = query(
          collection(db, 'price_configurations'),
          where('manufacturer', '==', currentItem.manufacturer),
          where('model', '==', currentItem.model),
          where('ram', '==', currentItem.ram),
          where('storage', '==', currentItem.storage),
          where('color', '==', currentItem.color)
        );
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
          const priceData = querySnapshot.docs[0].data();
          setCurrentItem(prev => ({
            ...prev,
            dealersPrice: priceData.dealersPrice ? priceData.dealersPrice.toString() : '',
            retailPrice: priceData.retailPrice ? priceData.retailPrice.toString() : ''
          }));
        } else {
          setCurrentItem(prev => ({
            ...prev,
            dealersPrice: '',
            retailPrice: ''
          }));
        }
      } catch (error) {
        console.error("Error fetching pricing:", error);
        setCurrentItem(prev => ({
          ...prev,
          dealersPrice: '',
          retailPrice: ''
        }));
      }
    };

    fetchPricing();
  }, [currentItem.manufacturer, currentItem.model, currentItem.ram, currentItem.storage, currentItem.color]);

  // Validate current item and calculate totals
  useEffect(() => {
    const isValid = 
      currentItem.manufacturer &&
      currentItem.model &&
      currentItem.ram &&
      currentItem.storage &&
      currentItem.color &&
      currentItem.quantity > 0 &&
      currentItem.dealersPrice &&
      parseFloat(currentItem.dealersPrice.replace(/,/g, '')) > 0;
    
    setIsCurrentItemValid(isValid);
    
    if (currentItem.dealersPrice && currentItem.quantity) {
      const price = parseFloat(currentItem.dealersPrice.replace(/,/g, '')) || 0;
      const total = price * currentItem.quantity;
      
      setCurrentItem(prev => ({
        ...prev,
        totalPrice: total
      }));
    }
  }, [
    currentItem.manufacturer,
    currentItem.model,
    currentItem.ram,
    currentItem.storage,
    currentItem.color,
    currentItem.quantity,
    currentItem.dealersPrice
  ]);
{/* Part 2 End - Data Fetching and useEffect Hooks with Suppliers */}

{/* Part 3 Start - Event Handlers */}
  // Handle purchase date change
  const handlePurchaseDateChange = (e) => {
    setPurchaseDate(e.target.value);
  };

  // Handle supplier selection - UPDATED: Auto-populate account payable from supplier's outstanding balance (only for new procurement)
  const handleSupplierChange = (e) => {
    const supplierId = e.target.value;
    setSelectedSupplier(supplierId);
    
    if (supplierId) {
      const supplierData = suppliers.find(s => s.id === supplierId);
      setSelectedSupplierData(supplierData);
      
      // Auto-populate bank fields and account payable when supplier is selected
      if (supplierData) {
        setBankName(supplierData.bankName || '');
        setBankAccount(supplierData.bankAccount || '');
        
        // FIXED: Only auto-populate account payable for NEW procurement, not when editing existing ones
        // This preserves the historical account payable value for existing procurements
        if (!isEditing && !procurementToEdit) {
          const outstandingBalance = supplierData.totalOutstanding || 0;
          setAccountPayable(formatNumberWithCommas(outstandingBalance.toString()));
        }
        // For existing procurement: keep the account payable that was already set from procurement data
      }
    } else {
      setSelectedSupplierData(null);
      setBankName('');
      setBankAccount('');
      // Only clear account payable for new procurement, not when editing
      if (!isEditing && !procurementToEdit) {
        setAccountPayable('');
      }
    }
  };

  // Handle current item field changes
  const handleCurrentManufacturerChange = (e) => {
    setCurrentItem(prev => ({
      ...prev,
      manufacturer: e.target.value,
      model: '',
      ram: '',
      storage: '',
      color: ''
    }));
  };

  const handleCurrentModelChange = (e) => {
    setCurrentItem(prev => ({
      ...prev,
      model: e.target.value,
      ram: '',
      storage: '',
      color: ''
    }));
  };

  const handleCurrentRamChange = (e) => {
    setCurrentItem(prev => ({
      ...prev,
      ram: e.target.value,
      storage: '',
      color: ''
    }));
  };

  const handleCurrentStorageChange = (e) => {
    setCurrentItem(prev => ({
      ...prev,
      storage: e.target.value,
      color: ''
    }));
  };

  const handleCurrentColorChange = (e) => {
    setCurrentItem(prev => ({
      ...prev,
      color: e.target.value
    }));
  };

  const handleCurrentQuantityChange = (e) => {
    const quantity = parseInt(e.target.value) || 1;
    setCurrentItem(prev => ({
      ...prev,
      quantity: Math.max(1, quantity)
    }));
  };

  const handleCurrentDealersPriceChange = (e) => {
    const cleanValue = validatePrice(e.target.value);
    setCurrentItem(prev => ({
      ...prev,
      dealersPrice: cleanValue
    }));
  };

  const handleCurrentRetailPriceChange = (e) => {
    const cleanValue = validatePrice(e.target.value);
    setCurrentItem(prev => ({
      ...prev,
      retailPrice: cleanValue
    }));
  };

  // UPDATED: Handle payment reference change - now works in payment mode
  const handlePaymentReferenceChange = (e) => {
    const value = e.target.value;
    // Allow alphanumeric and common reference characters
    const sanitized = value.replace(/[^a-zA-Z0-9-_#/\s]/g, '');
    setPaymentReference(sanitized);
  };

  const handleBankNameChange = (e) => {
    setBankName(e.target.value);
  };

  const handleBankAccountChange = (e) => {
    setBankAccount(e.target.value);
  };

  const handleAccountPayableChange = (e) => {
    setAccountPayable(e.target.value);
  };
{/* Part 3 End - Event Handlers */}

{/* Part 4 Start - Essential Functions */}
  // Helper function to safely parse any price (handles both string and number)
  const safeParsePrice = (price) => {
    if (typeof price === 'number') {
      return price;
    }
    if (typeof price === 'string') {
      return parseFloat(price.replace(/,/g, '')) || 0;
    }
    return 0;
  };

  // Clear all items from procurement list
  const clearAllItems = () => {
    if (window.confirm('Are you sure you want to clear all items from the procurement list?')) {
      setProcurementItems([]);
      resetCurrentItem();
    }
  };

  // Increment current item quantity
  const incrementCurrentQuantity = () => {
    setCurrentItem(prev => ({
      ...prev,
      quantity: prev.quantity + 1
    }));
  };

  // Decrement current item quantity
  const decrementCurrentQuantity = () => {
    setCurrentItem(prev => ({
      ...prev,
      quantity: Math.max(1, prev.quantity - 1)
    }));
  };

  // Increment table item quantity
  const incrementTableQuantity = (itemId) => {
    setProcurementItems(prevItems => 
      prevItems.map(item => 
        item.id === itemId 
          ? { ...item, quantity: item.quantity + 1, totalPrice: (item.quantity + 1) * safeParsePrice(item.dealersPrice) }
          : item
      )
    );
  };

  // Decrement table item quantity (remove if quantity becomes 0)
  const decrementTableQuantity = (itemId) => {
    setProcurementItems(prevItems => 
      prevItems.map(item => 
        item.id === itemId 
          ? item.quantity === 1 
            ? null // Will be filtered out
            : { ...item, quantity: item.quantity - 1, totalPrice: (item.quantity - 1) * safeParsePrice(item.dealersPrice) }
          : item
      ).filter(Boolean) // Remove null items
    );
  };

  // Handle color change in table
  const handleTableColorChange = (itemId, newColor) => {
    setProcurementItems(prevItems => 
      prevItems.map(item => 
        item.id === itemId 
          ? { ...item, color: newColor }
          : item
      )
    );
  };

  // Handle form key events
  const handleKeyDown = (e) => {
    // Allow form submission on Ctrl+Enter
    if (e.ctrlKey && e.key === 'Enter') {
      e.preventDefault();
      if (procurementItems.length > 0 && purchaseDate && selectedSupplier) {
        handleSubmit(e);
      }
    }
  };

  // Add item to procurement table
  const addItemToTable = () => {
    if (!isCurrentItemValid) return;
    
    const dealersPrice = parseFloat(currentItem.dealersPrice.replace(/,/g, '')) || 0;
    const totalPrice = currentItem.quantity * dealersPrice;
    
    const newItem = {
      id: nextId,
      manufacturer: currentItem.manufacturer,
      model: currentItem.model,
      ram: currentItem.ram,
      storage: currentItem.storage,
      color: currentItem.color,
      quantity: currentItem.quantity,
      dealersPrice: formatNumberWithCommas(dealersPrice.toString()),
      retailPrice: currentItem.retailPrice,
      totalPrice: totalPrice
    };
    
    // Store available colors for this item
    setItemColorOptions(prev => ({
      ...prev,
      [nextId]: colors
    }));
    
    setProcurementItems(prev => [...prev, newItem]);
    setNextId(prev => prev + 1);
    resetCurrentItem();
  };

  // NEW: Handle payment update (only saves payment fields)
  const handlePaymentUpdate = async () => {
    try {
      setIsSubmitting(true);
      setError(null);

      console.log('Updating payment details for procurement:', editingId);

      // Prepare payment data
      const paymentData = {
        isPaid: paymentStatus === 'paid',
        paymentStatus: paymentStatus,
        paymentDate: datePaid || null,
        datePaid: datePaid || null,
        paymentReference: paymentReference || null
      };

      // Use supplier service to update payment status
      const result = await supplierService.updateProcurementPaymentStatus(editingId, paymentData);

      if (result.success) {
        console.log('Payment details updated successfully');
        
        // Show success message
        alert(`Payment details updated successfully!\n\nProcurement: ${procurementToEdit?.reference || editingId}\nStatus: ${paymentStatus === 'paid' ? 'PAID' : 'UNPAID'}`);
        
        // Clear the form and return to procurement management
        resetToCreateMode();
      } else {
        setError(`Error updating payment details: ${result.error}`);
      }
    } catch (error) {
      console.error('Error updating payment details:', error);
      setError(`Error updating payment details: ${error.message}`);
    } finally {
      setIsSubmitting(false);
    }
  };
{/* Part 4 End - Essential Functions */}

{/* Part 5 Start - Form Submission with Edit and Create Support */}
  // Handle form submission with supplier service for proper balance updates
  const handleSubmit = async (e) => {
    e.preventDefault();
    
    // Validation
    if (procurementItems.length === 0) {
      alert('Please add at least one phone model to the procurement list');
      return;
    }
    
    if (!purchaseDate) {
      alert('Please enter the purchase date');
      return;
    }
    
    // Supplier validation - Required for saving
    if (!selectedSupplier) {
      alert('Please select a supplier before saving the procurement record');
      return;
    }
    
    setIsSubmitting(true);
    
    try {
      const grandTotal = calculateGrandTotal();
      
      // Prepare procurement data
      const procurementData = {
        // Items array - using safe parsing for both dealersPrice and retailPrice
        items: procurementItems.map(item => ({
          manufacturer: item.manufacturer,
          model: item.model,
          ram: item.ram,
          storage: item.storage,
          color: item.color,
          quantity: item.quantity,
          dealersPrice: safeParsePrice(item.dealersPrice),
          retailPrice: safeParsePrice(item.retailPrice),
          totalPrice: item.totalPrice
        })),
        
        // Summary data
        totalQuantity: procurementItems.reduce((sum, item) => sum + item.quantity, 0),
        grandTotal: grandTotal,
        
        // Procurement details
        purchaseDate: purchaseDate,
        paymentStatus: 'pending',
        deliveryStatus: 'pending',
        paymentReference: paymentReference || '',
        bankName: bankName || '',
        bankAccount: bankAccount || '',
        accountPayable: accountPayable || ''
      };
      
      if (isEditing) {
        // UPDATE EXISTING PROCUREMENT WITH PROPER BALANCE MANAGEMENT
        console.log("Updating procurement with supplier service:", editingId, procurementData);
        
        const result = await supplierService.updateProcurement(
          editingId, 
          procurementData, 
          selectedSupplier
        );
        
        if (result.success) {
          console.log("Procurement updated successfully:", result);
          
          // Clear editing state
          clearProcurementToEdit();
          
          // Detailed success message
          let message = `Procurement record updated successfully!\n\n`;
          message += `Procurement ID: ${editingId}\n`;
          message += `Supplier: ${selectedSupplierData?.supplierName}\n`;
          message += `Total Items: ${procurementData.items.length}\n`;
          message += `Total Quantity: ${procurementData.totalQuantity}\n`;
          message += `Grand Total: ${formatPrice(grandTotal.toString())}\n`;
          
          if (result.supplierChanged) {
            message += `\n Supplier was changed - balances updated accordingly`;
          }
          
          if (result.grandTotalDifference !== 0) {
            const diffType = result.grandTotalDifference > 0 ? 'increased' : 'decreased';
            const diffAmount = Math.abs(result.grandTotalDifference);
            message += `\n Grand total ${diffType} by ${formatPrice(diffAmount.toString())}`;
            message += `\n Supplier balance updated automatically`;
          }
          
          alert(message);
          
          // Reset form
          resetForm();
          
        } else {
          console.error("Error updating procurement:", result.error);
          alert(`Error updating procurement: ${result.error}`);
        }
        
      } else {
        // CREATE NEW PROCUREMENT (existing logic)
        console.log("Creating new procurement with supplier service:", procurementData);
        
        const result = await supplierService.createProcurement(procurementData, selectedSupplier);
        
        if (result.success) {
          console.log("Procurement created successfully:", result);
          
          // Success message
          alert(`Procurement record saved successfully!\n\nProcurement ID: ${result.procurementId}\nReference: ${result.reference}\nSupplier: ${selectedSupplierData?.supplierName}\nTotal Items: ${procurementData.items.length}\nTotal Quantity: ${procurementData.totalQuantity}\nGrand Total: ${formatPrice(grandTotal.toString())}`);
          
          // Reset form
          resetForm();
          
        } else {
          console.error("Error creating procurement:", result.error);
          alert(`Error creating procurement: ${result.error}`);
        }
      }
      
    } catch (error) {
      console.error("Error in handleSubmit:", error);
      alert(`Error submitting form: ${error.message}`);
    } finally {
      setIsSubmitting(false);
    }
  };
{/* Part 5 End - Form Submission with Edit and Create Support */}

{/* Part 6 Start - Loading States and Form Start */}
  // Show loading state ONLY when actually loading
  if (loading) {
    return (
      <div className="min-h-screen bg-white p-4">
        <Card className="w-full max-w-6xl mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
          <CardHeader className="bg-[rgb(52,69,157)] py-3">
            <CardTitle className="text-2xl text-white flex items-center">
              <ShoppingCart className="h-6 w-6 mr-2" />
              Phone Procurement
            </CardTitle>
          </CardHeader>
          <CardContent className="p-4">
            <div className="text-center py-12">
              <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[rgb(52,69,157)]"></div>
              <p className="mt-2 text-gray-600">Loading form data...</p>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  
  // Show error state
  if (error) {
    return (
      <div className="min-h-screen bg-white p-4">
        <Card className="w-full max-w-6xl mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
          <CardHeader className="bg-red-600 py-3">
            <CardTitle className="text-2xl text-white flex items-center">
              <ShoppingCart className="h-6 w-6 mr-2" />
              Error
            </CardTitle>
          </CardHeader>
          <CardContent className="p-4">
            <p className="text-red-600">{error}</p>
            <button 
              onClick={() => window.location.reload()}
              className="mt-4 px-4 py-2 bg-[rgb(52,69,157)] text-white rounded flex items-center"
            >
              <RefreshCw className="h-4 w-4 mr-2" />
              Retry
            </button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white p-4">
      <form onSubmit={handleSubmit} onKeyDown={handleKeyDown}>
        <Card className="w-full max-w-6xl mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
          <CardHeader className="bg-[rgb(52,69,157)] py-3">
            <div className="flex justify-between items-center">
              <CardTitle className="text-2xl text-white flex items-center">
                <ShoppingCart className="h-6 w-6 mr-2" />
                {procurementMode === 'payment' 
                  ? `Enter Payment Details - ${procurementToEdit?.reference || procurementToEdit?.id}`
                  : isViewingProcurement 
                    ? `View Phone Procurement - ${procurementToEdit?.reference || procurementToEdit?.id}`
                    : (isEditing || procurementToEdit) 
                      ? `Edit Phone Procurement - ${procurementToEdit?.reference || editingId}` 
                      : 'Phone Procurement'}
              </CardTitle>
              
              {/* Cancel Edit Button */}
              {(isEditing || procurementToEdit) && (
                <button
                  type="button"
                  onClick={resetToCreateMode}
                  className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 flex items-center text-sm"
                  title={procurementMode === 'payment' 
                    ? "Close payment entry and return to procurement management" 
                    : isViewingProcurement 
                      ? "Close view and return to create mode" 
                      : "Cancel editing and return to create mode"}
                >
                   {procurementMode === 'payment' 
                    ? 'Close Payment' 
                    : isViewingProcurement 
                      ? 'Close' 
                      : 'Cancel Edit'}
                </button>
              )}
            </div>
          </CardHeader>

          <CardContent className="bg-white p-4 space-y-6">
{/* Part 6 End - Loading States and Form Start */}

{/* Part 7 Start - Procurement Details Section */}
            {/* Procurement Details Section */}
            <div className="space-y-4">
              <h3 className="text-lg font-semibold text-[rgb(52,69,157)]">Procurement Details</h3>
              
              {/* First Row: Purchase Date, Supplier, Bank Name, Bank Account, Account Payable */}
              <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                {/* Purchase Date */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Purchase Date:</label>
                  <input 
                    type="date" 
                    className="w-full p-2 border rounded text-sm h-10 disabled:bg-gray-100 disabled:text-gray-500"
                    value={purchaseDate}
                    onChange={handlePurchaseDateChange}
                    disabled={isViewingProcurement || procurementMode === 'payment'}
                    required
                  />
                </div>

                {/* Supplier - Dropdown */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Supplier:</label>
                  <select 
                    className="w-full p-2 border rounded text-sm h-10 disabled:bg-gray-100 disabled:text-gray-500"
                    value={selectedSupplier}
                    onChange={handleSupplierChange}
                    disabled={isViewingProcurement || procurementMode === 'payment'}
                    required
                  >
                    <option value="">-- Select Supplier --</option>
                    {suppliers.map(supplier => (
                      <option key={supplier.id} value={supplier.id}>
                        {supplier.supplierName}
                      </option>
                    ))}
                  </select>
                </div>

                {/* Bank Name - DISABLED */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Bank Name:</label>
                  <input 
                    type="text" 
                    className="w-full p-2 border rounded text-sm h-10 disabled:bg-gray-100 disabled:text-gray-400"
                    value={bankName}
                    onChange={handleBankNameChange}
                    placeholder="Bank name"
                    disabled={true}
                  />
                </div>

                {/* Bank Account - DISABLED */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Bank Account:</label>
                  <input 
                    type="text" 
                    className="w-full p-2 border rounded text-sm h-10 disabled:bg-gray-100 disabled:text-gray-400"
                    value={bankAccount}
                    onChange={handleBankAccountChange}
                    placeholder="Account number"
                    disabled={true}
                  />
                </div>

                {/* Account Payable - DISABLED */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Account Payable:</label>
                  <input 
                    type="text" 
                    className="w-full p-2 border rounded text-sm h-10 disabled:bg-gray-100 disabled:text-gray-400"
                    value={accountPayable}
                    onChange={handleAccountPayableChange}
                    placeholder="Payable amount"
                    disabled={true}
                  />
                </div>
              </div>

              {/* Second Row: Payment Status, Date Paid, Payment Reference, Delivery Status, Date Delivered */}
              <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                {/* Payment Status - ENHANCED with color styling */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Payment Status:</label>
                  <select 
                    className={`w-full p-2 border rounded text-sm h-10 font-medium ${
                      procurementMode === 'payment' 
                        ? paymentStatus === 'paid' 
                          ? 'bg-green-100 text-green-800 border-green-300' 
                          : 'bg-red-100 text-red-800 border-red-300'
                        : 'bg-gray-100 text-gray-400'
                    }`}
                    value={paymentStatus}
                    onChange={(e) => setPaymentStatus(e.target.value)}
                    disabled={procurementMode !== 'payment'}
                  >
                    <option value="unpaid">Unpaid</option>
                    <option value="paid">Paid</option>
                  </select>
                </div>

                {/* Date Paid - ENABLED only when payment status is 'paid' in payment mode */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Date Paid:</label>
                  <input 
                    type="date" 
                    className={`w-full p-2 border rounded text-sm h-10 ${
                      procurementMode === 'payment' && paymentStatus === 'paid'
                        ? 'bg-white text-black' 
                        : 'bg-gray-100 text-gray-400'
                    }`}
                    value={datePaid}
                    onChange={(e) => setDatePaid(e.target.value)}
                    disabled={procurementMode !== 'payment' || paymentStatus !== 'paid'}
                  />
                </div>

                {/* Payment Reference - ENABLED only when payment status is 'paid' in payment mode */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Payment Reference:</label>
                  <input 
                    type="text" 
                    className={`w-full p-2 border rounded text-sm h-10 ${
                      procurementMode === 'payment' && paymentStatus === 'paid'
                        ? 'bg-white text-black' 
                        : 'bg-gray-100 text-gray-400'
                    }`}
                    value={paymentReference}
                    onChange={handlePaymentReferenceChange}
                    placeholder="Payment reference"
                    disabled={procurementMode !== 'payment' || paymentStatus !== 'paid'}
                  />
                </div>

                {/* Delivery Status - Read-only */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Delivery Status:</label>
                  <input 
                    type="text" 
                    className="w-full p-2 border rounded text-sm h-10 bg-gray-100 text-gray-400"
                    value="Pending"
                    disabled={true}
                  />
                </div>

                {/* Date Delivered - Read-only */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Date Delivered:</label>
                  <input 
                    type="date" 
                    className="w-full p-2 border rounded text-sm h-10 bg-gray-100 text-gray-400"
                    value={dateDelivered}
                    disabled={true}
                  />
                </div>
              </div>
            </div>
{/* Part 7 End - Procurement Details Section */}

{/* Part 8 Start - Phone Selection Section */}
            {/* Phone Selection Section */}
            <div className="space-y-4">
              <h3 className="text-lg font-semibold text-[rgb(52,69,157)]">Add Phone to Procurement</h3>
              
              {/* First Row: Manufacturer, Model, RAM, Storage, Color */}
              <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                {/* Manufacturer */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Manufacturer:</label>
                  <select 
                    className="w-full p-2 border rounded text-sm h-10 disabled:bg-gray-100 disabled:text-gray-500"
                    value={currentItem.manufacturer}
                    onChange={handleCurrentManufacturerChange}
                    disabled={isViewingProcurement || procurementMode === 'payment'}
                  >
                    <option value="">-- Select Manufacturer --</option>
                    {manufacturers.map(manufacturer => (
                      <option key={manufacturer} value={manufacturer}>
                        {manufacturer}
                      </option>
                    ))}
                  </select>
                </div>

                {/* Model */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Model:</label>
                  <select 
                    className="w-full p-2 border rounded text-sm h-10 disabled:bg-gray-100 disabled:text-gray-500"
                    value={currentItem.model}
                    onChange={handleCurrentModelChange}
                    disabled={isViewingProcurement || procurementMode === 'payment' || !currentItem.manufacturer}
                  >
                    <option value="">-- Select Model --</option>
                    {models.map(model => (
                      <option key={model} value={model}>
                        {model}
                      </option>
                    ))}
                  </select>
                </div>

                {/* RAM */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">RAM:</label>
                  <select 
                    className="w-full p-2 border rounded text-sm h-10 disabled:bg-gray-100 disabled:text-gray-500"
                    value={currentItem.ram}
                    onChange={handleCurrentRamChange}
                    disabled={isViewingProcurement || procurementMode === 'payment' || !currentItem.model}
                  >
                    <option value="">-- Select RAM --</option>
                    {rams.map(ram => (
                      <option key={ram} value={ram}>
                        {formatWithGB(ram)}
                      </option>
                    ))}
                  </select>
                </div>

                {/* Storage */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Storage:</label>
                  <select 
                    className="w-full p-2 border rounded text-sm h-10 disabled:bg-gray-100 disabled:text-gray-500"
                    value={currentItem.storage}
                    onChange={handleCurrentStorageChange}
                    disabled={isViewingProcurement || procurementMode === 'payment' || !currentItem.ram}
                  >
                    <option value="">-- Select Storage --</option>
                    {storages.map(storage => (
                      <option key={storage} value={storage}>
                        {formatWithGB(storage)}
                      </option>
                    ))}
                  </select>
                </div>

                {/* Color */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Color:</label>
                  <select 
                    className="w-full p-2 border rounded text-sm h-10 disabled:bg-gray-100 disabled:text-gray-500"
                    value={currentItem.color}
                    onChange={handleCurrentColorChange}
                    disabled={isViewingProcurement || procurementMode === 'payment' || !currentItem.storage}
                  >
                    <option value="">-- Select Color --</option>
                    {colors.map(color => (
                      <option key={color} value={color}>
                        {color}
                      </option>
                    ))}
                  </select>
                </div>
              </div>

              {/* Second Row: Quantity, Dealers Price, Retail Price, Total Price, Margin % + Action */}
              <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                {/* Quantity - REMOVED required */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Quantity:</label>
                  <div className="flex items-center gap-1">
                    <button
                      type="button"
                      onClick={decrementCurrentQuantity}
                      disabled={currentItem.quantity <= 1 || isViewingProcurement || procurementMode === 'payment'}
                      className="w-10 h-10 border rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                    >
                      <Minus className="h-3 w-3" />
                    </button>
                    <input 
                      type="number" 
                      className="w-32 p-2 border rounded text-center text-sm h-10 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none disabled:bg-gray-100 disabled:text-gray-500"
                      value={currentItem.quantity}
                      onChange={handleCurrentQuantityChange}
                      disabled={isViewingProcurement || procurementMode === 'payment'}
                      min="1"
                    />
                    <button
                      type="button"
                      onClick={incrementCurrentQuantity}
                      disabled={isViewingProcurement || procurementMode === 'payment'}
                      className="w-10 h-10 border rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                    >
                      <Plus className="h-3 w-3" />
                    </button>
                  </div>
                </div>

                {/* Dealers Price - UPDATED with formatted display */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Dealer&apos;s Price:</label>
                  <div className="relative">
                    <span className="absolute left-2 top-2 text-gray-500 text-sm"></span>
                    <input 
                      type="text" 
                      className="w-full p-2 pl-6 border rounded text-sm disabled:bg-gray-100 disabled:text-gray-500"
                      value={currentItem.dealersPrice ? formatNumberWithCommas(currentItem.dealersPrice) : ''}
                      onChange={handleCurrentDealersPriceChange}
                      disabled={isViewingProcurement || procurementMode === 'payment'}
                      placeholder="0.00"
                    />
                  </div>
                </div>

                {/* Retail Price - UPDATED with formatted display */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Retail Price:</label>
                  <div className="relative">
                    <span className="absolute left-2 top-2 text-gray-500 text-sm"></span>
                    <input 
                      type="text" 
                      className="w-full p-2 pl-6 border rounded text-sm disabled:bg-gray-100 disabled:text-gray-500"
                      value={currentItem.retailPrice ? formatNumberWithCommas(currentItem.retailPrice) : ''}
                      onChange={handleCurrentRetailPriceChange}
                      disabled={isViewingProcurement || procurementMode === 'payment'}
                      placeholder="0.00"
                    />
                  </div>
                </div>

                {/* Total Price - Auto-calculated, disabled */}
                <div className="space-y-2">
                  <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Total Price:</label>
                  <div className="relative">
                    <span className="absolute left-2 top-2 text-gray-500 text-sm"></span>
                    <input 
                      type="text" 
                      className="w-full p-2 pl-6 border rounded text-sm bg-gray-100 text-gray-400"
                      value={currentItem.dealersPrice && currentItem.quantity 
                        ? formatPrice((parseFloat(currentItem.dealersPrice.replace(/,/g, '')) * currentItem.quantity).toString())
                        : '0.00'}
                      disabled={true}
                      readOnly
                    />
                  </div>
                </div>

                {/* Right Column: Margin and Action */}
                <div className="flex gap-2">
                  <div className="flex-1 space-y-2">
                    <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Margin:</label>
                    <input 
                      type="text" 
                      className="w-full p-2 border rounded text-sm bg-gray-100 text-gray-400 text-center"
                      value={currentItem.dealersPrice && currentItem.retailPrice 
                        ? `${calculateMargin(currentItem.dealersPrice, currentItem.retailPrice)}%` : '0.00%'}
                      disabled={true}
                      readOnly
                    />
                  </div>
                  <div className="flex-1 space-y-2">
                    <label className="block text-[rgb(52,69,157)] font-semibold text-sm">Action:</label>
                    <button
                      type="button"
                      onClick={addItemToTable}
                      disabled={!isCurrentItemValid || isViewingProcurement || procurementMode === 'payment'}
                      className="w-full py-2 bg-[rgb(52,69,157)] text-white rounded hover:bg-[rgb(52,69,157)]/90 disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center justify-center"
                    >
                      <Plus className="h-4 w-4 mr-1" />
                      Add
                    </button>
                  </div>
                </div>
              </div>
            </div>
{/* Part 8 End - Phone Selection Section */}

{/* Part 9 Start - Procurement Table */}
            {/* Section Divider */}
            <div className="border-t border-gray-300 my-6"></div>

            {/* Procurement Table Section */}
            <div className="space-y-4">
              <div className="flex justify-between items-center">
                <h3 className="text-lg font-semibold text-[rgb(52,69,157)]">
                  Procurement List ({procurementItems.length} items)
                </h3>
                {procurementItems.length > 0 && !isViewingProcurement && procurementMode !== 'payment' && (
                  <button
                    type="button"
                    onClick={clearAllItems}
                    className="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200 flex items-center"
                  >
                    <Trash2 className="h-4 w-4 mr-1" />
                    Clear All
                  </button>
                )}
              </div>

              {procurementItems.length === 0 ? (
                <div className="text-center py-8 text-gray-500 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                  <p className="text-lg font-medium">No items in procurement list</p>
                  <p className="text-sm">Add phones using the form above</p>
                </div>
              ) : (
                <div className="overflow-x-auto border rounded-lg">
                  <table className="w-full border-collapse text-sm">
                    <thead>
                      <tr className="bg-gray-100">
                        <th className="border px-3 py-3 text-left font-semibold">Manufacturer</th>
                        <th className="border px-3 py-3 text-left font-semibold">Model</th>
                        <th className="border px-3 py-3 text-center font-semibold">RAM</th>
                        <th className="border px-3 py-3 text-center font-semibold">Storage</th>
                        <th className="border px-3 py-3 text-center font-semibold">Color</th>
                        <th className="border px-3 py-3 text-center font-semibold">Qty</th>
                        <th className="border px-3 py-3 text-right font-semibold">Dealer&apos;s Price</th>
                        <th className="border px-3 py-3 text-right font-semibold">Total Price</th>
                      </tr>
                    </thead>
                    <tbody>
                      {procurementItems.map((item) => (
                        <tr key={item.id} className="hover:bg-gray-50">
                          <td className="border px-3 py-2 text-left">{item.manufacturer}</td>
                          <td className="border px-3 py-2 text-left">{item.model}</td>
                          <td className="border px-3 py-2 text-center">{formatWithGB(item.ram)}</td>
                          <td className="border px-3 py-2 text-center">{formatWithGB(item.storage)}</td>
                          <td className="border px-3 py-2 text-center">
                            {isViewingProcurement || procurementMode === 'payment' ? (
                              <span className="inline-block px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs">
                                {item.color}
                              </span>
                            ) : (
                              <select 
                                value={item.color}
                                onChange={(e) => handleTableColorChange(item.id, e.target.value)}
                                className="w-full p-1 border rounded text-xs text-center"
                              >
                                {(itemColorOptions[item.id] || []).map(color => (
                                  <option key={color} value={color}>{color}</option>
                                ))}
                              </select>
                            )}
                          </td>
                          <td className="border px-3 py-2 text-center">
                            {isViewingProcurement || procurementMode === 'payment' ? (
                              <span className="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium min-w-[2rem] text-center">
                                {item.quantity}
                              </span>
                            ) : (
                              <div className="flex items-center justify-center gap-1">
                                <button
                                  type="button"
                                  onClick={() => decrementTableQuantity(item.id)}
                                  disabled={isViewingProcurement || procurementMode === 'payment'}
                                  className="w-6 h-6 border rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center text-xs"
                                  title={item.quantity === 1 ? "Remove item" : "Decrease quantity"}
                                >
                                  <Minus className="h-3 w-3" />
                                </button>
                                <span className="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium min-w-[2rem] text-center">
                                  {item.quantity}
                                </span>
                                <button
                                  type="button"
                                  onClick={() => incrementTableQuantity(item.id)}
                                  disabled={isViewingProcurement || procurementMode === 'payment'}
                                  className="w-6 h-6 border rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center text-xs"
                                  title="Increase quantity"
                                >
                                  <Plus className="h-3 w-3" />
                                </button>
                              </div>
                            )}
                          </td>
                          <td className="border px-3 py-2 text-right font-mono">
                            {formatPrice(item.dealersPrice)}
                          </td>
                          <td className="border px-3 py-2 text-right font-mono font-medium">
                            {formatPrice(item.totalPrice.toString())}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                    <tfoot>
                      <tr className="bg-blue-50 font-semibold">
                        <td colSpan="5" className="border px-3 py-2 text-right">Total Items:</td>
                        <td className="border px-3 py-2 text-center font-mono">
                          {procurementItems.reduce((sum, item) => sum + item.quantity, 0)}
                        </td>
                        <td className="border px-3 py-2 text-right">Grand Total:</td>
                        <td className="border px-3 py-2 text-right font-mono text-lg">
                          {formatPrice(calculateGrandTotal().toString())}
                        </td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              )}
            </div>
{/* Part 9 End - Procurement Table */}

{/* Part 10 Start - Summary and Submit Button */}
            {/* Procurement Summary Section */}
            {procurementItems.length > 0 && (
              <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 mb-4">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">Procurement Summary</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="bg-white rounded-lg p-4 border border-blue-100 shadow-sm">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600 font-medium">Unique Models</p>
                        <p className="text-xs text-gray-500">Different phone configurations</p>
                      </div>
                      <div className="text-right">
                        <p className="text-xl font-bold text-blue-600">
                          {procurementItems.length}
                        </p>
                        <p className="text-xs text-gray-500">models</p>
                      </div>
                    </div>
                  </div>
                  
                  <div className="bg-white rounded-lg p-4 border border-green-100 shadow-sm">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600 font-medium">Total Units</p>
                        <p className="text-xs text-gray-500">Combined quantity ordered</p>
                      </div>
                      <div className="text-right">
                        <p className="text-xl font-bold text-green-600">
                          {procurementItems.reduce((sum, item) => sum + item.quantity, 0)}
                        </p>
                        <p className="text-xs text-gray-500">units</p>
                      </div>
                    </div>
                  </div>
                  
                  <div className="bg-white rounded-lg p-4 border border-purple-100 shadow-sm">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600 font-medium">Grand Total</p>
                        <p className="text-xs text-gray-500">Total procurement cost</p>
                      </div>
                      <div className="text-right">
                        <p className="text-xl font-bold text-purple-600">
                          {formatPrice(calculateGrandTotal().toString())}
                        </p>
                        <p className="text-xs text-gray-500">total cost</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Submit Button - Different for payment mode */}
            {!isViewingProcurement && (
              <div className="pt-4">
                {procurementMode === 'payment' ? (
                  <button
                    type="button"
                    onClick={handlePaymentUpdate}
                    disabled={isSubmitting}
                    className="w-full py-3 bg-green-600 text-white rounded hover:bg-green-700 flex items-center justify-center font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {isSubmitting ? (
                      <>
                        <RefreshCw className="animate-spin h-5 w-5 mr-2" />
                        Saving Payment Details...
                      </>
                    ) : (
                      'Save Payment Details'
                    )}
                  </button>
                ) : (
                  <button
                    type="submit"
                    className="w-full py-3 bg-[rgb(52,69,157)] text-white rounded hover:bg-[rgb(52,69,157)]/90 flex items-center justify-center font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled={
                      procurementItems.length === 0 || 
                      isSubmitting || 
                      !purchaseDate || 
                      !selectedSupplier
                    }
                  >
                    {isSubmitting ? (
                      <>
                        <RefreshCw className="animate-spin h-5 w-5 mr-2" />
                        {isEditing ? 'Updating Procurement...' : 'Saving Procurement...'}
                      </>
                    ) : (
                      <>
                        <ShoppingCart className="h-5 w-5 mr-2" />
                        {isEditing ? `Update Procurement Record (${procurementItems.length} items)` : `Save Procurement Record (${procurementItems.length} items)`}
                      </>
                    )}
                  </button>
                )}
              </div>
            )}
          </CardContent>
        </Card>
      </form>
    </div>
  );
};

export default PhoneProcurementForm;
{/* Part 10 End - Summary and Submit Button */}
</file>

<file path="src/components/StockReceivingForm.jsx">
{/* Part 1 Start - Imports and Component Definition */}
import { useState, useEffect, useMemo } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { 
  Package, 
  Calendar, 
  Building2,
  MapPin,
  X,
  CheckCircle,
  Loader
} from 'lucide-react';
import { useGlobalState } from '../context/GlobalStateContext';
import { 
  collection, 
  query, 
  where, 
  getDocs, 
  limit,
  doc,
  writeBatch,
  runTransaction,
  increment
} from 'firebase/firestore';
import { db } from '../firebase/config';
import { checkDuplicateImeis } from './phone-selection/services/InventoryService';
import { createInventoryId, getCurrentDate } from './phone-selection/utils/phoneUtils';

const StockReceivingForm = () => {
  // Get procurement data from global state
  const { procurementForReceiving, clearProcurementForReceiving, setActiveComponent } = useGlobalState();
{/* Part 1 End - Imports and Component Definition */}

{/* Part 2 Start - State and Data Setup */}
  // Form state
  const [dateDelivered, setDateDelivered] = useState(new Date().toISOString().split('T')[0]);
  const [bulkLocation, setBulkLocation] = useState('');
  const [deliveryReference, setDeliveryReference] = useState('');
  
  // State for group barcodes
  const [groupBarcodes, setGroupBarcodes] = useState({});
  
  // State for barcode edit mode
  const [barcodeEditMode, setBarcodeEditMode] = useState({});
  
  // State for view-only mode
  const [isViewOnly, setIsViewOnly] = useState(false);
  
  // State for validation errors
  const [fieldErrors, setFieldErrors] = useState({});
  const [isValidating, setIsValidating] = useState(false);
  
  // State for save process
  const [isSaving, setIsSaving] = useState(false);
  const [saveProgress, setSaveProgress] = useState('');
  const [showConfirmDialog, setShowConfirmDialog] = useState(false);
  const [saveSuccess, setSaveSuccess] = useState(false);
  
  // Use actual procurement data or dummy data for testing - wrapped in useMemo to prevent recreating on every render
  const procurementData = useMemo(() => {
    const data = procurementForReceiving || {
      id: 'PROC-2024-001',
      reference: 'PO-2024-0156',
      supplierName: 'TechHub Electronics Inc.',
      supplierId: 'SUPP-001',
      purchaseDate: '2024-12-15',
      deliveryStatus: 'pending',
      items: [
        {
          manufacturer: 'Apple',
          model: 'iPhone 15 Pro',
          ram: '8GB',
          storage: '256GB',
          color: 'Natural Titanium',
          quantity: 3,
          dealersPrice: 75000,
          retailPrice: 85000,
          barcode: ''
        },
        {
          manufacturer: 'Samsung',
          model: 'Galaxy S24 Ultra',
          ram: '12GB',
          storage: '512GB',
          color: 'Titanium Gray',
          quantity: 2,
          dealersPrice: 65000,
          retailPrice: 75000,
          barcode: ''
        }
      ]
    };
    console.log(' Procurement Data:', data);
    console.log(' Procurement Items:', data.items);
    return data;
  }, [procurementForReceiving]);

  // Set view-only mode based on delivery status
  useEffect(() => {
    if (procurementData.deliveryStatus === 'delivered' || procurementData.isReceived === true) {
      setIsViewOnly(true);
      // Also set the delivery date and reference if available
      if (procurementData.dateDelivered) {
        setDateDelivered(procurementData.dateDelivered);
      }
      if (procurementData.deliveryReference) {
        setDeliveryReference(procurementData.deliveryReference);
      }
    }
  }, [procurementData]);

  // Initialize receiving items state
  const [receivingItems, setReceivingItems] = useState([]);
  
  // Debug effect to log state changes
  useEffect(() => {
    console.log(' Group Barcodes State Updated:', groupBarcodes);
  }, [groupBarcodes]);
  
  useEffect(() => {
    console.log(' Receiving Items State Updated:', receivingItems);
  }, [receivingItems]);
  
  // Initialize receiving items and fetch barcodes when procurementData changes
  useEffect(() => {
    const initializeItemsWithBarcodes = async () => {
      console.log(' Starting initializeItemsWithBarcodes');
      const isDelivered = procurementData.deliveryStatus === 'delivered' || procurementData.isReceived === true;
      console.log('Is Delivered Status:', isDelivered);
      
      // If in delivered mode, fetch the actual received items from inventory
      if (isDelivered && procurementData.id) {
        console.log(' Fetching received items for procurement:', procurementData.id);
        
        try {
          // Query inventory for items from this procurement
          const inventoryRef = collection(db, 'inventory');
          const q = query(
            inventoryRef,
            where("supplierId", "==", procurementData.supplierId || ''),
            where("supplier", "==", procurementData.supplierName)
          );
          
          const snapshot = await getDocs(q);
          console.log(` Found ${snapshot.size} inventory items from this supplier`);
          
          // Filter items by matching them to procurement items
          const receivedItems = [];
          const groupBarcodeMap = {};
          let rowId = 1;
          
          // Group the inventory items by product specification
          const inventoryByProduct = {};
          snapshot.forEach(doc => {
            const item = { id: doc.id, ...doc.data() };
            const productKey = `${item.manufacturer}_${item.model}_${item.ram}_${item.storage}_${item.color}`;
            
            if (!inventoryByProduct[productKey]) {
              inventoryByProduct[productKey] = [];
            }
            inventoryByProduct[productKey].push(item);
          });
          
          // Process each procurement item group
          procurementData.items.forEach((procItem, groupIndex) => {
            const productKey = `${procItem.manufacturer}_${procItem.model}_${procItem.ram}_${procItem.storage}_${procItem.color}`;
            const matchingInventoryItems = inventoryByProduct[productKey] || [];
            
            console.log(` Processing procurement item ${groupIndex}: ${productKey}`);
            console.log(`   Found ${matchingInventoryItems.length} matching inventory items`);
            
            // Set the barcode for this group
            if (matchingInventoryItems.length > 0 && matchingInventoryItems[0].barcode) {
              groupBarcodeMap[groupIndex] = matchingInventoryItems[0].barcode;
            }
            
            // Add the received items (up to the procurement quantity)
            const itemsToShow = matchingInventoryItems.slice(0, procItem.quantity);
            
            itemsToShow.forEach((invItem) => {
              receivedItems.push({
                id: rowId++,
                groupId: groupIndex,
                ...procItem,
                barcode: invItem.barcode || '',
                imei1: invItem.imei1 || '',
                imei2: invItem.imei2 || '',
                serialNumber: invItem.serialNumber || '',
                location: invItem.location || '',
                status: invItem.status || 'On-Hand'
              });
            });
            
            // If we have fewer received items than procurement quantity, add empty rows
            const remainingQty = procItem.quantity - itemsToShow.length;
            for (let i = 0; i < remainingQty; i++) {
              receivedItems.push({
                id: rowId++,
                groupId: groupIndex,
                ...procItem,
                barcode: groupBarcodeMap[groupIndex] || '',
                imei1: '',
                imei2: '',
                serialNumber: '',
                location: '',
                status: 'On-Hand'
              });
            }
          });
          
          console.log(' Final received items:', receivedItems);
          console.log(' Final group barcodes:', groupBarcodeMap);
          
          setGroupBarcodes(groupBarcodeMap);
          setReceivingItems(receivedItems);
          
        } catch (error) {
          console.error(' Error fetching received items:', error);
          // Fall back to creating empty rows
          await createEmptyRows();
        }
      } else {
        // Not in view mode, create empty rows for receiving
        await createEmptyRows();
      }
    };
    
    // Helper function to create empty rows
    const createEmptyRows = async () => {
      console.log(' Creating empty rows for receiving');
      const rows = [];
      let rowId = 1;
      const newGroupBarcodes = {};
      
      // Process each item group and fetch barcodes
      for (let groupIndex = 0; groupIndex < procurementData.items.length; groupIndex++) {
        const item = procurementData.items[groupIndex];
        console.log(`\n Processing Group ${groupIndex}:`, item);
        
        // Start with barcode from procurement if available
        let barcode = item.barcode || '';
        console.log(` Initial barcode from procurement: "${barcode}"`);
        
        // If no barcode in procurement, try to fetch from existing inventory
        if (!barcode && item.manufacturer && item.model && item.ram && item.storage && item.color) {
          try {
            console.log(` Fetching barcode for: ${item.manufacturer} ${item.model} ${item.ram} ${item.storage} ${item.color}`);
            
            const inventoryRef = collection(db, 'inventory');
            const q = query(
              inventoryRef,
              where("manufacturer", "==", item.manufacturer),
              where("model", "==", item.model),
              where("ram", "==", item.ram),
              where("storage", "==", item.storage),
              where("color", "==", item.color),
              limit(1)
            );
            
            console.log(' Query constraints:', {
              manufacturer: item.manufacturer,
              model: item.model,
              ram: item.ram,
              storage: item.storage,
              color: item.color
            });
            
            const snapshot = await getDocs(q);
            console.log(` Query results: ${snapshot.size} documents found`);
            
            if (!snapshot.empty) {
              const existingItem = snapshot.docs[0].data();
              console.log(' Found inventory item:', existingItem);
              if (existingItem.barcode) {
                barcode = existingItem.barcode;
                console.log(` Found barcode: "${barcode}"`);
              } else {
                console.log(' Inventory item has no barcode');
              }
            } else {
              console.log(' No matching inventory item found');
            }
          } catch (error) {
            console.error(' Error fetching barcode:', error);
          }
        } else if (!barcode) {
          console.log(' Missing required fields for barcode fetch:', {
            manufacturer: item.manufacturer,
            model: item.model,
            ram: item.ram,
            storage: item.storage,
            color: item.color
          });
        }
        
        // Store the barcode for this group
        newGroupBarcodes[groupIndex] = barcode;
        console.log(` Storing barcode for group ${groupIndex}: "${barcode}"`);
        
        // Create rows for each quantity
        for (let i = 0; i < item.quantity; i++) {
          rows.push({
            id: rowId++,
            groupId: groupIndex,
            ...item,
            barcode: barcode, // Use the fetched or existing barcode
            // Individual item fields
            imei1: '',
            imei2: '',
            serialNumber: '',
            location: '',
            status: 'On-Hand'
          });
        }
      }
      
      console.log(' Final newGroupBarcodes:', newGroupBarcodes);
      console.log(' Final rows:', rows);
      
      // Update states with the processed data
      setGroupBarcodes(newGroupBarcodes);
      setReceivingItems(rows);
    };
    
    // Call the async function
    initializeItemsWithBarcodes();
  }, [procurementData.id, procurementData.deliveryStatus, procurementData.isReceived, procurementData.items, procurementData.supplierId, procurementData.supplierName]); // Include all dependencies used inside
  
  // Group items by product model
  const groupedItems = useMemo(() => {
    console.log(' Recalculating groupedItems');
    console.log('Current receivingItems:', receivingItems);
    console.log('Current groupBarcodes:', groupBarcodes);
    
    const groups = receivingItems.reduce((groups, item) => {
      const groupKey = item.groupId;
      if (!groups[groupKey]) {
        const barcode = groupBarcodes[groupKey] || item.barcode || '';
        console.log(`Creating group ${groupKey} with barcode: "${barcode}"`);
        groups[groupKey] = {
          product: {
            manufacturer: item.manufacturer,
            model: item.model,
            ram: item.ram,
            storage: item.storage,
            color: item.color,
            dealersPrice: item.dealersPrice,
            retailPrice: item.retailPrice,
            barcode: barcode
          },
          items: []
        };
      }
      groups[groupKey].items.push(item);
      return groups;
    }, {});
    
    console.log(' Final groupedItems:', groups);
    return groups;
  }, [receivingItems, groupBarcodes]); // Added groupBarcodes as dependency
{/* Part 2 End - State and Data Setup */}

{/* Part 3 Start - Handler Functions */}
  // Handle individual field changes
  const handleItemChange = (itemId, field, value) => {
    setReceivingItems(prevItems =>
      prevItems.map(item =>
        item.id === itemId ? { ...item, [field]: value } : item
      )
    );
    
    // Clear error for this field when user types
    if (fieldErrors[`${field}-${itemId}`]) {
      setFieldErrors(prev => {
        const newErrors = { ...prev };
        delete newErrors[`${field}-${itemId}`];
        return newErrors;
      });
    }
  };

  // Handle bulk location set
  const handleBulkLocationSet = () => {
    if (!bulkLocation.trim()) return;
    
    setReceivingItems(prevItems =>
      prevItems.map(item => ({ ...item, location: bulkLocation }))
    );
    
    // Clear all location errors
    setFieldErrors(prev => {
      const newErrors = { ...prev };
      Object.keys(newErrors).forEach(key => {
        if (key.startsWith('location-')) {
          delete newErrors[key];
        }
      });
      return newErrors;
    });
  };

  // Handle barcode change for a group
  const handleGroupBarcodeChange = (groupId, value) => {
    setGroupBarcodes(prev => ({
      ...prev,
      [groupId]: value.toUpperCase()
    }));
    
    // Update all items in the group with the new barcode
    setReceivingItems(prevItems =>
      prevItems.map(item =>
        item.groupId === groupId ? { ...item, barcode: value.toUpperCase() } : item
      )
    );
    
    // Clear barcode errors for this group
    setFieldErrors(prev => {
      const newErrors = { ...prev };
      delete newErrors[`barcode-group-${groupId}`];
      return newErrors;
    });
  };

  // Toggle barcode edit mode
  const toggleBarcodeEditMode = (groupId) => {
    setBarcodeEditMode(prev => ({
      ...prev,
      [groupId]: !prev[groupId]
    }));
  };

  // Handle Enter key navigation
  const handleKeyDown = (e, groupKey, itemIndex, fieldName) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      
      const group = groupedItems[groupKey];
      const totalItemsInGroup = group.items.length;
      
      // Define field order for navigation
      const fieldOrder = ['imei1', 'imei2', 'serialNumber'];
      const currentFieldIndex = fieldOrder.indexOf(fieldName);
      
      let nextField = null;
      let nextItemIndex = itemIndex;
      
      // Determine next field and item
      if (currentFieldIndex < fieldOrder.length - 1) {
        // Move to next field in same row
        nextField = fieldOrder[currentFieldIndex + 1];
      } else if (itemIndex < totalItemsInGroup - 1) {
        // Move to first field of next row
        nextField = fieldOrder[0];
        nextItemIndex = itemIndex + 1;
      }
      
      // Focus on the next input if found
      if (nextField) {
        const nextInput = document.querySelector(
          `input[data-group="${groupKey}"][data-item="${nextItemIndex}"][data-field="${nextField}"]`
        );
        if (nextInput) {
          nextInput.focus();
        }
      }
    }
  };
  
  // Check for duplicate serial numbers
  const checkDuplicateSerialNumbers = async (serialNumber) => {
    if (!serialNumber) return { isValid: true };
    
    try {
      const inventoryRef = collection(db, 'inventory');
      const q = query(inventoryRef, where("serialNumber", "==", serialNumber));
      const snapshot = await getDocs(q);
      
      if (!snapshot.empty) {
        return {
          isValid: false,
          error: 'This serial number already exists in inventory'
        };
      }
      
      return { isValid: true };
    } catch (error) {
      console.error("Error checking serial number:", error);
      return {
        isValid: false,
        error: 'Error checking serial number'
      };
    }
  };
  
  // Validate form
  const validateForm = async () => {
    const errors = {};
    let hasErrors = false;
    
    // Check reference field
    if (!deliveryReference.trim()) {
      errors['reference'] = 'Delivery reference is required';
      hasErrors = true;
    }
    
    // Check each item
    for (const item of receivingItems) {
      // Check IMEI1
      if (!item.imei1) {
        errors[`imei1-${item.id}`] = 'IMEI1 is required';
        hasErrors = true;
      } else if (item.imei1.length !== 15) {
        errors[`imei1-${item.id}`] = 'IMEI1 must be exactly 15 digits';
        hasErrors = true;
      }
      
      // Check IMEI2
      if (item.imei2 && item.imei2.length !== 15) {
        errors[`imei2-${item.id}`] = 'IMEI2 must be exactly 15 digits';
        hasErrors = true;
      }
      
      // Check location
      if (!item.location) {
        errors[`location-${item.id}`] = 'Location is required';
        hasErrors = true;
      }
      
      // Check barcode for group
      const groupBarcode = groupBarcodes[item.groupId];
      if (!groupBarcode) {
        errors[`barcode-group-${item.groupId}`] = 'Barcode is required';
        hasErrors = true;
      }
    }
    
    // Check for duplicate IMEIs and serial numbers
    if (!hasErrors) {
      for (const item of receivingItems) {
        // Check IMEI duplicates
        const imeiCheck = await checkDuplicateImeis(item.imei1, item.imei2);
        if (!imeiCheck.isValid) {
          if (imeiCheck.imei1Error) {
            errors[`imei1-${item.id}`] = imeiCheck.imei1Error;
            hasErrors = true;
          }
          if (imeiCheck.imei2Error) {
            errors[`imei2-${item.id}`] = imeiCheck.imei2Error;
            hasErrors = true;
          }
        }
        
        // Check serial number duplicates
        if (item.serialNumber) {
          const serialCheck = await checkDuplicateSerialNumbers(item.serialNumber);
          if (!serialCheck.isValid) {
            errors[`serialNumber-${item.id}`] = serialCheck.error;
            hasErrors = true;
          }
        }
      }
    }
    
    return { errors, hasErrors };
  };

  // Handle form submission
  const handleSubmit = async (e) => {
    e.preventDefault();
    
    // Start validation
    setIsValidating(true);
    setFieldErrors({});
    
    // Validate form
    const { errors, hasErrors } = await validateForm();
    
    if (hasErrors) {
      setFieldErrors(errors);
      setIsValidating(false);
      // Scroll to first error
      const firstErrorField = document.querySelector('.border-red-500');
      if (firstErrorField) {
        firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstErrorField.focus();
      }
      return;
    }
    
    // If validation passed, show confirmation dialog
    setIsValidating(false);
    setShowConfirmDialog(true);
  };

  // Confirm and save
  const handleConfirmSave = async () => {
    setShowConfirmDialog(false);
    setIsSaving(true);
    setSaveProgress('Preparing to save items...');

    try {
      const batch = writeBatch(db);
      let itemsSaved = 0;

      // 1. Add items to inventory collection
      setSaveProgress('Adding items to inventory...');
      
      for (const item of receivingItems) {
        const inventoryData = {
          manufacturer: item.manufacturer,
          model: item.model,
          ram: item.ram,
          storage: item.storage,
          color: item.color,
          dealersPrice: item.dealersPrice,
          retailPrice: item.retailPrice,
          imei1: item.imei1,
          imei2: item.imei2 || '',
          serialNumber: item.serialNumber || '',
          barcode: groupBarcodes[item.groupId] || '',
          location: item.location,
          status: item.status,
          supplier: procurementData.supplierName,
          supplierId: procurementData.supplierId || '',
          lastUpdated: dateDelivered,
          dateAdded: dateDelivered
        };

        const docRef = doc(collection(db, 'inventory'));
        batch.set(docRef, inventoryData);
        itemsSaved++;
      }

      // 2. Update inventory_counts collection
      setSaveProgress('Updating inventory counts...');
      
      // Group items by product configuration for count updates
      const countUpdates = {};
      receivingItems.forEach(item => {
        const inventoryId = createInventoryId(
          item.manufacturer,
          item.model,
          item.ram,
          item.storage,
          item.color
        );
        
        if (!countUpdates[inventoryId]) {
          countUpdates[inventoryId] = {
            manufacturer: item.manufacturer,
            model: item.model,
            ram: item.ram,
            storage: item.storage,
            color: item.color,
            counts: {
              'On-Hand': 0,
              'On-Display': 0,
              Sold: 0,
              Reserved: 0,
              Defective: 0
            }
          };
        }
        
        countUpdates[inventoryId].counts[item.status]++;
      });

      // Update counts using transactions for each product configuration
      for (const [inventoryId, data] of Object.entries(countUpdates)) {
        await runTransaction(db, async (transaction) => {
          const inventoryRef = doc(db, 'inventory_counts', inventoryId);
          const inventoryDoc = await transaction.get(inventoryRef);
          
          if (!inventoryDoc.exists()) {
            // Create new inventory count document
            transaction.set(inventoryRef, {
              manufacturer: data.manufacturer,
              model: data.model,
              ram: data.ram,
              storage: data.storage,
              color: data.color,
              total: data.counts['On-Hand'] + data.counts['On-Display'] + data.counts.Sold + 
                     data.counts.Reserved + data.counts.Defective,
              onHand: data.counts['On-Hand'],
              onDisplay: data.counts['On-Display'],
              sold: data.counts.Sold,
              reserved: data.counts.Reserved,
              defective: data.counts.Defective,
              lastUpdated: getCurrentDate()
            });
          } else {
            // Update existing counts
            transaction.update(inventoryRef, {
              total: increment(data.counts['On-Hand'] + data.counts['On-Display'] + 
                            data.counts.Sold + data.counts.Reserved + data.counts.Defective),
              onHand: increment(data.counts['On-Hand']),
              onDisplay: increment(data.counts['On-Display']),
              sold: increment(data.counts.Sold),
              reserved: increment(data.counts.Reserved),
              defective: increment(data.counts.Defective),
              lastUpdated: getCurrentDate()
            });
          }
        });
      }

      // 3. Update procurement record
      setSaveProgress('Updating procurement record...');
      const procurementRef = doc(db, 'procurements', procurementData.id);
      batch.update(procurementRef, {
        deliveryStatus: 'delivered',
        dateDelivered: dateDelivered,
        deliveryReference: deliveryReference
      });

      // 4. Create ledger entry for delivery
      if (procurementData.supplierId) {
        setSaveProgress('Creating delivery ledger entry...');
        const ledgerData = {
          supplierId: procurementData.supplierId,
          supplierName: procurementData.supplierName,
          procurementId: procurementData.id,
          entryType: 'delivery',
          description: `Stock received - ${receivingItems.length} units`,
          reference: deliveryReference,
          entryDate: dateDelivered,
          createdAt: new Date().toISOString(),
          isDeleted: false
        };

        const ledgerRef = doc(collection(db, 'supplier_ledger'));
        batch.set(ledgerRef, ledgerData);
      }

      // Commit all batch operations
      setSaveProgress('Finalizing save...');
      await batch.commit();

      // Show success
      setSaveProgress(`Successfully added ${itemsSaved} items to inventory!`);
      setSaveSuccess(true);

      // Wait a moment then close
      setTimeout(() => {
        clearProcurementForReceiving();
        setActiveComponent('procurementmgmt');
      }, 2000);

    } catch (error) {
      console.error('Error saving items:', error);
      alert(`Error saving items: ${error.message}`);
      setIsSaving(false);
      setSaveProgress('');
    }
  };

  // Handle cancel - return to procurement management
  const handleCancel = () => {
    console.log('Cancelling stock receiving');
    clearProcurementForReceiving();
    setActiveComponent('procurementmgmt');
  };

  // Format price with commas
  const formatPrice = (value) => {
    if (!value) return '0.00';
    return value.toLocaleString('en-US', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  };
{/* Part 3 End - Handler Functions */}

{/* Part 4 Start - Form Header */}
  return (
    <div className="min-h-screen bg-white p-4">
      <Card className="w-full max-w-7xl mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
        <CardHeader className="bg-[rgb(52,69,157)] py-3">
          <div className="flex justify-between items-center">
            <CardTitle className="text-2xl text-white flex items-center">
              <Package className="h-6 w-6 mr-2" />
              Stock Receiving {isViewOnly && '(View Only)'}
            </CardTitle>
            
            <button
              type="button"
              onClick={handleCancel}
              className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 flex items-center text-sm"
              title="Cancel and return to procurement management"
            >
              <X className="h-4 w-4 mr-1" />
              {isViewOnly ? 'Close' : 'Cancel'}
            </button>
          </div>
        </CardHeader>

        <CardContent className="bg-white p-4">
          <form onSubmit={handleSubmit} className="space-y-6">
            {/* Procurement Info Section */}
            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
              <div className="flex flex-wrap gap-4">
                {/* Date Delivered */}
                <div className="space-y-2 flex-1 min-w-[120px] max-w-[150px]">
                  <label className="block text-sm font-semibold text-[rgb(52,69,157)]">
                    <Calendar className="h-4 w-4 inline mr-1" />
                    Date Delivered:
                  </label>
                  <input
                    type="date"
                    value={dateDelivered}
                    onChange={(e) => setDateDelivered(e.target.value)}
                    className="w-full px-3 py-2 border rounded text-sm"
                    required
                    disabled={isViewOnly}
                  />
                </div>

                {/* Reference - Now Editable and Repositioned */}
                <div className="space-y-2 flex-1 min-w-[120px] max-w-[160px]">
                  <label className="block text-sm font-semibold text-[rgb(52,69,157)]">
                    Reference:
                  </label>
                  <div>
                    <input
                      type="text"
                      value={deliveryReference}
                      onChange={(e) => {
                        setDeliveryReference(e.target.value);
                        // Clear reference error when user types
                        if (fieldErrors['reference']) {
                          setFieldErrors(prev => {
                            const newErrors = { ...prev };
                            delete newErrors['reference'];
                            return newErrors;
                          });
                        }
                      }}
                      className={`w-full px-3 py-2 border rounded text-sm ${fieldErrors['reference'] ? 'border-red-500' : ''}`}
                      placeholder="Delivery Receipt #"
                      disabled={isViewOnly}
                    />
                    {fieldErrors['reference'] && (
                      <p className="text-red-500 text-xs mt-1">{fieldErrors['reference']}</p>
                    )}
                  </div>
                </div>

                {/* Bulk Location */}
                <div className="space-y-2 flex-1 min-w-[240px] max-w-[320px]">
                  <label className="block text-sm font-semibold text-[rgb(52,69,157)]">
                    <MapPin className="h-4 w-4 inline mr-1" />
                    Set all locations to:
                  </label>
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={bulkLocation}
                      onChange={(e) => setBulkLocation(e.target.value)}
                      className="flex-1 px-3 py-2 border rounded text-sm"
                      placeholder="e.g. Stockroom A"
                      disabled={isViewOnly}
                    />
                    <button
                      type="button"
                      onClick={handleBulkLocationSet}
                      className="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm whitespace-nowrap"
                      disabled={isViewOnly}
                    >
                      Apply to All
                    </button>
                  </div>
                </div>

                {/* Supplier */}
                <div className="space-y-2 flex-1 min-w-[180px] max-w-[220px]">
                  <label className="block text-sm font-semibold text-[rgb(52,69,157)]">
                    <Building2 className="h-4 w-4 inline mr-1" />
                    Supplier:
                  </label>
                  <input
                    type="text"
                    value={procurementData.supplierName}
                    className="w-full px-3 py-2 border rounded text-sm bg-gray-100"
                    disabled
                  />
                </div>

                {/* Purchase Date */}
                <div className="space-y-2 flex-1 min-w-[100px] max-w-[130px]">
                  <label className="block text-sm font-semibold text-[rgb(52,69,157)]">
                    Purchase Date:
                  </label>
                  <input
                    type="text"
                    value={procurementData.purchaseDate}
                    className="w-full px-3 py-2 border rounded text-sm bg-gray-100"
                    disabled
                  />
                </div>

                {/* Procurement Reference */}
                <div className="space-y-2 flex-1 min-w-[120px] max-w-[150px]">
                  <label className="block text-sm font-semibold text-[rgb(52,69,157)]">
                    Procurement Ref:
                  </label>
                  <input
                    type="text"
                    value={procurementData.reference || procurementData.id}
                    className="w-full px-3 py-2 border rounded text-sm bg-gray-100"
                    disabled
                  />
                </div>
              </div>
            </div>
{/* Part 4 End - Form Header */}

{/* Part 5 Start - Items Table */}
            {/* Receiving Items Table */}
            <div className="space-y-6">
              <h3 className="text-lg font-semibold text-[rgb(52,69,157)]">
                {isViewOnly ? 'Received Items' : 'Items to Receive'}
              </h3>
              
              {/* Items grouped by product */}
              {Object.entries(groupedItems).map(([groupKey, group]) => (
                <div key={groupKey} className="border rounded-lg overflow-hidden">
                  {/* Group Header */}
                  <div className="bg-gray-100 px-4 py-3 flex items-center justify-between">
                    <div className="flex items-center gap-x-6">
                      <span className="text-base font-semibold">{group.product.manufacturer}</span>
                      <span className="text-base font-semibold"></span>
                      <span className="text-base font-semibold">({group.items.length} {group.items.length === 1 ? 'pc' : 'pcs'})</span>
                      <span className="text-base font-semibold"></span>
                      <span className="text-base font-semibold">{group.product.model}</span>
                      <span className="text-base font-semibold"></span>
                      <span className="text-base font-semibold">{group.product.ram} / {group.product.storage}</span>
                      <span className="text-base font-semibold"></span>
                      <span className="text-base font-semibold">{group.product.color}</span>
                      <span className="text-base font-semibold"></span>
                      <span className="text-base font-semibold">Retail Price: {formatPrice(group.product.retailPrice)}</span>
                    </div>
                    
                    {/* Barcode Edit - Button First, Field Second */}
                    <div className="flex items-center gap-2">
                      {barcodeEditMode[groupKey] ? (
                        <>
                          <button
                            type="button"
                            onClick={() => toggleBarcodeEditMode(groupKey)}
                            className="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700"
                            disabled={isViewOnly}
                          >
                            Save
                          </button>
                          <input
                            type="text"
                            value={groupBarcodes[groupKey] || ''}
                            onChange={(e) => handleGroupBarcodeChange(groupKey, e.target.value)}
                            className={`px-2 py-1 border rounded text-sm w-32 ${fieldErrors[`barcode-group-${groupKey}`] ? 'border-red-500' : ''}`}
                            placeholder="Enter barcode"
                            disabled={isViewOnly}
                          />
                        </>
                      ) : (
                        <>
                          <button
                            type="button"
                            onClick={() => toggleBarcodeEditMode(groupKey)}
                            className="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
                            disabled={isViewOnly}
                          >
                            Barcode
                          </button>
                          <div className="flex flex-col">
                            <div className={`px-2 py-1 border rounded text-sm font-mono min-w-[8rem] ${
                              !groupBarcodes[groupKey] 
                                ? 'border-red-500 text-red-600 bg-red-50' 
                                : 'border-gray-300 bg-gray-100'
                            }`}>
                              {groupBarcodes[groupKey] || 'NO BARCODE'}
                            </div>
                            {fieldErrors[`barcode-group-${groupKey}`] && (
                              <p className="text-red-500 text-xs mt-1">{fieldErrors[`barcode-group-${groupKey}`]}</p>
                            )}
                          </div>
                        </>
                      )}
                    </div>
                  </div>
                  
                  {/* Items Table */}
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-gray-50 border-y">
                        <tr>
                          <th className="px-3 py-2 text-left text-sm font-semibold text-gray-700">#</th>
                          <th className="px-3 py-2 text-left text-sm font-semibold text-gray-700">IMEI 1</th>
                          <th className="px-3 py-2 text-left text-sm font-semibold text-gray-700">IMEI 2</th>
                          <th className="px-3 py-2 text-left text-sm font-semibold text-gray-700">Serial Number</th>
                          <th className="px-3 py-2 text-left text-sm font-semibold text-gray-700">Location</th>
                          <th className="px-3 py-2 text-left text-sm font-semibold text-gray-700">Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {group.items.map((item, index) => (
                          <tr key={item.id} className={`border-b ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50`}>
                            <td className="px-3 py-3 text-sm">{index + 1}</td>
                            <td className="px-3 py-3">
                              <div>
                                <input
                                  type="text"
                                  value={item.imei1}
                                  onChange={(e) => handleItemChange(item.id, 'imei1', e.target.value)}
                                  onKeyDown={(e) => handleKeyDown(e, groupKey, index, 'imei1')}
                                  data-group={groupKey}
                                  data-item={index}
                                  data-field="imei1"
                                  className={`w-full px-2 py-1.5 border rounded text-sm ${fieldErrors[`imei1-${item.id}`] ? 'border-red-500' : ''}`}
                                  placeholder="15-digit IMEI"
                                  maxLength={15}
                                  required
                                  disabled={isViewOnly}
                                />
                                {fieldErrors[`imei1-${item.id}`] && (
                                  <p className="text-red-500 text-xs mt-1">{fieldErrors[`imei1-${item.id}`]}</p>
                                )}
                              </div>
                            </td>
                            <td className="px-3 py-3">
                              <div>
                                <input
                                  type="text"
                                  value={item.imei2}
                                  onChange={(e) => handleItemChange(item.id, 'imei2', e.target.value)}
                                  onKeyDown={(e) => handleKeyDown(e, groupKey, index, 'imei2')}
                                  data-group={groupKey}
                                  data-item={index}
                                  data-field="imei2"
                                  className={`w-full px-2 py-1.5 border rounded text-sm ${fieldErrors[`imei2-${item.id}`] ? 'border-red-500' : ''}`}
                                  placeholder="Optional"
                                  maxLength={15}
                                  disabled={isViewOnly}
                                />
                                {fieldErrors[`imei2-${item.id}`] && (
                                  <p className="text-red-500 text-xs mt-1">{fieldErrors[`imei2-${item.id}`]}</p>
                                )}
                              </div>
                            </td>
                            <td className="px-3 py-3">
                              <div>
                                <input
                                  type="text"
                                  value={item.serialNumber}
                                  onChange={(e) => handleItemChange(item.id, 'serialNumber', e.target.value)}
                                  onKeyDown={(e) => handleKeyDown(e, groupKey, index, 'serialNumber')}
                                  data-group={groupKey}
                                  data-item={index}
                                  data-field="serialNumber"
                                  className={`w-full px-2 py-1.5 border rounded text-sm ${fieldErrors[`serialNumber-${item.id}`] ? 'border-red-500' : ''}`}
                                  placeholder="Optional"
                                  disabled={isViewOnly}
                                />
                                {fieldErrors[`serialNumber-${item.id}`] && (
                                  <p className="text-red-500 text-xs mt-1">{fieldErrors[`serialNumber-${item.id}`]}</p>
                                )}
                              </div>
                            </td>
                            <td className="px-3 py-3">
                              <div>
                                <input
                                  type="text"
                                  value={item.location}
                                  onChange={(e) => handleItemChange(item.id, 'location', e.target.value)}
                                  className={`w-full px-2 py-1.5 border rounded text-sm ${fieldErrors[`location-${item.id}`] ? 'border-red-500' : ''}`}
                                  placeholder="Required"
                                  required
                                  disabled={isViewOnly}
                                />
                                {fieldErrors[`location-${item.id}`] && (
                                  <p className="text-red-500 text-xs mt-1">{fieldErrors[`location-${item.id}`]}</p>
                                )}
                              </div>
                            </td>
                            <td className="px-3 py-3">
                              <select
                                value={item.status}
                                onChange={(e) => handleItemChange(item.id, 'status', e.target.value)}
                                className={`w-full px-2 py-1.5 border rounded text-sm ${
                                  item.status === 'On-Hand' ? 'bg-blue-100 text-blue-800 border-blue-300' :
                                  item.status === 'On-Display' ? 'bg-yellow-100 text-yellow-800 border-yellow-300' :
                                  item.status === 'Sold' ? 'bg-purple-100 text-purple-800 border-purple-300' :
                                  item.status === 'Reserved' ? 'bg-orange-100 text-orange-800 border-orange-300' :
                                  item.status === 'Defective' ? 'bg-red-100 text-red-800 border-red-300' :
                                  'bg-white'
                                }`}
                                required
                                disabled={isViewOnly}
                              >
                                <option value="On-Hand">On-Hand</option>
                                <option value="On-Display">On-Display</option>
                                <option value="Sold">Sold</option>
                                <option value="Reserved">Reserved</option>
                                <option value="Defective">Defective</option>
                              </select>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              ))}
            </div>
{/* Part 5 End - Items Table */}

{/* Part 6 Start - Form Submission and Export */}
            {/* Submit Buttons */}
            {!isViewOnly && (
              <div className="flex justify-end gap-4 pt-4 border-t">
                <button
                  type="button"
                  onClick={handleCancel}
                  className="px-6 py-2.5 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 text-sm font-medium"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  disabled={isValidating || isSaving}
                  className={`px-6 py-2.5 rounded text-sm font-medium ${
                    isValidating || isSaving
                      ? 'bg-gray-400 text-white cursor-not-allowed' 
                      : 'bg-[rgb(52,69,157)] text-white hover:bg-[rgb(52,69,157)]/90'
                  }`}
                >
                  {isValidating ? 'Validating...' : `Receive Items (${receivingItems.length} units)`}
                </button>
              </div>
            )}
          </form>
        </CardContent>
      </Card>

      {/* Confirmation Dialog */}
      {showConfirmDialog && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 className="text-lg font-semibold text-gray-900 mb-4">
              Confirm Stock Receiving
            </h3>
            <p className="text-gray-600 mb-6">
              You are about to add {receivingItems.length} items to inventory. This action cannot be undone.
            </p>
            <div className="flex justify-end gap-3">
              <button
                onClick={() => setShowConfirmDialog(false)}
                className="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50"
              >
                Cancel
              </button>
              <button
                onClick={handleConfirmSave}
                className="px-4 py-2 bg-[rgb(52,69,157)] text-white rounded hover:bg-[rgb(52,69,157)]/90"
              >
                Confirm
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Progress Indicator */}
      {isSaving && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div className="flex flex-col items-center">
              {!saveSuccess ? (
                <>
                  <Loader className="h-8 w-8 animate-spin text-[rgb(52,69,157)] mb-4" />
                  <p className="text-gray-700 font-medium">{saveProgress}</p>
                </>
              ) : (
                <>
                  <CheckCircle className="h-12 w-12 text-green-500 mb-4" />
                  <p className="text-gray-700 font-medium">{saveProgress}</p>
                  <p className="text-sm text-gray-500 mt-2">Returning to procurement management...</p>
                </>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default StockReceivingForm;
{/* Part 6 End - Form Submission and Export */}
</file>

<file path="src/components/inventory/InventoryRow.jsx">
{/* Part 1 Start - Imports */}
import PropTypes from 'prop-types';
import { Edit, Trash2, FileEdit } from 'lucide-react';
import { useState, useEffect } from 'react';
import supplierService from '../../services/supplierService';
{/* Part 1 End - Imports */}

{/* Part 2 Start - Component Definition */}
const InventoryRow = ({
  item,
  handleEditClick,
  handleDeleteClick,
  handleEditDetailsClick // NEW: Add handler for edit details
}) => {
{/* Part 2 End - Component Definition */}

  {/* Part 3 Start - Helper Functions */}
  // State for supplier name lookup
  const [supplierName, setSupplierName] = useState('N/A');
  
  // Fetch supplier name when component mounts or supplier changes
  useEffect(() => {
    async function fetchSupplierName() {
      if (item.supplier) {
        try {
          const result = await supplierService.getSupplierById(item.supplier);
          if (result.success && result.supplier) {
            setSupplierName(result.supplier.supplierName);
          } else {
            setSupplierName('N/A');
          }
        } catch (error) {
          console.error('Error fetching supplier name:', error);
          setSupplierName('N/A');
        }
      } else {
        setSupplierName('N/A');
      }
    }
    
    fetchSupplierName();
  }, [item.supplier]);

  // Helper function to get status display
  const getStatusDisplay = (status) => {
    const statusMap = {
      'On-Hand': 'Stock',
      'On-Display': 'On-Display',
      'Sold': 'Sold',
      'Reserved': 'Reserved',
      'Defective': 'Defective'
    };
    return statusMap[status] || status;
  };
  
  // Format price with peso sign and commas
  const formatPrice = (price) => {
    return `${(price || 0).toLocaleString()}`;
  };
  {/* Part 3 End - Helper Functions */}
  
  {/* Part 4 Start - Component Render */}
  return (
    <tr className="hover:bg-gray-50">
      <td className="border px-2 py-3 whitespace-nowrap text-sm">{item.manufacturer}</td>
      <td className="border px-2 py-3 whitespace-nowrap text-sm">{item.model}</td>
      <td className="border px-2 py-3 whitespace-nowrap text-sm text-center">{item.ram}</td>
      <td className="border px-2 py-3 whitespace-nowrap text-sm text-center">{item.storage}</td>
      <td className="border px-2 py-3 whitespace-nowrap text-sm">{item.color}</td>
      <td className="border px-2 py-3 whitespace-nowrap text-sm">{item.imei1}</td>
      {/* UPDATED: Replaced barcode with serial number */}
      <td className="border px-2 py-3 whitespace-nowrap text-sm uppercase">
        {item.serialNumber || 'N/A'}
      </td>
      {/* NEW: Added supplier column */}
      <td className="border px-2 py-3 whitespace-nowrap text-sm">
        {supplierName}
      </td>
      <td className="border px-2 py-3 whitespace-nowrap text-sm text-right">
        <span className="text-gray-600">
          {formatPrice(item.retailPrice)}
        </span>
      </td>
      <td className="border px-2 py-3 whitespace-nowrap text-sm text-gray-500">
        {item.lastUpdated || '-'}
      </td>
      <td className="border px-2 py-3 text-center whitespace-nowrap">
        <span className={`px-2 py-1 text-sm rounded-full ${
          item.status === 'On-Hand' ? 'bg-blue-100 text-blue-800' :
          item.status === 'On-Display' ? 'bg-yellow-100 text-yellow-800' :
          item.status === 'Sold' ? 'bg-purple-100 text-purple-800' :
          item.status === 'Reserved' ? 'bg-orange-100 text-orange-800' :
          'bg-gray-100 text-gray-800'
        }`}>
          {getStatusDisplay(item.status)}
        </span>
      </td>
      <td className="border px-2 py-3 text-center whitespace-nowrap">
        <div className="flex justify-center space-x-2">
          <button
            onClick={() => handleEditClick(item)}
            className="p-1 text-blue-600 hover:text-blue-800"
            title="Quick edit"
          >
            <Edit className="h-5 w-5" />
          </button>
          <button
            onClick={() => handleEditDetailsClick(item)}
            className="p-1 text-green-600 hover:text-green-800"
            title="Edit full details"
          >
            <FileEdit className="h-5 w-5" />
          </button>
          <button
            onClick={() => handleDeleteClick(item.id)}
            className="p-1 text-red-600 hover:text-red-800"
            title="Delete item"
          >
            <Trash2 className="h-5 w-5" />
          </button>
        </div>
      </td>
    </tr>
  );
};
{/* Part 4 End - Component Render */}

{/* Part 5 Start - PropTypes Definition */}
InventoryRow.propTypes = {
  item: PropTypes.shape({
    id: PropTypes.string.isRequired,
    manufacturer: PropTypes.string.isRequired,
    model: PropTypes.string.isRequired,
    ram: PropTypes.string.isRequired,
    storage: PropTypes.string.isRequired,
    color: PropTypes.string.isRequired,
    imei1: PropTypes.string.isRequired,
    serialNumber: PropTypes.string, // FIXED: Added serialNumber
    supplier: PropTypes.string, // FIXED: Added supplier
    retailPrice: PropTypes.number, // NEW: Added retailPrice prop
    status: PropTypes.string.isRequired,
    lastUpdated: PropTypes.string
  }).isRequired,
  handleEditClick: PropTypes.func.isRequired,
  handleDeleteClick: PropTypes.func.isRequired,
  handleEditDetailsClick: PropTypes.func.isRequired // NEW: Add prop type
};
{/* Part 5 End - PropTypes Definition */}

{/* Part 6 Start - Export */}
export default InventoryRow;
{/* Part 6 End - Export */}
</file>

<file path="src/components/InventorySummaryForm.jsx">
{/* Part 1 Start - Imports and Initial State */}
import React, { useState, useEffect, useCallback } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { collection, getDocs } from 'firebase/firestore';
import { db } from '../firebase/config';
import { 
  Smartphone, 
  RefreshCw, 
  ChevronDown, 
  ChevronRight, 
  Filter, 
  X,
  CircleAlert  // NEW: Added for exclusion info display
} from 'lucide-react';

const InventorySummaryForm = () => {
  // Main state
  const [inventoryData, setInventoryData] = useState([]);
  const [filteredData, setFilteredData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [expandedRows, setExpandedRows] = useState(new Set());
  const [expandedColorSections, setExpandedColorSections] = useState({});
  const [expandedColorRows, setExpandedColorRows] = useState({}); // NEW: Track expanded color rows
  
  // NEW: Add state for excluded models info
  const [excludedModelsInfo, setExcludedModelsInfo] = useState([]);
  
  // Filter states
  const [showFilters, setShowFilters] = useState(false);
  const [filters, setFilters] = useState({
    manufacturer: '',
    model: '',
    ram: '',
    storage: '',
    color: ''
  });
  
  // Filter options
  const [filterOptions, setFilterOptions] = useState({
    manufacturers: [],
    models: [],
    rams: [],
    storages: [],
    colors: []
  });
  
  // Filtered options based on selections
  const [filteredOptions, setFilteredOptions] = useState({
    models: [],
    rams: [],
    storages: [],
    colors: []
  });

  // UPDATED: Add this function to fetch excluded models info for display with useCallback
  const fetchExcludedModelsInfo = useCallback(async () => {
    try {
      const phonesRef = collection(db, 'phones');
      const phonesSnapshot = await getDocs(phonesRef);
      
      const excludedList = [];
      phonesSnapshot.forEach(doc => {
        const phoneData = doc.data();
        if (phoneData.excludeFromSummary === true && phoneData.manufacturer && phoneData.model) {
          excludedList.push({
            manufacturer: phoneData.manufacturer,
            model: phoneData.model
          });
        }
      });
      
      setExcludedModelsInfo(excludedList.sort((a, b) => {
        if (a.manufacturer !== b.manufacturer) {
          return a.manufacturer.localeCompare(b.manufacturer);
        }
        return a.model.localeCompare(b.model);
      }));
    } catch (error) {
      console.error("Error fetching excluded models info:", error);
    }
  }, []);

  // Toggle row expansion (for base configurations)
  const toggleRowExpansion = (index) => {
    const newExpandedRows = new Set(expandedRows);
    if (newExpandedRows.has(index)) {
      newExpandedRows.delete(index);
      setExpandedColorSections(prev => {
        const newState = { ...prev };
        delete newState[index];
        return newState;
      });
      setExpandedColorRows(prev => {
        const newState = { ...prev };
        delete newState[index];
        return newState;
      });
    } else {
      newExpandedRows.add(index);
      setExpandedColorSections(prev => ({
        ...prev,
        [index]: {}
      }));
      setExpandedColorRows(prev => ({
        ...prev,
        [index]: {}
      }));
    }
    setExpandedRows(newExpandedRows);
  };

  // NEW: Toggle color row expansion (for showing/hiding detail sections)
  const toggleColorRowExpansion = (rowIndex, colorIndex) => {
    setExpandedColorRows(prev => ({
      ...prev,
      [rowIndex]: {
        ...prev[rowIndex],
        [colorIndex]: !prev[rowIndex]?.[colorIndex]
      }
    }));
  };

  // Toggle section expansion for color breakdown
  const toggleColorSectionExpansion = (rowIndex, colorIndex, section) => {
    setExpandedColorSections(prev => ({
      ...prev,
      [rowIndex]: {
        ...prev[rowIndex],
        [`${colorIndex}_${section}`]: !prev[rowIndex]?.[`${colorIndex}_${section}`]
      }
    }));
  };
{/* Part 1 End - Imports and Initial State */}

{/* Part 2 Start - Helper Functions and Filters */}
  // Handle filter change
  const handleFilterChange = (e) => {
    const { name, value } = e.target;
    setFilters(prev => ({
      ...prev,
      [name]: value
    }));
  };

  // Clear all filters
  const clearFilters = () => {
    setFilters({
      manufacturer: '',
      model: '',
      ram: '',
      storage: '',
      color: ''
    });
    setFilteredOptions({
      models: filterOptions.models,
      rams: filterOptions.rams,
      storages: filterOptions.storages,
      colors: filterOptions.colors
    });
  };

  // Utility functions
  const formatDate = (dateString) => {
    if (!dateString) return 'N/A';
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) {
        return dateString;
      }
      return date.toLocaleDateString('en-US', {
        month: '2-digit',
        day: '2-digit',
        year: 'numeric'
      });
    } catch {
      return dateString;
    }
  };

  const formatPrice = (price) => {
    if (!price && price !== 0) return 'N/A';
    return `${price.toLocaleString()}`;
  };

  const calculateMargin = (dealersPrice, retailPrice) => {
    if (!dealersPrice || !retailPrice) return 'N/A';
    const costPrice = typeof dealersPrice === 'string' ? parseFloat(dealersPrice.replace(/[^\d.-]/g, '')) : dealersPrice;
    const sellPrice = typeof retailPrice === 'string' ? parseFloat(retailPrice.replace(/[^\d.-]/g, '')) : retailPrice;
    if (costPrice <= 0) return 'N/A';
    const marginAmount = sellPrice - costPrice;
    const marginPercentage = (marginAmount / costPrice) * 100;
    return `${marginPercentage.toFixed(2)}%`;
  };

  const formatWithGB = (value) => {
    if (!value) return 'N/A';
    if (value.includes('GB') || value.includes('TB') || value.includes('gb') || value.includes('tb')) {
      return value;
    }
    return `${value}GB`;
  };

  // Apply filters to data
  const applyFilters = () => {
    if (!inventoryData.length) return;
    const filtered = inventoryData.filter(item => {
      if (filters.manufacturer && item.manufacturer !== filters.manufacturer) return false;
      if (filters.model && item.model !== filters.model) return false;
      if (filters.ram && item.ram !== filters.ram) return false;
      if (filters.storage && item.storage !== filters.storage) return false;
      if (filters.color && !item.colors.some(colorData => colorData.color === filters.color)) return false;
      return true;
    });
    setFilteredData(filtered);
  };
  
  // Update filtered options based on current selections
  const updateFilteredOptions = () => {
    if (!inventoryData.length) return;
    
    let filteredModels = filterOptions.models;
    let filteredRams = filterOptions.rams;
    let filteredStorages = filterOptions.storages;
    let filteredColors = filterOptions.colors;
    
    if (filters.manufacturer) {
      filteredModels = [...new Set(
        inventoryData
          .filter(item => item.manufacturer === filters.manufacturer)
          .map(item => item.model)
      )].sort();
    }
    
    if (filters.manufacturer || filters.model) {
      let filtered = inventoryData;
      if (filters.manufacturer) {
        filtered = filtered.filter(item => item.manufacturer === filters.manufacturer);
      }
      if (filters.model) {
        filtered = filtered.filter(item => item.model === filters.model);
      }
      filteredRams = [...new Set(filtered.map(item => item.ram))].sort();
    }
    
    if (filters.manufacturer || filters.model || filters.ram) {
      let filtered = inventoryData;
      if (filters.manufacturer) {
        filtered = filtered.filter(item => item.manufacturer === filters.manufacturer);
      }
      if (filters.model) {
        filtered = filtered.filter(item => item.model === filters.model);
      }
      if (filters.ram) {
        filtered = filtered.filter(item => item.ram === filters.ram);
      }
      filteredStorages = [...new Set(filtered.map(item => item.storage))].sort();
    }
{/* Part 2 End - Helper Functions and Filters */}

{/* Part 3 Start - Filter Options Update and Date Helper */}
    if (filters.manufacturer || filters.model || filters.ram || filters.storage) {
      let filtered = inventoryData;
      if (filters.manufacturer) {
        filtered = filtered.filter(item => item.manufacturer === filters.manufacturer);
      }
      if (filters.model) {
        filtered = filtered.filter(item => item.model === filters.model);
      }
      if (filters.ram) {
        filtered = filtered.filter(item => item.ram === filters.ram);
      }
      if (filters.storage) {
        filtered = filtered.filter(item => item.storage === filters.storage);
      }
      filteredColors = [...new Set(
        filtered.flatMap(item => item.colors.map(colorData => colorData.color))
      )].sort();
    }
    
    setFilteredOptions({
      models: filteredModels,
      rams: filteredRams,
      storages: filteredStorages,
      colors: filteredColors
    });
  };

  // NEW: Helper function to check if a date is within the current month
  const isWithinCurrentMonth = (dateString) => {
    if (!dateString) return false;
    
    try {
      const itemDate = new Date(dateString);
      const currentDate = new Date();
      
      // Check if dates are valid
      if (isNaN(itemDate.getTime()) || isNaN(currentDate.getTime())) {
        return false;
      }
      
      // Compare year and month
      return itemDate.getFullYear() === currentDate.getFullYear() && 
             itemDate.getMonth() === currentDate.getMonth();
    } catch (error) {
      console.error("Error parsing date:", dateString, error);
      return false;
    }
  };

  // UPDATED: Fetch and process inventory data with exclusion logic, improved sorting, current month sold filter, and useCallback
  const fetchInventoryData = useCallback(async () => {
    setLoading(true);
    setError(null);
    
    try {
      // NEW: First, get the list of excluded models from the phones collection
      const phonesRef = collection(db, 'phones');
      const phonesSnapshot = await getDocs(phonesRef);
      
      const excludedModels = new Set();
      phonesSnapshot.forEach(doc => {
        const phoneData = doc.data();
        // If excludeFromSummary is true, add the manufacturer_model combination to excluded set
        if (phoneData.excludeFromSummary === true && phoneData.manufacturer && phoneData.model) {
          const modelKey = `${phoneData.manufacturer}_${phoneData.model}`;
          excludedModels.add(modelKey);
          console.log(`Excluding model from summary: ${phoneData.manufacturer} ${phoneData.model}`);
        }
      });
      
      console.log(`Found ${excludedModels.size} excluded models:`, Array.from(excludedModels));
      
      // Now fetch inventory data
      const inventoryRef = collection(db, 'inventory');
      const snapshot = await getDocs(inventoryRef);
      
      // Group inventory by manufacturer, model, ram, storage (excluding color)
      const groupedData = {};
      const manufacturers = new Set();
      const models = new Set();
      const rams = new Set();
      const storages = new Set();
      const colors = new Set();
{/* Part 3 End - Filter Options Update and Date Helper */}

{/* Part 4 Start - Inventory Data Processing */}
      snapshot.forEach(doc => {
        const item = { id: doc.id, ...doc.data() };
        
        // NEW: Check if this model should be excluded from summary
        const modelKey = `${item.manufacturer}_${item.model}`;
        if (excludedModels.has(modelKey)) {
          console.log(`Skipping excluded model: ${item.manufacturer} ${item.model}`);
          return; // Skip this item
        }
        
        const baseKey = `${item.manufacturer}_${item.model}_${item.ram}_${item.storage}`;
        
        // Add to filter options
        if (item.manufacturer) manufacturers.add(item.manufacturer);
        if (item.model) models.add(item.model);
        if (item.ram) rams.add(item.ram);
        if (item.storage) storages.add(item.storage);
        if (item.color) colors.add(item.color);
        
        if (!groupedData[baseKey]) {
          groupedData[baseKey] = {
            manufacturer: item.manufacturer,
            model: item.model,
            ram: item.ram,
            storage: item.storage,
            totalSold: 0,
            totalOnDisplay: 0,
            totalOnHand: 0,
            totalAvailable: 0,
            totalPending: 0,  // NEW: Added totalPending
            dealersPrice: item.dealersPrice || 0,
            retailPrice: item.retailPrice || 0,
            colors: {}
          };
        }
        
        // Group by color for color breakdown
        if (!groupedData[baseKey].colors[item.color]) {
          groupedData[baseKey].colors[item.color] = {
            color: item.color,
            sold: 0,
            onDisplay: 0,
            onHand: 0,
            available: 0,
            pending: 0,  // NEW: Added pending to color breakdown
            dealersPrice: item.dealersPrice || 0,
            retailPrice: item.retailPrice || 0,
            soldItems: [],
            onDisplayItems: [],
            onHandItems: []
          };
        }
        
        // Update counts based on status
        if (item.status === 'Sold') {
          // NEW: Filter sold items by current month
          if (isWithinCurrentMonth(item.lastUpdated)) {
            groupedData[baseKey].totalSold++;
            groupedData[baseKey].colors[item.color].sold++;
            groupedData[baseKey].colors[item.color].soldItems.push(item);
          }
        } else if (item.status === 'On-Display') {
          groupedData[baseKey].totalOnDisplay++;
          groupedData[baseKey].totalAvailable++;
          groupedData[baseKey].colors[item.color].onDisplay++;
          groupedData[baseKey].colors[item.color].available++;
          groupedData[baseKey].colors[item.color].onDisplayItems.push(item);
        } else if (item.status === 'On-Hand' || item.status === 'Stock') {
          groupedData[baseKey].totalOnHand++;
          groupedData[baseKey].totalAvailable++;
          groupedData[baseKey].colors[item.color].onHand++;
          groupedData[baseKey].colors[item.color].available++;
          groupedData[baseKey].colors[item.color].onHandItems.push(item);
        }
      });
      
      // NEW: Fetch procurement data to calculate pending items
      const procurementsRef = collection(db, 'procurements');
      const procurementsSnapshot = await getDocs(procurementsRef);
      
      procurementsSnapshot.forEach(doc => {
        const procurement = { id: doc.id, ...doc.data() };
        
        // Only process if delivery status is pending
        if (procurement.deliveryStatus === 'pending' && procurement.items && Array.isArray(procurement.items)) {
          procurement.items.forEach(item => {
            // Check if this model should be excluded from summary
            const modelKey = `${item.manufacturer}_${item.model}`;
            if (excludedModels.has(modelKey)) {
              return; // Skip this item
            }
            
            const baseKey = `${item.manufacturer}_${item.model}_${item.ram}_${item.storage}`;
            
            // If this configuration exists in grouped data, update pending count
            if (groupedData[baseKey]) {
              groupedData[baseKey].totalPending += (item.quantity || 0);
              
              // Update color-specific pending count
              if (groupedData[baseKey].colors[item.color]) {
                groupedData[baseKey].colors[item.color].pending += (item.quantity || 0);
              } else {
                // Create color entry if it doesn't exist yet
                groupedData[baseKey].colors[item.color] = {
                  color: item.color,
                  sold: 0,
                  onDisplay: 0,
                  onHand: 0,
                  available: 0,
                  pending: item.quantity || 0,
                  dealersPrice: item.dealersPrice || 0,
                  retailPrice: item.retailPrice || 0,
                  soldItems: [],
                  onDisplayItems: [],
                  onHandItems: []
                };
              }
            } else {
              // Create new entry if this configuration doesn't exist yet
              groupedData[baseKey] = {
                manufacturer: item.manufacturer,
                model: item.model,
                ram: item.ram,
                storage: item.storage,
                totalSold: 0,
                totalOnDisplay: 0,
                totalOnHand: 0,
                totalAvailable: 0,
                totalPending: item.quantity || 0,
                dealersPrice: item.dealersPrice || 0,
                retailPrice: item.retailPrice || 0,
                colors: {
                  [item.color]: {
                    color: item.color,
                    sold: 0,
                    onDisplay: 0,
                    onHand: 0,
                    available: 0,
                    pending: item.quantity || 0,
                    soldItems: [],
                    onDisplayItems: [],
                    onHandItems: []
                  }
                }
              };
              
              // Add to filter options if not already present
              if (item.manufacturer) manufacturers.add(item.manufacturer);
              if (item.model) models.add(item.model);
              if (item.ram) rams.add(item.ram);
              if (item.storage) storages.add(item.storage);
              if (item.color) colors.add(item.color);
            }
          });
        }
      });
      
      // Convert colors object to array and sort by color name
      Object.values(groupedData).forEach(item => {
        item.colors = Object.values(item.colors).sort((a, b) => 
          a.color.localeCompare(b.color)
        );
      });
      
      // Helper function to extract numeric value from RAM/Storage strings
      const extractNumericValue = (value) => {
        if (!value) return 0;
        
        // Extract numeric value and unit
        const match = value.match(/(\d+(?:\.\d+)?)/);
        if (!match) return 0;
        
        const num = parseFloat(match[1]);
        // Convert TB to GB for consistent comparison
        if (value.toLowerCase().includes('tb')) {
          return num * 1024;
        }
        return num;
      };
      
      // UPDATED: Improved sorting logic with numeric comparison for RAM and storage
      const inventoryArray = Object.values(groupedData).sort((a, b) => {
        // 1. Sort by manufacturer (string comparison)
        if (a.manufacturer !== b.manufacturer) {
          return a.manufacturer.localeCompare(b.manufacturer);
        }
        
        // 2. Sort by model (string comparison)
        if (a.model !== b.model) {
          return a.model.localeCompare(b.model);
        }
        
        // 3. Sort by RAM (numeric comparison - smallest to largest)
        const ramA = extractNumericValue(a.ram);
        const ramB = extractNumericValue(b.ram);
        if (ramA !== ramB) {
          return ramA - ramB; // Ascending order (smallest to largest)
        }
        
        // 4. Sort by storage (numeric comparison - smallest to largest)
        const storageA = extractNumericValue(a.storage);
        const storageB = extractNumericValue(b.storage);
        return storageA - storageB; // Ascending order (smallest to largest)
      });
{/* Part 4 End - Inventory Data Processing */}

{/* Part 5 Start - Final Data Setup and Effects */}
      const filterOpts = {
        manufacturers: [...manufacturers].sort(),
        models: [...models].sort(),
        rams: [...rams].sort(),
        storages: [...storages].sort(),
        colors: [...colors].sort()
      };
      setFilterOptions(filterOpts);
      setFilteredOptions({
        models: filterOpts.models,
        rams: filterOpts.rams,
        storages: filterOpts.storages,
        colors: filterOpts.colors
      });
      
      setInventoryData(inventoryArray);
      setFilteredData(inventoryArray);
      setLoading(false);
      
      // NEW: Log summary of excluded models for debugging
      console.log(`Inventory Summary loaded: ${inventoryArray.length} configurations (${excludedModels.size} models excluded)`);
      console.log(`Sold items filtered to current month only`);
      
    } catch (err) {
      console.error("Error fetching inventory data:", err);
      setError(`Error fetching inventory: ${err.message}`);
      setLoading(false);
    }
  }, []); // Empty dependency array since this function doesn't depend on any state or props

  // UPDATED: Effects with proper dependencies to fix React Hook warnings
  useEffect(() => {
    fetchInventoryData();
    fetchExcludedModelsInfo();
  }, [fetchInventoryData, fetchExcludedModelsInfo]); // Both functions are now memoized with useCallback
  
  useEffect(() => {
    updateFilteredOptions();
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [inventoryData, filters]);
  
  useEffect(() => {
    applyFilters();
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [filters, inventoryData]);

  // Loading state
  if (loading) {
    return (
      <div className="min-h-screen bg-white p-4">
        <Card className="w-full max-w-[1400px] mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
          <CardHeader className="bg-[rgb(52,69,157)] py-3">
            <CardTitle className="text-2xl text-white">Inventory Summary</CardTitle>
          </CardHeader>
          <CardContent className="p-4">
            <div className="text-center py-12">
              <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[rgb(52,69,157)]"></div>
              <p className="mt-2 text-gray-600">Loading inventory data...</p>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Error state
  if (error) {
    return (
      <div className="min-h-screen bg-white p-4">
        <Card className="w-full max-w-[1400px] mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
          <CardHeader className="bg-red-600 py-3">
            <CardTitle className="text-2xl text-white">Error</CardTitle>
          </CardHeader>
          <CardContent className="p-4">
            <p className="text-red-600">{error}</p>
            <button 
              onClick={fetchInventoryData}
              className="mt-4 px-4 py-2 bg-[rgb(52,69,157)] text-white rounded"
            >
              Try Again
            </button>
          </CardContent>
        </Card>
      </div>
    );
  }
{/* Part 5 End - Final Data Setup and Effects */}

{/* Part 6 Start - Main Return Header and Filter Panel */}
  return (
    <div className="min-h-screen bg-white p-4">
      <Card className="w-full max-w-[1400px] mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
        <CardHeader className="bg-[rgb(52,69,157)] py-3 flex flex-row justify-between items-center">
          <div className="flex items-center gap-2">
            <Smartphone className="h-6 w-6 text-white" />
            <CardTitle className="text-2xl text-white">Inventory Summary</CardTitle>
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => setShowFilters(!showFilters)}
              className={`flex items-center gap-1 ${showFilters ? 'bg-white/20 text-white' : 'bg-white text-[rgb(52,69,157)]'} px-4 py-2 rounded text-base font-medium`}
            >
              <Filter className="h-5 w-5 mr-1" />
              <span>Filters</span>
            </button>
            <button
              onClick={fetchInventoryData}
              className="flex items-center gap-1 bg-white text-[rgb(52,69,157)] px-4 py-2 rounded text-base font-medium"
            >
              <RefreshCw className="h-5 w-5 mr-1" />
              <span>Refresh</span>
            </button>
          </div>
        </CardHeader>

        {/* Filter Panel */}
        {showFilters && (
          <div className="bg-gray-50 px-4 py-4 border-b">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-lg text-[rgb(52,69,157)]">Filters</h3>
              <button 
                onClick={clearFilters}
                className="text-gray-500 hover:text-red-500 flex items-center"
              >
                <X className="h-4 w-4 mr-1" />
                Clear Filters
              </button>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Manufacturer</label>
                <select name="manufacturer" value={filters.manufacturer} onChange={handleFilterChange} className="w-full p-2 border rounded">
                  <option value="">All Manufacturers</option>
                  {filterOptions.manufacturers.map(manufacturer => (
                    <option key={manufacturer} value={manufacturer}>{manufacturer}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Model</label>
                <select name="model" value={filters.model} onChange={handleFilterChange} className="w-full p-2 border rounded">
                  <option value="">All Models</option>
                  {filteredOptions.models.map(model => (
                    <option key={model} value={model}>{model}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">RAM</label>
                <select name="ram" value={filters.ram} onChange={handleFilterChange} className="w-full p-2 border rounded">
                  <option value="">All RAM</option>
                  {filteredOptions.rams.map(ram => (
                    <option key={ram} value={ram}>{ram}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Storage</label>
                <select name="storage" value={filters.storage} onChange={handleFilterChange} className="w-full p-2 border rounded">
                  <option value="">All Storage</option>
                  {filteredOptions.storages.map(storage => (
                    <option key={storage} value={storage}>{storage}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Color</label>
                <select name="color" value={filters.color} onChange={handleFilterChange} className="w-full p-2 border rounded">
                  <option value="">All Colors</option>
                  {filteredOptions.colors.map(color => (
                    <option key={color} value={color}>{color}</option>
                  ))}
                </select>
              </div>
            </div>
            
            {/* Active filters summary */}
            {Object.values(filters).some(filter => filter !== '') && (
              <div className="mt-4 flex flex-wrap gap-2">
                {Object.entries(filters).map(([key, value]) => 
                  value && (
                    <div key={key} className="bg-gray-200 rounded-full px-3 py-1 text-sm flex items-center">
                      <span className="font-medium capitalize">{key}:</span>
                      <span className="ml-1">{value}</span>
                      <button 
                        onClick={() => setFilters(prev => ({ ...prev, [key]: '' }))}
                        className="ml-2 text-gray-500 hover:text-gray-700"
                      >
                        <X className="h-3 w-3" />
                      </button>
                    </div>
                  )
                )}
              </div>
            )}
          </div>
        )}
{/* Part 6 End - Main Return Header and Filter Panel */}

{/* Part 7 Start - Excluded Models Info and Table Start */}
        {/* NEW: Add Excluded Models Info Display */}
        <CardContent className="p-4">
          {excludedModelsInfo.length > 0 && (
            <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
              <div className="flex items-center gap-2 mb-2">
                <CircleAlert className="h-5 w-5 text-yellow-600" />
                <h4 className="font-medium text-yellow-800">
                  Excluded Models ({excludedModelsInfo.length})
                </h4>
              </div>
              <div className="text-sm text-yellow-700">
                The following models are excluded from this summary:
              </div>
              <div className="mt-2 flex flex-wrap gap-2">
                {excludedModelsInfo.map((model, index) => (
                  <span 
                    key={index}
                    className="inline-block px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded"
                  >
                    {model.manufacturer} {model.model}
                  </span>
                ))}
              </div>
            </div>
          )}

          {filteredData.length === 0 ? (
            <div className="text-center py-12 bg-gray-50 rounded-lg border border-dashed border-gray-300">
              <Smartphone className="h-12 w-12 text-gray-400 mx-auto mb-4" />
              <h3 className="text-lg font-medium text-gray-700 mb-2">No inventory data found</h3>
              {Object.values(filters).some(f => f) ? (
                <>
                  <p className="text-gray-500 mb-4">No items match your current filters.</p>
                  <button onClick={clearFilters} className="px-4 py-2 bg-[rgb(52,69,157)] text-white rounded-md">
                    Clear Filters
                  </button>
                </>
              ) : (
                <p className="text-gray-500">There are no inventory items in the database.</p>
              )}
            </div>
          ) : (
            <div className="space-y-4">
              {/* Inventory list */}
              <div className="bg-white border rounded-lg overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr className="text-xs font-semibold text-gray-700 uppercase tracking-wider">
                      <th className="px-3 py-3 text-left">Manufacturer</th>
                      <th className="px-3 py-3 text-left">Model</th>
                      <th className="px-3 py-3 text-left">RAM</th>
                      <th className="px-3 py-3 text-left">Storage</th>
                      <th className="px-3 py-3 text-left">Colors</th>
                      <th className="pl-0 pr-1 py-3 text-center">DP</th>
                      <th className="px-1 py-3 text-center">SRP</th>
                      <th className="px-1 py-3 text-right">Margin</th>
                      <th className="pl-12 pr-1 py-3 text-center">Sold</th>
                      <th className="px-1 py-3 text-center">Display</th>
                      <th className="px-1 py-3 text-center">Stock</th>
                      <th className="px-1 py-3 text-center">Available</th>
                      <th className="px-1 py-3 text-center">Pending</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {filteredData.map((item, index) => (
                      <React.Fragment key={index}>
                        {/* Main row */}
                        <tr 
                          className={`hover:bg-gray-100 cursor-pointer ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}
                          onClick={() => toggleRowExpansion(index)}
                        >
                          <td className="px-3 py-3 text-sm">{item.manufacturer}</td>
                          <td className="px-3 py-3 text-sm font-medium">{item.model}</td>
                          <td className="px-3 py-3 text-sm">{formatWithGB(item.ram)}</td>
                          <td className="px-3 py-3 text-sm">{formatWithGB(item.storage)}</td>
                          <td className="px-3 py-3 text-sm">
                            <div className="flex flex-wrap gap-1">
                              {item.colors.slice(0, 3).map((colorData, colorIndex) => (
                                <span 
                                  key={colorIndex} 
                                  className="inline-block px-2 py-1 text-xs bg-gray-100 rounded"
                                >
                                  {colorData.color}
                                </span>
                              ))}
                              {item.colors.length > 3 && (
                                <span className="inline-block px-2 py-1 text-xs bg-gray-200 rounded">
                                  +{item.colors.length - 3} more
                                </span>
                              )}
                            </div>
                          </td>
                          <td className="pl-0 pr-1 py-3 text-sm text-right">{formatPrice(item.dealersPrice)}</td>
                          <td className="px-1 py-3 text-sm text-right">{formatPrice(item.retailPrice)}</td>
                          <td className="px-1 py-3 text-sm text-right font-medium">
                            {calculateMargin(item.dealersPrice, item.retailPrice)}
                          </td>
                          <td className="pl-12 pr-1 py-2 text-sm text-center">
                            <span className="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">
                              {item.totalSold}
                            </span>
                          </td>
                          <td className="px-1 py-2 text-sm text-center">
                            <span className="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">
                              {item.totalOnDisplay}
                            </span>
                          </td>
                          <td className="px-1 py-2 text-sm text-center">
                            <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                              {item.totalOnHand}
                            </span>
                          </td>
                          <td className="px-1 py-2 text-sm text-center">
                            <span className="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                              {item.totalAvailable}
                            </span>
                          </td>
                          <td className="px-1 py-2 text-sm text-center">
                            <span className="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-medium">
                              {item.totalPending}
                            </span>
                          </td>
                        </tr>
{/* Part 7 End - Excluded Models Info and Table Start */}

{/* Part 8 Start - Expanded Color Breakdown */}
                        {/* Expanded color breakdown */}
                        {expandedRows.has(index) && (
                          <tr>
                            <td colSpan="13" className="px-0 py-0 border-b border-gray-200">
                              <div className="px-4 pb-4 pt-2 bg-gray-100">
                                <div className="space-y-4">
                                  <h4 className="font-semibold text-gray-700 mb-3">
                                    Color Breakdown ({item.colors.length} colors)
                                  </h4>
                                  
                                  {item.colors.map((colorData, colorIndex) => (
                                    <div key={colorIndex} className="border border-gray-200 rounded-lg bg-white">
                                      {/* Color header - Now clickable to expand/collapse detail sections */}
                                      <div 
                                        className="px-4 py-3 bg-gray-50 border-b border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors"
                                        onClick={() => toggleColorRowExpansion(index, colorIndex)}
                                      >
                                        <div className="flex justify-between items-center">
                                          <div className="flex items-center gap-4">
                                            <div className="flex items-center gap-2">
                                              {expandedColorRows[index]?.[colorIndex] ? (
                                                <ChevronDown className="h-5 w-5 text-gray-600" />
                                              ) : (
                                                <ChevronRight className="h-5 w-5 text-gray-600" />
                                              )}
                                              <h5 className="font-bold text-lg text-gray-800">{colorData.color}</h5>
                                            </div>
                                            <div className="flex gap-4 text-sm">
                                              <span className="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">
                                                Sold: {colorData.sold}
                                              </span>
                                              <span className="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs">
                                                Display: {colorData.onDisplay}
                                              </span>
                                              <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">
                                                Stock: {colorData.onHand}
                                              </span>
                                              <span className="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">
                                                Available: {colorData.available}
                                              </span>
                                              <span className="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs">
                                                Pending: {colorData.pending}
                                              </span>
                                            </div>
                                          </div>
                                          <div className="text-sm text-gray-600">
                                            {formatPrice(colorData.retailPrice)}  {calculateMargin(colorData.dealersPrice, colorData.retailPrice)} margin
                                          </div>
                                        </div>
                                      </div>
                                      
                                      {/* Color details sections - Only show when color row is expanded */}
                                      {expandedColorRows[index]?.[colorIndex] && (
                                        <div className="p-4 space-y-3">
                                          {/* Sold Items */}
                                          {colorData.soldItems.length > 0 && (
                                            <div>
                                              <div 
                                                className="flex items-center justify-between cursor-pointer bg-purple-50 p-2 rounded-t border border-purple-200"
                                                onClick={(e) => {
                                                  e.stopPropagation();
                                                  toggleColorSectionExpansion(index, colorIndex, 'sold');
                                                }}
                                              >
                                                <h6 className="font-semibold text-purple-700">
                                                  Sold Units ({colorData.sold})
                                                </h6>
                                                {expandedColorSections[index]?.[`${colorIndex}_sold`] ? (
                                                  <ChevronDown className="h-4 w-4 text-purple-500" />
                                                ) : (
                                                  <ChevronRight className="h-4 w-4 text-purple-500" />
                                                )}
                                              </div>
                                              
                                              {expandedColorSections[index]?.[`${colorIndex}_sold`] && (
                                                <div className="overflow-x-auto border border-t-0 border-purple-200 rounded-b">
                                                  <table className="min-w-full">
                                                    <thead className="bg-purple-50">
                                                      <tr className="text-xs text-purple-800">
                                                        <th className="py-2 px-3 text-left border-b">IMEI1</th>
                                                        <th className="py-2 px-3 text-left border-b">IMEI2</th>
                                                        <th className="py-2 px-3 text-left border-b">Barcode</th>
                                                        <th className="py-2 px-3 text-right border-b">Retail Price</th>
                                                        <th className="py-2 px-3 text-left border-b">Last Updated</th>
                                                      </tr>
                                                    </thead>
                                                    <tbody className="bg-white">
                                                      {colorData.soldItems.map((soldItem, soldIndex) => (
                                                        <tr key={soldIndex} className={soldIndex % 2 === 0 ? 'bg-white' : 'bg-purple-50'}>
                                                          <td className="py-2 px-3 text-xs">{soldItem.imei1 || 'N/A'}</td>
                                                          <td className="py-2 px-3 text-xs">{soldItem.imei2 || '-'}</td>
                                                          <td className="py-2 px-3 text-xs">{soldItem.barcode || 'N/A'}</td>
                                                          <td className="py-2 px-3 text-xs text-right">{formatPrice(soldItem.retailPrice)}</td>
                                                          <td className="py-2 px-3 text-xs">{formatDate(soldItem.lastUpdated)}</td>
                                                        </tr>
                                                      ))}
                                                    </tbody>
                                                  </table>
                                                </div>
                                              )}
                                            </div>
                                          )}
{/* Part 8 End - Expanded Color Breakdown */}

{/* Part 9 Start - Display and Stock Items Tables */}
                                          {/* On Display Items */}
                                          {colorData.onDisplayItems.length > 0 && (
                                            <div>
                                              <div 
                                                className="flex items-center justify-between cursor-pointer bg-yellow-50 p-2 rounded-t border border-yellow-200"
                                                onClick={(e) => {
                                                  e.stopPropagation();
                                                  toggleColorSectionExpansion(index, colorIndex, 'display');
                                                }}
                                              >
                                                <h6 className="font-semibold text-yellow-700">
                                                  Display Units ({colorData.onDisplay})
                                                </h6>
                                                {expandedColorSections[index]?.[`${colorIndex}_display`] ? (
                                                  <ChevronDown className="h-4 w-4 text-yellow-500" />
                                                ) : (
                                                  <ChevronRight className="h-4 w-4 text-yellow-500" />
                                                )}
                                              </div>
                                              
                                              {expandedColorSections[index]?.[`${colorIndex}_display`] && (
                                                <div className="overflow-x-auto border border-t-0 border-yellow-200 rounded-b">
                                                  <table className="min-w-full">
                                                    <thead className="bg-yellow-50">
                                                      <tr className="text-xs text-yellow-800">
                                                        <th className="py-2 px-3 text-left border-b">IMEI1</th>
                                                        <th className="py-2 px-3 text-left border-b">IMEI2</th>
                                                        <th className="py-2 px-3 text-left border-b">Barcode</th>
                                                        <th className="py-2 px-3 text-right border-b">Retail Price</th>
                                                        <th className="py-2 px-3 text-left border-b">Last Updated</th>
                                                      </tr>
                                                    </thead>
                                                    <tbody className="bg-white">
                                                      {colorData.onDisplayItems.map((displayItem, displayIndex) => (
                                                        <tr key={displayIndex} className={displayIndex % 2 === 0 ? 'bg-white' : 'bg-yellow-50'}>
                                                          <td className="py-2 px-3 text-xs">{displayItem.imei1 || 'N/A'}</td>
                                                          <td className="py-2 px-3 text-xs">{displayItem.imei2 || '-'}</td>
                                                          <td className="py-2 px-3 text-xs">{displayItem.barcode || 'N/A'}</td>
                                                          <td className="py-2 px-3 text-xs text-right">{formatPrice(displayItem.retailPrice)}</td>
                                                          <td className="py-2 px-3 text-xs">{formatDate(displayItem.lastUpdated)}</td>
                                                        </tr>
                                                      ))}
                                                    </tbody>
                                                  </table>
                                                </div>
                                              )}
                                            </div>
                                          )}
                                          
                                          {/* On Hand Items */}
                                          {colorData.onHandItems.length > 0 && (
                                            <div>
                                              <div 
                                                className="flex items-center justify-between cursor-pointer bg-blue-50 p-2 rounded-t border border-blue-200"
                                                onClick={(e) => {
                                                  e.stopPropagation();
                                                  toggleColorSectionExpansion(index, colorIndex, 'stock');
                                                }}
                                              >
                                                <h6 className="font-semibold text-blue-700">
                                                  Stock Units ({colorData.onHand})
                                                </h6>
                                                {expandedColorSections[index]?.[`${colorIndex}_stock`] ? (
                                                  <ChevronDown className="h-4 w-4 text-blue-500" />
                                                ) : (
                                                  <ChevronRight className="h-4 w-4 text-blue-500" />
                                                )}
                                              </div>
                                              
                                              {expandedColorSections[index]?.[`${colorIndex}_stock`] && (
                                                <div className="overflow-x-auto border border-t-0 border-blue-200 rounded-b">
                                                  <table className="min-w-full">
                                                    <thead className="bg-blue-50">
                                                      <tr className="text-xs text-blue-800">
                                                        <th className="py-2 px-3 text-left border-b">IMEI1</th>
                                                        <th className="py-2 px-3 text-left border-b">IMEI2</th>
                                                        <th className="py-2 px-3 text-left border-b">Barcode</th>
                                                        <th className="py-2 px-3 text-right border-b">Retail Price</th>
                                                        <th className="py-2 px-3 text-left border-b">Last Updated</th>
                                                      </tr>
                                                    </thead>
                                                    <tbody className="bg-white">
                                                      {colorData.onHandItems.map((handItem, handIndex) => (
                                                        <tr key={handIndex} className={handIndex % 2 === 0 ? 'bg-white' : 'bg-blue-50'}>
                                                          <td className="py-2 px-3 text-xs">{handItem.imei1 || 'N/A'}</td>
                                                          <td className="py-2 px-3 text-xs">{handItem.imei2 || '-'}</td>
                                                          <td className="py-2 px-3 text-xs">{handItem.barcode || 'N/A'}</td>
                                                          <td className="py-2 px-3 text-xs text-right">{formatPrice(handItem.retailPrice)}</td>
                                                          <td className="py-2 px-3 text-xs">{formatDate(handItem.lastUpdated)}</td>
                                                        </tr>
                                                      ))}
                                                    </tbody>
                                                  </table>
                                                </div>
                                              )}
                                            </div>
                                          )}

                                          {/* Empty states */}
                                          {colorData.soldItems.length === 0 && colorData.onDisplayItems.length === 0 && colorData.onHandItems.length === 0 && (
                                            <div className="text-center py-4 text-gray-500">
                                              No detailed information available for this color
                                            </div>
                                          )}
                                        </div>
                                      )}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            </td>
                          </tr>
                        )}
                      </React.Fragment>
                    ))}
                  </tbody>
                </table>
              </div>
{/* Part 9 End - Display and Stock Items Tables */}

{/* Part 10 Start - Inventory Value Summary and Footer */}
              {/* Inventory Value Summary */}
              <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 mb-4">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">Inventory Value Summary</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="bg-white rounded-lg p-4 border border-blue-100 shadow-sm">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600 font-medium">{"Total Dealer's Value"}</p>
                        <p className="text-xs text-gray-500">{"(Available units  Dealer's price)"}</p>
                      </div>
                      <div className="text-right">
                        <p className="text-xl font-bold text-blue-600">
                          {(() => {
                            const totalDealerValue = filteredData.reduce((total, item) => {
                              return total + (item.totalAvailable * item.dealersPrice);
                            }, 0);
                            return formatPrice(totalDealerValue);
                          })()}
                        </p>
                        <p className="text-xs text-gray-500">
                          {filteredData.reduce((total, item) => total + item.totalAvailable, 0)} units
                        </p>
                      </div>
                    </div>
                  </div>
                  
                  <div className="bg-white rounded-lg p-4 border border-green-100 shadow-sm">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600 font-medium">Total Retail Value</p>
                        <p className="text-xs text-gray-500">{"(Available units  Retail price)"}</p>
                      </div>
                      <div className="text-right">
                        <p className="text-xl font-bold text-green-600">
                          {(() => {
                            const totalRetailValue = filteredData.reduce((total, item) => {
                              return total + (item.totalAvailable * item.retailPrice);
                            }, 0);
                            return formatPrice(totalRetailValue);
                          })()}
                        </p>
                        <p className="text-xs text-gray-500">
                          {filteredData.reduce((total, item) => total + item.totalAvailable, 0)} units
                        </p>
                      </div>
                    </div>
                  </div>
                  
                  <div className="bg-white rounded-lg p-4 border border-purple-100 shadow-sm">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600 font-medium">Potential Profit</p>
                        <p className="text-xs text-gray-500">{"(Retail value - Dealer's value)"}</p>
                      </div>
                      <div className="text-right">
                        <p className="text-xl font-bold text-purple-600">
                          {(() => {
                            const totalDealerValue = filteredData.reduce((total, item) => {
                              return total + (item.totalAvailable * item.dealersPrice);
                            }, 0);
                            const totalRetailValue = filteredData.reduce((total, item) => {
                              return total + (item.totalAvailable * item.retailPrice);
                            }, 0);
                            const potentialProfit = totalRetailValue - totalDealerValue;
                            return formatPrice(potentialProfit);
                          })()}
                        </p>
                        <p className="text-xs text-gray-500">
                          {(() => {
                            const totalDealerValue = filteredData.reduce((total, item) => {
                              return total + (item.totalAvailable * item.dealersPrice);
                            }, 0);
                            const totalRetailValue = filteredData.reduce((total, item) => {
                              return total + (item.totalAvailable * item.retailPrice);
                            }, 0);
                            const marginPercentage = totalDealerValue > 0 ? 
                              ((totalRetailValue - totalDealerValue) / totalDealerValue * 100) : 0;
                            return `${marginPercentage.toFixed(3)}% margin`;
                          })()}
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Summary footer */}
              <div className="text-center text-gray-600">
                {Object.values(filters).some(f => f) 
                  ? `Showing ${filteredData.length} of ${inventoryData.length} inventory configurations (filtered)`
                  : `Showing ${filteredData.length} inventory configurations`}
                {expandedRows.size > 0 && `  ${expandedRows.size} rows expanded`}
              </div>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
};

export default InventorySummaryForm;
{/* Part 10 End - Inventory Value Summary and Footer */}
</file>

<file path="src/components/phone-selection/PhoneSelectionForm.jsx">
{/* Part 1 Start - Imports and Dependencies */}
import { useGlobalState } from '../../context/GlobalStateContext'; // NEW: Import global state
import { updatePhoneInInventory } from './services/inventoryService'; // NEW: Import update function
import { useState, useEffect, useRef } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import PhoneBasicInfo from './PhoneBasicInfo';
import PhonePriceInfo from './PhonePriceInfo';
import PhoneColorInfo from './PhoneColorInfo';
import PhoneAdditionalInfo from './PhoneAdditionalInfo';
import usePhoneOptions from './hooks/usePhoneOptions';
import usePhoneCache from './hooks/usePhoneCache';
import { collection, query, where, getDocs, doc, getDoc, limit } from 'firebase/firestore';
import { db } from '../../firebase/config';
import { 
  formatNumberWithCommas,
  validateImei, 
  validatePrice,
  handleKeyDown, 
  getCurrentDate 
} from './utils/phoneUtils';
import { 
  checkDuplicateImeis, 
  addPhoneToInventory 
} from './services/inventoryService';
import supplierService from '../../services/supplierService'; // NEW: Import supplier service
import { Search, ArrowRight, CircleAlert } from 'lucide-react';
{/* Part 1 End - Imports and Dependencies */}

{/* Part 2 Start - Component and State Definitions */}
const PhoneSelectionForm = () => {
  // Get inventory item to edit from global state
  const { inventoryItemToEdit, clearInventoryItemToEdit } = useGlobalState(); // NEW: Get inventory edit state
  
  // ====== STATE DEFINITIONS ======
  // Core state for selections
  const [selectedManufacturer, setSelectedManufacturer] = useState('');
  const [selectedModel, setSelectedModel] = useState('');
  const [selectedColor, setSelectedColor] = useState('');
  const [selectedStorage, setSelectedStorage] = useState('');
  const [selectedRam, setSelectedRam] = useState('');
  
  // NEW: Track if we're in edit mode
  const [isEditMode, setIsEditMode] = useState(false);
  const [editItemId, setEditItemId] = useState(null);
  
  // Barcode search
  const [barcodeSearch, setBarcodeSearch] = useState('');
  const [isBarcodeSearching, setIsBarcodeSearching] = useState(false);
  const [barcodeSearchError, setBarcodeSearchError] = useState('');
  
  // Get options and loading state from custom hook
  const { 
    manufacturers, 
    models, 
    colors, 
    storage, 
    ram, 
    loading: optionsLoading, 
    error: optionsError,
    fetchManufacturers,
    fetchModels,
    fetchOptions
  } = usePhoneOptions();
  
  // Get price cache from custom hook (keeping for backward compatibility in form submission)
  const {
    updatePriceConfiguration
  } = usePhoneCache();
  
  // Track previous selection to avoid overwriting user edits
  const prevSelectionRef = useRef('');
  const prevColorRef = useRef('');
  
  // Form input fields state
  const [imei1, setImei1] = useState('');
  const [imei2, setImei2] = useState('');
  const [barcode, setBarcode] = useState('');
  const [serialNumber, setSerialNumber] = useState(''); // NEW: Added serial number state
  const [location, setLocation] = useState(''); // NEW: Added location state
  const [supplier, setSupplier] = useState(''); // NEW: Added supplier state
  const [suppliers, setSuppliers] = useState([]); // NEW: Added suppliers array state
  const [dealersPrice, setDealersPrice] = useState('');
  const [retailPrice, setRetailPrice] = useState('');
  const [status, setStatus] = useState('On-Hand');
  

  // ADD THIS DEBUGGING USEEFFECT
  useEffect(() => {
    console.log('Serial number state changed to:', serialNumber);
  }, [serialNumber]);

  // UI state
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isSpecsSelected, setIsSpecsSelected] = useState(false);
  const [isCheckingImei, setIsCheckingImei] = useState(false);
  const [imei1Error, setImei1Error] = useState('');
  const [imei2Error, setImei2Error] = useState('');
  const [lastUpdated, setLastUpdated] = useState(getCurrentDate());
  const [userEnteredBarcode, setUserEnteredBarcode] = useState(false);
{/* Part 2 End - Component and State Definitions */}

{/* Part 3 Start - Event Handlers */}
  // ====== EVENT HANDLERS ======
  // Event handlers for form inputs
  const handleManufacturerChange = (e) => {
    const newManufacturer = e.target.value;
    setSelectedManufacturer(newManufacturer);
    setSelectedModel('');
    setSelectedColor('');
    setSelectedStorage('');
    setSelectedRam('');
    setDealersPrice('');
    setRetailPrice('');
    
    if (newManufacturer) {
      fetchModels(newManufacturer);
    }
  };

  const handleModelChange = (e) => {
    const newModel = e.target.value;
    setSelectedModel(newModel);
    setSelectedColor('');
    setSelectedStorage('');
    setSelectedRam('');
    setDealersPrice('');
    setRetailPrice('');
    
    if (selectedManufacturer && newModel) {
      fetchOptions(selectedManufacturer, newModel);
    }
  };

  const handleColorChange = (e) => {
    setSelectedColor(e.target.value);
    // Reset user entered flag when color changes
    setUserEnteredBarcode(false);
  };

  const handleRamChange = (e) => {
    const newRam = e.target.value;
    setSelectedRam(newRam);
  };

  const handleStorageChange = (e) => {
    const newStorage = e.target.value;
    setSelectedStorage(newStorage);
  };

  const handleImei1Change = (e) => {
    const newImei = validateImei(e.target.value);
    setImei1(newImei);
    setImei1Error(''); // Clear error on change
  };

  const handleImei2Change = (e) => {
    const newImei = validateImei(e.target.value);
    setImei2(newImei);
    setImei2Error(''); // Clear error on change
  };

  const handleBarcodeChange = (e) => {
    const newBarcode = e.target.value.toUpperCase();
    setBarcode(newBarcode);
    // Set flag that user has entered a barcode manually
    setUserEnteredBarcode(true);
  };

  const handleSerialNumberChange = (e) => {
    const newSerialNumber = e.target.value.toUpperCase();
    console.log('Serial number changing to:', newSerialNumber); // ADD THIS
    setSerialNumber(newSerialNumber);
  };

  const handleLocationChange = (e) => {
    const newLocation = e.target.value;
    setLocation(newLocation);
  };

  const handleSupplierChange = (e) => {
    const newSupplier = e.target.value;
    setSupplier(newSupplier);
  };

  const handleBarcodeSearchChange = (e) => {
    setBarcodeSearch(e.target.value.toUpperCase());
    setBarcodeSearchError('');
  };

  const handleBarcodeSearchKeyDown = (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleBarcodeSearch();
    }
  };

  // Handle barcode search
  const handleBarcodeSearch = async () => {
    if (!barcodeSearch.trim()) {
      setBarcodeSearchError('Please enter a barcode to search');
      return;
    }
    
    setIsBarcodeSearching(true);
    setBarcodeSearchError('');
    
    try {
      // Search for the barcode in inventory
      const inventoryRef = collection(db, 'inventory');
      const q = query(
        inventoryRef, 
        where("barcode", "==", barcodeSearch.trim())
      );
      const snapshot = await getDocs(q);
      
      if (snapshot.empty) {
        setBarcodeSearchError('No matching phone found for this barcode');
        setIsBarcodeSearching(false);
        return;
      }
      
      // Get the first matching record
      const matchingPhone = snapshot.docs[0].data();
      
      // Set all the fields accordingly
      setSelectedManufacturer(matchingPhone.manufacturer);
      
      // Fetch models for this manufacturer
      await fetchModels(matchingPhone.manufacturer);
      
      setSelectedModel(matchingPhone.model);
      
      // Fetch options for this model
      await fetchOptions(matchingPhone.manufacturer, matchingPhone.model);
      
      setSelectedRam(matchingPhone.ram);
      setSelectedStorage(matchingPhone.storage);
      setSelectedColor(matchingPhone.color);
      
      // Set prices
      setDealersPrice(formatNumberWithCommas(matchingPhone.dealersPrice.toString()));
      setRetailPrice(formatNumberWithCommas(matchingPhone.retailPrice.toString()));
      
      // Set isSpecsSelected to true BEFORE setting barcode
      setIsSpecsSelected(true);
      
      // Use setTimeout to ensure the DOM has updated and the barcode field exists
      setTimeout(() => {
        // Set barcode
        setBarcode(matchingPhone.barcode);
        setUserEnteredBarcode(true); // Treat this as a user-confirmed barcode
      }, 0);
      
      // Clear the barcode search
      setBarcodeSearch('');
      
      // Clear IMEI fields (these should be empty for a new entry)
      setImei1('');
      setImei2('');
      setSerialNumber('');

      // Set status and last updated
      setStatus('On-Hand');
      setLastUpdated(getCurrentDate());
      
    } catch (error) {
      console.error("Error searching by barcode:", error);
      setBarcodeSearchError('Error searching for barcode. Please try again.');
    } finally {
      setIsBarcodeSearching(false);
    }
  };

  // Pricing input handlers with commas that work correctly
  const handleDealersPriceChange = (e) => {
    const rawValue = e.target.value;
    
    // Check if input is empty and store as-is if it is
    if (rawValue === '') {
      setDealersPrice('');
    } else {
      // Apply formatting if not empty
      const validatedPrice = validatePrice(rawValue);
      const formattedPrice = formatNumberWithCommas(validatedPrice);
      setDealersPrice(formattedPrice);
    }
  };

  const handleRetailPriceChange = (e) => {
    const rawValue = e.target.value;
    
    // Check if input is empty and store as-is if it is
    if (rawValue === '') {
      setRetailPrice('');
    } else {
      // Apply formatting if not empty
      const validatedPrice = validatePrice(rawValue);
      const formattedPrice = formatNumberWithCommas(validatedPrice);
      setRetailPrice(formattedPrice);
    }
  };

  const handleStatusChange = (e) => {
    const newStatus = e.target.value;
    setStatus(newStatus);
    setLastUpdated(getCurrentDate());
  };

  // Form submission handler
  const handleSubmit = async (e) => {
    e.preventDefault();
    
    // Basic form validation - UPDATED to include location and supplier
    if (!selectedManufacturer || !selectedModel || !selectedRam || 
        !selectedStorage || !selectedColor || !imei1 || !barcode || 
        !dealersPrice || !retailPrice || !location || !supplier) {
      alert('Please fill in all required fields');
      return;
    }
    
    // Set checking state and clear previous errors
    setIsSubmitting(true);
    setIsCheckingImei(true);
    setImei1Error('');
    setImei2Error('');
    
    // Check for duplicate IMEIs before submitting (skip if editing same item)
    const imeisCheck = await checkDuplicateImeis(imei1, imei2, isEditMode ? editItemId : null);
    
    setIsCheckingImei(false);
    
    if (!imeisCheck.isValid) {
      setImei1Error(imeisCheck.imei1Error);
      setImei2Error(imeisCheck.imei2Error);
      setIsSubmitting(false);
      return; // Don't proceed if IMEIs are invalid
    }
    
    // Update lastUpdated on submit
    const currentDate = getCurrentDate();
    setLastUpdated(currentDate);
    
    // Parse prices properly removing commas
    const dPrice = parseFloat(dealersPrice.replace(/,/g, '')) || 0;
    const rPrice = parseFloat(retailPrice.replace(/,/g, '')) || 0;
    
    const phoneData = {
      manufacturer: selectedManufacturer,
      model: selectedModel,
      color: selectedColor,
      ram: selectedRam,
      storage: selectedStorage,
      imei1,
      imei2,
      barcode,
      serialNumber, // NEW: Added serial number to phone data
      location, // NEW: Added location to phone data
      supplier, // NEW: Added supplier to phone data
      dealersPrice: dPrice,
      retailPrice: rPrice,
      status,
      lastUpdated: currentDate,
      dateAdded: isEditMode ? inventoryItemToEdit.dateAdded : currentDate // Preserve original date if editing
    };
    
    setLoading(true);
    
    try {
      let result;
      
      if (isEditMode) {
        // Update existing phone in inventory
        result = await updatePhoneInInventory(editItemId, phoneData, inventoryItemToEdit);
      } else {
        // Add new phone to inventory
        result = await addPhoneToInventory(phoneData);
      }
      
      if (!result.success) {
        throw new Error(result.error || `Failed to ${isEditMode ? 'update' : 'add'} phone to inventory`);
      }
      
      // IMPORTANT: Update the price configuration
      // 1. First update base price (without color)
      await updatePriceConfiguration(
        selectedManufacturer,
        selectedModel,
        selectedRam,
        selectedStorage,
        dealersPrice,
        retailPrice
      );
      
      // 2. Then update color-specific price
      await updatePriceConfiguration(
        selectedManufacturer,
        selectedModel,
        selectedRam,
        selectedStorage,
        dealersPrice,
        retailPrice,
        selectedColor
      );
      
      // Reset fields after successful submission
      setImei1('');
      setImei2('');
      setSerialNumber(''); // NEW: Reset serial number after submission
      setLocation(''); // NEW: Reset location after submission
      setSupplier(''); // NEW: Reset supplier after submission
      setStatus('On-Hand');
      
      // Clear edit mode
      if (isEditMode) {
        clearInventoryItemToEdit();
        setIsEditMode(false);
        setEditItemId(null);
      }
      
      // Set flag that the barcode value should persist
      setUserEnteredBarcode(true);
      
      setLoading(false);
      setIsSubmitting(false);
      alert(`Phone details ${isEditMode ? 'updated' : 'saved'} successfully!`);
    } catch (error) {
      console.error(`Error ${isEditMode ? 'updating' : 'adding'} document:`, error);
      setError(`Error ${isEditMode ? 'updating' : 'saving'} phone: ${error.message}`);
      setLoading(false);
      setIsSubmitting(false);
      alert(`Error ${isEditMode ? 'updating' : 'saving'} phone details. Please try again.`);
    }
  };
{/* Part 3 End - Event Handlers */}

{/* Part 4 Start - Effect Hooks */}
  // ====== EFFECT HOOKS ======
  // Fetch manufacturers on component mount
  useEffect(() => {
    // Only fetch if manufacturers haven't been loaded yet
    if (manufacturers.length === 0) {
      async function initializeForm() {
        setLoading(true);
        try {
          // Fetch manufacturers list
          await fetchManufacturers();
          
          setLoading(false);
        } catch (error) {
          console.error("Error initializing form:", error);
          setError(`Error loading data: ${error.message}`);
          setLoading(false);
        }
      }
      
      initializeForm();
    }
  }, [manufacturers.length, fetchManufacturers]);

  // NEW: Fetch suppliers on component mount
  useEffect(() => {
    async function fetchSuppliers() {
      try {
        const result = await supplierService.getAllSuppliers();
        if (result.success) {
          setSuppliers(result.suppliers);
        } else {
          console.error("Error loading suppliers:", result.error);
        }
      } catch (error) {
        console.error("Error fetching suppliers:", error);
      }
    }
    
    fetchSuppliers();
  }, []);

  // Check if selections are complete and fetch prices directly from Firestore
  useEffect(() => {
    const fetchPricesDirectly = async () => {
      // First, create a key to track our selections for pricing (without color)
      const priceSelectionKey = `${selectedManufacturer}_${selectedModel}_${selectedRam}_${selectedStorage}`;
      
      // Create a complete key that includes color for barcode lookup
      // const barcodeSelectionKey = `${selectedManufacturer}_${selectedModel}_${selectedRam}_${selectedStorage}_${selectedColor}`;
      
      // Track if we need to reset the barcode
      const shouldResetBarcode = prevSelectionRef.current !== priceSelectionKey;
      
      // Only check when we have all the necessary selections
      if (selectedManufacturer && selectedModel && selectedRam && selectedStorage) {
        
        // Reset barcode when the base configuration changes (manufacturer, model, RAM, storage)
        if (shouldResetBarcode) {
          setBarcode('');
          setUserEnteredBarcode(false);
        }
        
        // Fetch prices directly from Firestore instead of using cache
        if (shouldResetBarcode) {
          console.log("Selection changed - fetching prices from Firestore");
          
          try {
            // Fetch base price configuration
            const baseConfigId = `${selectedManufacturer}_${selectedModel}_${selectedRam}_${selectedStorage}`.replace(/\s+/g, '_').toLowerCase();
            const baseConfigRef = doc(db, 'price_configurations', baseConfigId);
            const baseConfigSnap = await getDoc(baseConfigRef);
            
            if (baseConfigSnap.exists()) {
              const baseData = baseConfigSnap.data();
              console.log("Found base pricing:", baseData);
              
              if (baseData.dealersPrice) {
                setDealersPrice(formatNumberWithCommas(baseData.dealersPrice.toString()));
              }
              if (baseData.retailPrice) {
                setRetailPrice(formatNumberWithCommas(baseData.retailPrice.toString()));
              }
            } else {
              console.log("No base pricing found for this configuration");
              // Clear prices if no configuration found
              setDealersPrice('');
              setRetailPrice('');
            }
          } catch (error) {
            console.error("Error fetching price configuration:", error);
          }
        }
        
        // Check for color-specific pricing and barcode if color is also selected
        if (selectedColor) {
          // Check if color changed - comparing with previous color
          const colorChanged = prevColorRef.current !== selectedColor;
          
          // Fetch color-specific pricing and barcode when color changes or base selections change
          if ((shouldResetBarcode || colorChanged) && !userEnteredBarcode) {
            try {
              const colorConfigId = `${selectedManufacturer}_${selectedModel}_${selectedRam}_${selectedStorage}_${selectedColor}`.replace(/\s+/g, '_').toLowerCase();
              const colorConfigRef = doc(db, 'price_configurations', colorConfigId);
              const colorConfigSnap = await getDoc(colorConfigRef);
              
              if (colorConfigSnap.exists()) {
                const colorData = colorConfigSnap.data();
                console.log("Found color-specific pricing:", colorData);
                
                // Update prices with color-specific pricing if available
                if (colorData.dealersPrice) {
                  setDealersPrice(formatNumberWithCommas(colorData.dealersPrice.toString()));
                }
                if (colorData.retailPrice) {
                  setRetailPrice(formatNumberWithCommas(colorData.retailPrice.toString()));
                }
              }
              
              // Also check for barcode from inventory
              const inventoryQuery = query(
                collection(db, 'inventory'),
                where("manufacturer", "==", selectedManufacturer),
                where("model", "==", selectedModel),
                where("ram", "==", selectedRam),
                where("storage", "==", selectedStorage),
                where("color", "==", selectedColor),
                limit(1)
              );
              
              const inventorySnap = await getDocs(inventoryQuery);
              if (!inventorySnap.empty) {
                const inventoryItem = inventorySnap.docs[0].data();
                if (inventoryItem.barcode) {
                  setBarcode(inventoryItem.barcode);
                }
              } else if (colorChanged) {
                // Only clear barcode when color changes and there's no barcode for this color
                setBarcode('');
              }
            } catch (error) {
              console.error("Error fetching color-specific pricing:", error);
            }
          }
          
          // If we have a complete selection including color, we can show the additional info section
          setIsSpecsSelected(true);
        } else {
          setIsSpecsSelected(false);
        }
      } else {
        setIsSpecsSelected(false);
      }
      
      // Update the previous selection ref
      // Update ref
      prevSelectionRef.current = priceSelectionKey;
      prevColorRef.current = selectedColor;
    };
    
    fetchPricesDirectly();
  }, [selectedManufacturer, selectedModel, selectedRam, selectedStorage, selectedColor, userEnteredBarcode]);

  // NEW: Handle inventory item editing
  useEffect(() => {
    if (inventoryItemToEdit && !isEditMode) {
      // Set edit mode
      setIsEditMode(true);
      setEditItemId(inventoryItemToEdit.id);
      
      // Populate all fields with the item data
      setSelectedManufacturer(inventoryItemToEdit.manufacturer);
      setSelectedModel(inventoryItemToEdit.model);
      setSelectedRam(inventoryItemToEdit.ram);
      setSelectedStorage(inventoryItemToEdit.storage);
      setSelectedColor(inventoryItemToEdit.color);
      setImei1(inventoryItemToEdit.imei1);
      setImei2(inventoryItemToEdit.imei2 || '');
      setBarcode(inventoryItemToEdit.barcode || '');
      setSerialNumber(inventoryItemToEdit.serialNumber || '');
      setLocation(inventoryItemToEdit.location || ''); // NEW: Set location for editing
      setSupplier(inventoryItemToEdit.supplier || ''); // NEW: Set supplier for editing
      setDealersPrice(formatNumberWithCommas(inventoryItemToEdit.dealersPrice?.toString() || '0'));
      setRetailPrice(formatNumberWithCommas(inventoryItemToEdit.retailPrice?.toString() || '0'));
      setStatus(inventoryItemToEdit.status);
      setLastUpdated(inventoryItemToEdit.lastUpdated || getCurrentDate());
      
      // Set flags to show all sections
      setIsSpecsSelected(true);
      setUserEnteredBarcode(true);
      
      // Fetch options for the selected manufacturer and model
      if (inventoryItemToEdit.manufacturer) {
        fetchModels(inventoryItemToEdit.manufacturer).then(() => {
          if (inventoryItemToEdit.model) {
            fetchOptions(inventoryItemToEdit.manufacturer, inventoryItemToEdit.model);
          }
        });
      }
    }
  }, [inventoryItemToEdit, isEditMode, fetchModels, fetchOptions]); // Include all dependencies
  
  // NEW: Clean up when component unmounts or switches away
  useEffect(() => {
    return () => {
      if (isEditMode) {
        clearInventoryItemToEdit();
        setIsEditMode(false);
        setEditItemId(null);
      }
    };
  }, [isEditMode, clearInventoryItemToEdit]);
{/* Part 4 End - Effect Hooks */}

{/* Part 5 Start - Component Render */}
  // Show loading state for initial load
  if ((loading || optionsLoading) && manufacturers.length === 0) {
    return (
      <div className="min-h-screen bg-white p-4">
        <Card className="w-full max-w-[640px] mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
          <CardHeader className="bg-[rgb(52,69,157)] py-3">
            <CardTitle className="text-2xl text-white">Loading...</CardTitle>
          </CardHeader>
          <CardContent className="p-4">
            <p>Fetching data...</p>
          </CardContent>
        </Card>
      </div>
    );
  }
  
  // Show error state
  if (error || optionsError) {
    const errorMessage = error || optionsError;
    return (
      <div className="min-h-screen bg-white p-4">
        <Card className="w-full max-w-[640px] mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
          <CardHeader className="bg-red-600 py-3">
            <CardTitle className="text-2xl text-white">Error</CardTitle>
          </CardHeader>
          <CardContent className="p-4">
            <p>{errorMessage}</p>
            <button 
              onClick={() => window.location.reload()}
              className="mt-4 px-4 py-2 bg-[rgb(52,69,157)] text-white rounded"
            >
              Reload
            </button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Main component render
  return (
    <div className="min-h-screen bg-white p-4">
      <form 
        onSubmit={handleSubmit}
        onKeyDown={handleKeyDown}>
        <Card className="w-full max-w-[640px] mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
          <CardHeader className="bg-[rgb(52,69,157)] py-3">
            <CardTitle className="text-2xl text-white">
              {isEditMode ? 'Edit Phone Details' : 'Select Phone'}
            </CardTitle>
          </CardHeader>

          <CardContent className="bg-white p-4 space-y-4">
            {/* Barcode Search */}
            <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">
              <h3 className="font-semibold text-lg text-[rgb(52,69,157)] mb-3">Quick Barcode Search</h3>
              <div className="flex gap-2">
                <div className="flex-1">
                  <input
                    type="text"
                    value={barcodeSearch}
                    onChange={handleBarcodeSearchChange}
                    onKeyDown={handleBarcodeSearchKeyDown}
                    placeholder="Enter barcode to auto-fill phone details"
                    className="w-full p-2 border rounded"
                  />
                </div>
                <button
                  type="button"
                  onClick={handleBarcodeSearch}
                  disabled={isBarcodeSearching || !barcodeSearch.trim()}
                  className="px-4 py-2 bg-[rgb(52,69,157)] text-white rounded flex items-center"
                >
                  {isBarcodeSearching ? (
                    <span className="animate-spin mr-2"></span>
                  ) : (
                    <Search className="h-5 w-5 mr-2" />
                  )}
                  Search
                </button>
              </div>
              
              {barcodeSearchError && (
                <div className="mt-2 text-red-500 flex items-center">
                  <CircleAlert className="h-4 w-4 mr-1" />
                  {barcodeSearchError}
                </div>
              )}
              
              <div className="mt-2 text-sm text-gray-500 flex items-center">
                <ArrowRight className="h-4 w-4 mr-1" />
                <span>Scan or enter a barcode to automatically fill the phone details</span>
              </div>
            </div>

            {/* Manual Selection Divider */}
            <div className="relative text-center">
              <div className="absolute inset-0 flex items-center">
                <div className="w-full border-t border-gray-300"></div>
              </div>
              <div className="relative flex justify-center">
                <span className="bg-white px-3 text-gray-500 text-sm">Or select manually</span>
              </div>
            </div>

            {/* Basic Information */}
            <PhoneBasicInfo 
              selectedManufacturer={selectedManufacturer}
              selectedModel={selectedModel}
              selectedRam={selectedRam}
              selectedStorage={selectedStorage}
              manufacturers={manufacturers}
              models={models}
              ram={ram}
              storage={storage}
              handleRamChange={handleRamChange}
              handleStorageChange={handleStorageChange}
              handleManufacturerChange={handleManufacturerChange}
              handleModelChange={handleModelChange}
            />

            {/* Price Information */}
            {selectedRam && selectedStorage && (
              <PhonePriceInfo 
                dealersPrice={dealersPrice}
                retailPrice={retailPrice}
                handleDealersPriceChange={handleDealersPriceChange}
                handleRetailPriceChange={handleRetailPriceChange}
              />
            )}

            {/* Color Information */}
            {selectedModel && (
              <PhoneColorInfo 
                selectedColor={selectedColor}
                colors={colors}
                handleColorChange={handleColorChange}
              />
            )}

            {/* Additional Information */}
            {isSpecsSelected && (
              <PhoneAdditionalInfo 
                imei1={imei1}
                imei2={imei2}
                barcode={barcode}
                serialNumber={serialNumber}
                location={location}
                supplier={supplier}
                suppliers={suppliers}
                status={status}
                lastUpdated={lastUpdated}
                handleImei1Change={handleImei1Change}
                handleImei2Change={handleImei2Change}
                handleBarcodeChange={handleBarcodeChange}
                handleSerialNumberChange={handleSerialNumberChange}
                handleLocationChange={handleLocationChange}
                handleSupplierChange={handleSupplierChange}
                handleStatusChange={handleStatusChange}
                imei1Error={imei1Error}
                imei2Error={imei2Error}
              />
            )}

            {/* Submit Button */}
            <div className="pt-4">
              <button
                type="submit"
                className="w-full py-2 bg-[rgb(52,69,157)] text-white rounded hover:bg-[rgb(52,69,157)]/90"
                disabled={!isSpecsSelected || isCheckingImei || isSubmitting}
              >
                {isSubmitting ? (isEditMode ? 'Updating...' : 'Saving...') : (isEditMode ? 'Update Entry' : 'Save Entry')}
              </button>
            </div>
          </CardContent>
        </Card>
      </form>
    </div>
  );
};
{/* Part 5 End - Component Render */}

export default PhoneSelectionForm;
</file>

<file path="src/components/ProcurementManagementForm.jsx">
{/* Part 1 Start - Imports, State, and Helper Functions */}
import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { collection, getDocs, query, orderBy } from 'firebase/firestore';
import { db } from '../firebase/config';
import { 
  RefreshCw, 
  Package,
  Search,
  Calendar,
  Building2,
  Hash,
  DollarSign,
  CreditCard,
  Truck,
  Eye,
  Edit,
  Trash2,
  Settings
} from 'lucide-react';
import { useGlobalState } from '../context/GlobalStateContext';
import supplierService from '../services/supplierService';

const ProcurementManagementForm = () => {
  // ====== GLOBAL STATE ======
  const { editProcurement, viewProcurement, paymentProcurement, receiveProcurement } = useGlobalState(); // ADDED: receiveProcurement

  // ====== STATE DEFINITIONS ======
  // State for procurement data
  const [procurements, setProcurements] = useState([]);
  const [filteredProcurements, setFilteredProcurements] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  
  // Search and filter state
  const [searchTerm, setSearchTerm] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');

  // ====== HELPER FUNCTIONS ======
  // Format price with commas and two decimal places
  const formatPrice = (value) => {
    if (!value && value !== 0) return '0.00';
    const numValue = parseFloat(value.toString().replace(/,/g, ''));
    if (isNaN(numValue)) return '0.00';
    return numValue.toLocaleString('en-US', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  };

  // Format date for display
  const formatDate = (dateString) => {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  };

  // Get payment status display
  const getPaymentStatus = (procurement) => {
    if (procurement.isPaid === true || procurement.paymentStatus === 'paid') {
      return {
        label: 'Paid',
        className: 'bg-green-100 text-green-800'
      };
    }
    return {
      label: 'Unpaid',
      className: 'bg-red-100 text-red-800'
    };
  };

  // Get delivery status display
  const getDeliveryStatus = (procurement) => {
    if (procurement.isReceived === true || procurement.deliveryStatus === 'delivered') {
      return {
        label: 'Delivered',
        className: 'bg-green-100 text-green-800'
      };
    }
    return {
      label: 'Pending',
      className: 'bg-yellow-100 text-yellow-800'
    };
  };
{/* Part 1 End - Imports, State, and Helper Functions */}

{/* Part 2 Start - Data Fetching Functions */}
  // Fetch all procurement entries
  const fetchAllProcurements = async () => {
    setLoading(true);
    setError(null);
    
    try {
      const procurementsRef = collection(db, 'procurements');
      const q = query(procurementsRef, orderBy('purchaseDate', 'desc'));
      const snapshot = await getDocs(q);
      
      const procurementsList = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        procurementsList.push({
          id: doc.id,
          ...data,
          // Ensure we have the necessary fields with fallbacks
          totalQuantity: data.totalQuantity || (data.items ? data.items.reduce((sum, item) => sum + (item.quantity || 0), 0) : 0),
          grandTotal: data.grandTotal || 0,
          paymentStatus: data.paymentStatus || (data.isPaid ? 'paid' : 'pending'),
          deliveryStatus: data.deliveryStatus || (data.isReceived ? 'delivered' : 'pending')
        });
      });
      
      setProcurements(procurementsList);
      setFilteredProcurements(procurementsList);
      console.log('Fetched procurements:', procurementsList.length);
      
    } catch (error) {
      console.error('Error fetching procurements:', error);
      setError('Failed to load procurement data. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  // Initialize data fetch
  useEffect(() => {
    fetchAllProcurements();
  }, []);

  // Filter procurements based on search and status
  useEffect(() => {
    let filtered = [...procurements];
    
    // Apply search filter
    if (searchTerm) {
      filtered = filtered.filter(procurement =>
        procurement.supplierName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        procurement.reference?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        procurement.purchaseDate?.includes(searchTerm) ||
        procurement.id.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }
    
    // Apply status filter
    if (statusFilter !== 'all') {
      filtered = filtered.filter(procurement => {
        switch (statusFilter) {
          case 'paid':
            return procurement.isPaid === true || procurement.paymentStatus === 'paid';
          case 'unpaid':
            return procurement.isPaid !== true && procurement.paymentStatus !== 'paid';
          case 'delivered':
            return procurement.isReceived === true || procurement.deliveryStatus === 'delivered';
          case 'pending':
            return procurement.isReceived !== true && procurement.deliveryStatus !== 'delivered';
          default:
            return true;
        }
      });
    }
    
    setFilteredProcurements(filtered);
  }, [procurements, searchTerm, statusFilter]);
{/* Part 2 End - Data Fetching Functions */}

{/* Part 3 Start - Form Action Handlers with Payment Update */}
  // ====== SEARCH AND FILTER HANDLERS ======
  
  // Handle search input change
  const handleSearchChange = (e) => {
    setSearchTerm(e.target.value);
  };
  
  // Handle status filter change
  const handleStatusFilterChange = (e) => {
    setStatusFilter(e.target.value);
  };
  
  // ====== FORM ACTION HANDLERS ======
  
  // CHANGED: Handle payment status click to open payment mode
  const handlePaymentUpdate = (procurement) => {
    console.log('Opening payment mode for procurement:', procurement.id);
    // Use global state to open procurement in payment mode
    paymentProcurement(procurement);
  };

  // CHANGED: Handle delivery status click to open stock receiving form
  const handleDeliveryUpdate = (procurement) => {
    console.log('Opening stock receiving for procurement:', procurement.id);
    // Use global state to open stock receiving form with procurement data
    receiveProcurement(procurement);
  };

  const handleViewProcurement = (procurement) => {
    console.log('View procurement:', procurement.id);
    // Use the view function to open the form in read-only mode
    viewProcurement(procurement);
  };

  const handleEditProcurement = (procurement) => {
    console.log('Edit procurement:', procurement.id);
    // Use global state to edit procurement and switch to procurement form
    editProcurement(procurement);
  };

  const handleDeleteProcurement = async (procurement) => {
    // ENHANCED: Check if procurement is paid and show appropriate warning
    const isPaid = procurement.isPaid === true || procurement.paymentStatus === 'paid';
    
    const confirmMessage = `Are you sure you want to delete this procurement?\n\n` +
      `Reference: ${procurement.reference || procurement.id}\n` +
      `Supplier: ${procurement.supplierName}\n` +
      `Amount: ${formatPrice(procurement.grandTotal?.toString() || '0')}\n` +
      `Items: ${procurement.totalQuantity || 0}\n` +
      `Payment Status: ${isPaid ? 'PAID' : 'UNPAID'}\n\n` +
      `This will:\n` +
      (isPaid 
        ? ` Update supplier balance (Deduct ${formatPrice(procurement.grandTotal?.toString() || '0')})\n Remove payment record\n Delete all procurement items`
        : ` Delete all procurement items\n Not affect supplier balance (unpaid)`) +
      `\n\nThis action cannot be undone.`;
    
    if (confirm(confirmMessage)) {
      setLoading(true);
      
      try {
        // Use supplier service to properly delete procurement and update supplier
        const result = await supplierService.deleteProcurement(procurement.id, procurement.supplierId);
        
        if (result.success) {
          console.log("Procurement deleted successfully");
          
          // Refresh the procurement list
          await fetchAllProcurements();
          
        } else {
          setError(`Failed to delete procurement: ${result.error}`);
          alert(`Error: ${result.error}`);
        }
      } catch (error) {
        console.error("Error in delete handler:", error);
        setError(`Failed to delete procurement: ${error.message}`);
        alert(`Error: ${error.message}`);
      } finally {
        setLoading(false);
      }
    }
  };
{/* Part 3 End - Form Action Handlers with Payment Update */}

{/* Part 4 Start - Loading and Error States */}
  // Show loading state
  if (loading) {
    return (
      <div className="min-h-screen bg-white p-4">
        <Card className="w-full max-w-7xl mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
          <CardHeader className="bg-[rgb(52,69,157)] py-3">
            <CardTitle className="text-2xl text-white flex items-center">
              <Package className="h-6 w-6 mr-2" />
              Procurement Management
            </CardTitle>
          </CardHeader>
          <CardContent className="p-4">
            <div className="text-center py-12">
              <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[rgb(52,69,157)]"></div>
              <p className="mt-2 text-gray-600">Loading procurement data...</p>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Show error state
  if (error) {
    return (
      <div className="min-h-screen bg-white p-4">
        <Card className="w-full max-w-7xl mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
          <CardHeader className="bg-red-600 py-3">
            <CardTitle className="text-2xl text-white flex items-center">
              <Package className="h-6 w-6 mr-2" />
              Error
            </CardTitle>
          </CardHeader>
          <CardContent className="p-4">
            <p className="text-red-600">{error}</p>
            <button 
              onClick={fetchAllProcurements}
              className="mt-4 px-4 py-2 bg-[rgb(52,69,157)] text-white rounded flex items-center"
            >
              <RefreshCw className="h-4 w-4 mr-2" />
              Retry
            </button>
          </CardContent>
        </Card>
      </div>
    );
  }
{/* Part 4 End - Loading and Error States */}

{/* Part 5 Start - Main Component Render */}
  return (
    <div className="min-h-screen bg-white p-4">
      <Card className="w-full max-w-7xl mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]">
        <CardHeader className="bg-[rgb(52,69,157)] py-3">
          <CardTitle className="text-2xl text-white flex items-center">
            <Package className="h-6 w-6 mr-2" />
            Procurement Management
          </CardTitle>
        </CardHeader>

        <CardContent className="bg-white p-4 space-y-6">
{/* Part 5 End - Main Component Render */}

{/* Part 6 Start - Search and Filter Section */}
          {/* Search and Filter Section */}
          <div className="space-y-4">
            <div className="flex flex-col md:flex-row gap-4">
              {/* Search Input */}
              <div className="flex-1">
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4" />
                  <input
                    type="text"
                    placeholder="Search by supplier name, reference, or date..."
                    value={searchTerm}
                    onChange={handleSearchChange}
                    className="w-full pl-10 pr-4 py-2 border rounded-lg text-sm"
                  />
                </div>
              </div>

              {/* Status Filter */}
              <div className="w-full md:w-48">
                <select
                  value={statusFilter}
                  onChange={handleStatusFilterChange}
                  className="w-full p-2 border rounded-lg text-sm"
                >
                  <option value="all">All Status</option>
                  <option value="paid">Paid Only</option>
                  <option value="unpaid">Unpaid Only</option>
                  <option value="delivered">Delivered Only</option>
                  <option value="pending">Pending Delivery</option>
                </select>
              </div>

              {/* Refresh Button */}
              <button
                onClick={fetchAllProcurements}
                className="px-4 py-2 bg-[rgb(52,69,157)] text-white rounded-lg hover:bg-[rgb(52,69,157)]/90 flex items-center justify-center"
              >
                <RefreshCw className="h-4 w-4 mr-2" />
                Refresh
              </button>
            </div>
          </div>
{/* Part 6 End - Search and Filter Section */}

{/* Part 7 Start - Enhanced Procurement Summary */}
          {/* Procurement Summary - Enhanced Design */}
          <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 mb-4">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-lg font-semibold text-gray-800">Procurement Summary</h3>
              <div className="text-sm text-gray-600">
                {searchTerm || statusFilter !== 'all' 
                  ? `${filteredProcurements.length} of ${procurements.length} entries (filtered)`
                  : `${filteredProcurements.length} entries`}
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="bg-white rounded-lg p-4 border border-blue-100 shadow-sm">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-gray-600 font-medium">Total Procurement Value</p>
                    <p className="text-xs text-gray-500">Combined value of all procurements</p>
                  </div>
                  <div className="text-right">
                    <p className="text-xl font-bold text-blue-600">
                      {(() => {
                        const totalValue = filteredProcurements.reduce((total, procurement) => {
                          return total + (procurement.grandTotal || 0);
                        }, 0);
                        return totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                      })()}
                    </p>
                    <p className="text-xs text-gray-500">
                      {filteredProcurements.length} {filteredProcurements.length === 1 ? 'entry' : 'entries'}
                    </p>
                  </div>
                </div>
              </div>
              
              <div className="bg-white rounded-lg p-4 border border-green-100 shadow-sm">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-gray-600 font-medium">Total Units Procured</p>
                    <p className="text-xs text-gray-500">Combined quantity across all entries</p>
                  </div>
                  <div className="text-right">
                    <p className="text-xl font-bold text-green-600">
                      {(() => {
                        const totalQuantity = filteredProcurements.reduce((total, procurement) => {
                          return total + (procurement.totalQuantity || 0);
                        }, 0);
                        return totalQuantity.toLocaleString('en-US');
                      })()}
                    </p>
                    <p className="text-xs text-gray-500">units</p>
                  </div>
                </div>
              </div>
              
              <div className="bg-white rounded-lg p-4 border border-purple-100 shadow-sm">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-gray-600 font-medium">Payment Status</p>
                    <p className="text-xs text-gray-500">Paid vs Outstanding amounts</p>
                  </div>
                  <div className="text-right">
                    <p className="text-xl font-bold text-purple-600">
                      {(() => {
                        const paidAmount = filteredProcurements.reduce((total, procurement) => {
                          if (procurement.isPaid === true || procurement.paymentStatus === 'paid') {
                            return total + (procurement.grandTotal || 0);
                          }
                          return total;
                        }, 0);
                        return paidAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                      })()} paid
                    </p>
                    <p className="text-xs text-gray-500">
                      {(() => {
                        const paidCount = filteredProcurements.filter(p => 
                          p.isPaid === true || p.paymentStatus === 'paid'
                        ).length;
                        const totalCount = filteredProcurements.length;
                        const percentage = totalCount > 0 ? (paidCount / totalCount * 100) : 0;
                        return `${percentage.toFixed(1)}% completed`;
                      })()}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
{/* Part 7 End - Enhanced Procurement Summary */}

{/* Part 8 Start - Procurement Entries Table */}
          {/* Procurement List */}
          <div className="space-y-4">
            <div className="flex justify-between items-center">
              <h3 className="text-lg font-semibold text-[rgb(52,69,157)]">
                Procurement Entries ({filteredProcurements.length} items)
              </h3>
            </div>

            {filteredProcurements.length === 0 ? (
              <div className="text-center py-12 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                <Package className="h-12 w-12 text-gray-400 mx-auto mb-4" />
                <h4 className="text-lg font-medium text-gray-700 mb-2">
                  {procurements.length === 0 ? 'No procurement entries found' : 'No entries match your filters'}
                </h4>
                <p className="text-gray-500">
                  {procurements.length === 0 
                    ? 'Create procurement entries from the Phone Procurement form'
                    : 'Try adjusting your search criteria or filters'
                  }
                </p>
              </div>
            ) : (
              <div className="overflow-x-auto border rounded-lg">
                <table className="w-full border-collapse text-sm">
                  <thead>
                    <tr className="bg-gray-100">
                      <th className="border px-3 py-3 text-left font-semibold">
                        <div className="flex items-center">
                          <Calendar className="h-4 w-4 mr-2" />
                          Date
                        </div>
                      </th>
                      <th className="border px-3 py-3 text-left font-semibold">
                        <div className="flex items-center">
                          <Building2 className="h-4 w-4 mr-2" />
                          Supplier
                        </div>
                      </th>
                      <th className="border px-3 py-3 text-center font-semibold">
                        <div className="flex items-center justify-center">
                          <Hash className="h-4 w-4 mr-2" />
                          Total Items
                        </div>
                      </th>
                      <th className="border px-3 py-3 text-right font-semibold">
                        <div className="flex items-center justify-end">
                          <DollarSign className="h-4 w-4 mr-2" />
                          Amount
                        </div>
                      </th>
                      <th className="border px-3 py-3 text-center font-semibold">
                        <div className="flex items-center justify-center">
                          <CreditCard className="h-4 w-4 mr-2" />
                          Payment
                        </div>
                      </th>
                      <th className="border px-3 py-3 text-center font-semibold">
                        <div className="flex items-center justify-center">
                          <Truck className="h-4 w-4 mr-2" />
                          Delivery
                        </div>
                      </th>
                      <th className="border px-3 py-3 text-center font-semibold">
                        <div className="flex items-center justify-center">
                          <Settings className="h-4 w-4 mr-2" />
                          Actions
                        </div>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredProcurements.map((procurement, index) => {
                      const paymentStatus = getPaymentStatus(procurement);
                      const deliveryStatus = getDeliveryStatus(procurement);
                      
                      return (
                        <tr key={procurement.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                          <td className="border px-3 py-3">
                            <div className="font-medium">{formatDate(procurement.purchaseDate)}</div>
                            <div className="text-xs text-gray-500">ID: {procurement.id.slice(-8)}</div>
                          </td>
                          <td className="border px-3 py-3">
                            <div className="font-medium">{procurement.supplierName || 'Unknown'}</div>
                            {procurement.reference && (
                              <div className="text-xs text-gray-500">Ref: {procurement.reference}</div>
                            )}
                          </td>
                          <td className="border px-3 py-3 text-center">
                            <span className="font-semibold">{procurement.totalQuantity || 0}</span>
                          </td>
                          <td className="border px-3 py-3 text-right">
                            <span className="font-mono font-semibold">
                              {(procurement.grandTotal || 0).toLocaleString('en-US', { 
                                minimumFractionDigits: 2, 
                                maximumFractionDigits: 2 
                              })}
                            </span>
                          </td>
                          <td className="border px-3 py-3 text-center">
                            {/* CHANGED: Convert Payment column to clickable status button */}
                            <button
                              onClick={() => handlePaymentUpdate(procurement)}
                              className={`px-2 py-1 rounded-full text-xs font-medium transition-colors ${paymentStatus.className} hover:opacity-80 cursor-pointer`}
                              title={`${paymentStatus.label === 'Paid' ? 'Click to mark as Unpaid' : 'Click to mark as Paid'}`}
                            >
                              {paymentStatus.label}
                            </button>
                          </td>
                          <td className="border px-3 py-3 text-center">
                            {/* CHANGED: Convert Delivery column to clickable status button */}
                            <button
                              onClick={() => handleDeliveryUpdate(procurement)}
                              className={`px-2 py-1 rounded-full text-xs font-medium transition-colors ${deliveryStatus.className} hover:opacity-80 cursor-pointer`}
                              title={`${deliveryStatus.label === 'Delivered' ? 'View received items' : 'Click to receive inventory'}`}
                            >
                              {deliveryStatus.label}
                            </button>
                          </td>
                          <td className="border px-3 py-3">
                            <div className="flex items-center justify-center gap-1">
                              <button
                                onClick={() => handleViewProcurement(procurement)}
                                className="p-1 text-blue-600 hover:bg-blue-100 rounded"
                                title="View Details"
                              >
                                <Eye className="h-4 w-4" />
                              </button>
                              <button
                                onClick={() => handleEditProcurement(procurement)}
                                className="p-1 text-green-600 hover:bg-green-100 rounded"
                                title="Edit Procurement"
                              >
                                <Edit className="h-4 w-4" />
                              </button>
                              <button
                                onClick={() => handleDeleteProcurement(procurement)}
                                className="p-1 text-red-600 hover:bg-red-100 rounded"
                                title="Delete Procurement"
                              >
                                <Trash2 className="h-4 w-4" />
                              </button>
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            )}
          </div>
{/* Part 8 End - Procurement Entries Table */}

        </CardContent>
      </Card>
    </div>
  );
};

export default ProcurementManagementForm;
</file>

<file path="src/components/inventory/InventoryTable.jsx">
{/* Part 1 Start - Imports */}
import { useGlobalState } from '../../context/GlobalStateContext'; // NEW: Import global state
import { useState } from 'react';
import PropTypes from 'prop-types';
import { doc, updateDoc, runTransaction, increment, deleteDoc } from 'firebase/firestore';
import { db } from '../../firebase/config';
import InventoryRow from './InventoryRow';
import InventoryEditForm from './InventoryEditForm';
import DeleteConfirmationModal from './DeleteConfirmationModal';
// Import getCurrentDate utility function
import { getCurrentDate } from '../phone-selection/utils/phoneUtils';
{/* Part 1 End - Imports */}

{/* Part 2 Start - Component Definition */}
const InventoryTable = ({ 
  inventoryItems, 
  handleSort, 
  sortField, 
  sortDirection, 
  allItems,
  setAllItems,
  setInventoryItems,
  applyFilters
}) => {
{/* Part 2 End - Component Definition */}

  {/* Part 3 Start - State Management */}
  const [editingItemId, setEditingItemId] = useState(null);
  const [editFormData, setEditFormData] = useState({
    manufacturer: '',
    model: '',
    ram: '',
    storage: '',
    color: '',
    imei1: '',
    serialNumber: '', // UPDATED: Added serialNumber instead of barcode
    supplier: '', // UPDATED: Added supplier
    status: '',
    retailPrice: 0, // NEW: Added retailPrice to initial state
    location: '', // NEW: Added location to initial state
  });
  const [savingItemId, setSavingItemId] = useState(null);
  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
  const [itemToDelete, setItemToDelete] = useState(null);
  const [isDeleting, setIsDeleting] = useState(false);
  // Get global state function for editing inventory items
  const { editInventoryItem } = useGlobalState(); // NEW: Get edit function from context
  {/* Part 3 End - State Management */}

  {/* Part 4 Start - Event Handlers */}
  
  {/* Edit Handlers Section */}
  // NEW: Handle edit details click
  const handleEditDetailsClick = (item) => {
    editInventoryItem(item);
  };
  // Handle edit button click
  const handleEditClick = (item) => {
    // If we're already editing, cancel it first
    if (editingItemId) {
      setEditingItemId(null);
    }
    
    // Set the item to edit
    setEditingItemId(item.id);
    
    // Populate form with item data
    setEditFormData({
      manufacturer: item.manufacturer,
      model: item.model,
      ram: item.ram,
      storage: item.storage,
      color: item.color,
      imei1: item.imei1,
      serialNumber: item.serialNumber || '', // UPDATED: Added serialNumber
      supplier: item.supplier || '', // UPDATED: Added supplier
      status: item.status,
      retailPrice: item.retailPrice, // NEW: Added retailPrice to edit form data
      location: item.location || '', // NEW: Preserve location
    });
  };

  {/* Delete Handlers Section */}
  // Handle delete button click
  const handleDeleteClick = (itemId) => {
    const item = allItems.find(item => item.id === itemId);
    if (item) {
      setItemToDelete(item);
      setIsDeleteModalOpen(true);
    }
  };

  // Handle delete confirmation - PRESERVED: Original working delete logic
  const handleDeleteConfirm = async () => {
    if (!itemToDelete) return;
    
    setIsDeleting(true);
    
    try {
      // Get a reference to the document
      const itemRef = doc(db, 'inventory', itemToDelete.id);
      
      // Delete the document
      await deleteDoc(itemRef);
      
      // Update inventory counts
      const inventoryId = `${itemToDelete.manufacturer}_${itemToDelete.model}_${itemToDelete.ram}_${itemToDelete.storage}_${itemToDelete.color}`.replace(/\s+/g, '_').toLowerCase();
      
      // Reference to the inventory count doc
      const inventoryRef = doc(db, 'inventory_counts', inventoryId);
      
      // Update inventory counts based on the item's status
      await runTransaction(db, async (transaction) => {
        const inventoryDoc = await transaction.get(inventoryRef);
        
        if (inventoryDoc.exists()) {
          // Determine which field to decrement based on status
          const decrementField = 
            itemToDelete.status === 'On-Hand' ? 'onHand' : 
            itemToDelete.status === 'On-Display' ? 'onDisplay' : 
            itemToDelete.status === 'Sold' ? 'sold' : 
            itemToDelete.status === 'Reserved' ? 'reserved' : 
            'defective';
          
          // Decrement total and status count
          transaction.update(inventoryRef, {
            total: increment(-1),
            [decrementField]: increment(-1),
            lastUpdated: new Date().toLocaleDateString()
          });
        }
      });
      
      // Update local state by removing the deleted item
      const updatedItems = allItems.filter(item => item.id !== itemToDelete.id);
      setAllItems(updatedItems);
      
      // Re-apply filters
      const filteredItems = applyFilters(updatedItems);
      setInventoryItems(filteredItems);
      
      // Close the modal and reset state
      setIsDeleteModalOpen(false);
      setItemToDelete(null);
      setIsDeleting(false);
      
    } catch (error) {
      console.error("Error deleting item:", error);
      alert(`Error deleting item: ${error.message}`);
      setIsDeleting(false);
    }
  };

  // Handle cancel delete
  const handleDeleteCancel = () => {
    setIsDeleteModalOpen(false);
    setItemToDelete(null);
  };

  {/* Edit Form Handlers Section */}
  // Handle cancel edit
  const handleCancelEdit = () => {
    setEditingItemId(null);
    setEditFormData({
      manufacturer: '',
      model: '',
      ram: '',
      storage: '',
      color: '',
      imei1: '',
      serialNumber: '', // UPDATED: Reset serialNumber
      supplier: '', // UPDATED: Reset supplier
      status: '',
      retailPrice: 0, // NEW: Added retailPrice to reset state
      location: '', // NEW: Reset location
    });
  };

  // Handle edit form input changes
  const handleEditInputChange = (e) => {
    const { name, value } = e.target;
    
    setEditFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  // Handle save edits - includes lastUpdated
  const handleSaveEdit = async (id) => {
    setSavingItemId(id);
    
    try {
      // Get the original item to preserve location and supplier
      const originalItem = allItems.find(item => item.id === id);
      
      // Create an update object with the edited fields
      const updateData = {
        manufacturer: editFormData.manufacturer,
        model: editFormData.model,
        ram: editFormData.ram,
        storage: editFormData.storage,
        color: editFormData.color,
        imei1: editFormData.imei1,
        serialNumber: editFormData.serialNumber || '', // UPDATED: Save serialNumber
        barcode: originalItem.barcode || '', // Preserve barcode from original
        status: editFormData.status,
        location: originalItem.location || '', // NEW: Preserve location
        supplier: editFormData.supplier || '', // UPDATED: Save supplier
        lastUpdated: getCurrentDate() // Update lastUpdated when item is edited
      };
      
      // Get a reference to the document
      const itemRef = doc(db, 'inventory', id);
      
      // Update the document
      await updateDoc(itemRef, updateData);
      
      // If the status was changed, update the inventory counts
      if (originalItem && originalItem.status !== editFormData.status) {
        // Create a unique ID for this inventory item type
        const inventoryId = `${editFormData.manufacturer}_${editFormData.model}_${editFormData.ram}_${editFormData.storage}_${editFormData.color}`.replace(/\s+/g, '_').toLowerCase();
        
        // Reference to the inventory count doc
        const inventoryRef = doc(db, 'inventory_counts', inventoryId);
        
        // Run as a transaction to ensure data consistency
        await runTransaction(db, async (transaction) => {
          const inventoryDoc = await transaction.get(inventoryRef);
          
          if (inventoryDoc.exists()) {
            // Decrement the old status count
            const decrementField = 
              originalItem.status === 'On-Hand' ? 'onHand' : 
              originalItem.status === 'On-Display' ? 'onDisplay' : 
              originalItem.status === 'Sold' ? 'sold' : 
              originalItem.status === 'Reserved' ? 'reserved' : 
              'defective';
            
            // Increment the new status count
            const incrementField = 
              editFormData.status === 'On-Hand' ? 'onHand' : 
              editFormData.status === 'On-Display' ? 'onDisplay' : 
              editFormData.status === 'Sold' ? 'sold' : 
              editFormData.status === 'Reserved' ? 'reserved' : 
              'defective';
            
            // Update counters
            transaction.update(inventoryRef, {
              [decrementField]: increment(-1),
              [incrementField]: increment(1),
              lastUpdated: new Date().toLocaleDateString()
            });
          }
        });
      }
      
      // Update local state - includes lastUpdated
      setAllItems(prevItems => 
        prevItems.map(item => 
          item.id === id 
            ? { 
                ...item, 
                ...updateData,
                // Keep original prices since we're not editing them
                dealersPrice: item.dealersPrice,
                retailPrice: item.retailPrice
              } 
            : item
        )
      );
      
      // Reset editing state
      setEditingItemId(null);
      setSavingItemId(null);
      
      // Re-apply filters to update the displayed inventory items - includes lastUpdated
      const updatedItems = allItems.map(item => 
        item.id === id 
          ? { 
              ...item, 
              ...updateData,
              // Keep original prices since we're not editing them
              dealersPrice: item.dealersPrice,
              retailPrice: item.retailPrice
            } 
          : item
      );
      const filteredItems = applyFilters(updatedItems);
      setInventoryItems(filteredItems);
      
    } catch (error) {
      console.error("Error updating item:", error);
      alert(`Error updating item: ${error.message}`);
      setSavingItemId(null);
    }
  };
  {/* Part 4 End - Event Handlers */}
  
  {/* Part 5 Start - Sorting Logic */}
  // UPDATED: Enhanced sorting logic for new sortable columns
  const sortedInventoryItems = [...inventoryItems].sort((a, b) => {
    // Handle numeric fields
    if (sortField === 'retailPrice') {
      if (sortDirection === 'asc') {
        return a.retailPrice - b.retailPrice;
      } else {
        return b.retailPrice - a.retailPrice;
      }
    }
    
    // Handle date field (lastUpdated)
    if (sortField === 'lastUpdated') {
      const dateA = a.lastUpdated ? new Date(a.lastUpdated) : new Date(0);
      const dateB = b.lastUpdated ? new Date(b.lastUpdated) : new Date(0);
      
      if (sortDirection === 'asc') {
        return dateA - dateB;
      } else {
        return dateB - dateA;
      }
    }
    
    // Handle string fields (including serialNumber and supplier)
    if (sortDirection === 'asc') {
      return (a[sortField] || '').localeCompare(b[sortField] || '');
    } else {
      return (b[sortField] || '').localeCompare(a[sortField] || '');
    }
  });
  {/* Part 5 End - Sorting Logic */}

  {/* Part 6 Start - Component Render */}
  return (
    <div className="overflow-x-auto">
      <table className="w-full border-collapse text-base">
        <thead>
          <tr className="bg-gray-100">
            <th 
              className="border px-2 py-3 text-left cursor-pointer hover:bg-gray-200 font-semibold"
              onClick={() => handleSort('manufacturer')}
              style={{ width: '12%' }}
            >
              Manufacturer
              {sortField === 'manufacturer' && (
                <span className="ml-1">{sortDirection === 'asc' ? '' : ''}</span>
              )}
            </th>
            <th 
              className="border px-2 py-3 text-left cursor-pointer hover:bg-gray-200 font-semibold"
              onClick={() => handleSort('model')}
              style={{ width: '12%' }}
            >
              Model
              {sortField === 'model' && (
                <span className="ml-1">{sortDirection === 'asc' ? '' : ''}</span>
              )}
            </th>
            <th 
              className="border px-2 py-3 text-left cursor-pointer hover:bg-gray-200 font-semibold" 
              onClick={() => handleSort('ram')}
              style={{ width: '7%' }}
            >
              RAM
              {sortField === 'ram' && (
                <span className="ml-1">{sortDirection === 'asc' ? '' : ''}</span>
              )}
            </th>
            <th 
              className="border px-2 py-3 text-left cursor-pointer hover:bg-gray-200 font-semibold" 
              onClick={() => handleSort('storage')}
              style={{ width: '7%' }}
            >
              Storage
              {sortField === 'storage' && (
                <span className="ml-1">{sortDirection === 'asc' ? '' : ''}</span>
              )}
            </th>
            <th 
              className="border px-2 py-3 text-left cursor-pointer hover:bg-gray-200 font-semibold" 
              onClick={() => handleSort('color')}
              style={{ width: '12%' }}
            >
              Color
              {sortField === 'color' && (
                <span className="ml-1">{sortDirection === 'asc' ? '' : ''}</span>
              )}
            </th>
            <th 
              className="border px-2 py-3 text-left cursor-pointer hover:bg-gray-200 font-semibold" 
              onClick={() => handleSort('imei1')}
              style={{ width: '15%' }}
            >
              IMEI1
              {sortField === 'imei1' && (
                <span className="ml-1">{sortDirection === 'asc' ? '' : ''}</span>
              )}
            </th>
            {/* UPDATED: Replaced barcode with serial number */}
            <th 
              className="border px-2 py-3 text-left cursor-pointer hover:bg-gray-200 font-semibold" 
              onClick={() => handleSort('serialNumber')}
              style={{ width: '12%' }}
            >
              Serial Number
              {sortField === 'serialNumber' && (
                <span className="ml-1">{sortDirection === 'asc' ? '' : ''}</span>
              )}
            </th>
            {/* NEW: Added Supplier column */}
            <th 
              className="border px-2 py-3 text-left cursor-pointer hover:bg-gray-200 font-semibold" 
              onClick={() => handleSort('supplier')}
              style={{ width: '12%' }}
            >
              Supplier
              {sortField === 'supplier' && (
                <span className="ml-1">{sortDirection === 'asc' ? '' : ''}</span>
              )}
            </th>
            {/* NEW: Added Retail Price column */}
            <th 
              className="border px-2 py-3 text-right cursor-pointer hover:bg-gray-200 font-semibold" 
              onClick={() => handleSort('retailPrice')}
              style={{ width: '10%' }}
            >
              Price
              {sortField === 'retailPrice' && (
                <span className="ml-1">{sortDirection === 'asc' ? '' : ''}</span>
              )}
            </th>
            <th 
              className="border px-2 py-3 text-left cursor-pointer hover:bg-gray-200 font-semibold" 
              onClick={() => handleSort('lastUpdated')}
              style={{ width: '8%' }}
            >
              Date
              {sortField === 'lastUpdated' && (
                <span className="ml-1">{sortDirection === 'asc' ? '' : ''}</span>
              )}
            </th>
            <th 
              className="border px-2 py-3 text-center cursor-pointer hover:bg-gray-200 font-semibold"
              onClick={() => handleSort('status')}
              style={{ width: '8%' }}
            >
              Status
              {sortField === 'status' && (
                <span className="ml-1">{sortDirection === 'asc' ? '' : ''}</span>
              )}
            </th>
            <th className="border px-2 py-3 text-center font-semibold" style={{ width: '6%' }}>Action</th>
          </tr>
        </thead>
        <tbody>
          {sortedInventoryItems.map((item) => (
            editingItemId === item.id ? (
              <InventoryEditForm 
                key={item.id}
                itemId={item.id}
                editFormData={editFormData}
                handleEditInputChange={handleEditInputChange}
                handleSaveEdit={handleSaveEdit}
                handleCancelEdit={handleCancelEdit}
                savingItemId={savingItemId}
              />
            ) : (
             <InventoryRow 
                key={item.id}
                item={item}
                handleEditClick={handleEditClick}
                handleDeleteClick={handleDeleteClick}
                handleEditDetailsClick={handleEditDetailsClick}
              />
            )
          ))}
        </tbody>
      </table>

      {/* Delete confirmation modal */}
      <DeleteConfirmationModal
        isOpen={isDeleteModalOpen}
        itemToDelete={itemToDelete}
        onCancel={handleDeleteCancel}
        onConfirm={handleDeleteConfirm}
        isDeleting={isDeleting}
      />
    </div>
  );
};
{/* Part 6 End - Component Render */}

{/* Part 7 Start - PropTypes Definition */}
InventoryTable.propTypes = {
  inventoryItems: PropTypes.array.isRequired,
  handleSort: PropTypes.func.isRequired,
  sortField: PropTypes.string.isRequired,
  sortDirection: PropTypes.string.isRequired,
  allItems: PropTypes.array.isRequired,
  setAllItems: PropTypes.func.isRequired,
  setInventoryItems: PropTypes.func.isRequired,
  applyFilters: PropTypes.func.isRequired
};
{/* Part 7 End - PropTypes Definition */}

{/* Part 8 Start - Export */}
export default InventoryTable;
{/* Part 8 End - Export */}
</file>

<file path="src/components/InventoryListForm.jsx">
{/* Part 1 Start - Imports and Initial State */}
import { useState, useEffect, useCallback, useRef } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { collection, getDocs, query, orderBy, where } from 'firebase/firestore';
import { db } from '../firebase/config';
import { Smartphone, RefreshCw, Filter, X, Search, FileText } from 'lucide-react';
import InventoryTable from './inventory/InventoryTable';
import InventoryFilters from './inventory/InventoryFilters';

const InventoryListForm = () => {
  // State for inventory data
  const [inventoryItems, setInventoryItems] = useState([]);
  const [allItems, setAllItems] = useState([]); // Store all unfiltered items
  const [loading, setLoading] = useState(false); // Changed to false by default
  const [error, setError] = useState(null);
  const [sortField, setSortField] = useState('manufacturer');
  const [sortDirection, setSortDirection] = useState('asc');
  const [initialLoad, setInitialLoad] = useState(true); // Track if data has been loaded
  
  // State for filters - UPDATED: Added startDate and endDate
  const [filters, setFilters] = useState({
    manufacturer: '',
    model: '',
    ram: '',
    storage: '',
    status: '',
    minPrice: '',
    maxPrice: '',
    color: '',
    imei1: '',
    barcode: '',
    serialNumber: '', // ADD THIS LINE
    supplier: '', // ADD THIS LINE
    startDate: '',
    endDate: ''
  });
  
  // Separate state for pending filter changes (before debounce) - UPDATED: Added date fields
  const [pendingFilters, setPendingFilters] = useState({
    minPrice: '',
    maxPrice: '',
    imei1: '',
    barcode: '',
    serialNumber: '', // ADD THIS LINE
    startDate: '',
    endDate: ''
  });
  
  // Filter options lists - Updated to use 'Stock' instead of 'On-Hand'
  const [filterOptions, setFilterOptions] = useState({
    manufacturers: [],
    models: [],
    rams: [],
    storages: [],
    colors: [],
    suppliers: [],
    statuses: ['Stock', 'On-Display', 'Sold', 'Reserved', 'Defective']
  });
  
  // Show/hide filters
  const [showFilters, setShowFilters] = useState(true); // Default to showing filters
  
  // Debounce timer ref
  const debounceTimerRef = useRef(null);
  
  // State for Word export
  const [isExporting, setIsExporting] = useState(false);
{/* Part 1 End - Imports and Initial State */}

{/* Part 2 Start - Helper Functions and Effects */}
  // Format number with commas
  const formatNumberWithCommas = (value) => {
    if (!value && value !== 0) return '';
    return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  };
  
  // Parse price value for filters
  const parsePrice = (value) => {
    if (!value) return '';
    return value.replace(/,/g, '');
  };

  // Sync filters to pendingFilters when filters change - UPDATED: Added date fields
  useEffect(() => {
    setPendingFilters(prevPending => ({
      ...prevPending,
      minPrice: filters.minPrice,
      maxPrice: filters.maxPrice,
      imei1: filters.imei1,
      barcode: filters.barcode,
      serialNumber: filters.serialNumber,
      startDate: filters.startDate,
      endDate: filters.endDate
    }));
  }, [filters.minPrice, filters.maxPrice, filters.imei1, filters.barcode, filters.serialNumber, filters.startDate, filters.endDate]);

  // Load manufacturer list on component mount
  useEffect(() => {
    async function loadManufacturers() {
      try {
        const inventoryRef = collection(db, 'inventory');
        const snapshot = await getDocs(inventoryRef);
        
        const manufacturers = [...new Set(
          snapshot.docs.map(doc => doc.data().manufacturer)
        )].filter(Boolean).sort();
        
        setFilterOptions(prev => ({
          ...prev,
          manufacturers
        }));
      } catch (error) {
        console.error("Error loading manufacturers:", error);
      }
    }
    
    loadManufacturers();
  }, []);

  // Load supplier list from suppliers collection
  useEffect(() => {
    async function loadSuppliers() {
      try {
        const suppliersRef = collection(db, 'suppliers');
        const snapshot = await getDocs(suppliersRef);
        
        const suppliers = snapshot.docs.map(doc => ({
          id: doc.id,
          name: doc.data().supplierName
        })).sort((a, b) => a.name.localeCompare(b.name));
        
        setFilterOptions(prev => ({
          ...prev,
          suppliers
        }));
      } catch (error) {
        console.error("Error loading suppliers:", error);
      }
    }
    
    loadSuppliers();
  }, []);
{/* Part 2 End - Helper Functions and Effects */}

{/* Part 3 Start - Filter Logic and Handlers */}
  // Apply filters to the data - UPDATED: Fixed date filtering logic and added supplier
  const applyFilters = useCallback((items) => {
    return items.filter(item => {
      // Apply manufacturer filter
      if (filters.manufacturer && item.manufacturer !== filters.manufacturer) {
        return false;
      }
      
      // Apply model filter
      if (filters.model && item.model !== filters.model) {
        return false;
      }
      
      // Apply RAM filter
      if (filters.ram && item.ram !== filters.ram) {
        return false;
      }
      
      // Apply storage filter
      if (filters.storage && item.storage !== filters.storage) {
        return false;
      }
      
      // Apply status filter - handle both 'Stock' and 'On-Hand'
      if (filters.status) {
        const filterStatus = filters.status === 'Stock' ? 'On-Hand' : filters.status;
        if (item.status !== filterStatus) {
          return false;
        }
      }
      
      // Apply color filter
      if (filters.color && item.color !== filters.color) {
        return false;
      }
      
      // Apply IMEI1 filter (partial match)
      if (filters.imei1 && !item.imei1.includes(filters.imei1)) {
        return false;
      }
      
      // Apply barcode filter (partial match)
      if (filters.barcode && item.barcode && !item.barcode.includes(filters.barcode)) {
        return false;
      }
      
      // Apply serial number filter (partial match)
      if (filters.serialNumber) {
        // If filter is set, item must have a serial number AND it must include the search term
        if (!item.serialNumber || !item.serialNumber.includes(filters.serialNumber)) {
          return false;
        }
      }
      
      // Apply supplier filter (exact match by ID)
      if (filters.supplier) {
        if (item.supplier !== filters.supplier) {
          return false;
        }
      }
      
      // Apply min price filter (using retail price)
      if (filters.minPrice) {
        const minPrice = parseFloat(parsePrice(filters.minPrice));
        if (!isNaN(minPrice) && item.retailPrice < minPrice) {
          return false;
        }
      }
      
      // Apply max price filter (using retail price)
      if (filters.maxPrice) {
        const maxPrice = parseFloat(parsePrice(filters.maxPrice));
        if (!isNaN(maxPrice) && item.retailPrice > maxPrice) {
          return false;
        }
      }

      // FIXED: Apply start date filter (using lastUpdated field) - Now properly inclusive
      if (filters.startDate) {
        const startDate = new Date(filters.startDate);
        startDate.setHours(0, 0, 0, 0); // Set to start of day
        
        if (item.lastUpdated) {
          // Parse the item date (which is in MM/DD/YYYY format)
          const itemDate = new Date(item.lastUpdated);
          itemDate.setHours(0, 0, 0, 0); // Set to start of day
          
          // Check if item date is before start date (exclusive)
          if (itemDate < startDate) {
            return false;
          }
        }
      }

      // FIXED: Apply end date filter (using lastUpdated field) - Now properly inclusive
      if (filters.endDate) {
        const endDate = new Date(filters.endDate);
        endDate.setHours(23, 59, 59, 999); // Set to end of day
        
        if (item.lastUpdated) {
          // Parse the item date (which is in MM/DD/YYYY format)
          const itemDate = new Date(item.lastUpdated);
          
          // Check if item date is after end date (exclusive)
          if (itemDate > endDate) {
            return false;
          }
        }
      }
      
      // If it passed all filters, include it
      return true;
    });
  }, [filters]);

  // Apply filters when they change AFTER initial data load - MOVED HERE: After applyFilters declaration
  useEffect(() => {
    if (!initialLoad && allItems.length > 0) {
      const filtered = applyFilters(allItems);
      setInventoryItems(filtered);
    }
  }, [filters, allItems, applyFilters, initialLoad]);

  // Load filter options from data
  const loadFilterOptions = useCallback((data) => {
    const manufacturers = [...new Set(data.map(item => item.manufacturer))].sort();
    const models = [...new Set(data.map(item => item.model))].sort();
    const rams = [...new Set(data.map(item => item.ram))].sort();
    const storages = [...new Set(data.map(item => item.storage))].sort();
   
    // For colors, filter based on manufacturer and model if selected
    let filteredData = data;
    if (filters.manufacturer) {
      filteredData = filteredData.filter(item => item.manufacturer === filters.manufacturer);
    }
    if (filters.model) {
      filteredData = filteredData.filter(item => item.model === filters.model);
    }
    
    const colors = [...new Set(filteredData.map(item => item.color))].sort();
    
    setFilterOptions(prev => ({
      ...prev,
      manufacturers,
      models,
      rams,
      storages,
      colors,
      statuses: ['Stock', 'On-Display', 'Sold', 'Reserved', 'Defective']
    }));
  }, [filters.manufacturer, filters.model]);

  // Handle filter change - UPDATED: Added date field handling and supplier as dropdown
  const handleFilterChange = (e) => {
    const { name, value } = e.target;
    
    // For debounced text inputs (price fields, imei, barcode, dates, serial number)
    if (name === 'minPrice' || name === 'maxPrice' || name === 'imei1' || name === 'barcode' || name === 'serialNumber' || name === 'startDate' || name === 'endDate') {
      // For price fields, handle numeric input
      if (name === 'minPrice' || name === 'maxPrice') {
        // Allow only numbers and commas
        const sanitizedValue = value.replace(/[^\d,]/g, '');
        // Remove all commas first
        const numberOnly = sanitizedValue.replace(/,/g, '');
        // Format with proper comma placement
        const formattedValue = formatNumberWithCommas(numberOnly);
        
        // Update pending value first (for display)
        setPendingFilters(prev => ({
          ...prev,
          [name]: formattedValue
        }));
        
        // Clear any existing timer
        if (debounceTimerRef.current) {
          clearTimeout(debounceTimerRef.current);
        }
        
        // Set a new timer to update the actual filter after delay
        debounceTimerRef.current = setTimeout(() => {
          setFilters(prev => ({
            ...prev,
            [name]: formattedValue
          }));
        }, 800); // 800ms delay
      } else if (name === 'startDate' || name === 'endDate') {
        // NEW: Handle date fields with debounce
        setPendingFilters(prev => ({
          ...prev,
          [name]: value
        }));
        
        // Clear any existing timer
        if (debounceTimerRef.current) {
          clearTimeout(debounceTimerRef.current);
        }
        
        // Set a new timer to update the actual filter after delay
        debounceTimerRef.current = setTimeout(() => {
          setFilters(prev => ({
            ...prev,
            [name]: value
          }));
        }, 500); // 500ms delay for dates
      } else {
        // For text search fields (IMEI, barcode, serial number, supplier)
        setPendingFilters(prev => ({
          ...prev,
          [name]: value
        }));
        
        // Clear any existing timer
        if (debounceTimerRef.current) {
          clearTimeout(debounceTimerRef.current);
        }
        
        // Set a new timer to update the actual filter after delay
        debounceTimerRef.current = setTimeout(() => {
          setFilters(prev => ({
            ...prev,
            [name]: value
          }));
        }, 500); // 500ms delay
      }
    } else {
      // For dropdown selects (instant filtering)
      setFilters(prev => ({
        ...prev,
        [name]: value
      }));
      
      // Reset color when manufacturer or model changes
      if (name === 'manufacturer' || name === 'model') {
        setFilters(prev => ({
          ...prev,
          color: '',
          [name]: value
        }));
      }
    }
  };

  // Clear all filters - UPDATED: Added date fields and supplier
  const clearFilters = () => {
    // Clear both actual filters and pending filters
    setFilters({
      manufacturer: '',
      model: '',
      ram: '',
      storage: '',
      status: '',
      minPrice: '',
      maxPrice: '',
      color: '',
      imei1: '',
      barcode: '',
      serialNumber: '', 
      supplier: '',
      startDate: '',
      endDate: ''
    });
    
    setPendingFilters({
      minPrice: '',
      maxPrice: '',
      imei1: '',
      barcode: '',
      serialNumber: '',
      startDate: '',
      endDate: ''
    });
    
    // Clear any active debounce timer
    if (debounceTimerRef.current) {
      clearTimeout(debounceTimerRef.current);
      debounceTimerRef.current = null;
    }
  };
{/* Part 3 End - Filter Logic and Handlers */}

{/* Part 4 Start - Data Fetching Functions */}
  // Fetch inventory data - modified to handle search constraints
  const fetchInventoryData = useCallback(async () => {
    setLoading(true);
    setError(null);
    
    try {
      const inventoryRef = collection(db, 'inventory');
      
      // Build query constraints
      let queryConstraints = [orderBy(sortField, sortDirection)];
      
      // Add filter constraints if specified
      if (filters.manufacturer) {
        queryConstraints.push(where("manufacturer", "==", filters.manufacturer));
      }
      
      if (filters.model) {
        queryConstraints.push(where("model", "==", filters.model));
      }
      
      // Note: Firebase can only perform inequalities on a single field
      // For more complex filtering, we'll do it client-side
      
      // Create query with constraints
      const q = query(inventoryRef, ...queryConstraints);
      const snapshot = await getDocs(q);
      
      const items = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        items.push({
          id: doc.id,
          manufacturer: data.manufacturer || '',
          model: data.model || '',
          ram: data.ram || '',
          storage: data.storage || '',
          color: data.color || '',
          dealersPrice: data.dealersPrice || 0,
          retailPrice: data.retailPrice || 0,
          imei1: data.imei1 || '',
          imei2: data.imei2 || '',  // Also add imei2 while we're at it
          barcode: data.barcode || '',
          serialNumber: data.serialNumber || '', // ADD THIS LINE
          location: data.location || '', // FIXED: Added location field
          supplier: data.supplier || '', // FIXED: Added supplier field
          status: data.status || 'On-Hand',
          dateAdded: data.dateAdded || '',
          lastUpdated: data.lastUpdated || ''
        });
      });
      
      // Store all items
      setAllItems(items);
      
      // Load filter options from the fetched data
      loadFilterOptions(items);
      
      // Apply all filters client-side
      const filteredItems = applyFilters(items);
      setInventoryItems(filteredItems);
      setInitialLoad(false);
      setLoading(false);
    } catch (error) {
      console.error("Error fetching inventory data:", error);
      setError(`Error fetching inventory: ${error.message}`);
      setLoading(false);
    }
  }, [sortField, sortDirection, filters.manufacturer, filters.model, loadFilterOptions, applyFilters]);
{/* Part 4 End - Data Fetching Functions */}

{/* Part 5 Start - Event Handlers */}
  // Handle the search button click
  const handleSearch = () => {
    fetchInventoryData();
  };

  // Handle sort change
  const handleSort = (field) => {
    if (field === sortField) {
      // Toggle direction if same field
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      // Set new field and default to asc
      setSortField(field);
      setSortDirection('asc');
    }
  };

  // Handle Word export
  const handleWordExport = async () => {
    if (inventoryItems.length === 0) {
      alert('No inventory items to export');
      return;
    }

    setIsExporting(true);
    
    try {
      // Get supplier information
      const suppliersRef = collection(db, 'suppliers');
      const suppliersSnapshot = await getDocs(suppliersRef);
      const suppliersMap = {};
      suppliersSnapshot.forEach(doc => {
        suppliersMap[doc.id] = doc.data().supplierName;
      });

      // Build filter summary
      let filterSummary = [];
      if (filters.manufacturer) {
        filterSummary.push(`Brand: ${filters.manufacturer}`);
      } else {
        filterSummary.push('Brand: All');
      }
      
      if (filters.model) {
        filterSummary.push(`Model: ${filters.model}`);
      } else {
        filterSummary.push('Model: All');
      }
      
      if (filters.ram) {
        filterSummary.push(`RAM: ${filters.ram}`);
      } else {
        filterSummary.push('RAM: All');
      }
      
      if (filters.storage) {
        filterSummary.push(`Storage: ${filters.storage}`);
      } else {
        filterSummary.push('Storage: All');
      }
      
      if (filters.status) {
        filterSummary.push(`Status: ${filters.status}`);
      } else {
        filterSummary.push('Status: All');
      }
      
      if (filters.color) {
        filterSummary.push(`Color: ${filters.color}`);
      } else {
        filterSummary.push('Color: All');
      }
      
      if (filters.supplier) {
        const supplierName = suppliersMap[filters.supplier] || filters.supplier;
        filterSummary.push(`Supplier: ${supplierName}`);
      } else {
        filterSummary.push('Supplier: All');
      }
      
      if (filters.startDate) {
        filterSummary.push(`Start Date: ${new Date(filters.startDate).toLocaleDateString('en-US')}`);
      }
      
      if (filters.endDate) {
        filterSummary.push(`End Date: ${new Date(filters.endDate).toLocaleDateString('en-US')}`);
      }

      // Create HTML content with Word-specific namespace and minimal margins
      let htmlContent = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" 
              xmlns:w="urn:schemas-microsoft-com:office:word" 
              xmlns="http://www.w3.org/TR/REC-html40">
        <head>
          <meta charset="utf-8">
          <title>Inventory List Report</title>
          <!--[if gte mso 9]>
          <xml>
            <w:WordDocument>
              <w:View>Print</w:View>
              <w:Zoom>100</w:Zoom>
              <w:DoNotOptimizeForBrowser/>
            </w:WordDocument>
          </xml>
          <![endif]-->
          <style>
            @page {
              size: 8.5in 11in;
              margin: 0.5in 0.5in 0.5in 0.5in;
              mso-header-margin: 0;
              mso-footer-margin: 0;
              mso-paper-source: 0;
            }
            body {
              margin: 0;
              padding: 0;
              font-family: Arial, sans-serif;
              font-size: 10pt;
              color: #000;
            }
            div.Section1 {
              page: Section1;
              margin: 0;
              padding: 0;
            }
            h1 { 
              text-align: center; 
              color: #34459d;
              font-size: 21pt;
              margin: 0 0 10pt 0;
              padding: 0;
              font-weight: bold;
            }
            .header-info {
              margin: 0 0 3pt 0;
              font-size: 11pt;
              padding: 0;
            }
            .header-info p {
              margin: 0 0 3pt 0;
              padding: 0;
            }
            .filter-info {
              margin: 10pt 0 20pt 0;
              font-size: 11pt;
              padding: 0;
            }
            .filter-info p {
              margin: 0;
              padding: 0;
            }
            table {
              width: 100%;
              border-collapse: collapse;
              border-spacing: 0;
              margin: 0;
              padding: 0;
              table-layout: fixed;
            }
            th {
              background-color: #34459d;
              color: white;
              padding: 6pt 8pt;
              text-align: left;
              font-size: 10pt;
              font-weight: bold;
              border: 1pt solid #34459d;
              vertical-align: middle;
            }
            td {
              padding: 5pt 8pt;
              border: 1pt solid #ddd;
              font-size: 9pt;
              font-family: Arial, sans-serif;
              vertical-align: middle;
              mso-line-height-rule: exactly;
              line-height: 14pt;
            }
            th.center, td.center {
              text-align: center;
            }
            .phone-cell {
              font-weight: bold;
              text-align: center;
              vertical-align: middle;
              white-space: nowrap;
            }
            .phone-number {
              font-size: 9pt;
              font-weight: bold;
              color: #000;
            }
            .imei-cell {
              font-family: Arial, sans-serif;
              font-size: 9pt;
            }
            .gray-row {
              background-color: #f0f0f0;
            }
            .white-row {
              background-color: white;
            }
            .model-cell {
              font-size: 9pt;
            }
            .status-cell {
              white-space: nowrap !important;
              font-size: 9pt;
              min-width: 80pt;
              width: 80pt;
            }
          </style>
        </head>
        <body>
          <div class="Section1">
            <h1>Inventory List Report</h1>
            <div class="header-info">
              <p><b>Generated Date:</b> ${new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              })}</p>
              <p><b>Total Items:</b> ${inventoryItems.length}</p>
            </div>
            <div class="filter-info">
              <p><b>Applied Filters:</b></p>
              <p>${filterSummary.join(' | ')}</p>
            </div>
            <table>
              <colgroup>
                <col style="width: 12%;">
                <col style="width: 8%;">
                <col style="width: 32%;">
                <col style="width: 14%;">
                <col style="width: 19%;">
                <col style="width: 15%;">
              </colgroup>
              <thead>
                <tr>
                  <th class="center">Phone</th>
                  <th>Brand</th>
                  <th>Model</th>
                  <th>Color</th>
                  <th>IMEI</th>
                  <th class="center" style="white-space: nowrap;">Status</th>
                </tr>
              </thead>
              <tbody>
      `;

      // Group items by manufacturer, model, storage, and color
      const groupedItems = {};
      inventoryItems.forEach(item => {
        const key = `${item.manufacturer}_${item.model}_${item.storage}_${item.color}`;
        if (!groupedItems[key]) {
          groupedItems[key] = {
            manufacturer: item.manufacturer,
            model: item.model,
            ram: item.ram,
            storage: item.storage,
            color: item.color,
            items: []
          };
        }
        groupedItems[key].items.push(item);
      });

      // Sort grouped items
      const sortedGroups = Object.values(groupedItems).sort((a, b) => {
        if (a.manufacturer !== b.manufacturer) {
          return a.manufacturer.localeCompare(b.manufacturer);
        }
        if (a.model !== b.model) {
          return a.model.localeCompare(b.model);
        }
        if (a.storage !== b.storage) {
          const storageA = parseInt(a.storage) || 0;
          const storageB = parseInt(b.storage) || 0;
          return storageA - storageB;
        }
        return a.color.localeCompare(b.color);
      });

      // Generate rows with alternating colors
      let groupIndex = 0;
      sortedGroups.forEach(group => {
        const rowspan = group.items.length;
        const rowClass = groupIndex % 2 === 0 ? 'white-row' : 'gray-row';
        const phoneCountBg = groupIndex % 2 === 0 ? 'white' : '#f0f0f0';
        
        // Format RAM and storage with GB
        const ramDisplay = group.ram ? `${group.ram}GB` : 'N/A';
        const storageDisplay = group.storage ? `${group.storage}GB` : 'N/A';
        const modelDisplay = `${group.model} (${ramDisplay}+${storageDisplay})`;
        
        // First row of the group
        htmlContent += `
          <tr class="${rowClass}">
            <td rowspan="${rowspan}" class="phone-cell" style="background-color: ${phoneCountBg}; white-space: nowrap;">
              Phone ${group.items.length}
            </td>
            <td rowspan="${rowspan}" style="vertical-align: middle;">${group.manufacturer}</td>
            <td rowspan="${rowspan}" class="model-cell" style="vertical-align: middle;">${modelDisplay}</td>
            <td rowspan="${rowspan}" style="vertical-align: middle;">${group.color}</td>
            <td class="imei-cell">${group.items[0].imei1 || 'N/A'}</td>
            <td class="center status-cell" style="white-space: nowrap !important; width: 80pt;">${group.items[0].status === 'On-Hand' ? 'Stock' : group.items[0].status}</td>
          </tr>
        `;

        // Additional rows for the same group
        for (let i = 1; i < group.items.length; i++) {
          const item = group.items[i];
          htmlContent += `
            <tr class="${rowClass}">
              <td class="imei-cell">${item.imei1 || 'N/A'}</td>
              <td class="center status-cell" style="white-space: nowrap !important; width: 80pt;">${item.status === 'On-Hand' ? 'Stock' : item.status}</td>
            </tr>
          `;
        }
        
        groupIndex++;
      });

      htmlContent += `
              </tbody>
            </table>
          </div>
        </body>
        </html>
      `;

      // Create blob and download with proper MIME type for Word
      const blob = new Blob([htmlContent], { 
        type: 'application/vnd.ms-word;charset=utf-8' 
      });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `Inventory_List_${new Date().toISOString().split('T')[0]}.doc`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      setIsExporting(false);
    } catch (error) {
      console.error('Error exporting to Word:', error);
      alert('Failed to export to Word. Please try again.');
      setIsExporting(false);
    }
  };
{/* Part 5 End - Event Handlers */}

{/* Part 6 Start - Main Component JSX */}
  return (
    <div className="min-h-screen bg-white p-4">
      <Card className="w-full mx-auto rounded-lg overflow-hidden shadow-[0_3px_10px_rgb(0,0,0,0.2)]" style={{ maxWidth: '1472px' }}>
        <CardHeader className="bg-[rgb(52,69,157)] py-3 flex flex-row justify-between items-center">
          <div className="flex items-center gap-2">
            <Smartphone className="h-6 w-6 text-white" />
            <CardTitle className="text-2xl text-white">Inventory List</CardTitle>
            {!initialLoad && (
              <span className="text-white/80 text-sm">
                ({inventoryItems.length} items)
              </span>
            )}
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => setShowFilters(!showFilters)}
              className={`flex items-center gap-1 ${showFilters ? 
                'bg-white/20 text-white' : 'bg-white text-[rgb(52,69,157)]'} px-4 py-2 rounded text-base font-medium`}
            >
              <Filter className="h-5 w-5 mr-1" />
              <span>Filters</span>
            </button>
            <button
              onClick={handleSearch}
              className="flex items-center gap-1 bg-white text-[rgb(52,69,157)] px-4 py-2 rounded text-base font-medium"
            >
              <Search className="h-5 w-5 mr-1" />
              <span>Search</span>
            </button>
            <button
              onClick={() => fetchInventoryData()}
              className="flex items-center gap-1 bg-white text-[rgb(52,69,157)] px-4 py-2 rounded text-base font-medium"
            >
              <RefreshCw className="h-5 w-5 mr-1" />
              <span>Refresh</span>
            </button>
            <button
              onClick={handleWordExport}
              disabled={isExporting || inventoryItems.length === 0}
              className={`flex items-center gap-1 ${
                isExporting || inventoryItems.length === 0
                  ? 'bg-gray-400 text-gray-200 cursor-not-allowed'
                  : 'bg-white text-[rgb(52,69,157)]'
              } px-4 py-2 rounded text-base font-medium`}
            >
              <FileText className="h-5 w-5 mr-1" />
              <span>{isExporting ? 'Exporting...' : 'Export'}</span>
            </button>
          </div>
        </CardHeader>

        <CardContent className="p-4">
          {/* Filters panel */}
          {showFilters && (
            <div className="mb-6 p-4 bg-gray-50 rounded-lg border">
              <div className="flex justify-between items-center mb-4">
                <h3 className="font-semibold text-lg text-[rgb(52,69,157)]">Filters</h3>
                <button 
                  onClick={clearFilters}
                  className="text-gray-500 hover:text-red-500 flex items-center"
                >
                  <X className="h-4 w-4 mr-1" />
                  Clear Filters
                </button>
              </div>
              
              <InventoryFilters 
                filters={filters}
                pendingFilters={pendingFilters}
                filterOptions={filterOptions}
                handleFilterChange={handleFilterChange}
                allItems={allItems}
              />
            </div>
          )}
          {/* Inventory Summary Section */}
          {!initialLoad && inventoryItems.length > 0 && (
            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 mb-4">
              <div className="mb-4">
                <h3 className="text-lg font-semibold text-gray-800">Inventory Summary</h3>
              </div>
              
              <div className="flex flex-col md:flex-row gap-4">
                {/* Item Count - 25% */}
                <div className="w-full md:w-[25%] bg-white rounded-lg p-4 border border-blue-100 shadow-sm">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-gray-600 font-medium">Item Count</p>
                      <p className="text-xs text-gray-500">Total inventory items</p>
                    </div>
                    <div className="text-right">
                      <p className="text-xl font-bold text-blue-600">
                        {inventoryItems.length.toLocaleString()}
                      </p>
                      <p className="text-xs text-gray-500">
                        {inventoryItems.length === 1 ? 'item' : 'items'}
                      </p>
                    </div>
                  </div>
                </div>
                
                {/* Total Value - 30% */}
                <div className="w-full md:w-[30%] bg-white rounded-lg p-4 border border-green-100 shadow-sm">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-gray-600 font-medium">Total Value</p>
                      <p className="text-xs text-gray-500">Combined retail price</p>
                    </div>
                    <div className="text-right">
                      <p className="text-xl font-bold text-green-600">
                        {(() => {
                          const totalValue = inventoryItems.reduce((total, item) => {
                            return total + (item.retailPrice || 0);
                          }, 0);
                          return totalValue.toLocaleString('en-US', { 
                            minimumFractionDigits: 2, 
                            maximumFractionDigits: 2 
                          });
                        })()}
                      </p>
                      <p className="text-xs text-gray-500">retail value</p>
                    </div>
                  </div>
                </div>
                
                {/* Status Breakdown - 45% */}
                <div className="w-full md:w-[45%] bg-white rounded-lg p-4 border border-purple-100 shadow-sm">
                  <div className="flex items-start">
                    <div className="mr-4">
                      <p className="text-sm text-gray-600 font-medium">Status Breakdown</p>
                      <p className="text-xs text-gray-500">Items by status</p>
                    </div>
                    <div className="flex flex-wrap gap-3 items-center">
                      {(() => {
                        const statusCounts = inventoryItems.reduce((counts, item) => {
                          const status = item.status || 'Unknown';
                          counts[status] = (counts[status] || 0) + 1;
                          return counts;
                        }, {});
                        
                        // Define order and display names
                        const statusOrder = [
                          { key: 'On-Hand', display: 'Stock' },
                          { key: 'On-Display', display: 'Display' },
                          { key: 'Sold', display: 'Sold' },
                          { key: 'Reserved', display: 'Reserved' },
                          { key: 'Defective', display: 'Defective' }
                        ];
                        
                        return statusOrder
                          .filter(status => statusCounts[status.key] > 0)
                          .map((status) => (
                            <div key={status.key} className="flex items-center">
                              <span className={`text-xs px-2 py-0.5 rounded-full ${
                                status.key === 'On-Hand' ? 'bg-blue-100 text-blue-700' :
                                status.key === 'On-Display' ? 'bg-yellow-100 text-yellow-700' :
                                status.key === 'Sold' ? 'bg-purple-100 text-purple-700' :
                                status.key === 'Reserved' ? 'bg-orange-100 text-orange-700' :
                                'bg-gray-100 text-gray-700'
                              }`}>
                                {status.display}
                              </span>
                              <span className="font-semibold text-gray-700 ml-1">
                                {statusCounts[status.key]}
                              </span>
                            </div>
                          ));
                      })()}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
          <div className="overflow-x-auto">
            {initialLoad ? (
              <div className="text-center py-12">
                <p className="text-lg mb-4">Use the search button to load inventory items</p>
                <p className="text-sm text-gray-500 mb-6">You can apply filters before searching or search all items</p>
                <button
                  onClick={handleSearch}
                  className="bg-[rgb(52,69,157)] text-white px-6 py-2 rounded-md flex items-center mx-auto"
                >
                  <Search className="h-5 w-5 mr-2" />
                  Search All Inventory
                </button>
              </div>
            ) : inventoryItems.length === 0 ? (
              <div className="text-center py-12">
                <p className="text-lg text-gray-500">No inventory items match your filters</p>
                <button
                  onClick={clearFilters}
                  className="mt-4 text-blue-600 hover:text-blue-800 underline"
                >
                  Clear all filters
                </button>
              </div>
            ) : (
              <InventoryTable 
                inventoryItems={inventoryItems}
                allItems={allItems}
                setAllItems={setAllItems}
                setInventoryItems={setInventoryItems}
                loading={loading}
                error={error}
                sortField={sortField}
                sortDirection={sortDirection}
                handleSort={handleSort}
                applyFilters={applyFilters}
              />
            )}
          </div>
          <div className="overflow-x-auto"></div>
          {/* Show loading state */}
          {loading && (
            <div className="text-center py-4">
              <RefreshCw className="h-6 w-6 animate-spin mx-auto text-[rgb(52,69,157)]" />
              <p className="text-gray-600 mt-2">Loading inventory items...</p>
            </div>
          )}
          
          {/* Show error state */}
          {error && (
            <div className="text-center py-4 text-red-600">
              <p>{error}</p>
              <button
                onClick={() => {
                  setError(null);
                  fetchInventoryData();
                }}
                className="mt-2 text-blue-600 hover:text-blue-800 underline"
              >
                Try again
              </button>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
};

export default InventoryListForm;
{/* Part 6 End - Main Component JSX */}
</file>

</files>
